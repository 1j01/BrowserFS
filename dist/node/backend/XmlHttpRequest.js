var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var api_error_1 = require('../core/api_error');
var file_flag_1 = require('../core/file_flag');
var util_1 = require('../core/util');
var preload_file = require('../generic/preload_file');
var xhr = require('../generic/xhr');
var file_index_1 = require('../generic/file_index');
var XmlHttpRequest = (function (_super) {
    __extends(XmlHttpRequest, _super);
    function XmlHttpRequest(listingUrl, prefixUrl) {
        if (prefixUrl === void 0) { prefixUrl = ''; }
        _super.call(this);
        if (listingUrl == null) {
            listingUrl = 'index.json';
        }
        if (prefixUrl.length > 0 && prefixUrl.charAt(prefixUrl.length - 1) !== '/') {
            prefixUrl = prefixUrl + '/';
        }
        this.prefixUrl = prefixUrl;
        var listing = this._requestFileSync(listingUrl, 'json');
        if (listing == null) {
            throw new Error("Unable to find listing at URL: " + listingUrl);
        }
        this._index = file_index_1.FileIndex.fromListing(listing);
    }
    XmlHttpRequest.prototype.empty = function () {
        this._index.fileIterator(function (file) {
            file.file_data = null;
        });
    };
    XmlHttpRequest.prototype.getXhrPath = function (filePath) {
        if (filePath.charAt(0) === '/') {
            filePath = filePath.slice(1);
        }
        return this.prefixUrl + filePath;
    };
    XmlHttpRequest.prototype._requestFileSizeAsync = function (path, cb) {
        xhr.getFileSizeAsync(this.getXhrPath(path), cb);
    };
    XmlHttpRequest.prototype._requestFileSizeSync = function (path) {
        return xhr.getFileSizeSync(this.getXhrPath(path));
    };
    XmlHttpRequest.prototype._requestFileAsync = function (p, type, cb) {
        xhr.asyncDownloadFile(this.getXhrPath(p), type, cb);
    };
    XmlHttpRequest.prototype._requestFileSync = function (p, type) {
        return xhr.syncDownloadFile(this.getXhrPath(p), type);
    };
    XmlHttpRequest.prototype.getName = function () {
        return 'XmlHttpRequest';
    };
    XmlHttpRequest.isAvailable = function () {
        return typeof XMLHttpRequest !== "undefined" && XMLHttpRequest !== null;
    };
    XmlHttpRequest.prototype.diskSpace = function (path, cb) {
        cb(0, 0);
    };
    XmlHttpRequest.prototype.isReadOnly = function () {
        return true;
    };
    XmlHttpRequest.prototype.supportsLinks = function () {
        return false;
    };
    XmlHttpRequest.prototype.supportsProps = function () {
        return false;
    };
    XmlHttpRequest.prototype.supportsSynch = function () {
        return true;
    };
    XmlHttpRequest.prototype.preloadFile = function (path, buffer) {
        var inode = this._index.getInode(path);
        if (file_index_1.isFileInode(inode)) {
            if (inode === null) {
                throw api_error_1.ApiError.ENOENT(path);
            }
            var stats = inode.getData();
            stats.size = buffer.length;
            stats.file_data = buffer;
        }
        else {
            throw api_error_1.ApiError.EISDIR(path);
        }
    };
    XmlHttpRequest.prototype.stat = function (path, isLstat, cb) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            return cb(api_error_1.ApiError.ENOENT(path));
        }
        var stats;
        if (file_index_1.isFileInode(inode)) {
            stats = inode.getData();
            if (stats.size < 0) {
                this._requestFileSizeAsync(path, function (e, size) {
                    if (e) {
                        return cb(e);
                    }
                    stats.size = size;
                    cb(null, stats.clone());
                });
            }
            else {
                cb(null, stats.clone());
            }
        }
        else if (file_index_1.isDirInode(inode)) {
            stats = inode.getStats();
            cb(null, stats);
        }
        else {
            cb(api_error_1.ApiError.FileError(api_error_1.ErrorCode.EINVAL, path));
        }
    };
    XmlHttpRequest.prototype.statSync = function (path, isLstat) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        var stats;
        if (file_index_1.isFileInode(inode)) {
            stats = inode.getData();
            if (stats.size < 0) {
                stats.size = this._requestFileSizeSync(path);
            }
        }
        else if (file_index_1.isDirInode(inode)) {
            stats = inode.getStats();
        }
        else {
            throw api_error_1.ApiError.FileError(api_error_1.ErrorCode.EINVAL, path);
        }
        return stats;
    };
    XmlHttpRequest.prototype.open = function (path, flags, mode, cb) {
        if (flags.isWriteable()) {
            return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EPERM, path));
        }
        var _this = this;
        var inode = this._index.getInode(path);
        if (inode === null) {
            return cb(api_error_1.ApiError.ENOENT(path));
        }
        if (file_index_1.isFileInode(inode)) {
            var stats = inode.getData();
            switch (flags.pathExistsAction()) {
                case file_flag_1.ActionType.THROW_EXCEPTION:
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    return cb(api_error_1.ApiError.EEXIST(path));
                case file_flag_1.ActionType.NOP:
                    if (stats.file_data != null) {
                        return cb(null, new preload_file.NoSyncFile(_this, path, flags, stats.clone(), stats.file_data));
                    }
                    this._requestFileAsync(path, 'buffer', function (err, buffer) {
                        if (err) {
                            return cb(err);
                        }
                        stats.size = buffer.length;
                        stats.file_data = buffer;
                        return cb(null, new preload_file.NoSyncFile(_this, path, flags, stats.clone(), buffer));
                    });
                    break;
                default:
                    return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, 'Invalid FileMode object.'));
            }
        }
        else {
            return cb(api_error_1.ApiError.EISDIR(path));
        }
    };
    XmlHttpRequest.prototype.openSync = function (path, flags, mode) {
        if (flags.isWriteable()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EPERM, path);
        }
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        if (file_index_1.isFileInode(inode)) {
            var stats = inode.getData();
            switch (flags.pathExistsAction()) {
                case file_flag_1.ActionType.THROW_EXCEPTION:
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    throw api_error_1.ApiError.EEXIST(path);
                case file_flag_1.ActionType.NOP:
                    if (stats.file_data != null) {
                        return new preload_file.NoSyncFile(this, path, flags, stats.clone(), stats.file_data);
                    }
                    var buffer = this._requestFileSync(path, 'buffer');
                    stats.size = buffer.length;
                    stats.file_data = buffer;
                    return new preload_file.NoSyncFile(this, path, flags, stats.clone(), buffer);
                default:
                    throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, 'Invalid FileMode object.');
            }
        }
        else {
            throw api_error_1.ApiError.EISDIR(path);
        }
    };
    XmlHttpRequest.prototype.readdir = function (path, cb) {
        try {
            cb(null, this.readdirSync(path));
        }
        catch (e) {
            cb(e);
        }
    };
    XmlHttpRequest.prototype.readdirSync = function (path) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        else if (file_index_1.isDirInode(inode)) {
            return inode.getListing();
        }
        else {
            throw api_error_1.ApiError.ENOTDIR(path);
        }
    };
    XmlHttpRequest.prototype.readFile = function (fname, encoding, flag, cb) {
        var oldCb = cb;
        this.open(fname, flag, 0x1a4, function (err, fd) {
            if (err) {
                return cb(err);
            }
            cb = function (err, arg) {
                fd.close(function (err2) {
                    if (err == null) {
                        err = err2;
                    }
                    return oldCb(err, arg);
                });
            };
            var fdCast = fd;
            var fdBuff = fdCast.getBuffer();
            if (encoding === null) {
                return cb(err, util_1.copyingSlice(fdBuff));
            }
            try {
                cb(null, fdBuff.toString(encoding));
            }
            catch (e) {
                cb(e);
            }
        });
    };
    XmlHttpRequest.prototype.readFileSync = function (fname, encoding, flag) {
        var fd = this.openSync(fname, flag, 0x1a4);
        try {
            var fdCast = fd;
            var fdBuff = fdCast.getBuffer();
            if (encoding === null) {
                return util_1.copyingSlice(fdBuff);
            }
            return fdBuff.toString(encoding);
        }
        finally {
            fd.closeSync();
        }
    };
    return XmlHttpRequest;
})(file_system.BaseFileSystem);
exports.__esModule = true;
exports["default"] = XmlHttpRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWG1sSHR0cFJlcXVlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFja2VuZC9YbWxIdHRwUmVxdWVzdC50cyJdLCJuYW1lcyI6WyJYbWxIdHRwUmVxdWVzdCIsIlhtbEh0dHBSZXF1ZXN0LmNvbnN0cnVjdG9yIiwiWG1sSHR0cFJlcXVlc3QuZW1wdHkiLCJYbWxIdHRwUmVxdWVzdC5nZXRYaHJQYXRoIiwiWG1sSHR0cFJlcXVlc3QuX3JlcXVlc3RGaWxlU2l6ZUFzeW5jIiwiWG1sSHR0cFJlcXVlc3QuX3JlcXVlc3RGaWxlU2l6ZVN5bmMiLCJYbWxIdHRwUmVxdWVzdC5fcmVxdWVzdEZpbGVBc3luYyIsIlhtbEh0dHBSZXF1ZXN0Ll9yZXF1ZXN0RmlsZVN5bmMiLCJYbWxIdHRwUmVxdWVzdC5nZXROYW1lIiwiWG1sSHR0cFJlcXVlc3QuaXNBdmFpbGFibGUiLCJYbWxIdHRwUmVxdWVzdC5kaXNrU3BhY2UiLCJYbWxIdHRwUmVxdWVzdC5pc1JlYWRPbmx5IiwiWG1sSHR0cFJlcXVlc3Quc3VwcG9ydHNMaW5rcyIsIlhtbEh0dHBSZXF1ZXN0LnN1cHBvcnRzUHJvcHMiLCJYbWxIdHRwUmVxdWVzdC5zdXBwb3J0c1N5bmNoIiwiWG1sSHR0cFJlcXVlc3QucHJlbG9hZEZpbGUiLCJYbWxIdHRwUmVxdWVzdC5zdGF0IiwiWG1sSHR0cFJlcXVlc3Quc3RhdFN5bmMiLCJYbWxIdHRwUmVxdWVzdC5vcGVuIiwiWG1sSHR0cFJlcXVlc3Qub3BlblN5bmMiLCJYbWxIdHRwUmVxdWVzdC5yZWFkZGlyIiwiWG1sSHR0cFJlcXVlc3QucmVhZGRpclN5bmMiLCJYbWxIdHRwUmVxdWVzdC5yZWFkRmlsZSIsIlhtbEh0dHBSZXF1ZXN0LnJlYWRGaWxlU3luYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFPLFdBQVcsV0FBVyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ3BELDBCQUFrQyxtQkFBbUIsQ0FBQyxDQUFBO0FBQ3RELDBCQUFtQyxtQkFB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akJBLENBQUNBO0lBQ0hBLENBQUNBO0lBQ0h2QixxQkFBQ0E7QUFBREEsQ0FBQ0EsQUEzVEQsRUFBNEMsV0FBVyxDQUFDLGNBQWMsRUEyVHJFO0FBM1REO21DQTJUQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZpbGVfc3lzdGVtID0gcmVxdWlyZSgnLi4vY29yZS9maWxlX3N5c3RlbScpO1xuaW1wb3J0IHtBcGlFcnJvciwgRXJyb3JDb2RlfSBmcm9tICcuLi9jb3JlL2FwaV9lcnJvcic7XG5pbXBvcnQge0ZpbGVGbGFnLCBBY3Rpb25UeXBlfSBmcm9tICcuLi9jb3JlL2ZpbGVfZmxhZyc7XG5pbXBvcnQge2NvcHlpbmdTbGljZX0gZnJvbSAnLi4vY29yZS91dGlsJztcbmltcG9ydCBmaWxlID0gcmVxdWlyZSgnLi4vY29yZS9maWxlJyk7XG5pbXBvcnQgU3RhdHMgZnJvbSAnLi4vY29yZS9ub2RlX2ZzX3N0YXRzJztcbmltcG9ydCBwcmVsb2FkX2ZpbGUgPSByZXF1aXJlKCcuLi9nZW5lcmljL3ByZWxvYWRfZmlsZScpO1xuaW1wb3J0IHhociA9IHJlcXVpcmUoJy4uL2dlbmVyaWMveGhyJyk7XG5pbXBvcnQge0ZpbGVJbmRleCwgRGlySW5vZGUsIEZpbGVJbm9kZSwgSW5vZGUsIGlzRmlsZUlub2RlLCBpc0Rpcklub2RlfSBmcm9tICcuLi9nZW5lcmljL2ZpbGVfaW5kZXgnO1xuXG4vKipcbiAqIEEgc2ltcGxlIGZpbGVzeXN0ZW0gYmFja2VkIGJ5IFhtbEh0dHBSZXF1ZXN0cy5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgWG1sSHR0cFJlcXVlc3QgZXh0ZW5kcyBmaWxlX3N5c3RlbS5CYXNlRmlsZVN5c3RlbSBpbXBsZW1lbnRzIGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0ge1xuICBwcml2YXRlIF9pbmRleDogRmlsZUluZGV4O1xuICBwdWJsaWMgcHJlZml4VXJsOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIHRoZSBmaWxlIHN5c3RlbS5cbiAgICogQHBhcmFtIGxpc3RpbmdVcmwgVGhlIHBhdGggdG8gdGhlIEpTT04gZmlsZSBpbmRleCBnZW5lcmF0ZWQgYnlcbiAgICogICB0b29scy9YSFJJbmRleGVyLmNvZmZlZS4gVGhpcyBjYW4gYmUgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgd2VicGFnZSBVUkxcbiAgICogICBvciBhYnNvbHV0ZWx5IHNwZWNpZmllZC5cbiAgICogQHBhcmFtIHByZWZpeFVybCBUaGUgdXJsIHByZWZpeCB0byB1c2UgZm9yIGFsbCB3ZWItc2VydmVyIHJlcXVlc3RzLlxuICAgKi9cbiAgY29uc3RydWN0b3IobGlzdGluZ1VybDogc3RyaW5nLCBwcmVmaXhVcmw6IHN0cmluZyA9ICcnKSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAobGlzdGluZ1VybCA9PSBudWxsKSB7XG4gICAgICBsaXN0aW5nVXJsID0gJ2luZGV4Lmpzb24nO1xuICAgIH1cbiAgICAvLyBwcmVmaXhfdXJsIG11c3QgZW5kIGluIGEgZGlyZWN0b3J5IHNlcGFyYXRvci5cbiAgICBpZiAocHJlZml4VXJsLmxlbmd0aCA+IDAgJiYgcHJlZml4VXJsLmNoYXJBdChwcmVmaXhVcmwubGVuZ3RoIC0gMSkgIT09ICcvJykge1xuICAgICAgcHJlZml4VXJsID0gcHJlZml4VXJsICsgJy8nO1xuICAgIH1cbiAgICB0aGlzLnByZWZpeFVybCA9IHByZWZpeFVybDtcbiAgICB2YXIgbGlzdGluZyA9IHRoaXMuX3JlcXVlc3RGaWxlU3luYyhsaXN0aW5nVXJsLCAnanNvbicpO1xuICAgIGlmIChsaXN0aW5nID09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlVuYWJsZSB0byBmaW5kIGxpc3RpbmcgYXQgVVJMOiBcIiArIGxpc3RpbmdVcmwpO1xuICAgIH1cbiAgICB0aGlzLl9pbmRleCA9IEZpbGVJbmRleC5mcm9tTGlzdGluZyhsaXN0aW5nKTtcbiAgfVxuXG4gIHB1YmxpYyBlbXB0eSgpOiB2b2lkIHtcbiAgICB0aGlzLl9pbmRleC5maWxlSXRlcmF0b3IoZnVuY3Rpb24oZmlsZTogU3RhdHMpIHtcbiAgICAgIGZpbGUuZmlsZV9kYXRhID0gbnVsbDtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0WGhyUGF0aChmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoZmlsZVBhdGguY2hhckF0KDApID09PSAnLycpIHtcbiAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGguc2xpY2UoMSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByZWZpeFVybCArIGZpbGVQYXRoO1xuICB9XG5cbiAgLyoqXG4gICAqIE9ubHkgcmVxdWVzdHMgdGhlIEhFQUQgY29udGVudCwgZm9yIHRoZSBmaWxlIHNpemUuXG4gICAqL1xuICBwdWJsaWMgX3JlcXVlc3RGaWxlU2l6ZUFzeW5jKHBhdGg6IHN0cmluZywgY2I6IChlcnI6IEFwaUVycm9yLCBzaXplPzogbnVtYmVyKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgeGhyLmdldEZpbGVTaXplQXN5bmModGhpcy5nZXRYaHJQYXRoKHBhdGgpLCBjYik7XG4gIH1cbiAgcHVibGljIF9yZXF1ZXN0RmlsZVNpemVTeW5jKHBhdGg6IHN0cmluZyk6IG51bWJlciB7XG4gICAgcmV0dXJuIHhoci5nZXRGaWxlU2l6ZVN5bmModGhpcy5nZXRYaHJQYXRoKHBhdGgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3luY2hyb25vdXNseSBkb3dubG9hZCB0aGUgZ2l2ZW4gZmlsZS5cbiAgICovXG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlQXN5bmMocDogc3RyaW5nLCB0eXBlOiAnYnVmZmVyJywgY2I6IChlcnI6IEFwaUVycm9yLCBkYXRhPzogTm9kZUJ1ZmZlcikgPT4gdm9pZCk6IHZvaWQ7XG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlQXN5bmMocDogc3RyaW5nLCB0eXBlOiAnanNvbicsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQ7XG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlQXN5bmMocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQ7XG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlQXN5bmMocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHhoci5hc3luY0Rvd25sb2FkRmlsZSh0aGlzLmdldFhoclBhdGgocCksIHR5cGUsIGNiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTeW5jaHJvbm91c2x5IGRvd25sb2FkIHRoZSBnaXZlbiBmaWxlLlxuICAgKi9cbiAgcHJpdmF0ZSBfcmVxdWVzdEZpbGVTeW5jKHA6IHN0cmluZywgdHlwZTogJ2J1ZmZlcicpOiBOb2RlQnVmZmVyO1xuICBwcml2YXRlIF9yZXF1ZXN0RmlsZVN5bmMocDogc3RyaW5nLCB0eXBlOiAnanNvbicpOiBhbnk7XG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlU3luYyhwOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGFueTtcbiAgcHJpdmF0ZSBfcmVxdWVzdEZpbGVTeW5jKHA6IHN0cmluZywgdHlwZTogc3RyaW5nKTogYW55IHtcbiAgICByZXR1cm4geGhyLnN5bmNEb3dubG9hZEZpbGUodGhpcy5nZXRYaHJQYXRoKHApLCB0eXBlKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXROYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuICdYbWxIdHRwUmVxdWVzdCc7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGlzQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xuICAgIC8vIEB0b2RvIE9sZGVyIGJyb3dzZXJzIHVzZSBhIGRpZmZlcmVudCBuYW1lIGZvciBYSFIsIGlpcmMuXG4gICAgcmV0dXJuIHR5cGVvZiBYTUxIdHRwUmVxdWVzdCAhPT0gXCJ1bmRlZmluZWRcIiAmJiBYTUxIdHRwUmVxdWVzdCAhPT0gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBkaXNrU3BhY2UocGF0aDogc3RyaW5nLCBjYjogKHRvdGFsOiBudW1iZXIsIGZyZWU6IG51bWJlcikgPT4gdm9pZCk6IHZvaWQge1xuICAgIC8vIFJlYWQtb25seSBmaWxlIHN5c3RlbS4gV2UgY291bGQgY2FsY3VsYXRlIHRoZSB0b3RhbCBzcGFjZSwgYnV0IHRoYXQncyBub3RcbiAgICAvLyBpbXBvcnRhbnQgcmlnaHQgbm93LlxuICAgIGNiKDAsIDApO1xuICB9XG5cbiAgcHVibGljIGlzUmVhZE9ubHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgc3VwcG9ydHNMaW5rcygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgc3VwcG9ydHNQcm9wcygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgc3VwcG9ydHNTeW5jaCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTcGVjaWFsIFhIUiBmdW5jdGlvbjogUHJlbG9hZCB0aGUgZ2l2ZW4gZmlsZSBpbnRvIHRoZSBpbmRleC5cbiAgICogQHBhcmFtIFtTdHJpbmddIHBhdGhcbiAgICogQHBhcmFtIFtCcm93c2VyRlMuQnVmZmVyXSBidWZmZXJcbiAgICovXG4gIHB1YmxpYyBwcmVsb2FkRmlsZShwYXRoOiBzdHJpbmcsIGJ1ZmZlcjogTm9kZUJ1ZmZlcik6IHZvaWQge1xuICAgIHZhciBpbm9kZSA9IHRoaXMuX2luZGV4LmdldElub2RlKHBhdGgpO1xuICAgIGlmIChpc0ZpbGVJbm9kZTxTdGF0cz4oaW5vZGUpKSB7XG4gICAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHBhdGgpO1xuICAgICAgfVxuICAgICAgdmFyIHN0YXRzID0gaW5vZGUuZ2V0RGF0YSgpO1xuICAgICAgc3RhdHMuc2l6ZSA9IGJ1ZmZlci5sZW5ndGg7XG4gICAgICBzdGF0cy5maWxlX2RhdGEgPSBidWZmZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVJU0RJUihwYXRoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc3RhdChwYXRoOiBzdHJpbmcsIGlzTHN0YXQ6IGJvb2xlYW4sIGNiOiAoZTogQXBpRXJyb3IsIHN0YXQ/OiBTdGF0cykgPT4gdm9pZCk6IHZvaWQge1xuICAgIHZhciBpbm9kZSA9IHRoaXMuX2luZGV4LmdldElub2RlKHBhdGgpO1xuICAgIGlmIChpbm9kZSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNiKEFwaUVycm9yLkVOT0VOVChwYXRoKSk7XG4gICAgfVxuICAgIHZhciBzdGF0czogU3RhdHM7XG4gICAgaWYgKGlzRmlsZUlub2RlPFN0YXRzPihpbm9kZSkpIHtcbiAgICAgIHN0YXRzID0gaW5vZGUuZ2V0RGF0YSgpO1xuICAgICAgLy8gQXQgdGhpcyBwb2ludCwgYSBub24tb3BlbmVkIGZpbGUgd2lsbCBzdGlsbCBoYXZlIGRlZmF1bHQgc3RhdHMgZnJvbSB0aGUgbGlzdGluZy5cbiAgICAgIGlmIChzdGF0cy5zaXplIDwgMCkge1xuICAgICAgICB0aGlzLl9yZXF1ZXN0RmlsZVNpemVBc3luYyhwYXRoLCBmdW5jdGlvbihlOiBBcGlFcnJvciwgc2l6ZT86IG51bWJlcikge1xuICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICByZXR1cm4gY2IoZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHN0YXRzLnNpemUgPSBzaXplO1xuICAgICAgICAgIGNiKG51bGwsIHN0YXRzLmNsb25lKCkpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNiKG51bGwsIHN0YXRzLmNsb25lKCkpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaXNEaXJJbm9kZShpbm9kZSkpIHtcbiAgICAgIHN0YXRzID0gaW5vZGUuZ2V0U3RhdHMoKTtcbiAgICAgIGNiKG51bGwsIHN0YXRzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2IoQXBpRXJyb3IuRmlsZUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIHBhdGgpKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc3RhdFN5bmMocGF0aDogc3RyaW5nLCBpc0xzdGF0OiBib29sZWFuKTogU3RhdHMge1xuICAgIHZhciBpbm9kZSA9IHRoaXMuX2luZGV4LmdldElub2RlKHBhdGgpO1xuICAgIGlmIChpbm9kZSA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHBhdGgpO1xuICAgIH1cbiAgICB2YXIgc3RhdHM6IFN0YXRzO1xuICAgIGlmIChpc0ZpbGVJbm9kZTxTdGF0cz4oaW5vZGUpKSB7XG4gICAgICBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcbiAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIGEgbm9uLW9wZW5lZCBmaWxlIHdpbGwgc3RpbGwgaGF2ZSBkZWZhdWx0IHN0YXRzIGZyb20gdGhlIGxpc3RpbmcuXG4gICAgICBpZiAoc3RhdHMuc2l6ZSA8IDApIHtcbiAgICAgICAgc3RhdHMuc2l6ZSA9IHRoaXMuX3JlcXVlc3RGaWxlU2l6ZVN5bmMocGF0aCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChpc0Rpcklub2RlKGlub2RlKSkge1xuICAgICAgc3RhdHMgPSBpbm9kZS5nZXRTdGF0cygpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5GaWxlRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgcGF0aCk7XG4gICAgfVxuICAgIHJldHVybiBzdGF0cztcbiAgfVxuXG4gIHB1YmxpYyBvcGVuKHBhdGg6IHN0cmluZywgZmxhZ3M6IEZpbGVGbGFnLCBtb2RlOiBudW1iZXIsIGNiOiAoZTogQXBpRXJyb3IsIGZpbGU/OiBmaWxlLkZpbGUpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAvLyBJTlZBUklBTlQ6IFlvdSBjYW4ndCB3cml0ZSB0byBmaWxlcyBvbiB0aGlzIGZpbGUgc3lzdGVtLlxuICAgIGlmIChmbGFncy5pc1dyaXRlYWJsZSgpKSB7XG4gICAgICByZXR1cm4gY2IobmV3IEFwaUVycm9yKEVycm9yQ29kZS5FUEVSTSwgcGF0aCkpO1xuICAgIH1cbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgIC8vIENoZWNrIGlmIHRoZSBwYXRoIGV4aXN0cywgYW5kIGlzIGEgZmlsZS5cbiAgICB2YXIgaW5vZGUgPSB0aGlzLl9pbmRleC5nZXRJbm9kZShwYXRoKTtcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBjYihBcGlFcnJvci5FTk9FTlQocGF0aCkpO1xuICAgIH1cbiAgICBpZiAoaXNGaWxlSW5vZGU8U3RhdHM+KGlub2RlKSkge1xuICAgICAgdmFyIHN0YXRzID0gaW5vZGUuZ2V0RGF0YSgpO1xuICAgICAgc3dpdGNoIChmbGFncy5wYXRoRXhpc3RzQWN0aW9uKCkpIHtcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLlRIUk9XX0VYQ0VQVElPTjpcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLlRSVU5DQVRFX0ZJTEU6XG4gICAgICAgICAgcmV0dXJuIGNiKEFwaUVycm9yLkVFWElTVChwYXRoKSk7XG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5OT1A6XG4gICAgICAgICAgLy8gVXNlIGV4aXN0aW5nIGZpbGUgY29udGVudHMuXG4gICAgICAgICAgLy8gWFhYOiBVaCwgdGhpcyBtYWludGFpbnMgdGhlIHByZXZpb3VzbHktdXNlZCBmbGFnLlxuICAgICAgICAgIGlmIChzdGF0cy5maWxlX2RhdGEgIT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIG5ldyBwcmVsb2FkX2ZpbGUuTm9TeW5jRmlsZShfdGhpcywgcGF0aCwgZmxhZ3MsIHN0YXRzLmNsb25lKCksIHN0YXRzLmZpbGVfZGF0YSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBAdG9kbyBiZSBsYXppZXIgYWJvdXQgYWN0dWFsbHkgcmVxdWVzdGluZyB0aGUgZmlsZVxuICAgICAgICAgIHRoaXMuX3JlcXVlc3RGaWxlQXN5bmMocGF0aCwgJ2J1ZmZlcicsIGZ1bmN0aW9uKGVycjogQXBpRXJyb3IsIGJ1ZmZlcj86IE5vZGVCdWZmZXIpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyB3ZSBkb24ndCBpbml0aWFsbHkgaGF2ZSBmaWxlIHNpemVzXG4gICAgICAgICAgICBzdGF0cy5zaXplID0gYnVmZmVyLmxlbmd0aDtcbiAgICAgICAgICAgIHN0YXRzLmZpbGVfZGF0YSA9IGJ1ZmZlcjtcbiAgICAgICAgICAgIHJldHVybiBjYihudWxsLCBuZXcgcHJlbG9hZF9maWxlLk5vU3luY0ZpbGUoX3RoaXMsIHBhdGgsIGZsYWdzLCBzdGF0cy5jbG9uZSgpLCBidWZmZXIpKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gY2IobmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsICdJbnZhbGlkIEZpbGVNb2RlIG9iamVjdC4nKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBjYihBcGlFcnJvci5FSVNESVIocGF0aCkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvcGVuU3luYyhwYXRoOiBzdHJpbmcsIGZsYWdzOiBGaWxlRmxhZywgbW9kZTogbnVtYmVyKTogZmlsZS5GaWxlIHtcbiAgICAvLyBJTlZBUklBTlQ6IFlvdSBjYW4ndCB3cml0ZSB0byBmaWxlcyBvbiB0aGlzIGZpbGUgc3lzdGVtLlxuICAgIGlmIChmbGFncy5pc1dyaXRlYWJsZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVQRVJNLCBwYXRoKTtcbiAgICB9XG4gICAgLy8gQ2hlY2sgaWYgdGhlIHBhdGggZXhpc3RzLCBhbmQgaXMgYSBmaWxlLlxuICAgIHZhciBpbm9kZSA9IHRoaXMuX2luZGV4LmdldElub2RlKHBhdGgpO1xuICAgIGlmIChpbm9kZSA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHBhdGgpO1xuICAgIH1cbiAgICBpZiAoaXNGaWxlSW5vZGU8U3RhdHM+KGlub2RlKSkge1xuICAgICAgdmFyIHN0YXRzID0gaW5vZGUuZ2V0RGF0YSgpO1xuICAgICAgc3dpdGNoIChmbGFncy5wYXRoRXhpc3RzQWN0aW9uKCkpIHtcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLlRIUk9XX0VYQ0VQVElPTjpcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLlRSVU5DQVRFX0ZJTEU6XG4gICAgICAgICAgdGhyb3cgQXBpRXJyb3IuRUVYSVNUKHBhdGgpO1xuICAgICAgICBjYXNlIEFjdGlvblR5cGUuTk9QOlxuICAgICAgICAgIC8vIFVzZSBleGlzdGluZyBmaWxlIGNvbnRlbnRzLlxuICAgICAgICAgIC8vIFhYWDogVWgsIHRoaXMgbWFpbnRhaW5zIHRoZSBwcmV2aW91c2x5LXVzZWQgZmxhZy5cbiAgICAgICAgICBpZiAoc3RhdHMuZmlsZV9kYXRhICE9IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgcHJlbG9hZF9maWxlLk5vU3luY0ZpbGUodGhpcywgcGF0aCwgZmxhZ3MsIHN0YXRzLmNsb25lKCksIHN0YXRzLmZpbGVfZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIEB0b2RvIGJlIGxhemllciBhYm91dCBhY3R1YWxseSByZXF1ZXN0aW5nIHRoZSBmaWxlXG4gICAgICAgICAgdmFyIGJ1ZmZlciA9IHRoaXMuX3JlcXVlc3RGaWxlU3luYyhwYXRoLCAnYnVmZmVyJyk7XG4gICAgICAgICAgLy8gd2UgZG9uJ3QgaW5pdGlhbGx5IGhhdmUgZmlsZSBzaXplc1xuICAgICAgICAgIHN0YXRzLnNpemUgPSBidWZmZXIubGVuZ3RoO1xuICAgICAgICAgIHN0YXRzLmZpbGVfZGF0YSA9IGJ1ZmZlcjtcbiAgICAgICAgICByZXR1cm4gbmV3IHByZWxvYWRfZmlsZS5Ob1N5bmNGaWxlKHRoaXMsIHBhdGgsIGZsYWdzLCBzdGF0cy5jbG9uZSgpLCBidWZmZXIpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCAnSW52YWxpZCBGaWxlTW9kZSBvYmplY3QuJyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVJU0RJUihwYXRoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVhZGRpcihwYXRoOiBzdHJpbmcsIGNiOiAoZTogQXBpRXJyb3IsIGxpc3Rpbmc/OiBzdHJpbmdbXSkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICBjYihudWxsLCB0aGlzLnJlYWRkaXJTeW5jKHBhdGgpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjYihlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVhZGRpclN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIC8vIENoZWNrIGlmIGl0IGV4aXN0cy5cbiAgICB2YXIgaW5vZGUgPSB0aGlzLl9pbmRleC5nZXRJbm9kZShwYXRoKTtcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwYXRoKTtcbiAgICB9IGVsc2UgaWYgKGlzRGlySW5vZGUoaW5vZGUpKSB7XG4gICAgICByZXR1cm4gaW5vZGUuZ2V0TGlzdGluZygpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FTk9URElSKHBhdGgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBXZSBoYXZlIHRoZSBlbnRpcmUgZmlsZSBhcyBhIGJ1ZmZlcjsgb3B0aW1pemUgcmVhZEZpbGUuXG4gICAqL1xuICBwdWJsaWMgcmVhZEZpbGUoZm5hbWU6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZywgZmxhZzogRmlsZUZsYWcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQge1xuICAgIC8vIFdyYXAgY2IgaW4gZmlsZSBjbG9zaW5nIGNvZGUuXG4gICAgdmFyIG9sZENiID0gY2I7XG4gICAgLy8gR2V0IGZpbGUuXG4gICAgdGhpcy5vcGVuKGZuYW1lLCBmbGFnLCAweDFhNCwgZnVuY3Rpb24oZXJyOiBBcGlFcnJvciwgZmQ/OiBmaWxlLkZpbGUpIHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIGNiKGVycik7XG4gICAgICB9XG4gICAgICBjYiA9IGZ1bmN0aW9uKGVycjogQXBpRXJyb3IsIGFyZz86IEJ1ZmZlcikge1xuICAgICAgICBmZC5jbG9zZShmdW5jdGlvbihlcnIyOiBhbnkpIHtcbiAgICAgICAgICBpZiAoZXJyID09IG51bGwpIHtcbiAgICAgICAgICAgIGVyciA9IGVycjI7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBvbGRDYihlcnIsIGFyZyk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIHZhciBmZENhc3QgPSA8cHJlbG9hZF9maWxlLk5vU3luY0ZpbGU8WG1sSHR0cFJlcXVlc3Q+PiBmZDtcbiAgICAgIHZhciBmZEJ1ZmYgPSA8QnVmZmVyPiBmZENhc3QuZ2V0QnVmZmVyKCk7XG4gICAgICBpZiAoZW5jb2RpbmcgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGNiKGVyciwgY29weWluZ1NsaWNlKGZkQnVmZikpO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgY2IobnVsbCwgZmRCdWZmLnRvU3RyaW5nKGVuY29kaW5nKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNiKGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNwZWNpYWxseS1vcHRpbWl6ZWQgcmVhZGZpbGUuXG4gICAqL1xuICBwdWJsaWMgcmVhZEZpbGVTeW5jKGZuYW1lOiBzdHJpbmcsIGVuY29kaW5nOiBzdHJpbmcsIGZsYWc6IEZpbGVGbGFnKTogYW55IHtcbiAgICAvLyBHZXQgZmlsZS5cbiAgICB2YXIgZmQgPSB0aGlzLm9wZW5TeW5jKGZuYW1lLCBmbGFnLCAweDFhNCk7XG4gICAgdHJ5IHtcbiAgICAgIHZhciBmZENhc3QgPSA8cHJlbG9hZF9maWxlLk5vU3luY0ZpbGU8WG1sSHR0cFJlcXVlc3Q+PiBmZDtcbiAgICAgIHZhciBmZEJ1ZmYgPSA8QnVmZmVyPiBmZENhc3QuZ2V0QnVmZmVyKCk7XG4gICAgICBpZiAoZW5jb2RpbmcgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGNvcHlpbmdTbGljZShmZEJ1ZmYpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZkQnVmZi50b1N0cmluZyhlbmNvZGluZyk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGZkLmNsb3NlU3luYygpO1xuICAgIH1cbiAgfVxufVxuIl19