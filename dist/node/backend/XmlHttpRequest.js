var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var api_error_1 = require('../core/api_error');
var file_flag_1 = require('../core/file_flag');
var util_1 = require('../core/util');
var preload_file = require('../generic/preload_file');
var xhr = require('../generic/xhr');
var file_index_1 = require('../generic/file_index');
function tryToString(buff, encoding, cb) {
    try {
        cb(null, buff.toString(encoding));
    }
    catch (e) {
        cb(e);
    }
}
var XmlHttpRequest = (function (_super) {
    __extends(XmlHttpRequest, _super);
    function XmlHttpRequest(listingUrl, prefixUrl) {
        if (prefixUrl === void 0) { prefixUrl = ''; }
        _super.call(this);
        if (listingUrl == null) {
            listingUrl = 'index.json';
        }
        if (prefixUrl.length > 0 && prefixUrl.charAt(prefixUrl.length - 1) !== '/') {
            prefixUrl = prefixUrl + '/';
        }
        this.prefixUrl = prefixUrl;
        var listing = this._requestFileSync(listingUrl, 'json');
        if (listing == null) {
            throw new Error("Unable to find listing at URL: " + listingUrl);
        }
        this._index = file_index_1.FileIndex.fromListing(listing);
    }
    XmlHttpRequest.prototype.empty = function () {
        this._index.fileIterator(function (file) {
            file.file_data = null;
        });
    };
    XmlHttpRequest.prototype.getXhrPath = function (filePath) {
        if (filePath.charAt(0) === '/') {
            filePath = filePath.slice(1);
        }
        return this.prefixUrl + filePath;
    };
    XmlHttpRequest.prototype._requestFileSizeAsync = function (path, cb) {
        xhr.getFileSizeAsync(this.getXhrPath(path), cb);
    };
    XmlHttpRequest.prototype._requestFileSizeSync = function (path) {
        return xhr.getFileSizeSync(this.getXhrPath(path));
    };
    XmlHttpRequest.prototype._requestFileAsync = function (p, type, cb) {
        xhr.asyncDownloadFile(this.getXhrPath(p), type, cb);
    };
    XmlHttpRequest.prototype._requestFileSync = function (p, type) {
        return xhr.syncDownloadFile(this.getXhrPath(p), type);
    };
    XmlHttpRequest.prototype.getName = function () {
        return 'XmlHttpRequest';
    };
    XmlHttpRequest.isAvailable = function () {
        return typeof XMLHttpRequest !== "undefined" && XMLHttpRequest !== null;
    };
    XmlHttpRequest.prototype.diskSpace = function (path, cb) {
        cb(0, 0);
    };
    XmlHttpRequest.prototype.isReadOnly = function () {
        return true;
    };
    XmlHttpRequest.prototype.supportsLinks = function () {
        return false;
    };
    XmlHttpRequest.prototype.supportsProps = function () {
        return false;
    };
    XmlHttpRequest.prototype.supportsSynch = function () {
        return true;
    };
    XmlHttpRequest.prototype.preloadFile = function (path, buffer) {
        var inode = this._index.getInode(path);
        if (file_index_1.isFileInode(inode)) {
            if (inode === null) {
                throw api_error_1.ApiError.ENOENT(path);
            }
            var stats = inode.getData();
            stats.size = buffer.length;
            stats.file_data = buffer;
        }
        else {
            throw api_error_1.ApiError.EISDIR(path);
        }
    };
    XmlHttpRequest.prototype.stat = function (path, isLstat, cb) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            return cb(api_error_1.ApiError.ENOENT(path));
        }
        var stats;
        if (file_index_1.isFileInode(inode)) {
            stats = inode.getData();
            if (stats.size < 0) {
                this._requestFileSizeAsync(path, function (e, size) {
                    if (e) {
                        return cb(e);
                    }
                    stats.size = size;
                    cb(null, stats.clone());
                });
            }
            else {
                cb(null, stats.clone());
            }
        }
        else if (file_index_1.isDirInode(inode)) {
            stats = inode.getStats();
            cb(null, stats);
        }
        else {
            cb(api_error_1.ApiError.FileError(api_error_1.ErrorCode.EINVAL, path));
        }
    };
    XmlHttpRequest.prototype.statSync = function (path, isLstat) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        var stats;
        if (file_index_1.isFileInode(inode)) {
            stats = inode.getData();
            if (stats.size < 0) {
                stats.size = this._requestFileSizeSync(path);
            }
        }
        else if (file_index_1.isDirInode(inode)) {
            stats = inode.getStats();
        }
        else {
            throw api_error_1.ApiError.FileError(api_error_1.ErrorCode.EINVAL, path);
        }
        return stats;
    };
    XmlHttpRequest.prototype.open = function (path, flags, mode, cb) {
        if (flags.isWriteable()) {
            return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EPERM, path));
        }
        var _this = this;
        var inode = this._index.getInode(path);
        if (inode === null) {
            return cb(api_error_1.ApiError.ENOENT(path));
        }
        if (file_index_1.isFileInode(inode)) {
            var stats = inode.getData();
            switch (flags.pathExistsAction()) {
                case file_flag_1.ActionType.THROW_EXCEPTION:
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    return cb(api_error_1.ApiError.EEXIST(path));
                case file_flag_1.ActionType.NOP:
                    if (stats.file_data != null) {
                        return cb(null, new preload_file.NoSyncFile(_this, path, flags, stats.clone(), stats.file_data));
                    }
                    this._requestFileAsync(path, 'buffer', function (err, buffer) {
                        if (err) {
                            return cb(err);
                        }
                        stats.size = buffer.length;
                        stats.file_data = buffer;
                        return cb(null, new preload_file.NoSyncFile(_this, path, flags, stats.clone(), buffer));
                    });
                    break;
                default:
                    return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, 'Invalid FileMode object.'));
            }
        }
        else {
            return cb(api_error_1.ApiError.EISDIR(path));
        }
    };
    XmlHttpRequest.prototype.openSync = function (path, flags, mode) {
        if (flags.isWriteable()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EPERM, path);
        }
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        if (file_index_1.isFileInode(inode)) {
            var stats = inode.getData();
            switch (flags.pathExistsAction()) {
                case file_flag_1.ActionType.THROW_EXCEPTION:
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    throw api_error_1.ApiError.EEXIST(path);
                case file_flag_1.ActionType.NOP:
                    if (stats.file_data != null) {
                        return new preload_file.NoSyncFile(this, path, flags, stats.clone(), stats.file_data);
                    }
                    var buffer = this._requestFileSync(path, 'buffer');
                    stats.size = buffer.length;
                    stats.file_data = buffer;
                    return new preload_file.NoSyncFile(this, path, flags, stats.clone(), buffer);
                default:
                    throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, 'Invalid FileMode object.');
            }
        }
        else {
            throw api_error_1.ApiError.EISDIR(path);
        }
    };
    XmlHttpRequest.prototype.readdir = function (path, cb) {
        try {
            cb(null, this.readdirSync(path));
        }
        catch (e) {
            cb(e);
        }
    };
    XmlHttpRequest.prototype.readdirSync = function (path) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        else if (file_index_1.isDirInode(inode)) {
            return inode.getListing();
        }
        else {
            throw api_error_1.ApiError.ENOTDIR(path);
        }
    };
    XmlHttpRequest.prototype.readFile = function (fname, encoding, flag, cb) {
        var oldCb = cb;
        this.open(fname, flag, 0x1a4, function (err, fd) {
            if (err) {
                return cb(err);
            }
            cb = function (err, arg) {
                fd.close(function (err2) {
                    if (err == null) {
                        err = err2;
                    }
                    return oldCb(err, arg);
                });
            };
            var fdCast = fd;
            var fdBuff = fdCast.getBuffer();
            if (encoding === null) {
                cb(err, util_1.copyingSlice(fdBuff));
            }
            else {
                tryToString(fdBuff, encoding, cb);
            }
        });
    };
    XmlHttpRequest.prototype.readFileSync = function (fname, encoding, flag) {
        var fd = this.openSync(fname, flag, 0x1a4);
        try {
            var fdCast = fd;
            var fdBuff = fdCast.getBuffer();
            if (encoding === null) {
                return util_1.copyingSlice(fdBuff);
            }
            return fdBuff.toString(encoding);
        }
        finally {
            fd.closeSync();
        }
    };
    return XmlHttpRequest;
})(file_system.BaseFileSystem);
exports.__esModule = true;
exports["default"] = XmlHttpRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWG1sSHR0cFJlcXVlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFja2VuZC9YbWxIdHRwUmVxdWVzdC50cyJdLCJuYW1lcyI6WyJ0cnlUb1N0cmluZyIsIlhtbEh0dHBSZXF1ZXN0IiwiWG1sSHR0cFJlcXVlc3QuY29uc3RydWN0b3IiLCJYbWxIdHRwUmVxdWVzdC5lbXB0eSIsIlhtbEh0dHBSZXF1ZXN0LmdldFhoclBhdGgiLCJYbWxIdHRwUmVxdWVzdC5fcmVxdWVzdEZpbGVTaXplQXN5bmMiLCJYbWxIdHRwUmVxdWVzdC5fcmVxdWVzdEZpbGVTaXplU3luYyIsIlhtbEh0dHBSZXF1ZXN0Ll9yZXF1ZXN0RmlsZUFzeW5jIiwiWG1sSHR0cFJlcXVlc3QuX3JlcXVlc3RGaWxlU3luYyIsIlhtbEh0dHBSZXF1ZXN0LmdldE5hbWUiLCJYbWxIdHRwUmVxdWVzdC5pc0F2YWlsYWJsZSIsIlhtbEh0dHBSZXF1ZXN0LmRpc2tTcGFjZSIsIlhtbEh0dHBSZXF1ZXN0LmlzUmVhZE9ubHkiLCJYbWxIdHRwUmVxdWVzdC5zdXBwb3J0c0xpbmtzIiwiWG1sSHR0cFJlcXVlc3Quc3VwcG9ydHNQcm9wcyIsIlhtbEh0dHBSZXF1ZXN0LnN1cHBvcnRzU3luY2giLCJYbWxIdHRwUmVxdWVzdC5wcmVsb2FkRmlsZSIsIlhtbEh0dHBSZXF1ZXN0LnN0YXQiLCJYbWxIdHRwUmVxdWVzdC5zdGF0U3luYyIsIlhtbEh0dHBSZXF1ZXN0Lm9wZW4iLCJYbWxIdHRwUmVxdWVzdC5vcGVuU3luYyIsIlhtbEh0dHBSZXF1ZXN0LnJlYWRkaXIiLCJYbWxIdHRwUmVxdWVzdC5yZWFkZGlyU3luYyIsIlhtbEh0dHBSZXF1ZXN0LnJlYWRGaWxlIiwiWG1sSHR0cFJlcXVlc3QucmVhZEZpbGVTeW5jIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLElBQU8sV0FBVyxXQUFXLHFCQUFxQixDQUFDLENBQUM7QUFDcEQsMEJBQWtDLG1CQUFtQixDQUFDLENBQUE7QUFD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LG1CQUFZQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUM5QkEsQ0FBQ0E7WUFDREEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7UUFDbkNBLENBQUNBO2dCQUFTQSxDQUFDQTtZQUNUQSxFQUFFQSxDQUFDQSxTQUFTQSxFQUFFQSxDQUFDQTtRQUNqQkEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFDSHZCLHFCQUFDQTtBQUFEQSxDQUFDQSxBQXhURCxFQUE0QyxXQUFXLENBQUMsY0FBYyxFQXdUckU7QUF4VEQ7bUNBd1RDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmlsZV9zeXN0ZW0gPSByZXF1aXJlKCcuLi9jb3JlL2ZpbGVfc3lzdGVtJyk7XG5pbXBvcnQge0FwaUVycm9yLCBFcnJvckNvZGV9IGZyb20gJy4uL2NvcmUvYXBpX2Vycm9yJztcbmltcG9ydCB7RmlsZUZsYWcsIEFjdGlvblR5cGV9IGZyb20gJy4uL2NvcmUvZmlsZV9mbGFnJztcbmltcG9ydCB7Y29weWluZ1NsaWNlfSBmcm9tICcuLi9jb3JlL3V0aWwnO1xuaW1wb3J0IGZpbGUgPSByZXF1aXJlKCcuLi9jb3JlL2ZpbGUnKTtcbmltcG9ydCBTdGF0cyBmcm9tICcuLi9jb3JlL25vZGVfZnNfc3RhdHMnO1xuaW1wb3J0IHByZWxvYWRfZmlsZSA9IHJlcXVpcmUoJy4uL2dlbmVyaWMvcHJlbG9hZF9maWxlJyk7XG5pbXBvcnQgeGhyID0gcmVxdWlyZSgnLi4vZ2VuZXJpYy94aHInKTtcbmltcG9ydCB7RmlsZUluZGV4LCBEaXJJbm9kZSwgRmlsZUlub2RlLCBJbm9kZSwgaXNGaWxlSW5vZGUsIGlzRGlySW5vZGV9IGZyb20gJy4uL2dlbmVyaWMvZmlsZV9pbmRleCc7XG5cbi8qKlxuICogVHJ5IHRvIGNvbnZlcnQgdGhlIGdpdmVuIGJ1ZmZlciBpbnRvIGEgc3RyaW5nLCBhbmQgcGFzcyBpdCB0byB0aGUgY2FsbGJhY2suXG4gKiBPcHRpbWl6YXRpb24gdGhhdCByZW1vdmVzIHRoZSBuZWVkZWQgdHJ5L2NhdGNoIGludG8gYSBoZWxwZXIgZnVuY3Rpb24sIGFzXG4gKiB0aGlzIGlzIGFuIHVuY29tbW9uIGNhc2UuXG4gKi9cbmZ1bmN0aW9uIHRyeVRvU3RyaW5nKGJ1ZmY6IEJ1ZmZlciwgZW5jb2Rpbmc6IHN0cmluZywgY2I6IChlOiBBcGlFcnJvciwgcnY/OiBzdHJpbmcpID0+IHZvaWQpIHtcbiAgdHJ5IHtcbiAgICBjYihudWxsLCBidWZmLnRvU3RyaW5nKGVuY29kaW5nKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjYihlKTtcbiAgfVxufVxuXG4vKipcbiAqIEEgc2ltcGxlIGZpbGVzeXN0ZW0gYmFja2VkIGJ5IFhtbEh0dHBSZXF1ZXN0cy5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgWG1sSHR0cFJlcXVlc3QgZXh0ZW5kcyBmaWxlX3N5c3RlbS5CYXNlRmlsZVN5c3RlbSBpbXBsZW1lbnRzIGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0ge1xuICBwcml2YXRlIF9pbmRleDogRmlsZUluZGV4PHt9PjtcbiAgcHVibGljIHByZWZpeFVybDogc3RyaW5nO1xuICAvKipcbiAgICogQ29uc3RydWN0cyB0aGUgZmlsZSBzeXN0ZW0uXG4gICAqIEBwYXJhbSBsaXN0aW5nVXJsIFRoZSBwYXRoIHRvIHRoZSBKU09OIGZpbGUgaW5kZXggZ2VuZXJhdGVkIGJ5XG4gICAqICAgdG9vbHMvWEhSSW5kZXhlci5jb2ZmZWUuIFRoaXMgY2FuIGJlIHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IHdlYnBhZ2UgVVJMXG4gICAqICAgb3IgYWJzb2x1dGVseSBzcGVjaWZpZWQuXG4gICAqIEBwYXJhbSBwcmVmaXhVcmwgVGhlIHVybCBwcmVmaXggdG8gdXNlIGZvciBhbGwgd2ViLXNlcnZlciByZXF1ZXN0cy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKGxpc3RpbmdVcmw6IHN0cmluZywgcHJlZml4VXJsOiBzdHJpbmcgPSAnJykge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKGxpc3RpbmdVcmwgPT0gbnVsbCkge1xuICAgICAgbGlzdGluZ1VybCA9ICdpbmRleC5qc29uJztcbiAgICB9XG4gICAgLy8gcHJlZml4X3VybCBtdXN0IGVuZCBpbiBhIGRpcmVjdG9yeSBzZXBhcmF0b3IuXG4gICAgaWYgKHByZWZpeFVybC5sZW5ndGggPiAwICYmIHByZWZpeFVybC5jaGFyQXQocHJlZml4VXJsLmxlbmd0aCAtIDEpICE9PSAnLycpIHtcbiAgICAgIHByZWZpeFVybCA9IHByZWZpeFVybCArICcvJztcbiAgICB9XG4gICAgdGhpcy5wcmVmaXhVcmwgPSBwcmVmaXhVcmw7XG4gICAgdmFyIGxpc3RpbmcgPSB0aGlzLl9yZXF1ZXN0RmlsZVN5bmMobGlzdGluZ1VybCwgJ2pzb24nKTtcbiAgICBpZiAobGlzdGluZyA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gZmluZCBsaXN0aW5nIGF0IFVSTDogXCIgKyBsaXN0aW5nVXJsKTtcbiAgICB9XG4gICAgdGhpcy5faW5kZXggPSBGaWxlSW5kZXguZnJvbUxpc3RpbmcobGlzdGluZyk7XG4gIH1cblxuICBwdWJsaWMgZW1wdHkoKTogdm9pZCB7XG4gICAgdGhpcy5faW5kZXguZmlsZUl0ZXJhdG9yKGZ1bmN0aW9uKGZpbGU6IFN0YXRzKSB7XG4gICAgICBmaWxlLmZpbGVfZGF0YSA9IG51bGw7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldFhoclBhdGgoZmlsZVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKGZpbGVQYXRoLmNoYXJBdCgwKSA9PT0gJy8nKSB7XG4gICAgICBmaWxlUGF0aCA9IGZpbGVQYXRoLnNsaWNlKDEpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcmVmaXhVcmwgKyBmaWxlUGF0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPbmx5IHJlcXVlc3RzIHRoZSBIRUFEIGNvbnRlbnQsIGZvciB0aGUgZmlsZSBzaXplLlxuICAgKi9cbiAgcHVibGljIF9yZXF1ZXN0RmlsZVNpemVBc3luYyhwYXRoOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgc2l6ZT86IG51bWJlcikgPT4gdm9pZCk6IHZvaWQge1xuICAgIHhoci5nZXRGaWxlU2l6ZUFzeW5jKHRoaXMuZ2V0WGhyUGF0aChwYXRoKSwgY2IpO1xuICB9XG4gIHB1YmxpYyBfcmVxdWVzdEZpbGVTaXplU3luYyhwYXRoOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIHJldHVybiB4aHIuZ2V0RmlsZVNpemVTeW5jKHRoaXMuZ2V0WGhyUGF0aChwYXRoKSk7XG4gIH1cblxuICAvKipcbiAgICogQXN5bmNocm9ub3VzbHkgZG93bmxvYWQgdGhlIGdpdmVuIGZpbGUuXG4gICAqL1xuICBwcml2YXRlIF9yZXF1ZXN0RmlsZUFzeW5jKHA6IHN0cmluZywgdHlwZTogJ2J1ZmZlcicsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IE5vZGVCdWZmZXIpID0+IHZvaWQpOiB2b2lkO1xuICBwcml2YXRlIF9yZXF1ZXN0RmlsZUFzeW5jKHA6IHN0cmluZywgdHlwZTogJ2pzb24nLCBjYjogKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpOiB2b2lkO1xuICBwcml2YXRlIF9yZXF1ZXN0RmlsZUFzeW5jKHA6IHN0cmluZywgdHlwZTogc3RyaW5nLCBjYjogKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpOiB2b2lkO1xuICBwcml2YXRlIF9yZXF1ZXN0RmlsZUFzeW5jKHA6IHN0cmluZywgdHlwZTogc3RyaW5nLCBjYjogKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB4aHIuYXN5bmNEb3dubG9hZEZpbGUodGhpcy5nZXRYaHJQYXRoKHApLCB0eXBlLCBjYik7XG4gIH1cblxuICAvKipcbiAgICogU3luY2hyb25vdXNseSBkb3dubG9hZCB0aGUgZ2l2ZW4gZmlsZS5cbiAgICovXG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlU3luYyhwOiBzdHJpbmcsIHR5cGU6ICdidWZmZXInKTogTm9kZUJ1ZmZlcjtcbiAgcHJpdmF0ZSBfcmVxdWVzdEZpbGVTeW5jKHA6IHN0cmluZywgdHlwZTogJ2pzb24nKTogYW55O1xuICBwcml2YXRlIF9yZXF1ZXN0RmlsZVN5bmMocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpOiBhbnk7XG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlU3luYyhwOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIHhoci5zeW5jRG93bmxvYWRGaWxlKHRoaXMuZ2V0WGhyUGF0aChwKSwgdHlwZSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiAnWG1sSHR0cFJlcXVlc3QnO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBpc0F2YWlsYWJsZSgpOiBib29sZWFuIHtcbiAgICAvLyBAdG9kbyBPbGRlciBicm93c2VycyB1c2UgYSBkaWZmZXJlbnQgbmFtZSBmb3IgWEhSLCBpaXJjLlxuICAgIHJldHVybiB0eXBlb2YgWE1MSHR0cFJlcXVlc3QgIT09IFwidW5kZWZpbmVkXCIgJiYgWE1MSHR0cFJlcXVlc3QgIT09IG51bGw7XG4gIH1cblxuICBwdWJsaWMgZGlza1NwYWNlKHBhdGg6IHN0cmluZywgY2I6ICh0b3RhbDogbnVtYmVyLCBmcmVlOiBudW1iZXIpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAvLyBSZWFkLW9ubHkgZmlsZSBzeXN0ZW0uIFdlIGNvdWxkIGNhbGN1bGF0ZSB0aGUgdG90YWwgc3BhY2UsIGJ1dCB0aGF0J3Mgbm90XG4gICAgLy8gaW1wb3J0YW50IHJpZ2h0IG5vdy5cbiAgICBjYigwLCAwKTtcbiAgfVxuXG4gIHB1YmxpYyBpc1JlYWRPbmx5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzTGlua3MoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzUHJvcHMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogU3BlY2lhbCBYSFIgZnVuY3Rpb246IFByZWxvYWQgdGhlIGdpdmVuIGZpbGUgaW50byB0aGUgaW5kZXguXG4gICAqIEBwYXJhbSBbU3RyaW5nXSBwYXRoXG4gICAqIEBwYXJhbSBbQnJvd3NlckZTLkJ1ZmZlcl0gYnVmZmVyXG4gICAqL1xuICBwdWJsaWMgcHJlbG9hZEZpbGUocGF0aDogc3RyaW5nLCBidWZmZXI6IE5vZGVCdWZmZXIpOiB2b2lkIHtcbiAgICB2YXIgaW5vZGUgPSB0aGlzLl9pbmRleC5nZXRJbm9kZShwYXRoKTtcbiAgICBpZiAoaXNGaWxlSW5vZGU8U3RhdHM+KGlub2RlKSkge1xuICAgICAgaWYgKGlub2RlID09PSBudWxsKSB7XG4gICAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwYXRoKTtcbiAgICAgIH1cbiAgICAgIHZhciBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcbiAgICAgIHN0YXRzLnNpemUgPSBidWZmZXIubGVuZ3RoO1xuICAgICAgc3RhdHMuZmlsZV9kYXRhID0gYnVmZmVyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FSVNESVIocGF0aCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHN0YXQocGF0aDogc3RyaW5nLCBpc0xzdGF0OiBib29sZWFuLCBjYjogKGU6IEFwaUVycm9yLCBzdGF0PzogU3RhdHMpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB2YXIgaW5vZGUgPSB0aGlzLl9pbmRleC5nZXRJbm9kZShwYXRoKTtcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBjYihBcGlFcnJvci5FTk9FTlQocGF0aCkpO1xuICAgIH1cbiAgICB2YXIgc3RhdHM6IFN0YXRzO1xuICAgIGlmIChpc0ZpbGVJbm9kZTxTdGF0cz4oaW5vZGUpKSB7XG4gICAgICBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcbiAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIGEgbm9uLW9wZW5lZCBmaWxlIHdpbGwgc3RpbGwgaGF2ZSBkZWZhdWx0IHN0YXRzIGZyb20gdGhlIGxpc3RpbmcuXG4gICAgICBpZiAoc3RhdHMuc2l6ZSA8IDApIHtcbiAgICAgICAgdGhpcy5fcmVxdWVzdEZpbGVTaXplQXN5bmMocGF0aCwgZnVuY3Rpb24oZTogQXBpRXJyb3IsIHNpemU/OiBudW1iZXIpIHtcbiAgICAgICAgICBpZiAoZSkge1xuICAgICAgICAgICAgcmV0dXJuIGNiKGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBzdGF0cy5zaXplID0gc2l6ZTtcbiAgICAgICAgICBjYihudWxsLCBzdGF0cy5jbG9uZSgpKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYihudWxsLCBzdGF0cy5jbG9uZSgpKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlzRGlySW5vZGUoaW5vZGUpKSB7XG4gICAgICBzdGF0cyA9IGlub2RlLmdldFN0YXRzKCk7XG4gICAgICBjYihudWxsLCBzdGF0cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNiKEFwaUVycm9yLkZpbGVFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBwYXRoKSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHN0YXRTeW5jKHBhdGg6IHN0cmluZywgaXNMc3RhdDogYm9vbGVhbik6IFN0YXRzIHtcbiAgICB2YXIgaW5vZGUgPSB0aGlzLl9pbmRleC5nZXRJbm9kZShwYXRoKTtcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwYXRoKTtcbiAgICB9XG4gICAgdmFyIHN0YXRzOiBTdGF0cztcbiAgICBpZiAoaXNGaWxlSW5vZGU8U3RhdHM+KGlub2RlKSkge1xuICAgICAgc3RhdHMgPSBpbm9kZS5nZXREYXRhKCk7XG4gICAgICAvLyBBdCB0aGlzIHBvaW50LCBhIG5vbi1vcGVuZWQgZmlsZSB3aWxsIHN0aWxsIGhhdmUgZGVmYXVsdCBzdGF0cyBmcm9tIHRoZSBsaXN0aW5nLlxuICAgICAgaWYgKHN0YXRzLnNpemUgPCAwKSB7XG4gICAgICAgIHN0YXRzLnNpemUgPSB0aGlzLl9yZXF1ZXN0RmlsZVNpemVTeW5jKHBhdGgpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaXNEaXJJbm9kZShpbm9kZSkpIHtcbiAgICAgIHN0YXRzID0gaW5vZGUuZ2V0U3RhdHMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgQXBpRXJyb3IuRmlsZUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIHBhdGgpO1xuICAgIH1cbiAgICByZXR1cm4gc3RhdHM7XG4gIH1cblxuICBwdWJsaWMgb3BlbihwYXRoOiBzdHJpbmcsIGZsYWdzOiBGaWxlRmxhZywgbW9kZTogbnVtYmVyLCBjYjogKGU6IEFwaUVycm9yLCBmaWxlPzogZmlsZS5GaWxlKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgLy8gSU5WQVJJQU5UOiBZb3UgY2FuJ3Qgd3JpdGUgdG8gZmlsZXMgb24gdGhpcyBmaWxlIHN5c3RlbS5cbiAgICBpZiAoZmxhZ3MuaXNXcml0ZWFibGUoKSkge1xuICAgICAgcmV0dXJuIGNiKG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRVBFUk0sIHBhdGgpKTtcbiAgICB9XG4gICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAvLyBDaGVjayBpZiB0aGUgcGF0aCBleGlzdHMsIGFuZCBpcyBhIGZpbGUuXG4gICAgdmFyIGlub2RlID0gdGhpcy5faW5kZXguZ2V0SW5vZGUocGF0aCk7XG4gICAgaWYgKGlub2RlID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gY2IoQXBpRXJyb3IuRU5PRU5UKHBhdGgpKTtcbiAgICB9XG4gICAgaWYgKGlzRmlsZUlub2RlPFN0YXRzPihpbm9kZSkpIHtcbiAgICAgIHZhciBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcbiAgICAgIHN3aXRjaCAoZmxhZ3MucGF0aEV4aXN0c0FjdGlvbigpKSB7XG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5USFJPV19FWENFUFRJT046XG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5UUlVOQ0FURV9GSUxFOlxuICAgICAgICAgIHJldHVybiBjYihBcGlFcnJvci5FRVhJU1QocGF0aCkpO1xuICAgICAgICBjYXNlIEFjdGlvblR5cGUuTk9QOlxuICAgICAgICAgIC8vIFVzZSBleGlzdGluZyBmaWxlIGNvbnRlbnRzLlxuICAgICAgICAgIC8vIFhYWDogVWgsIHRoaXMgbWFpbnRhaW5zIHRoZSBwcmV2aW91c2x5LXVzZWQgZmxhZy5cbiAgICAgICAgICBpZiAoc3RhdHMuZmlsZV9kYXRhICE9IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBjYihudWxsLCBuZXcgcHJlbG9hZF9maWxlLk5vU3luY0ZpbGUoX3RoaXMsIHBhdGgsIGZsYWdzLCBzdGF0cy5jbG9uZSgpLCBzdGF0cy5maWxlX2RhdGEpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gQHRvZG8gYmUgbGF6aWVyIGFib3V0IGFjdHVhbGx5IHJlcXVlc3RpbmcgdGhlIGZpbGVcbiAgICAgICAgICB0aGlzLl9yZXF1ZXN0RmlsZUFzeW5jKHBhdGgsICdidWZmZXInLCBmdW5jdGlvbihlcnI6IEFwaUVycm9yLCBidWZmZXI/OiBOb2RlQnVmZmVyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gd2UgZG9uJ3QgaW5pdGlhbGx5IGhhdmUgZmlsZSBzaXplc1xuICAgICAgICAgICAgc3RhdHMuc2l6ZSA9IGJ1ZmZlci5sZW5ndGg7XG4gICAgICAgICAgICBzdGF0cy5maWxlX2RhdGEgPSBidWZmZXI7XG4gICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgbmV3IHByZWxvYWRfZmlsZS5Ob1N5bmNGaWxlKF90aGlzLCBwYXRoLCBmbGFncywgc3RhdHMuY2xvbmUoKSwgYnVmZmVyKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmV0dXJuIGNiKG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCAnSW52YWxpZCBGaWxlTW9kZSBvYmplY3QuJykpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY2IoQXBpRXJyb3IuRUlTRElSKHBhdGgpKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb3BlblN5bmMocGF0aDogc3RyaW5nLCBmbGFnczogRmlsZUZsYWcsIG1vZGU6IG51bWJlcik6IGZpbGUuRmlsZSB7XG4gICAgLy8gSU5WQVJJQU5UOiBZb3UgY2FuJ3Qgd3JpdGUgdG8gZmlsZXMgb24gdGhpcyBmaWxlIHN5c3RlbS5cbiAgICBpZiAoZmxhZ3MuaXNXcml0ZWFibGUoKSkge1xuICAgICAgdGhyb3cgbmV3IEFwaUVycm9yKEVycm9yQ29kZS5FUEVSTSwgcGF0aCk7XG4gICAgfVxuICAgIC8vIENoZWNrIGlmIHRoZSBwYXRoIGV4aXN0cywgYW5kIGlzIGEgZmlsZS5cbiAgICB2YXIgaW5vZGUgPSB0aGlzLl9pbmRleC5nZXRJbm9kZShwYXRoKTtcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwYXRoKTtcbiAgICB9XG4gICAgaWYgKGlzRmlsZUlub2RlPFN0YXRzPihpbm9kZSkpIHtcbiAgICAgIHZhciBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcbiAgICAgIHN3aXRjaCAoZmxhZ3MucGF0aEV4aXN0c0FjdGlvbigpKSB7XG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5USFJPV19FWENFUFRJT046XG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5UUlVOQ0FURV9GSUxFOlxuICAgICAgICAgIHRocm93IEFwaUVycm9yLkVFWElTVChwYXRoKTtcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLk5PUDpcbiAgICAgICAgICAvLyBVc2UgZXhpc3RpbmcgZmlsZSBjb250ZW50cy5cbiAgICAgICAgICAvLyBYWFg6IFVoLCB0aGlzIG1haW50YWlucyB0aGUgcHJldmlvdXNseS11c2VkIGZsYWcuXG4gICAgICAgICAgaWYgKHN0YXRzLmZpbGVfZGF0YSAhPSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IHByZWxvYWRfZmlsZS5Ob1N5bmNGaWxlKHRoaXMsIHBhdGgsIGZsYWdzLCBzdGF0cy5jbG9uZSgpLCBzdGF0cy5maWxlX2RhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBAdG9kbyBiZSBsYXppZXIgYWJvdXQgYWN0dWFsbHkgcmVxdWVzdGluZyB0aGUgZmlsZVxuICAgICAgICAgIHZhciBidWZmZXIgPSB0aGlzLl9yZXF1ZXN0RmlsZVN5bmMocGF0aCwgJ2J1ZmZlcicpO1xuICAgICAgICAgIC8vIHdlIGRvbid0IGluaXRpYWxseSBoYXZlIGZpbGUgc2l6ZXNcbiAgICAgICAgICBzdGF0cy5zaXplID0gYnVmZmVyLmxlbmd0aDtcbiAgICAgICAgICBzdGF0cy5maWxlX2RhdGEgPSBidWZmZXI7XG4gICAgICAgICAgcmV0dXJuIG5ldyBwcmVsb2FkX2ZpbGUuTm9TeW5jRmlsZSh0aGlzLCBwYXRoLCBmbGFncywgc3RhdHMuY2xvbmUoKSwgYnVmZmVyKTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgJ0ludmFsaWQgRmlsZU1vZGUgb2JqZWN0LicpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FSVNESVIocGF0aCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlYWRkaXIocGF0aDogc3RyaW5nLCBjYjogKGU6IEFwaUVycm9yLCBsaXN0aW5nPzogc3RyaW5nW10pID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY2IobnVsbCwgdGhpcy5yZWFkZGlyU3luYyhwYXRoKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY2IoZSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlYWRkaXJTeW5jKHBhdGg6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICAvLyBDaGVjayBpZiBpdCBleGlzdHMuXG4gICAgdmFyIGlub2RlID0gdGhpcy5faW5kZXguZ2V0SW5vZGUocGF0aCk7XG4gICAgaWYgKGlub2RlID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FTk9FTlQocGF0aCk7XG4gICAgfSBlbHNlIGlmIChpc0Rpcklub2RlKGlub2RlKSkge1xuICAgICAgcmV0dXJuIGlub2RlLmdldExpc3RpbmcoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVERJUihwYXRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogV2UgaGF2ZSB0aGUgZW50aXJlIGZpbGUgYXMgYSBidWZmZXI7IG9wdGltaXplIHJlYWRGaWxlLlxuICAgKi9cbiAgcHVibGljIHJlYWRGaWxlKGZuYW1lOiBzdHJpbmcsIGVuY29kaW5nOiBzdHJpbmcsIGZsYWc6IEZpbGVGbGFnLCBjYjogKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAvLyBXcmFwIGNiIGluIGZpbGUgY2xvc2luZyBjb2RlLlxuICAgIHZhciBvbGRDYiA9IGNiO1xuICAgIC8vIEdldCBmaWxlLlxuICAgIHRoaXMub3BlbihmbmFtZSwgZmxhZywgMHgxYTQsIGZ1bmN0aW9uKGVycjogQXBpRXJyb3IsIGZkPzogZmlsZS5GaWxlKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgfVxuICAgICAgY2IgPSBmdW5jdGlvbihlcnI6IEFwaUVycm9yLCBhcmc/OiBCdWZmZXIpIHtcbiAgICAgICAgZmQuY2xvc2UoZnVuY3Rpb24oZXJyMjogYW55KSB7XG4gICAgICAgICAgaWYgKGVyciA9PSBudWxsKSB7XG4gICAgICAgICAgICBlcnIgPSBlcnIyO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gb2xkQ2IoZXJyLCBhcmcpO1xuICAgICAgICB9KTtcbiAgICAgIH07XG4gICAgICB2YXIgZmRDYXN0ID0gPHByZWxvYWRfZmlsZS5Ob1N5bmNGaWxlPFhtbEh0dHBSZXF1ZXN0Pj4gZmQ7XG4gICAgICB2YXIgZmRCdWZmID0gPEJ1ZmZlcj4gZmRDYXN0LmdldEJ1ZmZlcigpO1xuICAgICAgaWYgKGVuY29kaW5nID09PSBudWxsKSB7XG4gICAgICAgIGNiKGVyciwgY29weWluZ1NsaWNlKGZkQnVmZikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJ5VG9TdHJpbmcoZmRCdWZmLCBlbmNvZGluZywgY2IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNwZWNpYWxseS1vcHRpbWl6ZWQgcmVhZGZpbGUuXG4gICAqL1xuICBwdWJsaWMgcmVhZEZpbGVTeW5jKGZuYW1lOiBzdHJpbmcsIGVuY29kaW5nOiBzdHJpbmcsIGZsYWc6IEZpbGVGbGFnKTogYW55IHtcbiAgICAvLyBHZXQgZmlsZS5cbiAgICB2YXIgZmQgPSB0aGlzLm9wZW5TeW5jKGZuYW1lLCBmbGFnLCAweDFhNCk7XG4gICAgdHJ5IHtcbiAgICAgIHZhciBmZENhc3QgPSA8cHJlbG9hZF9maWxlLk5vU3luY0ZpbGU8WG1sSHR0cFJlcXVlc3Q+PiBmZDtcbiAgICAgIHZhciBmZEJ1ZmYgPSA8QnVmZmVyPiBmZENhc3QuZ2V0QnVmZmVyKCk7XG4gICAgICBpZiAoZW5jb2RpbmcgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGNvcHlpbmdTbGljZShmZEJ1ZmYpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZkQnVmZi50b1N0cmluZyhlbmNvZGluZyk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGZkLmNsb3NlU3luYygpO1xuICAgIH1cbiAgfVxufVxuIl19