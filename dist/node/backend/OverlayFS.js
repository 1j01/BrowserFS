var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var api_error_1 = require('../core/api_error');
var file_flag_1 = require('../core/file_flag');
var preload_file = require('../generic/preload_file');
var path = require('path');
var deletionLogPath = '/.deletedFiles.log';
function makeModeWritable(mode) {
    return 0x92 | mode;
}
var OverlayFile = (function (_super) {
    __extends(OverlayFile, _super);
    function OverlayFile(fs, path, flag, stats, data) {
        _super.call(this, fs, path, flag, stats, data);
    }
    OverlayFile.prototype.syncSync = function () {
        if (this.isDirty()) {
            this._fs._syncSync(this);
            this.resetDirty();
        }
    };
    OverlayFile.prototype.closeSync = function () {
        this.syncSync();
    };
    return OverlayFile;
})(preload_file.PreloadFile);
var OverlayFS = (function (_super) {
    __extends(OverlayFS, _super);
    function OverlayFS(writable, readable) {
        _super.call(this);
        this._isInitialized = false;
        this._deletedFiles = {};
        this._deleteLog = null;
        this._writable = writable;
        this._readable = readable;
        if (this._writable.isReadOnly()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Writable file system must be writable.");
        }
        if (!this._writable.supportsSynch() || !this._readable.supportsSynch()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "OverlayFS currently only operates on synchronous file systems.");
        }
    }
    OverlayFS.prototype.getOverlayedFileSystems = function () {
        return {
            readable: this._readable,
            writable: this._writable
        };
    };
    OverlayFS.prototype.createParentDirectories = function (p) {
        var _this = this;
        var parent = path.dirname(p), toCreate = [];
        while (!this._writable.existsSync(parent)) {
            toCreate.push(parent);
            parent = path.dirname(parent);
        }
        toCreate = toCreate.reverse();
        toCreate.forEach(function (p) {
            _this._writable.mkdirSync(p, _this.statSync(p, false).mode);
        });
    };
    OverlayFS.isAvailable = function () {
        return true;
    };
    OverlayFS.prototype._syncSync = function (file) {
        this.createParentDirectories(file.getPath());
        this._writable.writeFileSync(file.getPath(), file.getBuffer(), null, file_flag_1.FileFlag.getFileFlag('w'), file.getStats().mode);
    };
    OverlayFS.prototype.getName = function () {
        return "OverlayFS";
    };
    OverlayFS.prototype.initialize = function (cb) {
        var _this = this;
        if (!this._isInitialized) {
            this._writable.readFile(deletionLogPath, 'utf8', file_flag_1.FileFlag.getFileFlag('r'), function (err, data) {
                if (err) {
                    if (err.type !== api_error_1.ErrorCode.ENOENT) {
                        return cb(err);
                    }
                }
                else {
                    data.split('\n').forEach(function (path) {
                        _this._deletedFiles[path.slice(1)] = path.slice(0, 1) === 'd';
                    });
                }
                _this._writable.open(deletionLogPath, file_flag_1.FileFlag.getFileFlag('a'), 0x1a4, function (err, fd) {
                    if (err) {
                        cb(err);
                    }
                    else {
                        _this._deleteLog = fd;
                        cb();
                    }
                });
            });
        }
        else {
            cb();
        }
    };
    OverlayFS.prototype.isReadOnly = function () { return false; };
    OverlayFS.prototype.supportsSynch = function () { return true; };
    OverlayFS.prototype.supportsLinks = function () { return false; };
    OverlayFS.prototype.supportsProps = function () { return this._readable.supportsProps() && this._writable.supportsProps(); };
    OverlayFS.prototype.deletePath = function (p) {
        this._deletedFiles[p] = true;
        var buff = new Buffer("d" + p + "\n");
        this._deleteLog.writeSync(buff, 0, buff.length, null);
        this._deleteLog.syncSync();
    };
    OverlayFS.prototype.undeletePath = function (p) {
        if (this._deletedFiles[p]) {
            this._deletedFiles[p] = false;
            var buff = new Buffer("u" + p);
            this._deleteLog.writeSync(buff, 0, buff.length, null);
            this._deleteLog.syncSync();
        }
    };
    OverlayFS.prototype.renameSync = function (oldPath, newPath) {
        var _this = this;
        var oldStats = this.statSync(oldPath, false);
        if (oldStats.isDirectory()) {
            if (oldPath === newPath) {
                return;
            }
            var mode = 0x1ff;
            if (this.existsSync(newPath)) {
                var stats = this.statSync(newPath, false), mode = stats.mode;
                if (stats.isDirectory()) {
                    if (this.readdirSync(newPath).length > 0) {
                        throw api_error_1.ApiError.ENOTEMPTY(newPath);
                    }
                }
                else {
                    throw api_error_1.ApiError.ENOTDIR(newPath);
                }
            }
            if (this._writable.existsSync(oldPath)) {
                this._writable.renameSync(oldPath, newPath);
            }
            else if (!this._writable.existsSync(newPath)) {
                this._writable.mkdirSync(newPath, mode);
            }
            if (this._readable.existsSync(oldPath)) {
                this._readable.readdirSync(oldPath).forEach(function (name) {
                    _this.renameSync(path.resolve(oldPath, name), path.resolve(newPath, name));
                });
            }
        }
        else {
            if (this.existsSync(newPath) && this.statSync(newPath, false).isDirectory()) {
                throw api_error_1.ApiError.EISDIR(newPath);
            }
            this.writeFileSync(newPath, this.readFileSync(oldPath, null, file_flag_1.FileFlag.getFileFlag('r')), null, file_flag_1.FileFlag.getFileFlag('w'), oldStats.mode);
        }
        if (oldPath !== newPath && this.existsSync(oldPath)) {
            this.unlinkSync(oldPath);
        }
    };
    OverlayFS.prototype.statSync = function (p, isLstat) {
        try {
            return this._writable.statSync(p, isLstat);
        }
        catch (e) {
            if (this._deletedFiles[p]) {
                throw api_error_1.ApiError.ENOENT(p);
            }
            var oldStat = this._readable.statSync(p, isLstat).clone();
            oldStat.mode = makeModeWritable(oldStat.mode);
            return oldStat;
        }
    };
    OverlayFS.prototype.openSync = function (p, flag, mode) {
        if (this.existsSync(p)) {
            switch (flag.pathExistsAction()) {
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    this.createParentDirectories(p);
                    return this._writable.openSync(p, flag, mode);
                case file_flag_1.ActionType.NOP:
                    if (this._writable.existsSync(p)) {
                        return this._writable.openSync(p, flag, mode);
                    }
                    else {
                        var stats = this._readable.statSync(p, false).clone();
                        stats.mode = mode;
                        return new OverlayFile(this, p, flag, stats, this._readable.readFileSync(p, null, file_flag_1.FileFlag.getFileFlag('r')));
                    }
                default:
                    throw api_error_1.ApiError.EEXIST(p);
            }
        }
        else {
            switch (flag.pathNotExistsAction()) {
                case file_flag_1.ActionType.CREATE_FILE:
                    this.createParentDirectories(p);
                    return this._writable.openSync(p, flag, mode);
                default:
                    throw api_error_1.ApiError.ENOENT(p);
            }
        }
    };
    OverlayFS.prototype.unlinkSync = function (p) {
        if (this.existsSync(p)) {
            if (this._writable.existsSync(p)) {
                this._writable.unlinkSync(p);
            }
            if (this.existsSync(p)) {
                this.deletePath(p);
            }
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.rmdirSync = function (p) {
        if (this.existsSync(p)) {
            if (this._writable.existsSync(p)) {
                this._writable.rmdirSync(p);
            }
            if (this.existsSync(p)) {
                if (this.readdirSync(p).length > 0) {
                    throw api_error_1.ApiError.ENOTEMPTY(p);
                }
                else {
                    this.deletePath(p);
                }
            }
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.mkdirSync = function (p, mode) {
        if (this.existsSync(p)) {
            throw api_error_1.ApiError.EEXIST(p);
        }
        else {
            this.createParentDirectories(p);
            this._writable.mkdirSync(p, mode);
        }
    };
    OverlayFS.prototype.readdirSync = function (p) {
        var _this = this;
        var dirStats = this.statSync(p, false);
        if (!dirStats.isDirectory()) {
            throw api_error_1.ApiError.ENOTDIR(p);
        }
        var contents = [];
        try {
            contents = contents.concat(this._writable.readdirSync(p));
        }
        catch (e) {
        }
        try {
            contents = contents.concat(this._readable.readdirSync(p));
        }
        catch (e) {
        }
        var seenMap = {};
        return contents.filter(function (fileP) {
            var result = seenMap[fileP] === undefined && _this._deletedFiles[p + "/" + fileP] !== true;
            seenMap[fileP] = true;
            return result;
        });
    };
    OverlayFS.prototype.existsSync = function (p) {
        return this._writable.existsSync(p) || (this._readable.existsSync(p) && this._deletedFiles[p] !== true);
    };
    OverlayFS.prototype.chmodSync = function (p, isLchmod, mode) {
        var _this = this;
        this.operateOnWritable(p, function () {
            _this._writable.chmodSync(p, isLchmod, mode);
        });
    };
    OverlayFS.prototype.chownSync = function (p, isLchown, uid, gid) {
        var _this = this;
        this.operateOnWritable(p, function () {
            _this._writable.chownSync(p, isLchown, uid, gid);
        });
    };
    OverlayFS.prototype.utimesSync = function (p, atime, mtime) {
        var _this = this;
        this.operateOnWritable(p, function () {
            _this._writable.utimesSync(p, atime, mtime);
        });
    };
    OverlayFS.prototype.operateOnWritable = function (p, f) {
        if (this.existsSync(p)) {
            if (!this._writable.existsSync(p)) {
                this.copyToWritable(p);
            }
            f();
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.copyToWritable = function (p) {
        var pStats = this.statSync(p, false);
        if (pStats.isDirectory()) {
            this._writable.mkdirSync(p, pStats.mode);
        }
        else {
            this.writeFileSync(p, this._readable.readFileSync(p, null, file_flag_1.FileFlag.getFileFlag('r')), null, file_flag_1.FileFlag.getFileFlag('w'), this.statSync(p, false).mode);
        }
    };
    return OverlayFS;
})(file_system.SynchronousFileSystem);
exports.__esModule = true;
exports["default"] = OverlayFS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3ZlcmxheUZTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2JhY2tlbmQvT3ZlcmxheUZTLnRzIl0sIm5hbWVzIjpbIm1ha2VNb2RlV3JpdGFibGUiLCJPdmVybGF5RmlsZSIsIk92ZXJsYXlGaWxlLmNvbnN0cnVjdG9yIiwiT3ZlcmxheUZpbGUuc3luY1N5bmMiLCJPdmVybGF5RmlsZS5jbG9zZVN5bmMiLCJPdmVybGF5RlMiLCJPdmVybGF5RlMuY29uc3RydWN0b3IiLCJPdmVybGF5RlMuZ2V0T3ZlcmxheWVkRmlsZVN5c3RlbXMiLCJPdmVybGF5RlMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMiLCJPdmVybGF5RlMuaXNBdmFpbGFibGUiLCJPdmVybGF5RlMuX3N5bmNTeW5jIiwiT3ZlcmxheUZTLmdldE5hbWUiLCJPdmVybGF5RlMuaW5pdGlhbGl6ZSIsIk92ZXJsYXlGUy5pc1JlYWRPbmx5IiwiT3ZlcmxheUZTLnN1cHBvcnRzU3luY2giLCJPdmVybGF5RlMuc3VwcG9ydHNMaW5rcyIsIk92ZXJsYXlGUy5zdXBwb3J0c1Byb3BzIiwiT3ZlcmxheUZTLmRlbGV0ZVBhdGgiLCJPdmVybGF5RlMudW5kZWxldGVQYXRoIiwiT3ZlcmxheUZTLnJlbmFtZVN5bmMiLCJPdmVybGF5RlMuc3RhdFN5bmMiLCJPdmVybGF5RlMub3BlblN5bmMiLCJPdmVybGF5RlMudW5saW5rU3luYyIsIk92ZXJsYXlGUy5ybWRpclN5bmMiLCJPdmVybGF5RlMubWtkaXJTeW5jIiwiT3ZlcmxheUZTLnJlYWRkaXJTeW5jIiwiT3ZlcmxheUZTLmV4aXN0c1N5bmMiLCJPdmVybGF5RlMuY2htb2RTeW5jIiwiT3ZlcmxheUZTLmNob3duU3luYyIsIk92ZXJsYXlGUy51dGltZXNTeW5jIiwiT3ZlcmxheUZTLm9wZXJhdGVPbldyaXRhYmxlIiwiT3ZlcmxheUZTLmNvcHlUb1dyaXRhYmxlIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLElBQU8sV0FBVyxXQUFX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Q0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBQ0EsSUFBSUE7b0JBRS9DQSxLQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDNUVBLENBQUNBLENBQUNBLENBQUNBO1lBQ0xBLENBQUNBO1FBQ0hBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ05BLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO2dCQUM1RUEsTUFBTUEsb0JBQVFBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQ2pDQSxDQUFDQTtZQUVEQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxPQUFPQSxFQUN4QkEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsRUFBRUEsb0JBQVFBLENBQUNBLFdBQVdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLEVBQ2pFQSxvQkFBUUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDOUNBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLEtBQUtBLE9BQU9BLElBQUlBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BEQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtRQUMzQkEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFDTWQsNEJBQVFBLEdBQWZBLFVBQWdCQSxDQUFTQSxFQUFFQSxPQUFnQkE7UUFDekNlLElBQUlBLENBQUNBO1lBQ0hBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO1FBQzdDQSxDQUFFQTtRQUFBQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNYQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDMUJBLE1BQU1BLG9CQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMzQkEsQ0FBQ0E7WUFDREEsSUFBSUEsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7WUFHMURBLE9BQU9BLENBQUNBLElBQUlBLEdBQUdBLGdCQUFnQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDOUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBO1FBQ2pCQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUNNZiw0QkFBUUEsR0FBZkEsVUFBZ0JBLENBQVNBLEVBQUVBLElBQWNBLEVBQUVBLElBQVlBO1FBQ3JEZ0IsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdkJBLE1BQU1BLENBQUNBLENBQUNBLElBQUlBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hDQSxLQUFLQSxzQkFBVUEsQ0FBQ0EsYUFBYUE7b0JBQzNCQSxJQUFJQSxDQUFDQSx1QkFBdUJBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUNoQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hEQSxLQUFLQSxzQkFBVUEsQ0FBQ0EsR0FBR0E7b0JBQ2pCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTt3QkFDakNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO29CQUNoREEsQ0FBQ0E7b0JBQUNBLElBQUlBLENBQUNBLENBQUNBO3dCQUVOQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTt3QkFDdERBLEtBQUtBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBO3dCQUNsQkEsTUFBTUEsQ0FBQ0EsSUFBSUEsV0FBV0EsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsb0JBQVFBLENBQUNBLFdBQVdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUNoSEEsQ0FBQ0E7Z0JBQ0hBO29CQUNFQSxNQUFNQSxvQkFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDN0JBLENBQUNBO1FBQ0hBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ05BLE1BQU1BLENBQUFBLENBQUNBLElBQUlBLENBQUNBLG1CQUFtQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2xDQSxLQUFLQSxzQkFBVUEsQ0FBQ0EsV0FBV0E7b0JBQ3pCQSxJQUFJQSxDQUFDQSx1QkFBdUJBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUNoQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hEQTtvQkFDRUEsTUFBTUEsb0JBQVFBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQzdCQSxDQUFDQTtRQUNIQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUNNaEIsOEJBQVVBLEdBQWpCQSxVQUFrQkEsQ0FBU0E7UUFDekJpQixFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN2QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMvQkEsQ0FBQ0E7WUFHREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBRXZCQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNyQkEsQ0FBQ0E7UUFDSEEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDTkEsTUFBTUEsb0JBQVFBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQzNCQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUNNakIsNkJBQVNBLEdBQWhCQSxVQUFpQkEsQ0FBU0E7UUFDeEJrQixFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN2QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM5QkEsQ0FBQ0E7WUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBRXZCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDbkNBLE1BQU1BLG9CQUFRQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDOUJBLENBQUNBO2dCQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtvQkFDTkEsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3JCQSxDQUFDQTtZQUNIQSxDQUFDQTtRQUNIQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNOQSxNQUFNQSxvQkFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0JBLENBQUNBO0lBQ0hBLENBQUNBO0lBQ01sQiw2QkFBU0EsR0FBaEJBLFVBQWlCQSxDQUFTQSxFQUFFQSxJQUFZQTtRQUN0Q21CLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZCQSxNQUFNQSxvQkFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0JBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBR05BLElBQUlBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ3BDQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUNNbkIsK0JBQVdBLEdBQWxCQSxVQUFtQkEsQ0FBU0E7UUFBNUJvQixpQkFzQkNBO1FBckJDQSxJQUFJQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUN2Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDNUJBLE1BQU1BLG9CQUFRQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1QkEsQ0FBQ0E7UUFHREEsSUFBSUEsUUFBUUEsR0FBYUEsRUFBRUEsQ0FBQ0E7UUFDNUJBLElBQUlBLENBQUNBO1lBQ0hBLFFBQVFBLEdBQUdBLFFBQVFBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQzVEQSxDQUFFQTtRQUFBQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNiQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQTtZQUNIQSxRQUFRQSxHQUFHQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1REEsQ0FBRUE7UUFBQUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDYkEsQ0FBQ0E7UUFDREEsSUFBSUEsT0FBT0EsR0FBOEJBLEVBQUVBLENBQUNBO1FBQzVDQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFDQSxLQUFhQTtZQUNuQ0EsSUFBSUEsTUFBTUEsR0FBR0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsU0FBU0EsSUFBSUEsS0FBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsS0FBS0EsSUFBSUEsQ0FBQ0E7WUFDMUZBLE9BQU9BLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO1lBQ3RCQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUNoQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFDTXBCLDhCQUFVQSxHQUFqQkEsVUFBa0JBLENBQVNBO1FBQ3pCcUIsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDMUdBLENBQUNBO0lBQ01yQiw2QkFBU0EsR0FBaEJBLFVBQWlCQSxDQUFTQSxFQUFFQSxRQUFpQkEsRUFBRUEsSUFBWUE7UUFBM0RzQixpQkFJQ0E7UUFIQ0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxDQUFDQSxFQUFFQTtZQUN4QkEsS0FBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsUUFBUUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDOUNBLENBQUNBLENBQUNBLENBQUNBO0lBQ0xBLENBQUNBO0lBQ010Qiw2QkFBU0EsR0FBaEJBLFVBQWlCQSxDQUFTQSxFQUFFQSxRQUFpQkEsRUFBRUEsR0FBV0EsRUFBRUEsR0FBV0E7UUFBdkV1QixpQkFJQ0E7UUFIQ0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxDQUFDQSxFQUFFQTtZQUN4QkEsS0FBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsUUFBUUEsRUFBRUEsR0FBR0EsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDbERBLENBQUNBLENBQUNBLENBQUNBO0lBQ0xBLENBQUNBO0lBQ012Qiw4QkFBVUEsR0FBakJBLFVBQWtCQSxDQUFTQSxFQUFFQSxLQUFXQSxFQUFFQSxLQUFXQTtRQUFyRHdCLGlCQUlDQTtRQUhDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBLEVBQUVBO1lBQ3hCQSxLQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUM3Q0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFPT3hCLHFDQUFpQkEsR0FBekJBLFVBQTBCQSxDQUFTQSxFQUFFQSxDQUFhQTtRQUNoRHlCLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFHbENBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3pCQSxDQUFDQTtZQUNEQSxDQUFDQSxFQUFFQSxDQUFDQTtRQUNOQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNOQSxNQUFNQSxvQkFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0JBLENBQUNBO0lBQ0hBLENBQUNBO0lBTU96QixrQ0FBY0EsR0FBdEJBLFVBQXVCQSxDQUFTQTtRQUM5QjBCLElBQUlBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBQ3JDQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN6QkEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDM0NBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ05BLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLENBQUNBLEVBQ2xCQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQSxFQUFFQSxJQUFJQSxFQUFFQSxvQkFBUUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFDckVBLG9CQUFRQSxDQUFDQSxXQUFXQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUM3REEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFDSDFCLGdCQUFDQTtBQUFEQSxDQUFDQSxBQXBVRCxFQUF1QyxXQUFXLENBQUMscUJBQXFCLEVBb1V2RTtBQXBVRDs4QkFvVUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmaWxlX3N5c3RlbSA9IHJlcXVpcmUoJy4uL2NvcmUvZmlsZV9zeXN0ZW0nKTtcbmltcG9ydCB7QXBpRXJyb3IsIEVycm9yQ29kZX0gZnJvbSAnLi4vY29yZS9hcGlfZXJyb3InO1xuaW1wb3J0IHtGaWxlRmxhZywgQWN0aW9uVHlwZX0gZnJvbSAnLi4vY29yZS9maWxlX2ZsYWcnO1xuaW1wb3J0IHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlL3V0aWwnKTtcbmltcG9ydCBmaWxlID0gcmVxdWlyZSgnLi4vY29yZS9maWxlJyk7XG5pbXBvcnQge1N0YXRzfSBmcm9tICcuLi9jb3JlL25vZGVfZnNfc3RhdHMnO1xuaW1wb3J0IHByZWxvYWRfZmlsZSA9IHJlcXVpcmUoJy4uL2dlbmVyaWMvcHJlbG9hZF9maWxlJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmxldCBkZWxldGlvbkxvZ1BhdGggPSAnLy5kZWxldGVkRmlsZXMubG9nJztcblxuLyoqXG4gKiBHaXZlbiBhIHJlYWQtb25seSBtb2RlLCBtYWtlcyBpdCB3cml0YWJsZS5cbiAqL1xuZnVuY3Rpb24gbWFrZU1vZGVXcml0YWJsZShtb2RlOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gMHg5MiB8IG1vZGU7XG59XG5cbi8qKlxuICogT3ZlcmxheXMgYSBSTyBmaWxlIHRvIG1ha2UgaXQgd3JpdGFibGUuXG4gKi9cbmNsYXNzIE92ZXJsYXlGaWxlIGV4dGVuZHMgcHJlbG9hZF9maWxlLlByZWxvYWRGaWxlPE92ZXJsYXlGUz4gaW1wbGVtZW50cyBmaWxlLkZpbGUge1xuICBjb25zdHJ1Y3RvcihmczogT3ZlcmxheUZTLCBwYXRoOiBzdHJpbmcsIGZsYWc6IEZpbGVGbGFnLCBzdGF0czogU3RhdHMsIGRhdGE6IEJ1ZmZlcikge1xuICAgIHN1cGVyKGZzLCBwYXRoLCBmbGFnLCBzdGF0cywgZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgc3luY1N5bmMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNEaXJ0eSgpKSB7XG4gICAgICB0aGlzLl9mcy5fc3luY1N5bmModGhpcyk7XG4gICAgICB0aGlzLnJlc2V0RGlydHkoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xvc2VTeW5jKCk6IHZvaWQge1xuICAgIHRoaXMuc3luY1N5bmMoKTtcbiAgfVxufVxuXG4vKipcbiAqIE92ZXJsYXlGUyBtYWtlcyBhIHJlYWQtb25seSBmaWxlc3lzdGVtIHdyaXRhYmxlIGJ5IHN0b3Jpbmcgd3JpdGVzIG9uIGEgc2Vjb25kLFxuICogd3JpdGFibGUgZmlsZSBzeXN0ZW0uIERlbGV0ZXMgYXJlIHBlcnNpc3RlZCB2aWEgbWV0YWRhdGEgc3RvcmVkIG9uIHRoZSB3cml0YWJsZVxuICogZmlsZSBzeXN0ZW0uXG4gKlxuICogQ3VycmVudGx5IG9ubHkgd29ya3MgZm9yIHR3byBzeW5jaHJvbm91cyBmaWxlIHN5c3RlbXMuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE92ZXJsYXlGUyBleHRlbmRzIGZpbGVfc3lzdGVtLlN5bmNocm9ub3VzRmlsZVN5c3RlbSBpbXBsZW1lbnRzIGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0ge1xuICBwcml2YXRlIF93cml0YWJsZTogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbTtcbiAgcHJpdmF0ZSBfcmVhZGFibGU6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW07XG4gIHByaXZhdGUgX2lzSW5pdGlhbGl6ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfZGVsZXRlZEZpbGVzOiB7W3BhdGg6IHN0cmluZ106IGJvb2xlYW59ID0ge307XG4gIHByaXZhdGUgX2RlbGV0ZUxvZzogZmlsZS5GaWxlID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcih3cml0YWJsZTogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbSwgcmVhZGFibGU6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3dyaXRhYmxlID0gd3JpdGFibGU7XG4gICAgdGhpcy5fcmVhZGFibGUgPSByZWFkYWJsZTtcbiAgICBpZiAodGhpcy5fd3JpdGFibGUuaXNSZWFkT25seSgpKSB7XG4gICAgICB0aHJvdyBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgXCJXcml0YWJsZSBmaWxlIHN5c3RlbSBtdXN0IGJlIHdyaXRhYmxlLlwiKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl93cml0YWJsZS5zdXBwb3J0c1N5bmNoKCkgfHwgIXRoaXMuX3JlYWRhYmxlLnN1cHBvcnRzU3luY2goKSkge1xuICAgICAgdGhyb3cgbmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIFwiT3ZlcmxheUZTIGN1cnJlbnRseSBvbmx5IG9wZXJhdGVzIG9uIHN5bmNocm9ub3VzIGZpbGUgc3lzdGVtcy5cIik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldE92ZXJsYXllZEZpbGVTeXN0ZW1zKCk6IHsgcmVhZGFibGU6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW07IHdyaXRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtOyB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgcmVhZGFibGU6IHRoaXMuX3JlYWRhYmxlLFxuICAgICAgd3JpdGFibGU6IHRoaXMuX3dyaXRhYmxlXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaXRoIHRoZSBnaXZlbiBwYXRoLCBjcmVhdGUgdGhlIG5lZWRlZCBwYXJlbnQgZGlyZWN0b3JpZXMgb24gdGhlIHdyaXRhYmxlIHN0b3JhZ2VcbiAgICogc2hvdWxkIHRoZXkgbm90IGV4aXN0LiBVc2UgbW9kZXMgZnJvbSB0aGUgcmVhZC1vbmx5IHN0b3JhZ2UuXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZVBhcmVudERpcmVjdG9yaWVzKHA6IHN0cmluZyk6IHZvaWQge1xuICAgIHZhciBwYXJlbnQgPSBwYXRoLmRpcm5hbWUocCksIHRvQ3JlYXRlOiBzdHJpbmdbXSA9IFtdO1xuICAgIHdoaWxlICghdGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwYXJlbnQpKSB7XG4gICAgICB0b0NyZWF0ZS5wdXNoKHBhcmVudCk7XG4gICAgICBwYXJlbnQgPSBwYXRoLmRpcm5hbWUocGFyZW50KTtcbiAgICB9XG4gICAgdG9DcmVhdGUgPSB0b0NyZWF0ZS5yZXZlcnNlKCk7XG5cbiAgICB0b0NyZWF0ZS5mb3JFYWNoKChwOiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuX3dyaXRhYmxlLm1rZGlyU3luYyhwLCB0aGlzLnN0YXRTeW5jKHAsIGZhbHNlKS5tb2RlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgX3N5bmNTeW5jKGZpbGU6IHByZWxvYWRfZmlsZS5QcmVsb2FkRmlsZTxhbnk+KTogdm9pZCB7XG4gICAgdGhpcy5jcmVhdGVQYXJlbnREaXJlY3RvcmllcyhmaWxlLmdldFBhdGgoKSk7XG4gICAgdGhpcy5fd3JpdGFibGUud3JpdGVGaWxlU3luYyhmaWxlLmdldFBhdGgoKSwgZmlsZS5nZXRCdWZmZXIoKSwgbnVsbCwgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3cnKSwgZmlsZS5nZXRTdGF0cygpLm1vZGUpO1xuICB9XG5cbiAgcHVibGljIGdldE5hbWUoKSB7XG4gICAgcmV0dXJuIFwiT3ZlcmxheUZTXCI7XG4gIH1cblxuICAvKipcbiAgICogQ2FsbGVkIG9uY2UgdG8gbG9hZCB1cCBtZXRhZGF0YSBzdG9yZWQgb24gdGhlIHdyaXRhYmxlIGZpbGUgc3lzdGVtLlxuICAgKi9cbiAgcHVibGljIGluaXRpYWxpemUoY2I6IChlcnI/OiBBcGlFcnJvcikgPT4gdm9pZCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkge1xuICAgICAgLy8gUmVhZCBkZWxldGlvbiBsb2csIHByb2Nlc3MgaW50byBtZXRhZGF0YS5cbiAgICAgIHRoaXMuX3dyaXRhYmxlLnJlYWRGaWxlKGRlbGV0aW9uTG9nUGF0aCwgJ3V0ZjgnLFxuICAgICAgICBGaWxlRmxhZy5nZXRGaWxlRmxhZygncicpLCAoZXJyOiBBcGlFcnJvciwgZGF0YT86IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgLy8gRU5PRU5UID09PSBOZXdseS1pbnN0YW50aWF0ZWQgZmlsZSBzeXN0ZW0sIGFuZCB0aHVzIGVtcHR5IGxvZy5cbiAgICAgICAgICBpZiAoZXJyLnR5cGUgIT09IEVycm9yQ29kZS5FTk9FTlQpIHtcbiAgICAgICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkYXRhLnNwbGl0KCdcXG4nKS5mb3JFYWNoKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBsb2cgZW50cnkgYmVnaW5zIHcvICdkJywgaXQncyBhIGRlbGV0aW9uLiBPdGhlcndpc2UsIGl0J3NcbiAgICAgICAgICAgIC8vIGFuIHVuZGVsZXRpb24uXG4gICAgICAgICAgICAvLyBUT0RPOiBDbGVhbiB1cCBsb2cgZHVyaW5nIGluaXRpYWxpemF0aW9uIHBoYXNlLlxuICAgICAgICAgICAgdGhpcy5fZGVsZXRlZEZpbGVzW3BhdGguc2xpY2UoMSldID0gcGF0aC5zbGljZSgwLCAxKSA9PT0gJ2QnO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIC8vIE9wZW4gdXAgdGhlIGRlbGV0aW9uIGxvZyBmb3IgYXBwZW5kaW5nLlxuICAgICAgICB0aGlzLl93cml0YWJsZS5vcGVuKGRlbGV0aW9uTG9nUGF0aCwgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ2EnKSxcbiAgICAgICAgICAweDFhNCwgKGVycjogQXBpRXJyb3IsIGZkPzogZmlsZS5GaWxlKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY2IoZXJyKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fZGVsZXRlTG9nID0gZmQ7XG4gICAgICAgICAgICBjYigpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2IoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaXNSZWFkT25seSgpOiBib29sZWFuIHsgcmV0dXJuIGZhbHNlOyB9XG4gIHB1YmxpYyBzdXBwb3J0c1N5bmNoKCk6IGJvb2xlYW4geyByZXR1cm4gdHJ1ZTsgfVxuICBwdWJsaWMgc3VwcG9ydHNMaW5rcygpOiBib29sZWFuIHsgcmV0dXJuIGZhbHNlOyB9XG4gIHB1YmxpYyBzdXBwb3J0c1Byb3BzKCk6IGJvb2xlYW4geyByZXR1cm4gdGhpcy5fcmVhZGFibGUuc3VwcG9ydHNQcm9wcygpICYmIHRoaXMuX3dyaXRhYmxlLnN1cHBvcnRzUHJvcHMoKTsgfVxuXG4gIHByaXZhdGUgZGVsZXRlUGF0aChwOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLl9kZWxldGVkRmlsZXNbcF0gPSB0cnVlO1xuICAgIHZhciBidWZmID0gbmV3IEJ1ZmZlcihcImRcIiArIHAgKyBcIlxcblwiKTtcbiAgICB0aGlzLl9kZWxldGVMb2cud3JpdGVTeW5jKGJ1ZmYsIDAsIGJ1ZmYubGVuZ3RoLCBudWxsKTtcbiAgICB0aGlzLl9kZWxldGVMb2cuc3luY1N5bmMoKTtcbiAgfVxuXG4gIHByaXZhdGUgdW5kZWxldGVQYXRoKHA6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9kZWxldGVkRmlsZXNbcF0pIHtcbiAgICAgIHRoaXMuX2RlbGV0ZWRGaWxlc1twXSA9IGZhbHNlO1xuICAgICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKFwidVwiICsgcCk7XG4gICAgICB0aGlzLl9kZWxldGVMb2cud3JpdGVTeW5jKGJ1ZmYsIDAsIGJ1ZmYubGVuZ3RoLCBudWxsKTtcbiAgICAgIHRoaXMuX2RlbGV0ZUxvZy5zeW5jU3luYygpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZW5hbWVTeW5jKG9sZFBhdGg6IHN0cmluZywgbmV3UGF0aDogc3RyaW5nKTogdm9pZCB7XG4gICAgLy8gV3JpdGUgbmV3UGF0aCB1c2luZyBvbGRQYXRoJ3MgY29udGVudHMsIGRlbGV0ZSBvbGRQYXRoLlxuICAgIHZhciBvbGRTdGF0cyA9IHRoaXMuc3RhdFN5bmMob2xkUGF0aCwgZmFsc2UpO1xuICAgIGlmIChvbGRTdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAvLyBPcHRpbWl6YXRpb246IERvbid0IGJvdGhlciBtb3ZpbmcgaWYgb2xkID09PSBuZXcuXG4gICAgICBpZiAob2xkUGF0aCA9PT0gbmV3UGF0aCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHZhciBtb2RlID0gMHgxZmY7XG4gICAgICBpZiAodGhpcy5leGlzdHNTeW5jKG5ld1BhdGgpKSB7XG4gICAgICAgIHZhciBzdGF0cyA9IHRoaXMuc3RhdFN5bmMobmV3UGF0aCwgZmFsc2UpLFxuICAgICAgICAgIG1vZGUgPSBzdGF0cy5tb2RlO1xuICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgIGlmICh0aGlzLnJlYWRkaXJTeW5jKG5ld1BhdGgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRocm93IEFwaUVycm9yLkVOT1RFTVBUWShuZXdQYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVERJUihuZXdQYXRoKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBUYWtlIGNhcmUgb2Ygd3JpdGFibGUgZmlyc3QuIE1vdmUgYW55IGZpbGVzIHRoZXJlLCBvciBjcmVhdGUgYW4gZW1wdHkgZGlyZWN0b3J5XG4gICAgICAvLyBpZiBpdCBkb2Vzbid0IGV4aXN0LlxuICAgICAgaWYgKHRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMob2xkUGF0aCkpIHtcbiAgICAgICAgdGhpcy5fd3JpdGFibGUucmVuYW1lU3luYyhvbGRQYXRoLCBuZXdQYXRoKTtcbiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMobmV3UGF0aCkpIHtcbiAgICAgICAgdGhpcy5fd3JpdGFibGUubWtkaXJTeW5jKG5ld1BhdGgsIG1vZGUpO1xuICAgICAgfVxuXG4gICAgICAvLyBOZWVkIHRvIG1vdmUgKmV2ZXJ5IGZpbGUvZm9sZGVyKiBjdXJyZW50bHkgc3RvcmVkIG9uIHJlYWRhYmxlIHRvIGl0cyBuZXcgbG9jYXRpb25cbiAgICAgIC8vIG9uIHdyaXRhYmxlLlxuICAgICAgaWYgKHRoaXMuX3JlYWRhYmxlLmV4aXN0c1N5bmMob2xkUGF0aCkpIHtcbiAgICAgICAgdGhpcy5fcmVhZGFibGUucmVhZGRpclN5bmMob2xkUGF0aCkuZm9yRWFjaCgobmFtZSkgPT4ge1xuICAgICAgICAgIC8vIFJlY3Vyc2lvbiEgU2hvdWxkIHdvcmsgZm9yIGFueSBuZXN0ZWQgZmlsZXMgLyBmb2xkZXJzLlxuICAgICAgICAgIHRoaXMucmVuYW1lU3luYyhwYXRoLnJlc29sdmUob2xkUGF0aCwgbmFtZSksIHBhdGgucmVzb2x2ZShuZXdQYXRoLCBuYW1lKSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5leGlzdHNTeW5jKG5ld1BhdGgpICYmIHRoaXMuc3RhdFN5bmMobmV3UGF0aCwgZmFsc2UpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgdGhyb3cgQXBpRXJyb3IuRUlTRElSKG5ld1BhdGgpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLndyaXRlRmlsZVN5bmMobmV3UGF0aCxcbiAgICAgICAgdGhpcy5yZWFkRmlsZVN5bmMob2xkUGF0aCwgbnVsbCwgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3InKSksIG51bGwsXG4gICAgICAgIEZpbGVGbGFnLmdldEZpbGVGbGFnKCd3JyksIG9sZFN0YXRzLm1vZGUpO1xuICAgIH1cblxuICAgIGlmIChvbGRQYXRoICE9PSBuZXdQYXRoICYmIHRoaXMuZXhpc3RzU3luYyhvbGRQYXRoKSkge1xuICAgICAgdGhpcy51bmxpbmtTeW5jKG9sZFBhdGgpO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgc3RhdFN5bmMocDogc3RyaW5nLCBpc0xzdGF0OiBib29sZWFuKTogU3RhdHMge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGUuc3RhdFN5bmMocCwgaXNMc3RhdCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHRoaXMuX2RlbGV0ZWRGaWxlc1twXSkge1xuICAgICAgICB0aHJvdyBBcGlFcnJvci5FTk9FTlQocCk7XG4gICAgICB9XG4gICAgICB2YXIgb2xkU3RhdCA9IHRoaXMuX3JlYWRhYmxlLnN0YXRTeW5jKHAsIGlzTHN0YXQpLmNsb25lKCk7XG4gICAgICAvLyBNYWtlIHRoZSBvbGRTdGF0J3MgbW9kZSB3cml0YWJsZS4gUHJlc2VydmUgdGhlIHRvcG1vc3QgcGFydCBvZiB0aGVcbiAgICAgIC8vIG1vZGUsIHdoaWNoIHNwZWNpZmllcyBpZiBpdCBpcyBhIGZpbGUgb3IgYSBkaXJlY3RvcnkuXG4gICAgICBvbGRTdGF0Lm1vZGUgPSBtYWtlTW9kZVdyaXRhYmxlKG9sZFN0YXQubW9kZSk7XG4gICAgICByZXR1cm4gb2xkU3RhdDtcbiAgICB9XG4gIH1cbiAgcHVibGljIG9wZW5TeW5jKHA6IHN0cmluZywgZmxhZzogRmlsZUZsYWcsIG1vZGU6IG51bWJlcik6IGZpbGUuRmlsZSB7XG4gICAgaWYgKHRoaXMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgc3dpdGNoIChmbGFnLnBhdGhFeGlzdHNBY3Rpb24oKSkge1xuICAgICAgICBjYXNlIEFjdGlvblR5cGUuVFJVTkNBVEVfRklMRTpcbiAgICAgICAgICB0aGlzLmNyZWF0ZVBhcmVudERpcmVjdG9yaWVzKHApO1xuICAgICAgICAgIHJldHVybiB0aGlzLl93cml0YWJsZS5vcGVuU3luYyhwLCBmbGFnLCBtb2RlKTtcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLk5PUDpcbiAgICAgICAgICBpZiAodGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlLm9wZW5TeW5jKHAsIGZsYWcsIG1vZGUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBDcmVhdGUgYW4gT3ZlcmxheUZpbGUuXG4gICAgICAgICAgICB2YXIgc3RhdHMgPSB0aGlzLl9yZWFkYWJsZS5zdGF0U3luYyhwLCBmYWxzZSkuY2xvbmUoKTtcbiAgICAgICAgICAgIHN0YXRzLm1vZGUgPSBtb2RlO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBPdmVybGF5RmlsZSh0aGlzLCBwLCBmbGFnLCBzdGF0cywgdGhpcy5fcmVhZGFibGUucmVhZEZpbGVTeW5jKHAsIG51bGwsIEZpbGVGbGFnLmdldEZpbGVGbGFnKCdyJykpKTtcbiAgICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgQXBpRXJyb3IuRUVYSVNUKHApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBzd2l0Y2goZmxhZy5wYXRoTm90RXhpc3RzQWN0aW9uKCkpIHtcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLkNSRUFURV9GSUxFOlxuICAgICAgICAgIHRoaXMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMocCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlLm9wZW5TeW5jKHAsIGZsYWcsIG1vZGUpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcHVibGljIHVubGlua1N5bmMocDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgaWYgKHRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgdGhpcy5fd3JpdGFibGUudW5saW5rU3luYyhwKTtcbiAgICAgIH1cblxuICAgICAgLy8gRG9lcyBpdCBzdGlsbCBleGlzdD9cbiAgICAgIGlmICh0aGlzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgLy8gQWRkIHRvIGRlbGV0ZSBsb2cuXG4gICAgICAgIHRoaXMuZGVsZXRlUGF0aChwKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHApO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgcm1kaXJTeW5jKHA6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgIGlmICh0aGlzLl93cml0YWJsZS5leGlzdHNTeW5jKHApKSB7XG4gICAgICAgIHRoaXMuX3dyaXRhYmxlLnJtZGlyU3luYyhwKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgZGlyZWN0b3J5IGlzIGVtcHR5LlxuICAgICAgICBpZiAodGhpcy5yZWFkZGlyU3luYyhwKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVEVNUFRZKHApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuZGVsZXRlUGF0aChwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FTk9FTlQocCk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBta2RpclN5bmMocDogc3RyaW5nLCBtb2RlOiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FRVhJU1QocCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoZSBiZWxvdyB3aWxsIHRocm93IHNob3VsZCBhbnkgb2YgdGhlIHBhcmVudCBkaXJlY3RvcmllcyBmYWlsIHRvIGV4aXN0XG4gICAgICAvLyBvbiBfd3JpdGFibGUuXG4gICAgICB0aGlzLmNyZWF0ZVBhcmVudERpcmVjdG9yaWVzKHApO1xuICAgICAgdGhpcy5fd3JpdGFibGUubWtkaXJTeW5jKHAsIG1vZGUpO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgcmVhZGRpclN5bmMocDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIHZhciBkaXJTdGF0cyA9IHRoaXMuc3RhdFN5bmMocCwgZmFsc2UpO1xuICAgIGlmICghZGlyU3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVERJUihwKTtcbiAgICB9XG5cbiAgICAvLyBSZWFkZGlyIGluIGJvdGgsIG1lcmdlLCBjaGVjayBkZWxldGUgbG9nIG9uIGVhY2ggZmlsZSwgcmV0dXJuLlxuICAgIHZhciBjb250ZW50czogc3RyaW5nW10gPSBbXTtcbiAgICB0cnkge1xuICAgICAgY29udGVudHMgPSBjb250ZW50cy5jb25jYXQodGhpcy5fd3JpdGFibGUucmVhZGRpclN5bmMocCkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnRlbnRzID0gY29udGVudHMuY29uY2F0KHRoaXMuX3JlYWRhYmxlLnJlYWRkaXJTeW5jKHApKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgfVxuICAgIHZhciBzZWVuTWFwOiB7W25hbWU6IHN0cmluZ106IGJvb2xlYW59ID0ge307XG4gICAgcmV0dXJuIGNvbnRlbnRzLmZpbHRlcigoZmlsZVA6IHN0cmluZykgPT4ge1xuICAgICAgdmFyIHJlc3VsdCA9IHNlZW5NYXBbZmlsZVBdID09PSB1bmRlZmluZWQgJiYgdGhpcy5fZGVsZXRlZEZpbGVzW3AgKyBcIi9cIiArIGZpbGVQXSAhPT0gdHJ1ZTtcbiAgICAgIHNlZW5NYXBbZmlsZVBdID0gdHJ1ZTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG4gIH1cbiAgcHVibGljIGV4aXN0c1N5bmMocDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMocCkgfHwgKHRoaXMuX3JlYWRhYmxlLmV4aXN0c1N5bmMocCkgJiYgdGhpcy5fZGVsZXRlZEZpbGVzW3BdICE9PSB0cnVlKTtcbiAgfVxuICBwdWJsaWMgY2htb2RTeW5jKHA6IHN0cmluZywgaXNMY2htb2Q6IGJvb2xlYW4sIG1vZGU6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMub3BlcmF0ZU9uV3JpdGFibGUocCwgKCkgPT4ge1xuICAgICAgdGhpcy5fd3JpdGFibGUuY2htb2RTeW5jKHAsIGlzTGNobW9kLCBtb2RlKTtcbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgY2hvd25TeW5jKHA6IHN0cmluZywgaXNMY2hvd246IGJvb2xlYW4sIHVpZDogbnVtYmVyLCBnaWQ6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMub3BlcmF0ZU9uV3JpdGFibGUocCwgKCkgPT4ge1xuICAgICAgdGhpcy5fd3JpdGFibGUuY2hvd25TeW5jKHAsIGlzTGNob3duLCB1aWQsIGdpZCk7XG4gICAgfSk7XG4gIH1cbiAgcHVibGljIHV0aW1lc1N5bmMocDogc3RyaW5nLCBhdGltZTogRGF0ZSwgbXRpbWU6IERhdGUpOiB2b2lkIHtcbiAgICB0aGlzLm9wZXJhdGVPbldyaXRhYmxlKHAsICgpID0+IHtcbiAgICAgIHRoaXMuX3dyaXRhYmxlLnV0aW1lc1N5bmMocCwgYXRpbWUsIG10aW1lKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIZWxwZXIgZnVuY3Rpb246XG4gICAqIC0gRW5zdXJlcyBwIGlzIG9uIHdyaXRhYmxlIGJlZm9yZSBwcm9jZWVkaW5nLiBUaHJvd3MgYW4gZXJyb3IgaWYgaXQgZG9lc24ndCBleGlzdC5cbiAgICogLSBDYWxscyBmIHRvIHBlcmZvcm0gb3BlcmF0aW9uIG9uIHdyaXRhYmxlLlxuICAgKi9cbiAgcHJpdmF0ZSBvcGVyYXRlT25Xcml0YWJsZShwOiBzdHJpbmcsIGY6ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICBpZiAoIXRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgLy8gRmlsZSBpcyBvbiByZWFkYWJsZSBzdG9yYWdlLiBDb3B5IHRvIHdyaXRhYmxlIHN0b3JhZ2UgYmVmb3JlXG4gICAgICAgIC8vIGNoYW5naW5nIGl0cyBtb2RlLlxuICAgICAgICB0aGlzLmNvcHlUb1dyaXRhYmxlKHApO1xuICAgICAgfVxuICAgICAgZigpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FTk9FTlQocCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENvcHkgZnJvbSByZWFkYWJsZSB0byB3cml0YWJsZSBzdG9yYWdlLlxuICAgKiBQUkVDT05ESVRJT046IEZpbGUgZG9lcyBub3QgZXhpc3Qgb24gd3JpdGFibGUgc3RvcmFnZS5cbiAgICovXG4gIHByaXZhdGUgY29weVRvV3JpdGFibGUocDogc3RyaW5nKTogdm9pZCB7XG4gICAgdmFyIHBTdGF0cyA9IHRoaXMuc3RhdFN5bmMocCwgZmFsc2UpO1xuICAgIGlmIChwU3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgdGhpcy5fd3JpdGFibGUubWtkaXJTeW5jKHAsIHBTdGF0cy5tb2RlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy53cml0ZUZpbGVTeW5jKHAsXG4gICAgICAgIHRoaXMuX3JlYWRhYmxlLnJlYWRGaWxlU3luYyhwLCBudWxsLCBGaWxlRmxhZy5nZXRGaWxlRmxhZygncicpKSwgbnVsbCxcbiAgICAgICAgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3cnKSwgdGhpcy5zdGF0U3luYyhwLCBmYWxzZSkubW9kZSk7XG4gICAgfVxuICB9XG59XG4iXX0=