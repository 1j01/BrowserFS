var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var api_error_1 = require('../core/api_error');
var file_flag_1 = require('../core/file_flag');
var preload_file = require('../generic/preload_file');
var path = require('path');
var deletionLogPath = '/.deletedFiles.log';
function makeModeWritable(mode) {
    return 0x92 | mode;
}
var OverlayFile = (function (_super) {
    __extends(OverlayFile, _super);
    function OverlayFile(fs, path, flag, stats, data) {
        _super.call(this, fs, path, flag, stats, data);
    }
    OverlayFile.prototype.syncSync = function () {
        if (this.isDirty()) {
            this._fs._syncSync(this);
            this.resetDirty();
        }
    };
    OverlayFile.prototype.closeSync = function () {
        this.syncSync();
    };
    return OverlayFile;
})(preload_file.PreloadFile);
var OverlayFS = (function (_super) {
    __extends(OverlayFS, _super);
    function OverlayFS(writable, readable) {
        _super.call(this);
        this._isInitialized = false;
        this._deletedFiles = {};
        this._deleteLog = null;
        this._writable = writable;
        this._readable = readable;
        if (this._writable.isReadOnly()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Writable file system must be writable.");
        }
        if (!this._writable.supportsSynch() || !this._readable.supportsSynch()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "OverlayFS currently only operates on synchronous file systems.");
        }
    }
    OverlayFS.prototype.getOverlayedFileSystems = function () {
        return {
            readable: this._readable,
            writable: this._writable
        };
    };
    OverlayFS.prototype.createParentDirectories = function (p) {
        var _this = this;
        var parent = path.dirname(p), toCreate = [];
        while (!this._writable.existsSync(parent)) {
            toCreate.push(parent);
            parent = path.dirname(parent);
        }
        toCreate = toCreate.reverse();
        toCreate.forEach(function (p) {
            _this._writable.mkdirSync(p, _this.statSync(p, false).mode);
        });
    };
    OverlayFS.isAvailable = function () {
        return true;
    };
    OverlayFS.prototype._syncSync = function (file) {
        this.createParentDirectories(file.getPath());
        this._writable.writeFileSync(file.getPath(), file.getBuffer(), null, file_flag_1.FileFlag.getFileFlag('w'), file.getStats().mode);
    };
    OverlayFS.prototype.getName = function () {
        return "OverlayFS";
    };
    OverlayFS.prototype.initialize = function (cb) {
        var _this = this;
        if (!this._isInitialized) {
            this._writable.readFile(deletionLogPath, 'utf8', file_flag_1.FileFlag.getFileFlag('r'), function (err, data) {
                if (err) {
                    if (err.errno !== api_error_1.ErrorCode.ENOENT) {
                        return cb(err);
                    }
                }
                else {
                    data.split('\n').forEach(function (path) {
                        _this._deletedFiles[path.slice(1)] = path.slice(0, 1) === 'd';
                    });
                }
                _this._writable.open(deletionLogPath, file_flag_1.FileFlag.getFileFlag('a'), 0x1a4, function (err, fd) {
                    if (err) {
                        cb(err);
                    }
                    else {
                        _this._deleteLog = fd;
                        cb();
                    }
                });
            });
        }
        else {
            cb();
        }
    };
    OverlayFS.prototype.isReadOnly = function () { return false; };
    OverlayFS.prototype.supportsSynch = function () { return true; };
    OverlayFS.prototype.supportsLinks = function () { return false; };
    OverlayFS.prototype.supportsProps = function () { return this._readable.supportsProps() && this._writable.supportsProps(); };
    OverlayFS.prototype.deletePath = function (p) {
        this._deletedFiles[p] = true;
        var buff = new Buffer("d" + p + "\n");
        this._deleteLog.writeSync(buff, 0, buff.length, null);
        this._deleteLog.syncSync();
    };
    OverlayFS.prototype.undeletePath = function (p) {
        if (this._deletedFiles[p]) {
            this._deletedFiles[p] = false;
            var buff = new Buffer("u" + p);
            this._deleteLog.writeSync(buff, 0, buff.length, null);
            this._deleteLog.syncSync();
        }
    };
    OverlayFS.prototype.renameSync = function (oldPath, newPath) {
        var _this = this;
        var oldStats = this.statSync(oldPath, false);
        if (oldStats.isDirectory()) {
            if (oldPath === newPath) {
                return;
            }
            var mode = 0x1ff;
            if (this.existsSync(newPath)) {
                var stats = this.statSync(newPath, false), mode = stats.mode;
                if (stats.isDirectory()) {
                    if (this.readdirSync(newPath).length > 0) {
                        throw api_error_1.ApiError.ENOTEMPTY(newPath);
                    }
                }
                else {
                    throw api_error_1.ApiError.ENOTDIR(newPath);
                }
            }
            if (this._writable.existsSync(oldPath)) {
                this._writable.renameSync(oldPath, newPath);
            }
            else if (!this._writable.existsSync(newPath)) {
                this._writable.mkdirSync(newPath, mode);
            }
            if (this._readable.existsSync(oldPath)) {
                this._readable.readdirSync(oldPath).forEach(function (name) {
                    _this.renameSync(path.resolve(oldPath, name), path.resolve(newPath, name));
                });
            }
        }
        else {
            if (this.existsSync(newPath) && this.statSync(newPath, false).isDirectory()) {
                throw api_error_1.ApiError.EISDIR(newPath);
            }
            this.writeFileSync(newPath, this.readFileSync(oldPath, null, file_flag_1.FileFlag.getFileFlag('r')), null, file_flag_1.FileFlag.getFileFlag('w'), oldStats.mode);
        }
        if (oldPath !== newPath && this.existsSync(oldPath)) {
            this.unlinkSync(oldPath);
        }
    };
    OverlayFS.prototype.statSync = function (p, isLstat) {
        try {
            return this._writable.statSync(p, isLstat);
        }
        catch (e) {
            if (this._deletedFiles[p]) {
                throw api_error_1.ApiError.ENOENT(p);
            }
            var oldStat = this._readable.statSync(p, isLstat).clone();
            oldStat.mode = makeModeWritable(oldStat.mode);
            return oldStat;
        }
    };
    OverlayFS.prototype.openSync = function (p, flag, mode) {
        if (this.existsSync(p)) {
            switch (flag.pathExistsAction()) {
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    this.createParentDirectories(p);
                    return this._writable.openSync(p, flag, mode);
                case file_flag_1.ActionType.NOP:
                    if (this._writable.existsSync(p)) {
                        return this._writable.openSync(p, flag, mode);
                    }
                    else {
                        var stats = this._readable.statSync(p, false).clone();
                        stats.mode = mode;
                        return new OverlayFile(this, p, flag, stats, this._readable.readFileSync(p, null, file_flag_1.FileFlag.getFileFlag('r')));
                    }
                default:
                    throw api_error_1.ApiError.EEXIST(p);
            }
        }
        else {
            switch (flag.pathNotExistsAction()) {
                case file_flag_1.ActionType.CREATE_FILE:
                    this.createParentDirectories(p);
                    return this._writable.openSync(p, flag, mode);
                default:
                    throw api_error_1.ApiError.ENOENT(p);
            }
        }
    };
    OverlayFS.prototype.unlinkSync = function (p) {
        if (this.existsSync(p)) {
            if (this._writable.existsSync(p)) {
                this._writable.unlinkSync(p);
            }
            if (this.existsSync(p)) {
                this.deletePath(p);
            }
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.rmdirSync = function (p) {
        if (this.existsSync(p)) {
            if (this._writable.existsSync(p)) {
                this._writable.rmdirSync(p);
            }
            if (this.existsSync(p)) {
                if (this.readdirSync(p).length > 0) {
                    throw api_error_1.ApiError.ENOTEMPTY(p);
                }
                else {
                    this.deletePath(p);
                }
            }
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.mkdirSync = function (p, mode) {
        if (this.existsSync(p)) {
            throw api_error_1.ApiError.EEXIST(p);
        }
        else {
            this.createParentDirectories(p);
            this._writable.mkdirSync(p, mode);
        }
    };
    OverlayFS.prototype.readdirSync = function (p) {
        var _this = this;
        var dirStats = this.statSync(p, false);
        if (!dirStats.isDirectory()) {
            throw api_error_1.ApiError.ENOTDIR(p);
        }
        var contents = [];
        try {
            contents = contents.concat(this._writable.readdirSync(p));
        }
        catch (e) {
        }
        try {
            contents = contents.concat(this._readable.readdirSync(p));
        }
        catch (e) {
        }
        var seenMap = {};
        return contents.filter(function (fileP) {
            var result = seenMap[fileP] === undefined && _this._deletedFiles[p + "/" + fileP] !== true;
            seenMap[fileP] = true;
            return result;
        });
    };
    OverlayFS.prototype.existsSync = function (p) {
        return this._writable.existsSync(p) || (this._readable.existsSync(p) && this._deletedFiles[p] !== true);
    };
    OverlayFS.prototype.chmodSync = function (p, isLchmod, mode) {
        var _this = this;
        this.operateOnWritable(p, function () {
            _this._writable.chmodSync(p, isLchmod, mode);
        });
    };
    OverlayFS.prototype.chownSync = function (p, isLchown, uid, gid) {
        var _this = this;
        this.operateOnWritable(p, function () {
            _this._writable.chownSync(p, isLchown, uid, gid);
        });
    };
    OverlayFS.prototype.utimesSync = function (p, atime, mtime) {
        var _this = this;
        this.operateOnWritable(p, function () {
            _this._writable.utimesSync(p, atime, mtime);
        });
    };
    OverlayFS.prototype.operateOnWritable = function (p, f) {
        if (this.existsSync(p)) {
            if (!this._writable.existsSync(p)) {
                this.copyToWritable(p);
            }
            f();
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.copyToWritable = function (p) {
        var pStats = this.statSync(p, false);
        if (pStats.isDirectory()) {
            this._writable.mkdirSync(p, pStats.mode);
        }
        else {
            this.writeFileSync(p, this._readable.readFileSync(p, null, file_flag_1.FileFlag.getFileFlag('r')), null, file_flag_1.FileFlag.getFileFlag('w'), this.statSync(p, false).mode);
        }
    };
    return OverlayFS;
})(file_system.SynchronousFileSystem);
exports.__esModule = true;
exports["default"] = OverlayFS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3ZlcmxheUZTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2JhY2tlbmQvT3ZlcmxheUZTLnRzIl0sIm5hbWVzIjpbIm1ha2VNb2RlV3JpdGFibGUiLCJPdmVybGF5RmlsZSIsIk92ZXJsYXlGaWxlLmNvbnN0cnVjdG9yIiwiT3ZlcmxheUZpbGUuc3luY1N5bmMiLCJPdmVybGF5RmlsZS5jbG9zZVN5bmMiLCJPdmVybGF5RlMiLCJPdmVybGF5RlMuY29uc3RydWN0b3IiLCJPdmVybGF5RlMuZ2V0T3ZlcmxheWVkRmlsZVN5c3RlbXMiLCJPdmVybGF5RlMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMiLCJPdmVybGF5RlMuaXNBdmFpbGFibGUiLCJPdmVybGF5RlMuX3N5bmNTeW5jIiwiT3ZlcmxheUZTLmdldE5hbWUiLCJPdmVybGF5RlMuaW5pdGlhbGl6ZSIsIk92ZXJsYXlGUy5pc1JlYWRPbmx5IiwiT3ZlcmxheUZTLnN1cHBvcnRzU3luY2giLCJPdmVybGF5RlMuc3VwcG9ydHNMaW5rcyIsIk92ZXJsYXlGUy5zdXBwb3J0c1Byb3BzIiwiT3ZlcmxheUZTLmRlbGV0ZVBhdGgiLCJPdmVybGF5RlMudW5kZWxldGVQYXRoIiwiT3ZlcmxheUZTLnJlbmFtZVN5bmMiLCJPdmVybGF5RlMuc3RhdFN5bmMiLCJPdmVybGF5RlMub3BlblN5bmMiLCJPdmVybGF5RlMudW5saW5rU3luYyIsIk92ZXJsYXlGUy5ybWRpclN5bmMiLCJPdmVybGF5RlMubWtkaXJTeW5jIiwiT3ZlcmxheUZTLnJlYWRkaXJTeW5jIiwiT3ZlcmxheUZTLmV4aXN0c1N5bmMiLCJPdmVybGF5RlMuY2htb2RTeW5jIiwiT3ZlcmxheUZTLmNob3duU3luYyIsIk92ZXJsYXlGUy51dGltZXNTeW5jIiwiT3ZlcmxheUZTLm9wZXJhdGVPbldyaXRhYmxlIiwiT3ZlcmxheUZTLmNvcHlUb1dyaXRhYmxlIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLElBQU8sV0FBVyxXQUFX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Q0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBQ0EsSUFBSUE7b0JBRS9DQSxLQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDNUVBLENBQUNBLENBQUNBLENBQUNBO1lBQ0xBLENBQUNBO1FBQ0hBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ05BLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO2dCQUM1RUEsTUFBTUEsb0JBQVFBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQ2pDQSxDQUFDQTtZQUVEQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxPQUFPQSxFQUN4QkEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsRUFBRUEsb0JBQVFBLENBQUNBLFdBQVdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLEVBQ2pFQSxvQkFBUUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDOUNBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLEtBQUtBLE9BQU9BLElBQUlBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BEQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtRQUMzQkEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFDTWQsNEJBQVFBLEdBQWZBLFVBQWdCQSxDQUFTQSxFQUFFQSxPQUFnQkE7UUFDekNlLElBQUlBLENBQUNBO1lBQ0hBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO1FBQzdDQSxDQUFFQTtRQUFBQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNYQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDMUJBLE1BQU1BLG9CQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMzQkEsQ0FBQ0E7WUFDREEsSUFBSUEsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7WUFHMURBLE9BQU9BLENBQUNBLElBQUlBLEdBQUdBLGdCQUFnQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDOUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBO1FBQ2pCQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUNNZiw0QkFBUUEsR0FBZkEsVUFBZ0JBLENBQVNBLEVBQUVBLElBQWNBLEVBQUVBLElBQVlBO1FBQ3JEZ0IsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdkJBLE1BQU1BLENBQUNBLENBQUNBLElBQUlBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hDQSxLQUFLQSxzQkFBVUEsQ0FBQ0EsYUFBYUE7b0JBQzNCQSxJQUFJQSxDQUFDQSx1QkFBdUJBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUNoQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hEQSxLQUFLQSxzQkFBVUEsQ0FBQ0EsR0FBR0E7b0JBQ2pCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTt3QkFDakNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO29CQUNoREEsQ0FBQ0E7b0JBQUNBLElBQUlBLENBQUNBLENBQUNBO3dCQUVOQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTt3QkFDdERBLEtBQUtBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBO3dCQUNsQkEsTUFBTUEsQ0FBQ0EsSUFBSUEsV0FBV0EsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsb0JBQVFBLENBQUNBLFdBQVdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUNoSEEsQ0FBQ0E7Z0JBQ0hBO29CQUNFQSxNQUFNQSxvQkFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDN0JBLENBQUNBO1FBQ0hBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ05BLE1BQU1BLENBQUFBLENBQUNBLElBQUlBLENBQUNBLG1C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QVFBLENBQUNBLENBQUNBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBQ3JDQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN6QkEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDM0NBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ05BLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLENBQUNBLEVBQ2xCQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQSxFQUFFQSxJQUFJQSxFQUFFQSxvQkFBUUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFDckVBLG9CQUFRQSxDQUFDQSxXQUFXQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUM3REEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFDSDFCLGdCQUFDQTtBQUFEQSxDQUFDQSxBQXBVRCxFQUF1QyxXQUFXLENBQUMscUJBQXFCLEVBb1V2RTtBQXBVRDs4QkFvVUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmaWxlX3N5c3RlbSA9IHJlcXVpcmUoJy4uL2NvcmUvZmlsZV9zeXN0ZW0nKTtcbmltcG9ydCB7QXBpRXJyb3IsIEVycm9yQ29kZX0gZnJvbSAnLi4vY29yZS9hcGlfZXJyb3InO1xuaW1wb3J0IHtGaWxlRmxhZywgQWN0aW9uVHlwZX0gZnJvbSAnLi4vY29yZS9maWxlX2ZsYWcnO1xuaW1wb3J0IHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlL3V0aWwnKTtcbmltcG9ydCBmaWxlID0gcmVxdWlyZSgnLi4vY29yZS9maWxlJyk7XG5pbXBvcnQgU3RhdHMgZnJvbSAnLi4vY29yZS9ub2RlX2ZzX3N0YXRzJztcbmltcG9ydCBwcmVsb2FkX2ZpbGUgPSByZXF1aXJlKCcuLi9nZW5lcmljL3ByZWxvYWRfZmlsZScpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5sZXQgZGVsZXRpb25Mb2dQYXRoID0gJy8uZGVsZXRlZEZpbGVzLmxvZyc7XG5cbi8qKlxuICogR2l2ZW4gYSByZWFkLW9ubHkgbW9kZSwgbWFrZXMgaXQgd3JpdGFibGUuXG4gKi9cbmZ1bmN0aW9uIG1ha2VNb2RlV3JpdGFibGUobW9kZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIDB4OTIgfCBtb2RlO1xufVxuXG4vKipcbiAqIE92ZXJsYXlzIGEgUk8gZmlsZSB0byBtYWtlIGl0IHdyaXRhYmxlLlxuICovXG5jbGFzcyBPdmVybGF5RmlsZSBleHRlbmRzIHByZWxvYWRfZmlsZS5QcmVsb2FkRmlsZTxPdmVybGF5RlM+IGltcGxlbWVudHMgZmlsZS5GaWxlIHtcbiAgY29uc3RydWN0b3IoZnM6IE92ZXJsYXlGUywgcGF0aDogc3RyaW5nLCBmbGFnOiBGaWxlRmxhZywgc3RhdHM6IFN0YXRzLCBkYXRhOiBCdWZmZXIpIHtcbiAgICBzdXBlcihmcywgcGF0aCwgZmxhZywgc3RhdHMsIGRhdGEpO1xuICB9XG5cbiAgcHVibGljIHN5bmNTeW5jKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmlzRGlydHkoKSkge1xuICAgICAgdGhpcy5fZnMuX3N5bmNTeW5jKHRoaXMpO1xuICAgICAgdGhpcy5yZXNldERpcnR5KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNsb3NlU3luYygpOiB2b2lkIHtcbiAgICB0aGlzLnN5bmNTeW5jKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBPdmVybGF5RlMgbWFrZXMgYSByZWFkLW9ubHkgZmlsZXN5c3RlbSB3cml0YWJsZSBieSBzdG9yaW5nIHdyaXRlcyBvbiBhIHNlY29uZCxcbiAqIHdyaXRhYmxlIGZpbGUgc3lzdGVtLiBEZWxldGVzIGFyZSBwZXJzaXN0ZWQgdmlhIG1ldGFkYXRhIHN0b3JlZCBvbiB0aGUgd3JpdGFibGVcbiAqIGZpbGUgc3lzdGVtLlxuICpcbiAqIEN1cnJlbnRseSBvbmx5IHdvcmtzIGZvciB0d28gc3luY2hyb25vdXMgZmlsZSBzeXN0ZW1zLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPdmVybGF5RlMgZXh0ZW5kcyBmaWxlX3N5c3RlbS5TeW5jaHJvbm91c0ZpbGVTeXN0ZW0gaW1wbGVtZW50cyBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtIHtcbiAgcHJpdmF0ZSBfd3JpdGFibGU6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW07XG4gIHByaXZhdGUgX3JlYWRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtO1xuICBwcml2YXRlIF9pc0luaXRpYWxpemVkOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgX2RlbGV0ZWRGaWxlczoge1twYXRoOiBzdHJpbmddOiBib29sZWFufSA9IHt9O1xuICBwcml2YXRlIF9kZWxldGVMb2c6IGZpbGUuRmlsZSA9IG51bGw7XG5cbiAgY29uc3RydWN0b3Iod3JpdGFibGU6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0sIHJlYWRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl93cml0YWJsZSA9IHdyaXRhYmxlO1xuICAgIHRoaXMuX3JlYWRhYmxlID0gcmVhZGFibGU7XG4gICAgaWYgKHRoaXMuX3dyaXRhYmxlLmlzUmVhZE9ubHkoKSkge1xuICAgICAgdGhyb3cgbmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIFwiV3JpdGFibGUgZmlsZSBzeXN0ZW0gbXVzdCBiZSB3cml0YWJsZS5cIik7XG4gICAgfVxuICAgIGlmICghdGhpcy5fd3JpdGFibGUuc3VwcG9ydHNTeW5jaCgpIHx8ICF0aGlzLl9yZWFkYWJsZS5zdXBwb3J0c1N5bmNoKCkpIHtcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBcIk92ZXJsYXlGUyBjdXJyZW50bHkgb25seSBvcGVyYXRlcyBvbiBzeW5jaHJvbm91cyBmaWxlIHN5c3RlbXMuXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRPdmVybGF5ZWRGaWxlU3lzdGVtcygpOiB7IHJlYWRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtOyB3cml0YWJsZTogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbTsgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHJlYWRhYmxlOiB0aGlzLl9yZWFkYWJsZSxcbiAgICAgIHdyaXRhYmxlOiB0aGlzLl93cml0YWJsZVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogV2l0aCB0aGUgZ2l2ZW4gcGF0aCwgY3JlYXRlIHRoZSBuZWVkZWQgcGFyZW50IGRpcmVjdG9yaWVzIG9uIHRoZSB3cml0YWJsZSBzdG9yYWdlXG4gICAqIHNob3VsZCB0aGV5IG5vdCBleGlzdC4gVXNlIG1vZGVzIGZyb20gdGhlIHJlYWQtb25seSBzdG9yYWdlLlxuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVQYXJlbnREaXJlY3RvcmllcyhwOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB2YXIgcGFyZW50ID0gcGF0aC5kaXJuYW1lKHApLCB0b0NyZWF0ZTogc3RyaW5nW10gPSBbXTtcbiAgICB3aGlsZSAoIXRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMocGFyZW50KSkge1xuICAgICAgdG9DcmVhdGUucHVzaChwYXJlbnQpO1xuICAgICAgcGFyZW50ID0gcGF0aC5kaXJuYW1lKHBhcmVudCk7XG4gICAgfVxuICAgIHRvQ3JlYXRlID0gdG9DcmVhdGUucmV2ZXJzZSgpO1xuXG4gICAgdG9DcmVhdGUuZm9yRWFjaCgocDogc3RyaW5nKSA9PiB7XG4gICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMocCwgdGhpcy5zdGF0U3luYyhwLCBmYWxzZSkubW9kZSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGlzQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIF9zeW5jU3luYyhmaWxlOiBwcmVsb2FkX2ZpbGUuUHJlbG9hZEZpbGU8YW55Pik6IHZvaWQge1xuICAgIHRoaXMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMoZmlsZS5nZXRQYXRoKCkpO1xuICAgIHRoaXMuX3dyaXRhYmxlLndyaXRlRmlsZVN5bmMoZmlsZS5nZXRQYXRoKCksIGZpbGUuZ2V0QnVmZmVyKCksIG51bGwsIEZpbGVGbGFnLmdldEZpbGVGbGFnKCd3JyksIGZpbGUuZ2V0U3RhdHMoKS5tb2RlKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXROYW1lKCkge1xuICAgIHJldHVybiBcIk92ZXJsYXlGU1wiO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGxlZCBvbmNlIHRvIGxvYWQgdXAgbWV0YWRhdGEgc3RvcmVkIG9uIHRoZSB3cml0YWJsZSBmaWxlIHN5c3RlbS5cbiAgICovXG4gIHB1YmxpYyBpbml0aWFsaXplKGNiOiAoZXJyPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuX2lzSW5pdGlhbGl6ZWQpIHtcbiAgICAgIC8vIFJlYWQgZGVsZXRpb24gbG9nLCBwcm9jZXNzIGludG8gbWV0YWRhdGEuXG4gICAgICB0aGlzLl93cml0YWJsZS5yZWFkRmlsZShkZWxldGlvbkxvZ1BhdGgsICd1dGY4JyxcbiAgICAgICAgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3InKSwgKGVycjogQXBpRXJyb3IsIGRhdGE/OiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIC8vIEVOT0VOVCA9PT0gTmV3bHktaW5zdGFudGlhdGVkIGZpbGUgc3lzdGVtLCBhbmQgdGh1cyBlbXB0eSBsb2cuXG4gICAgICAgICAgaWYgKGVyci5lcnJubyAhPT0gRXJyb3JDb2RlLkVOT0VOVCkge1xuICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRhdGEuc3BsaXQoJ1xcbicpLmZvckVhY2goKHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgLy8gSWYgdGhlIGxvZyBlbnRyeSBiZWdpbnMgdy8gJ2QnLCBpdCdzIGEgZGVsZXRpb24uIE90aGVyd2lzZSwgaXQnc1xuICAgICAgICAgICAgLy8gYW4gdW5kZWxldGlvbi5cbiAgICAgICAgICAgIC8vIFRPRE86IENsZWFuIHVwIGxvZyBkdXJpbmcgaW5pdGlhbGl6YXRpb24gcGhhc2UuXG4gICAgICAgICAgICB0aGlzLl9kZWxldGVkRmlsZXNbcGF0aC5zbGljZSgxKV0gPSBwYXRoLnNsaWNlKDAsIDEpID09PSAnZCc7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gT3BlbiB1cCB0aGUgZGVsZXRpb24gbG9nIGZvciBhcHBlbmRpbmcuXG4gICAgICAgIHRoaXMuX3dyaXRhYmxlLm9wZW4oZGVsZXRpb25Mb2dQYXRoLCBGaWxlRmxhZy5nZXRGaWxlRmxhZygnYScpLFxuICAgICAgICAgIDB4MWE0LCAoZXJyOiBBcGlFcnJvciwgZmQ/OiBmaWxlLkZpbGUpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjYihlcnIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9kZWxldGVMb2cgPSBmZDtcbiAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjYigpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpc1JlYWRPbmx5KCk6IGJvb2xlYW4geyByZXR1cm4gZmFsc2U7IH1cbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7IHJldHVybiB0cnVlOyB9XG4gIHB1YmxpYyBzdXBwb3J0c0xpbmtzKCk6IGJvb2xlYW4geyByZXR1cm4gZmFsc2U7IH1cbiAgcHVibGljIHN1cHBvcnRzUHJvcHMoKTogYm9vbGVhbiB7IHJldHVybiB0aGlzLl9yZWFkYWJsZS5zdXBwb3J0c1Byb3BzKCkgJiYgdGhpcy5fd3JpdGFibGUuc3VwcG9ydHNQcm9wcygpOyB9XG5cbiAgcHJpdmF0ZSBkZWxldGVQYXRoKHA6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuX2RlbGV0ZWRGaWxlc1twXSA9IHRydWU7XG4gICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKFwiZFwiICsgcCArIFwiXFxuXCIpO1xuICAgIHRoaXMuX2RlbGV0ZUxvZy53cml0ZVN5bmMoYnVmZiwgMCwgYnVmZi5sZW5ndGgsIG51bGwpO1xuICAgIHRoaXMuX2RlbGV0ZUxvZy5zeW5jU3luYygpO1xuICB9XG5cbiAgcHJpdmF0ZSB1bmRlbGV0ZVBhdGgocDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2RlbGV0ZWRGaWxlc1twXSkge1xuICAgICAgdGhpcy5fZGVsZXRlZEZpbGVzW3BdID0gZmFsc2U7XG4gICAgICB2YXIgYnVmZiA9IG5ldyBCdWZmZXIoXCJ1XCIgKyBwKTtcbiAgICAgIHRoaXMuX2RlbGV0ZUxvZy53cml0ZVN5bmMoYnVmZiwgMCwgYnVmZi5sZW5ndGgsIG51bGwpO1xuICAgICAgdGhpcy5fZGVsZXRlTG9nLnN5bmNTeW5jKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlbmFtZVN5bmMob2xkUGF0aDogc3RyaW5nLCBuZXdQYXRoOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAvLyBXcml0ZSBuZXdQYXRoIHVzaW5nIG9sZFBhdGgncyBjb250ZW50cywgZGVsZXRlIG9sZFBhdGguXG4gICAgdmFyIG9sZFN0YXRzID0gdGhpcy5zdGF0U3luYyhvbGRQYXRoLCBmYWxzZSk7XG4gICAgaWYgKG9sZFN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIC8vIE9wdGltaXphdGlvbjogRG9uJ3QgYm90aGVyIG1vdmluZyBpZiBvbGQgPT09IG5ldy5cbiAgICAgIGlmIChvbGRQYXRoID09PSBuZXdQYXRoKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdmFyIG1vZGUgPSAweDFmZjtcbiAgICAgIGlmICh0aGlzLmV4aXN0c1N5bmMobmV3UGF0aCkpIHtcbiAgICAgICAgdmFyIHN0YXRzID0gdGhpcy5zdGF0U3luYyhuZXdQYXRoLCBmYWxzZSksXG4gICAgICAgICAgbW9kZSA9IHN0YXRzLm1vZGU7XG4gICAgICAgIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgaWYgKHRoaXMucmVhZGRpclN5bmMobmV3UGF0aCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVEVNUFRZKG5ld1BhdGgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBBcGlFcnJvci5FTk9URElSKG5ld1BhdGgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFRha2UgY2FyZSBvZiB3cml0YWJsZSBmaXJzdC4gTW92ZSBhbnkgZmlsZXMgdGhlcmUsIG9yIGNyZWF0ZSBhbiBlbXB0eSBkaXJlY3RvcnlcbiAgICAgIC8vIGlmIGl0IGRvZXNuJ3QgZXhpc3QuXG4gICAgICBpZiAodGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhvbGRQYXRoKSkge1xuICAgICAgICB0aGlzLl93cml0YWJsZS5yZW5hbWVTeW5jKG9sZFBhdGgsIG5ld1BhdGgpO1xuICAgICAgfSBlbHNlIGlmICghdGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhuZXdQYXRoKSkge1xuICAgICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMobmV3UGF0aCwgbW9kZSk7XG4gICAgICB9XG5cbiAgICAgIC8vIE5lZWQgdG8gbW92ZSAqZXZlcnkgZmlsZS9mb2xkZXIqIGN1cnJlbnRseSBzdG9yZWQgb24gcmVhZGFibGUgdG8gaXRzIG5ldyBsb2NhdGlvblxuICAgICAgLy8gb24gd3JpdGFibGUuXG4gICAgICBpZiAodGhpcy5fcmVhZGFibGUuZXhpc3RzU3luYyhvbGRQYXRoKSkge1xuICAgICAgICB0aGlzLl9yZWFkYWJsZS5yZWFkZGlyU3luYyhvbGRQYXRoKS5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgICAgICAgLy8gUmVjdXJzaW9uISBTaG91bGQgd29yayBmb3IgYW55IG5lc3RlZCBmaWxlcyAvIGZvbGRlcnMuXG4gICAgICAgICAgdGhpcy5yZW5hbWVTeW5jKHBhdGgucmVzb2x2ZShvbGRQYXRoLCBuYW1lKSwgcGF0aC5yZXNvbHZlKG5ld1BhdGgsIG5hbWUpKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmV4aXN0c1N5bmMobmV3UGF0aCkgJiYgdGhpcy5zdGF0U3luYyhuZXdQYXRoLCBmYWxzZSkuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICB0aHJvdyBBcGlFcnJvci5FSVNESVIobmV3UGF0aCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMud3JpdGVGaWxlU3luYyhuZXdQYXRoLFxuICAgICAgICB0aGlzLnJlYWRGaWxlU3luYyhvbGRQYXRoLCBudWxsLCBGaWxlRmxhZy5nZXRGaWxlRmxhZygncicpKSwgbnVsbCxcbiAgICAgICAgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3cnKSwgb2xkU3RhdHMubW9kZSk7XG4gICAgfVxuXG4gICAgaWYgKG9sZFBhdGggIT09IG5ld1BhdGggJiYgdGhpcy5leGlzdHNTeW5jKG9sZFBhdGgpKSB7XG4gICAgICB0aGlzLnVubGlua1N5bmMob2xkUGF0aCk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBzdGF0U3luYyhwOiBzdHJpbmcsIGlzTHN0YXQ6IGJvb2xlYW4pOiBTdGF0cyB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiB0aGlzLl93cml0YWJsZS5zdGF0U3luYyhwLCBpc0xzdGF0KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAodGhpcy5fZGVsZXRlZEZpbGVzW3BdKSB7XG4gICAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwKTtcbiAgICAgIH1cbiAgICAgIHZhciBvbGRTdGF0ID0gdGhpcy5fcmVhZGFibGUuc3RhdFN5bmMocCwgaXNMc3RhdCkuY2xvbmUoKTtcbiAgICAgIC8vIE1ha2UgdGhlIG9sZFN0YXQncyBtb2RlIHdyaXRhYmxlLiBQcmVzZXJ2ZSB0aGUgdG9wbW9zdCBwYXJ0IG9mIHRoZVxuICAgICAgLy8gbW9kZSwgd2hpY2ggc3BlY2lmaWVzIGlmIGl0IGlzIGEgZmlsZSBvciBhIGRpcmVjdG9yeS5cbiAgICAgIG9sZFN0YXQubW9kZSA9IG1ha2VNb2RlV3JpdGFibGUob2xkU3RhdC5tb2RlKTtcbiAgICAgIHJldHVybiBvbGRTdGF0O1xuICAgIH1cbiAgfVxuICBwdWJsaWMgb3BlblN5bmMocDogc3RyaW5nLCBmbGFnOiBGaWxlRmxhZywgbW9kZTogbnVtYmVyKTogZmlsZS5GaWxlIHtcbiAgICBpZiAodGhpcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICBzd2l0Y2ggKGZsYWcucGF0aEV4aXN0c0FjdGlvbigpKSB7XG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5UUlVOQ0FURV9GSUxFOlxuICAgICAgICAgIHRoaXMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMocCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlLm9wZW5TeW5jKHAsIGZsYWcsIG1vZGUpO1xuICAgICAgICBjYXNlIEFjdGlvblR5cGUuTk9QOlxuICAgICAgICAgIGlmICh0aGlzLl93cml0YWJsZS5leGlzdHNTeW5jKHApKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGUub3BlblN5bmMocCwgZmxhZywgbW9kZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBPdmVybGF5RmlsZS5cbiAgICAgICAgICAgIHZhciBzdGF0cyA9IHRoaXMuX3JlYWRhYmxlLnN0YXRTeW5jKHAsIGZhbHNlKS5jbG9uZSgpO1xuICAgICAgICAgICAgc3RhdHMubW9kZSA9IG1vZGU7XG4gICAgICAgICAgICByZXR1cm4gbmV3IE92ZXJsYXlGaWxlKHRoaXMsIHAsIGZsYWcsIHN0YXRzLCB0aGlzLl9yZWFkYWJsZS5yZWFkRmlsZVN5bmMocCwgbnVsbCwgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3InKSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBBcGlFcnJvci5FRVhJU1QocCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHN3aXRjaChmbGFnLnBhdGhOb3RFeGlzdHNBY3Rpb24oKSkge1xuICAgICAgICBjYXNlIEFjdGlvblR5cGUuQ1JFQVRFX0ZJTEU6XG4gICAgICAgICAgdGhpcy5jcmVhdGVQYXJlbnREaXJlY3RvcmllcyhwKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGUub3BlblN5bmMocCwgZmxhZywgbW9kZSk7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBwdWJsaWMgdW5saW5rU3luYyhwOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5leGlzdHNTeW5jKHApKSB7XG4gICAgICBpZiAodGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwKSkge1xuICAgICAgICB0aGlzLl93cml0YWJsZS51bmxpbmtTeW5jKHApO1xuICAgICAgfVxuXG4gICAgICAvLyBEb2VzIGl0IHN0aWxsIGV4aXN0P1xuICAgICAgaWYgKHRoaXMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgICAvLyBBZGQgdG8gZGVsZXRlIGxvZy5cbiAgICAgICAgdGhpcy5kZWxldGVQYXRoKHApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FTk9FTlQocCk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBybWRpclN5bmMocDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgaWYgKHRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgdGhpcy5fd3JpdGFibGUucm1kaXJTeW5jKHApO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgICAvLyBDaGVjayBpZiBkaXJlY3RvcnkgaXMgZW1wdHkuXG4gICAgICAgIGlmICh0aGlzLnJlYWRkaXJTeW5jKHApLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB0aHJvdyBBcGlFcnJvci5FTk9URU1QVFkocCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5kZWxldGVQYXRoKHApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwKTtcbiAgICB9XG4gIH1cbiAgcHVibGljIG1rZGlyU3luYyhwOiBzdHJpbmcsIG1vZGU6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVFWElTVChwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVGhlIGJlbG93IHdpbGwgdGhyb3cgc2hvdWxkIGFueSBvZiB0aGUgcGFyZW50IGRpcmVjdG9yaWVzIGZhaWwgdG8gZXhpc3RcbiAgICAgIC8vIG9uIF93cml0YWJsZS5cbiAgICAgIHRoaXMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMocCk7XG4gICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMocCwgbW9kZSk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyByZWFkZGlyU3luYyhwOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgdmFyIGRpclN0YXRzID0gdGhpcy5zdGF0U3luYyhwLCBmYWxzZSk7XG4gICAgaWYgKCFkaXJTdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBBcGlFcnJvci5FTk9URElSKHApO1xuICAgIH1cblxuICAgIC8vIFJlYWRkaXIgaW4gYm90aCwgbWVyZ2UsIGNoZWNrIGRlbGV0ZSBsb2cgb24gZWFjaCBmaWxlLCByZXR1cm4uXG4gICAgdmFyIGNvbnRlbnRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHRyeSB7XG4gICAgICBjb250ZW50cyA9IGNvbnRlbnRzLmNvbmNhdCh0aGlzLl93cml0YWJsZS5yZWFkZGlyU3luYyhwKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgY29udGVudHMgPSBjb250ZW50cy5jb25jYXQodGhpcy5fcmVhZGFibGUucmVhZGRpclN5bmMocCkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICB9XG4gICAgdmFyIHNlZW5NYXA6IHtbbmFtZTogc3RyaW5nXTogYm9vbGVhbn0gPSB7fTtcbiAgICByZXR1cm4gY29udGVudHMuZmlsdGVyKChmaWxlUDogc3RyaW5nKSA9PiB7XG4gICAgICB2YXIgcmVzdWx0ID0gc2Vlbk1hcFtmaWxlUF0gPT09IHVuZGVmaW5lZCAmJiB0aGlzLl9kZWxldGVkRmlsZXNbcCArIFwiL1wiICsgZmlsZVBdICE9PSB0cnVlO1xuICAgICAgc2Vlbk1hcFtmaWxlUF0gPSB0cnVlO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgZXhpc3RzU3luYyhwOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwKSB8fCAodGhpcy5fcmVhZGFibGUuZXhpc3RzU3luYyhwKSAmJiB0aGlzLl9kZWxldGVkRmlsZXNbcF0gIT09IHRydWUpO1xuICB9XG4gIHB1YmxpYyBjaG1vZFN5bmMocDogc3RyaW5nLCBpc0xjaG1vZDogYm9vbGVhbiwgbW9kZTogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5vcGVyYXRlT25Xcml0YWJsZShwLCAoKSA9PiB7XG4gICAgICB0aGlzLl93cml0YWJsZS5jaG1vZFN5bmMocCwgaXNMY2htb2QsIG1vZGUpO1xuICAgIH0pO1xuICB9XG4gIHB1YmxpYyBjaG93blN5bmMocDogc3RyaW5nLCBpc0xjaG93bjogYm9vbGVhbiwgdWlkOiBudW1iZXIsIGdpZDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5vcGVyYXRlT25Xcml0YWJsZShwLCAoKSA9PiB7XG4gICAgICB0aGlzLl93cml0YWJsZS5jaG93blN5bmMocCwgaXNMY2hvd24sIHVpZCwgZ2lkKTtcbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgdXRpbWVzU3luYyhwOiBzdHJpbmcsIGF0aW1lOiBEYXRlLCBtdGltZTogRGF0ZSk6IHZvaWQge1xuICAgIHRoaXMub3BlcmF0ZU9uV3JpdGFibGUocCwgKCkgPT4ge1xuICAgICAgdGhpcy5fd3JpdGFibGUudXRpbWVzU3luYyhwLCBhdGltZSwgbXRpbWUpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEhlbHBlciBmdW5jdGlvbjpcbiAgICogLSBFbnN1cmVzIHAgaXMgb24gd3JpdGFibGUgYmVmb3JlIHByb2NlZWRpbmcuIFRocm93cyBhbiBlcnJvciBpZiBpdCBkb2Vzbid0IGV4aXN0LlxuICAgKiAtIENhbGxzIGYgdG8gcGVyZm9ybSBvcGVyYXRpb24gb24gd3JpdGFibGUuXG4gICAqL1xuICBwcml2YXRlIG9wZXJhdGVPbldyaXRhYmxlKHA6IHN0cmluZywgZjogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgIGlmICghdGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwKSkge1xuICAgICAgICAvLyBGaWxlIGlzIG9uIHJlYWRhYmxlIHN0b3JhZ2UuIENvcHkgdG8gd3JpdGFibGUgc3RvcmFnZSBiZWZvcmVcbiAgICAgICAgLy8gY2hhbmdpbmcgaXRzIG1vZGUuXG4gICAgICAgIHRoaXMuY29weVRvV3JpdGFibGUocCk7XG4gICAgICB9XG4gICAgICBmKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29weSBmcm9tIHJlYWRhYmxlIHRvIHdyaXRhYmxlIHN0b3JhZ2UuXG4gICAqIFBSRUNPTkRJVElPTjogRmlsZSBkb2VzIG5vdCBleGlzdCBvbiB3cml0YWJsZSBzdG9yYWdlLlxuICAgKi9cbiAgcHJpdmF0ZSBjb3B5VG9Xcml0YWJsZShwOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB2YXIgcFN0YXRzID0gdGhpcy5zdGF0U3luYyhwLCBmYWxzZSk7XG4gICAgaWYgKHBTdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMocCwgcFN0YXRzLm1vZGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndyaXRlRmlsZVN5bmMocCxcbiAgICAgICAgdGhpcy5fcmVhZGFibGUucmVhZEZpbGVTeW5jKHAsIG51bGwsIEZpbGVGbGFnLmdldEZpbGVGbGFnKCdyJykpLCBudWxsLFxuICAgICAgICBGaWxlRmxhZy5nZXRGaWxlRmxhZygndycpLCB0aGlzLnN0YXRTeW5jKHAsIGZhbHNlKS5tb2RlKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==