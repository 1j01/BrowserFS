var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var preload_file = require('../generic/preload_file');
var file_system = require('../core/file_system');
var api_error_1 = require('../core/api_error');
var file_flag_1 = require('../core/file_flag');
var node_fs_stats_1 = require('../core/node_fs_stats');
var path = require('path');
var global = require('../core/global');
var async = require('async');
var util_1 = require('../core/util');
function isDirectoryEntry(entry) {
    return entry.isDirectory;
}
var _getFS = global.webkitRequestFileSystem || global.requestFileSystem || null;
function _requestQuota(type, size, success, errorCallback) {
    if (typeof navigator['webkitPersistentStorage'] !== 'undefined') {
        switch (type) {
            case global.PERSISTENT:
                navigator.webkitPersistentStorage.requestQuota(size, success, errorCallback);
                break;
            case global.TEMPORARY:
                navigator.webkitTemporaryStorage.requestQuota(size, success, errorCallback);
                break;
            default:
                errorCallback(new TypeError("Invalid storage type: " + type));
                break;
        }
    }
    else {
        global.webkitStorageInfo.requestQuota(type, size, success, errorCallback);
    }
}
function _toArray(list) {
    return Array.prototype.slice.call(list || [], 0);
}
var HTML5FSFile = (function (_super) {
    __extends(HTML5FSFile, _super);
    function HTML5FSFile(_fs, _path, _flag, _stat, contents) {
        _super.call(this, _fs, _path, _flag, _stat, contents);
    }
    HTML5FSFile.prototype.sync = function (cb) {
        var _this = this;
        if (this.isDirty()) {
            var opts = {
                create: false
            };
            var _fs = this._fs;
            var success = function (entry) {
                entry.createWriter(function (writer) {
                    var buffer = _this.getBuffer();
                    var blob = new Blob([util_1.buffer2ArrayBuffer(buffer)]);
                    var length = blob.size;
                    writer.onwriteend = function () {
                        writer.onwriteend = null;
                        writer.truncate(length);
                        _this.resetDirty();
                        cb();
                    };
                    writer.onerror = function (err) {
                        cb(_fs.convert(err, _this.getPath(), false));
                    };
                    writer.write(blob);
                });
            };
            var error = function (err) {
                cb(_fs.convert(err, _this.getPath(), false));
            };
            _fs.fs.root.getFile(this.getPath(), opts, success, error);
        }
        else {
            cb();
        }
    };
    HTML5FSFile.prototype.close = function (cb) {
        this.sync(cb);
    };
    return HTML5FSFile;
})(preload_file.PreloadFile);
exports.HTML5FSFile = HTML5FSFile;
var HTML5FS = (function (_super) {
    __extends(HTML5FS, _super);
    function HTML5FS(size, type) {
        if (size === void 0) { size = 5; }
        if (type === void 0) { type = global.PERSISTENT; }
        _super.call(this);
        this.size = 1024 * 1024 * size;
        this.type = type;
    }
    HTML5FS.prototype.getName = function () {
        return 'HTML5 FileSystem';
    };
    HTML5FS.isAvailable = function () {
        return _getFS != null;
    };
    HTML5FS.prototype.isReadOnly = function () {
        return false;
    };
    HTML5FS.prototype.supportsSymlinks = function () {
        return false;
    };
    HTML5FS.prototype.supportsProps = function () {
        return false;
    };
    HTML5FS.prototype.supportsSynch = function () {
        return false;
    };
    HTML5FS.prototype.convert = function (err, p, expectedDir) {
        switch (err.name) {
            case "PathExistsError":
                return api_error_1.ApiError.EEXIST(p);
            case 'QuotaExceededError':
                return api_error_1.ApiError.FileError(api_error_1.ErrorCode.ENOSPC, p);
            case 'NotFoundError':
                return api_error_1.ApiError.ENOENT(p);
            case 'SecurityError':
                return api_error_1.ApiError.FileError(api_error_1.ErrorCode.EACCES, p);
            case 'InvalidModificationError':
                return api_error_1.ApiError.FileError(api_error_1.ErrorCode.EPERM, p);
            case 'TypeMismatchError':
                return api_error_1.ApiError.FileError(expectedDir ? api_error_1.ErrorCode.ENOTDIR : api_error_1.ErrorCode.EISDIR, p);
            case "EncodingError":
            case "InvalidStateError":
            case "NoModificationAllowedError":
            default:
                return api_error_1.ApiError.FileError(api_error_1.ErrorCode.EINVAL, p);
        }
    };
    HTML5FS.prototype.allocate = function (cb) {
        var _this = this;
        if (cb === void 0) { cb = function () { }; }
        var success = function (fs) {
            _this.fs = fs;
            cb();
        };
        var error = function (err) {
            cb(_this.convert(err, "/", true));
        };
        if (this.type === global.PERSISTENT) {
            _requestQuota(this.type, this.size, function (granted) {
                _getFS(_this.type, granted, success, error);
            }, error);
        }
        else {
            _getFS(this.type, this.size, success, error);
        }
    };
    HTML5FS.prototype.empty = function (mainCb) {
        var _this = this;
        this._readdir('/', function (err, entries) {
            if (err) {
                console.error('Failed to empty FS');
                mainCb(err);
            }
            else {
                var finished = function (er) {
                    if (err) {
                        console.error("Failed to empty FS");
                        mainCb(err);
                    }
                    else {
                        mainCb();
                    }
                };
                var deleteEntry = function (entry, cb) {
                    var succ = function () {
                        cb();
                    };
                    var error = function (err) {
                        cb(_this.convert(err, entry.fullPath, !entry.isDirectory));
                    };
                    if (isDirectoryEntry(entry)) {
                        entry.removeRecursively(succ, error);
                    }
                    else {
                        entry.remove(succ, error);
                    }
                };
                async.each(entries, deleteEntry, finished);
            }
        });
    };
    HTML5FS.prototype.rename = function (oldPath, newPath, cb) {
        var _this = this;
        var semaphore = 2, successCount = 0, root = this.fs.root, currentPath = oldPath, error = function (err) {
            if (--semaphore <= 0) {
                cb(_this.convert(err, currentPath, false));
            }
        }, success = function (file) {
            if (++successCount === 2) {
                return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Something was identified as both a file and a directory. This should never happen."));
            }
            if (oldPath === newPath) {
                return cb();
            }
            currentPath = path.dirname(newPath);
            root.getDirectory(currentPath, {}, function (parentDir) {
                currentPath = path.basename(newPath);
                file.moveTo(parentDir, currentPath, function (entry) { cb(); }, function (err) {
                    if (file.isDirectory) {
                        currentPath = newPath;
                        _this.unlink(newPath, function (e) {
                            if (e) {
                                error(err);
                            }
                            else {
                                _this.rename(oldPath, newPath, cb);
                            }
                        });
                    }
                    else {
                        error(err);
                    }
                });
            }, error);
        };
        root.getFile(oldPath, {}, success, error);
        root.getDirectory(oldPath, {}, success, error);
    };
    HTML5FS.prototype.stat = function (path, isLstat, cb) {
        var _this = this;
        var opts = {
            create: false
        };
        var loadAsFile = function (entry) {
            var fileFromEntry = function (file) {
                var stat = new node_fs_stats_1.Stats(node_fs_stats_1.FileType.FILE, file.size);
                cb(null, stat);
            };
            entry.file(fileFromEntry, failedToLoad);
        };
        var loadAsDir = function (dir) {
            var size = 4096;
            var stat = new node_fs_stats_1.Stats(node_fs_stats_1.FileType.DIRECTORY, size);
            cb(null, stat);
        };
        var failedToLoad = function (err) {
            cb(_this.convert(err, path, false));
        };
        var failedToLoadAsFile = function () {
            _this.fs.root.getDirectory(path, opts, loadAsDir, failedToLoad);
        };
        this.fs.root.getFile(path, opts, loadAsFile, failedToLoadAsFile);
    };
    HTML5FS.prototype.open = function (p, flags, mode, cb) {
        var _this = this;
        var error = function (err) {
            if (err.name === 'InvalidModificationError' && flags.isExclusive()) {
                cb(api_error_1.ApiError.EEXIST(p));
            }
            else {
                cb(_this.convert(err, p, false));
            }
        };
        this.fs.root.getFile(p, {
            create: flags.pathNotExistsAction() === file_flag_1.ActionType.CREATE_FILE,
            exclusive: flags.isExclusive()
        }, function (entry) {
            entry.file(function (file) {
                var reader = new FileReader();
                reader.onloadend = function (event) {
                    var bfs_file = _this._makeFile(p, flags, file, reader.result);
                    cb(null, bfs_file);
                };
                reader.onerror = function (ev) {
                    error(reader.error);
                };
                reader.readAsArrayBuffer(file);
            }, error);
        }, error);
    };
    HTML5FS.prototype._statType = function (stat) {
        return stat.isFile ? node_fs_stats_1.FileType.FILE : node_fs_stats_1.FileType.DIRECTORY;
    };
    HTML5FS.prototype._makeFile = function (path, flag, stat, data) {
        if (data === void 0) { data = new ArrayBuffer(0); }
        var stats = new node_fs_stats_1.Stats(node_fs_stats_1.FileType.FILE, stat.size);
        var buffer = util_1.arrayBuffer2Buffer(data);
        return new HTML5FSFile(this, path, flag, stats, buffer);
    };
    HTML5FS.prototype._remove = function (path, cb, isFile) {
        var _this = this;
        var success = function (entry) {
            var succ = function () {
                cb();
            };
            var err = function (err) {
                cb(_this.convert(err, path, !isFile));
            };
            entry.remove(succ, err);
        };
        var error = function (err) {
            cb(_this.convert(err, path, !isFile));
        };
        var opts = {
            create: false
        };
        if (isFile) {
            this.fs.root.getFile(path, opts, success, error);
        }
        else {
            this.fs.root.getDirectory(path, opts, success, error);
        }
    };
    HTML5FS.prototype.unlink = function (path, cb) {
        this._remove(path, cb, true);
    };
    HTML5FS.prototype.rmdir = function (path, cb) {
        this._remove(path, cb, false);
    };
    HTML5FS.prototype.mkdir = function (path, mode, cb) {
        var _this = this;
        var opts = {
            create: true,
            exclusive: true
        };
        var success = function (dir) {
            cb();
        };
        var error = function (err) {
            cb(_this.convert(err, path, true));
        };
        this.fs.root.getDirectory(path, opts, success, error);
    };
    HTML5FS.prototype._readdir = function (path, cb) {
        var _this = this;
        var error = function (err) {
            cb(_this.convert(err, path, true));
        };
        this.fs.root.getDirectory(path, { create: false }, function (dirEntry) {
            var reader = dirEntry.createReader();
            var entries = [];
            var readEntries = function () {
                reader.readEntries((function (results) {
                    if (results.length) {
                        entries = entries.concat(_toArray(results));
                        readEntries();
                    }
                    else {
                        cb(null, entries);
                    }
                }), error);
            };
            readEntries();
        }, error);
    };
    HTML5FS.prototype.readdir = function (path, cb) {
        this._readdir(path, function (e, entries) {
            if (e) {
                return cb(e);
            }
            var rv = [];
            for (var i = 0; i < entries.length; i++) {
                rv.push(entries[i].name);
            }
            cb(null, rv);
        });
    };
    return HTML5FS;
})(file_system.BaseFileSystem);
exports.__esModule = true;
exports["default"] = HTML5FS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSFRNTDVGUy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9iYWNrZW5kL0hUTUw1RlMudHMiXSwibmFtZXMiOlsiaXNEaXJlY3RvcnlFbnRyeSIsIl9yZXF1ZXN0UXVvdGEiLCJfdG9BcnJheSIsIkhUTUw1RlNGaWxlIiwiSFRNTDVGU0ZpbGUuY29uc3RydWN0b3IiLCJIVE1MNUZTRmlsZS5zeW5jIiwiSFRNTDVGU0ZpbGUuY2xvc2UiLCJIVE1MNUZTIiwiSFRNTDVGUy5jb25zdHJ1Y3RvciIsIkhUTUw1RlMuZ2V0TmFtZSIsIkhUTUw1RlMuaXNBdmFpbGFibGUiLCJIVE1MNUZTLmlzUmVhZE9ubHkiLCJIVE1MNUZTLnN1cHBvcnRzU3ltbGlua3MiLCJIVE1MNUZTLnN1cHBvcnRzUHJvcHMiLCJIVE1MNUZTLnN1cHBvcnRzU3luY2giLCJIVE1MNUZTLmNvbnZlcnQiLCJIVE1MNUZTLmFsbG9jYXRlIiwiSFRNTDVGUy5lbXB0eSIsIkhUTUw1RlMucmVuYW1lIiwiSFRNTDVGUy5zdGF0IiwiSFRNTDVGUy5vcGVuIiwiSFRNTDVGUy5fc3RhdFR5cGUiLCJIVE1MNUZTLl9tYWtlRmlsZSIsIkhUTUw1RlMuX3JlbW92ZSIsIkhUTUw1RlMudW5saW5rIiwiSFRNTDVGUy5ybWRpciIsIkhUTUw1RlMubWtkaXIiLCJIVE1MNUZTLl9yZWFkZGlyIiwiSFRNTDVGUy5yZWFkZGlyIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLElBQU8sWUFBWSxXQUFXLHlCQUF5QixDQUFDLENBQUM7QUFDekQsSUFBTyxXQUFXLFdBQVcscUJBQXFCLENBQUMsQ0FBQztBQUNwRCwwQkFBa0MsbUJBQW1CLENBQUMsQ0FBQTtBQUN0RCwwQkFBbUMsbUJBQW1CLENBQUMsQ0FBQTtBQUN2RCw4QkFBOEIsdUJBQXVCLENBQUMsQ0FBQTtBQUV0RCxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUM5QixJQUFPLE1BQU0sV0FBVyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzFDLElBQU8sS0FBSyxXQUFXLE9BQU8sQ0FBQyxDQUFDO0FBQ2hDLHFCQUFxRCxjQUFjLENBQUMsQ0FBQTtBQUVwRSwwQkFBMEIsS0FBWTtJQUNwQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsV0FBV0EsQ0FBQ0E7QUFDM0JBLENBQUNBO0FBRUQsSUFBSSxNQUFNLEdBQTJHLE1BQU0sQ0FBQyx1QkFBdUIsSUFBSSxNQUFNLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDO0FBRXhMLHVCQUF1QixJQUFZLEVBQUUsSUFBWSxFQUFFLE9BQStCLEVBQUUsYUFBNEI7SUFNOUdDLEVBQUVBLENBQUNBLENBQUNBLE9BQWNBLFNBQVVBLENBQUNBLHlCQUF5QkEsQ0FBQ0EsS0FBS0EsV0FBV0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDeEVBLE1BQU1BLENBQUFBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ1pBLEtBQUtBLE1BQU1BLENBQUNBLFVBQVVBO2dCQUNiQSxTQUFVQSxDQUFDQSx1QkFBdUJBLENBQUNBLFlBQVlBLENBQUNBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLGFBQWFBLENBQUNBLENBQUNBO2dCQUNyRkEsS0FBS0EsQ0FBQ0E7WUFDUkEsS0FBS0EsTUFBTUEsQ0FBQ0EsU0FBU0E7Z0JBQ1pBLFNBQVVBLENBQUNBLHNCQUFzQkEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsSUFBSUEsRUFBRUEsT0FBT0EsRUFBRUEsYUFBYUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ3BGQSxLQUFLQSxDQUFBQTtZQUNQQTtnQkFDRUEsYUFBYUEsQ0FBQ0EsSUFBSUEsU0FBU0EsQ0FBQ0EsMkJBQXlCQSxJQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDOURBLEtBQUtBLENBQUNBO1FBQ1ZBLENBQUNBO0lBQ0hBLENBQUNBO0lBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ0NBLE1BQU9BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsRUFBRUEsT0FBT0EsRUFBRUEsYUFBYUEsQ0FBQ0EsQ0FBQ0E7SUFDcEZBLENBQUNBO0FBQ0hBLENBQUNBO0FBRUQsa0JBQWtCLElBQVk7SUFDNUJDLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLElBQUlBLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO0FBQ25EQSxDQUFDQTtBQVVEO0lBQWlDQywrQkFBaUNBO0lBQ2hFQSxxQkFBWUEsR0FBWUEsRUFBRUEsS0FBYUEsRUFBRUEsS0FBZUEsRUFBRUEsS0FBWUEsRUFBRUEsUUFBcUJBO1FBQzNGQyxrQkFBTUEsR0FBR0EsRUFBRUEsS0FBS0EsRUFBRUEsS0FBS0EsRUFBRUEsS0FBS0EsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDNUNBLENBQUNBO0lBRU1ELDBCQUFJQSxHQUFYQSxVQUFZQSxFQUEwQkE7UUFBdENFLGlCQStCQ0E7UUE5QkNBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBRW5CQSxJQUFJQSxJQUFJQSxHQUFHQTtnQkFDVEEsTUFBTUEsRUFBRUEsS0FBS0E7YUFDZEEsQ0FBQ0E7WUFDRkEsSUFBSUEsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0E7WUFDbkJBLElBQUlBLE9BQU9BLEdBQXNCQSxVQUFDQSxLQUFLQTtnQkFDckNBLEtBQUtBLENBQUNBLFlBQVlBLENBQUNBLFVBQUNBLE1BQU1BO29CQUN4QkEsSUFBSUEsTUFBTUEsR0FBR0EsS0FBSUEsQ0FBQ0EsU0FBU0EsRUFBRUEsQ0FBQ0E7b0JBQzlCQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxJQUFJQSxDQUFDQSxDQUFDQSx5QkFBa0JBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUNsREEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7b0JBQ3ZCQSxNQUFNQSxDQUFDQSxVQUFVQSxHQUFHQTt3QkFDbEJBLE1BQU1BLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBO3dCQUN6QkEsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7d0JBQ3hCQSxLQUFJQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQTt3QkFDbEJBLEVBQUVBLEVBQUVBLENBQUNBO29CQUNQQSxDQUFDQSxDQUFDQTtvQkFDRkEsTUFBTUEsQ0FBQ0EsT0FBT0EsR0FBR0EsVUFBQ0EsR0FBYUE7d0JBQzdCQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxFQUFFQSxLQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDOUNBLENBQUNBLENBQUNBO29CQUNGQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDckJBLENBQUNBLENBQUNBLENBQUNBO1lBQ0xBLENBQUNBLENBQUNBO1lBQ0ZBLElBQUlBLEtBQUtBLEdBQUdBLFVBQUNBLEdBQWFBO2dCQUN4QkEsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsS0FBSUEsQ0FBQ0EsT0FBT0EsRUFBRUEsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDOUNBLENBQUNBLENBQUNBO1lBQ0ZBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLEVBQUVBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBQzVEQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNOQSxFQUFFQSxFQUFFQSxDQUFDQTtRQUNQQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUVNRiwyQkFBS0EsR0FBWkEsVUFBYUEsRUFBMEJBO1FBQ3JDRyxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtJQUNoQkEsQ0FBQ0E7SUFDSEgsa0JBQUNBO0FBQURBLENBQUNBLEFBekNELEVBQWlDLFlBQVksQ0FBQyxXQUFXLEVBeUN4RDtBQXpDWSxtQkFBVyxjQXlDdkIsQ0FBQTtBQUVEO0lBQXFDSSwyQkFBMEJBO0lBVTdEQSxpQkFBWUEsSUFBZ0JBLEVBQUVBLElBQWdDQTtRQUFsREMsb0JBQWdCQSxHQUFoQkEsUUFBZ0JBO1FBQUVBLG9CQUFnQ0EsR0FBaENBLE9BQWVBLE1BQU1BLENBQUNBLFVBQVVBO1FBQzVEQSxpQkFBT0EsQ0FBQ0E7UUFFUkEsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDL0JBLElBQUlBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBO0lBQ25CQSxDQUFDQTtJQUVNRCx5QkFBT0EsR0FBZEE7UUFDRUUsTUFBTUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQTtJQUM1QkEsQ0FBQ0E7SUFFYUYsbUJBQVdBLEdBQXpCQTtRQUNFRyxNQUFNQSxDQUFDQSxNQUFNQSxJQUFJQSxJQUFJQSxDQUFDQTtJQUN4QkEsQ0FBQ0E7SUFFTUgsNEJBQVVBLEdBQWpCQTtRQUNFSSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtJQUNmQSxDQUFDQTtJQUVNSixrQ0FBZ0JBLEdBQXZCQTtRQUNFSyxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtJQUNmQSxDQUFDQTtJQUVNTCwrQkFBYUEsR0FBcEJBO1FBQ0VNLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2ZBLENBQUNBO0lBRU1OLCtCQUFhQSxHQUFwQkE7UUFDRU8sTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7SUFDZkEsQ0FBQ0E7SUFPTVAseUJBQU9BLEdBQWRBLFVBQWVBLEdBQWFBLEVBQUVBLENBQVNBLEVBQUVBLFdBQW9CQTtRQUMzRFEsTUFBTUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFHakJBLEtBQUtBLGlCQUFpQkE7Z0JBQ3BCQSxNQUFNQSxDQUFDQSxvQkFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFNUJBLEtBQUtBLG9CQUFvQkE7Z0JBQ3ZCQSxNQUFNQSxDQUFDQSxvQkFBUUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EscUJBQVNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBRWpEQSxLQUFLQSxlQUFlQTtnQkFDbEJBLE1BQU1BLENBQUNBLG9CQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUk1QkEsS0FBS0EsZUFBZUE7Z0JBQ2xCQSxNQUFNQSxDQUFDQSxvQkFBUUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EscUJBQVNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBSWpEQSxLQUFLQSwwQkFBMEJBO2dCQUM3QkEsTUFBTUEsQ0FBQ0Esb0JBQVFBLENBQUNBLFNBQVNBLENBQUNBLHFCQUFTQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUdoREEsS0FBS0EsbUJBQW1CQTtnQkFDdEJBLE1BQU1BLENBQUNBLG9CQUFRQSxDQUFDQSxTQUFTQSxDQUFDQSxXQUFXQSxHQUFHQSxxQkFBU0EsQ0FBQ0EsT0FBT0EsR0FBR0EscUJBQVNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBRW5GQSxLQUFLQSxlQUFlQSxDQUFDQTtZQUdyQkEsS0FBS0EsbUJBQW1CQSxDQUFDQTtZQUd6QkEsS0FBS0EsNEJBQTRCQSxDQUFDQTtZQUNsQ0E7Z0JBQ0VBLE1BQU1BLENBQUNBLG9CQUFRQSxDQUFDQSxTQUFTQSxDQUFDQSxxQkFBU0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbkRBLENBQUNBO0lBQ0hBLENBQUNBO0lBTU1SLDBCQUFRQSxHQUFmQSxVQUFnQkEsRUFBeUNBO1FBQXpEUyxpQkFlQ0E7UUFmZUEsa0JBQXlDQSxHQUF6Q0EsS0FBNkJBLGNBQVcsQ0FBQztRQUN2REEsSUFBSUEsT0FBT0EsR0FBR0EsVUFBQ0EsRUFBY0E7WUFDM0JBLEtBQUlBLENBQUNBLEVBQUVBLEdBQUdBLEVBQUVBLENBQUNBO1lBQ2JBLEVBQUVBLEVBQUVBLENBQUFBO1FBQ05BLENBQUNBLENBQUNBO1FBQ0ZBLElBQUlBLEtBQUtBLEdBQUdBLFVBQUNBLEdBQWlCQTtZQUM1QkEsRUFBRUEsQ0FBQ0EsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsR0FBR0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbkNBLENBQUNBLENBQUNBO1FBQ0ZBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLEtBQUtBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxVQUFDQSxPQUFlQTtnQkFDbERBLE1BQU1BLENBQUNBLEtBQUlBLENBQUNBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLE9BQU9BLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1lBQzdDQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUNaQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNOQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxPQUFPQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUMvQ0EsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFRTVQsdUJBQUtBLEdBQVpBLFVBQWFBLE1BQThCQTtRQUEzQ1UsaUJBbUNDQTtRQWpDQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsR0FBR0EsRUFBRUEsVUFBQ0EsR0FBYUEsRUFBRUEsT0FBaUJBO1lBQ2xEQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDUkEsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxDQUFDQTtnQkFDcENBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBQ2RBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUVOQSxJQUFJQSxRQUFRQSxHQUFHQSxVQUFDQSxFQUFPQTtvQkFDckJBLEVBQUVBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO3dCQUNSQSxPQUFPQSxDQUFDQSxLQUFLQSxDQUFDQSxvQkFBb0JBLENBQUNBLENBQUNBO3dCQUNwQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7b0JBQ2RBLENBQUNBO29CQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTt3QkFDTkEsTUFBTUEsRUFBRUEsQ0FBQ0E7b0JBQ1hBLENBQUNBO2dCQUNIQSxDQUFDQSxDQUFDQTtnQkFFRkEsSUFBSUEsV0FBV0EsR0FBR0EsVUFBQ0EsS0FBWUEsRUFBRUEsRUFBcUJBO29CQUNwREEsSUFBSUEsSUFBSUEsR0FBR0E7d0JBQ1RBLEVBQUVBLEVBQUVBLENBQUNBO29CQUNQQSxDQUFDQSxDQUFDQTtvQkFDRkEsSUFBSUEsS0FBS0EsR0FBR0EsVUFBQ0EsR0FBaUJBO3dCQUM1QkEsRUFBRUEsQ0FBQ0EsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsS0FBS0EsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQzVEQSxDQUFDQSxDQUFDQTtvQkFDRkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTt3QkFDNUJBLEtBQUtBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3ZDQSxDQUFDQTtvQkFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7d0JBQ05BLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO29CQUM1QkEsQ0FBQ0E7Z0JBQ0hBLENBQUNBLENBQUNBO2dCQUdGQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxXQUFXQSxFQUFFQSxRQUFRQSxDQUFDQSxDQUFDQTtZQUM3Q0EsQ0FBQ0E7UUFDSEEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFTVYsd0JBQU1BLEdBQWJBLFVBQWNBLE9BQWVBLEVBQUVBLE9BQWVBLEVBQUVBLEVBQTBCQTtRQUExRVcsaUJBbURDQTtRQWxEQ0EsSUFBSUEsU0FBU0EsR0FBV0EsQ0FBQ0EsRUFDdkJBLFlBQVlBLEdBQVdBLENBQUNBLEVBQ3hCQSxJQUFJQSxHQUFtQkEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsRUFDbkNBLFdBQVdBLEdBQVdBLE9BQU9BLEVBQzdCQSxLQUFLQSxHQUFHQSxVQUFDQSxHQUFpQkE7WUFDeEJBLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLFNBQVNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUNuQkEsRUFBRUEsQ0FBQ0EsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsV0FBV0EsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDOUNBLENBQUNBO1FBQ0hBLENBQUNBLEVBQ0RBLE9BQU9BLEdBQUdBLFVBQUNBLElBQVdBO1lBQ3BCQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxZQUFZQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDekJBLE1BQU1BLENBQUNBLEVBQUVBLENBQUNBLElBQUlBLG9CQUFRQSxDQUFDQSxxQkFBU0EsQ0FBQ0EsTUFBTUEsRUFBRUEsb0ZBQW9GQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsSUEsQ0FBQ0E7WUFJREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsS0FBS0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxNQUFNQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNkQSxDQUFDQTtZQUdEQSxXQUFXQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtZQUNwQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsV0FBV0EsRUFBRUEsRUFBRUEsRUFBRUEsVUFBQ0EsU0FBeUJBO2dCQUMzREEsV0FBV0EsR0FBR0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3JDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxTQUFTQSxFQUFFQSxXQUFXQSxFQUFFQSxVQUFDQSxLQUFZQSxJQUFhQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxVQUFDQSxHQUFpQkE7b0JBR3ZGQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTt3QkFDckJBLFdBQVdBLEdBQUdBLE9BQU9BLENBQUNBO3dCQUV0QkEsS0FBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsRUFBRUEsVUFBQ0EsQ0FBRUE7NEJBQ3RCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQ0FFTkEsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7NEJBQ2JBLENBQUNBOzRCQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQ0FFTkEsS0FBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsRUFBRUEsT0FBT0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7NEJBQ3BDQSxDQUFDQTt3QkFDSEEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ0xBLENBQUNBO29CQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTt3QkFDTkEsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7b0JBQ2JBLENBQUNBO2dCQUNIQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNMQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUNaQSxDQUFDQSxDQUFDQTtRQUlKQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxFQUFFQSxFQUFFQSxFQUFFQSxPQUFPQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUMxQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsT0FBT0EsRUFBRUEsRUFBRUEsRUFBRUEsT0FBT0EsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7SUFDakRBLENBQUNBO0lBRU1YLHNCQUFJQSxHQUFYQSxVQUFZQSxJQUFZQSxFQUFFQSxPQUFnQkEsRUFBRUEsRUFBeUNBO1FBQXJGWSxpQkFtQ0NBO1FBaENDQSxJQUFJQSxJQUFJQSxHQUFHQTtZQUNUQSxNQUFNQSxFQUFFQSxLQUFLQTtTQUNkQSxDQUFDQTtRQUVGQSxJQUFJQSxVQUFVQSxHQUFHQSxVQUFDQSxLQUFnQkE7WUFDaENBLElBQUlBLGFBQWFBLEdBQUdBLFVBQUNBLElBQVVBO2dCQUM3QkEsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEscUJBQUtBLENBQUNBLHdCQUFRQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDL0NBLEVBQUVBLENBQUNBLElBQUlBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQ2pCQSxDQUFDQSxDQUFDQTtZQUNGQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxFQUFFQSxZQUFZQSxDQUFDQSxDQUFDQTtRQUMxQ0EsQ0FBQ0EsQ0FBQ0E7UUFFRkEsSUFBSUEsU0FBU0EsR0FBR0EsVUFBQ0EsR0FBbUJBO1lBR2xDQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtZQUNoQkEsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEscUJBQUtBLENBQUNBLHdCQUFRQSxDQUFDQSxTQUFTQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUMvQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDakJBLENBQUNBLENBQUNBO1FBRUZBLElBQUlBLFlBQVlBLEdBQUdBLFVBQUNBLEdBQWlCQTtZQUNuQ0EsRUFBRUEsQ0FBQ0EsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBNEJBLENBQUNBLENBQUNBO1FBQ2hFQSxDQUFDQSxDQUFDQTtRQUdGQSxJQUFJQSxrQkFBa0JBLEdBQUdBO1lBQ3ZCQSxLQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxFQUFFQSxTQUFTQSxFQUFFQSxZQUFZQSxDQUFDQSxDQUFDQTtRQUNqRUEsQ0FBQ0EsQ0FBQ0E7UUFJRkEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsRUFBRUEsVUFBVUEsRUFBRUEsa0JBQWtCQSxDQUFDQSxDQUFDQTtJQUNuRUEsQ0FBQ0E7SUFFTVosc0JBQUlBLEdBQVhBLFVBQVlBLENBQVNBLEVBQUVBLEtBQWVBLEVBQUVBLElBQVlBLEVBQUVBLEVBQTBDQTtRQUFoR2EsaUJBMEJDQTtRQXpCQ0EsSUFBSUEsS0FBS0EsR0FBR0EsVUFBQ0EsR0FBYUE7WUFDeEJBLEVBQUVBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLEtBQUtBLDBCQUEwQkEsSUFBSUEsS0FBS0EsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25FQSxFQUFFQSxDQUFDQSxvQkFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDekJBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUNOQSxFQUFFQSxDQUFDQSxLQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsQ0EsQ0FBQ0E7UUFDSEEsQ0FBQ0EsQ0FBQ0E7UUFFRkEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsRUFBRUE7WUFDdEJBLE1BQU1BLEVBQUVBLEtBQUtBLENBQUNBLG1CQUFtQkEsRUFBRUEsS0FBS0Esc0JBQVVBLENBQUNBLFdBQVdBO1lBQzlEQSxTQUFTQSxFQUFFQSxLQUFLQSxDQUFDQSxXQUFXQSxFQUFFQTtTQUMvQkEsRUFBRUEsVUFBQ0EsS0FBZ0JBO1lBRWxCQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFDQSxJQUFVQTtnQkFDcEJBLElBQUlBLE1BQU1BLEdBQUdBLElBQUlBLFVBQVVBLEVBQUVBLENBQUNBO2dCQUM5QkEsTUFBTUEsQ0FBQ0EsU0FBU0EsR0FBR0EsVUFBQ0EsS0FBWUE7b0JBQzlCQSxJQUFJQSxRQUFRQSxHQUFHQSxLQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxFQUFFQSxJQUFJQSxFQUFnQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7b0JBQzNFQSxFQUFFQSxDQUFDQSxJQUFJQSxFQUFFQSxRQUFRQSxDQUFDQSxDQUFDQTtnQkFDckJBLENBQUNBLENBQUNBO2dCQUNGQSxNQUFNQSxDQUFDQSxPQUFPQSxHQUFHQSxVQUFDQSxFQUFTQTtvQkFDekJBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO2dCQUN0QkEsQ0FBQ0EsQ0FBQ0E7Z0JBQ0ZBLE1BQU1BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDakNBLENBQUNBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBQ1pBLENBQUNBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO0lBQ1pBLENBQUNBO0lBS09iLDJCQUFTQSxHQUFqQkEsVUFBa0JBLElBQVdBO1FBQzNCYyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSx3QkFBUUEsQ0FBQ0EsSUFBSUEsR0FBR0Esd0JBQVFBLENBQUNBLFNBQVNBLENBQUNBO0lBQzFEQSxDQUFDQTtJQU1PZCwyQkFBU0EsR0FBakJBLFVBQWtCQSxJQUFZQSxFQUFFQSxJQUFjQSxFQUFFQSxJQUFVQSxFQUFFQSxJQUFzQ0E7UUFBdENlLG9CQUFzQ0EsR0FBdENBLFdBQXdCQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNoR0EsSUFBSUEsS0FBS0EsR0FBR0EsSUFBSUEscUJBQUtBLENBQUNBLHdCQUFRQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNoREEsSUFBSUEsTUFBTUEsR0FBR0EseUJBQWtCQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUN0Q0EsTUFBTUEsQ0FBQ0EsSUFBSUEsV0FBV0EsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsRUFBRUEsS0FBS0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7SUFDMURBLENBQUNBO0lBUU9mLHlCQUFPQSxHQUFmQSxVQUFnQkEsSUFBWUEsRUFBRUEsRUFBMEJBLEVBQUVBLE1BQWVBO1FBQXpFZ0IsaUJBdUJDQTtRQXRCQ0EsSUFBSUEsT0FBT0EsR0FBR0EsVUFBQ0EsS0FBWUE7WUFDekJBLElBQUlBLElBQUlBLEdBQUdBO2dCQUNUQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNQQSxDQUFDQSxDQUFDQTtZQUNGQSxJQUFJQSxHQUFHQSxHQUFHQSxVQUFDQSxHQUFpQkE7Z0JBQzFCQSxFQUFFQSxDQUFDQSxLQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxFQUFFQSxJQUFJQSxFQUFFQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN2Q0EsQ0FBQ0EsQ0FBQ0E7WUFDRkEsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDMUJBLENBQUNBLENBQUNBO1FBQ0ZBLElBQUlBLEtBQUtBLEdBQUdBLFVBQUNBLEdBQWlCQTtZQUM1QkEsRUFBRUEsQ0FBQ0EsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsSUFBSUEsRUFBRUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDdkNBLENBQUNBLENBQUNBO1FBRUZBLElBQUlBLElBQUlBLEdBQUdBO1lBQ1RBLE1BQU1BLEVBQUVBLEtBQUtBO1NBQ2RBLENBQUNBO1FBRUZBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO1lBQ1hBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLEVBQUVBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBQ25EQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNOQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxFQUFFQSxPQUFPQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUN4REEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFFTWhCLHdCQUFNQSxHQUFiQSxVQUFjQSxJQUFZQSxFQUFFQSxFQUEwQkE7UUFDcERpQixJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxFQUFFQSxFQUFFQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUMvQkEsQ0FBQ0E7SUFFTWpCLHVCQUFLQSxHQUFaQSxVQUFhQSxJQUFZQSxFQUFFQSxFQUEwQkE7UUFDbkRrQixJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxFQUFFQSxFQUFFQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtJQUNoQ0EsQ0FBQ0E7SUFFTWxCLHVCQUFLQSxHQUFaQSxVQUFhQSxJQUFZQSxFQUFFQSxJQUFZQSxFQUFFQSxFQUEwQkE7UUFBbkVtQixpQkFjQ0E7UUFYQ0EsSUFBSUEsSUFBSUEsR0FBR0E7WUFDVEEsTUFBTUEsRUFBRUEsSUFBSUE7WUFDWkEsU0FBU0EsRUFBRUEsSUFBSUE7U0FDaEJBLENBQUNBO1FBQ0ZBLElBQUlBLE9BQU9BLEdBQUdBLFVBQUNBLEdBQW1CQTtZQUNoQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7UUFDUEEsQ0FBQ0EsQ0FBQ0E7UUFDRkEsSUFBSUEsS0FBS0EsR0FBR0EsVUFBQ0EsR0FBaUJBO1lBQzVCQSxFQUFFQSxDQUFDQSxLQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxFQUFFQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNwQ0EsQ0FBQ0EsQ0FBQ0E7UUFDRkEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsRUFBRUEsT0FBT0EsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7SUFDeERBLENBQUNBO0lBS09uQiwwQkFBUUEsR0FBaEJBLFVBQWlCQSxJQUFZQSxFQUFFQSxFQUE0Q0E7UUFBM0VvQixpQkFzQkNBO1FBckJDQSxJQUFJQSxLQUFLQSxHQUFHQSxVQUFDQSxHQUFpQkE7WUFDNUJBLEVBQUVBLENBQUNBLEtBQUlBLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1FBQ3BDQSxDQUFDQSxDQUFDQTtRQUVGQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxJQUFJQSxFQUFFQSxFQUFFQSxNQUFNQSxFQUFFQSxLQUFLQSxFQUFFQSxFQUFFQSxVQUFDQSxRQUF3QkE7WUFDMUVBLElBQUlBLE1BQU1BLEdBQUdBLFFBQVFBLENBQUNBLFlBQVlBLEVBQUVBLENBQUNBO1lBQ3JDQSxJQUFJQSxPQUFPQSxHQUFZQSxFQUFFQSxDQUFDQTtZQUcxQkEsSUFBSUEsV0FBV0EsR0FBR0E7Z0JBQ2hCQSxNQUFNQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxVQUFDQSxPQUFPQTtvQkFDMUJBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO3dCQUNuQkEsT0FBT0EsR0FBR0EsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7d0JBQzVDQSxXQUFXQSxFQUFFQSxDQUFDQTtvQkFDaEJBLENBQUNBO29CQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTt3QkFDTkEsRUFBRUEsQ0FBQ0EsSUFBSUEsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3BCQSxDQUFDQTtnQkFDSEEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7WUFDYkEsQ0FBQ0EsQ0FBQ0E7WUFDRkEsV0FBV0EsRUFBRUEsQ0FBQ0E7UUFDaEJBLENBQUNBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO0lBQ1pBLENBQUNBO0lBS01wQix5QkFBT0EsR0FBZEEsVUFBZUEsSUFBWUEsRUFBRUEsRUFBNkNBO1FBQ3hFcUIsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsRUFBRUEsVUFBQ0EsQ0FBV0EsRUFBRUEsT0FBaUJBO1lBQ2pEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDTkEsTUFBTUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDZkEsQ0FBQ0E7WUFDREEsSUFBSUEsRUFBRUEsR0FBYUEsRUFBRUEsQ0FBQ0E7WUFDdEJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLE9BQU9BLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO2dCQUN4Q0EsRUFBRUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLENBQUNBO1lBQ0RBLEVBQUVBLENBQUNBLElBQUlBLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBO1FBQ2ZBLENBQUNBLENBQUNBLENBQUNBO0lBQ0xBLENBQUNBO0lBQ0hyQixjQUFDQTtBQUFEQSxDQUFDQSxBQTdYRCxFQUFxQyxXQUFXLENBQUMsY0FBYyxFQTZYOUQ7QUE3WEQ7NEJBNlhDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHJlbG9hZF9maWxlID0gcmVxdWlyZSgnLi4vZ2VuZXJpYy9wcmVsb2FkX2ZpbGUnKTtcbmltcG9ydCBmaWxlX3N5c3RlbSA9IHJlcXVpcmUoJy4uL2NvcmUvZmlsZV9zeXN0ZW0nKTtcbmltcG9ydCB7QXBpRXJyb3IsIEVycm9yQ29kZX0gZnJvbSAnLi4vY29yZS9hcGlfZXJyb3InO1xuaW1wb3J0IHtGaWxlRmxhZywgQWN0aW9uVHlwZX0gZnJvbSAnLi4vY29yZS9maWxlX2ZsYWcnO1xuaW1wb3J0IHtTdGF0cywgRmlsZVR5cGV9IGZyb20gJy4uL2NvcmUvbm9kZV9mc19zdGF0cyc7XG5pbXBvcnQgZmlsZSA9IHJlcXVpcmUoJy4uL2NvcmUvZmlsZScpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgZ2xvYmFsID0gcmVxdWlyZSgnLi4vY29yZS9nbG9iYWwnKTtcbmltcG9ydCBhc3luYyA9IHJlcXVpcmUoJ2FzeW5jJyk7XG5pbXBvcnQge2J1ZmZlcjJBcnJheUJ1ZmZlciwgYXJyYXlCdWZmZXIyQnVmZmVyfSBmcm9tICcuLi9jb3JlL3V0aWwnO1xuXG5mdW5jdGlvbiBpc0RpcmVjdG9yeUVudHJ5KGVudHJ5OiBFbnRyeSk6IGVudHJ5IGlzIERpcmVjdG9yeUVudHJ5IHtcbiAgcmV0dXJuIGVudHJ5LmlzRGlyZWN0b3J5O1xufVxuXG52YXIgX2dldEZTOiAodHlwZTpudW1iZXIsIHNpemU6bnVtYmVyLCBzdWNjZXNzQ2FsbGJhY2s6IEZpbGVTeXN0ZW1DYWxsYmFjaywgZXJyb3JDYWxsYmFjaz86IEVycm9yQ2FsbGJhY2spID0+IHZvaWQgPSBnbG9iYWwud2Via2l0UmVxdWVzdEZpbGVTeXN0ZW0gfHwgZ2xvYmFsLnJlcXVlc3RGaWxlU3lzdGVtIHx8IG51bGw7XG5cbmZ1bmN0aW9uIF9yZXF1ZXN0UXVvdGEodHlwZTogbnVtYmVyLCBzaXplOiBudW1iZXIsIHN1Y2Nlc3M6IChzaXplOiBudW1iZXIpID0+IHZvaWQsIGVycm9yQ2FsbGJhY2s6IEVycm9yQ2FsbGJhY2spIHtcbiAgLy8gV2UgY2FzdCBuYXZpZ2F0b3IgYW5kIHdpbmRvdyB0byAnPGFueT4nIGJlY2F1c2UgZXZlcnl0aGluZyBoZXJlIGlzXG4gIC8vIG5vbnN0YW5kYXJkIGZ1bmN0aW9uYWxpdHksIGRlc3BpdGUgdGhlIGZhY3QgdGhhdCBDaHJvbWUgaGFzIHRoZSBvbmx5XG4gIC8vIGltcGxlbWVudGF0aW9uIG9mIHRoZSBIVE1MNUZTIGFuZCBpcyBsaWtlbHkgZHJpdmluZyB0aGUgc3RhbmRhcmRpemF0aW9uXG4gIC8vIHByb2Nlc3MuIFRodXMsIHRoZXNlIG9iamVjdHMgZGVmaW5lZCBvZmYgb2YgbmF2aWdhdG9yIGFuZCB3aW5kb3cgYXJlIG5vdFxuICAvLyBwcmVzZW50IGluIHRoZSBEZWZpbml0ZWx5VHlwZWQgVHlwZVNjcmlwdCB0eXBpbmdzIGZvciBGaWxlU3lzdGVtLlxuICBpZiAodHlwZW9mICg8YW55PiBuYXZpZ2F0b3IpWyd3ZWJraXRQZXJzaXN0ZW50U3RvcmFnZSddICE9PSAndW5kZWZpbmVkJykge1xuICAgIHN3aXRjaCh0eXBlKSB7XG4gICAgICBjYXNlIGdsb2JhbC5QRVJTSVNURU5UOlxuICAgICAgICAoPGFueT4gbmF2aWdhdG9yKS53ZWJraXRQZXJzaXN0ZW50U3RvcmFnZS5yZXF1ZXN0UXVvdGEoc2l6ZSwgc3VjY2VzcywgZXJyb3JDYWxsYmFjayk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBnbG9iYWwuVEVNUE9SQVJZOlxuICAgICAgICAoPGFueT4gbmF2aWdhdG9yKS53ZWJraXRUZW1wb3JhcnlTdG9yYWdlLnJlcXVlc3RRdW90YShzaXplLCBzdWNjZXNzLCBlcnJvckNhbGxiYWNrKTtcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGVycm9yQ2FsbGJhY2sobmV3IFR5cGVFcnJvcihgSW52YWxpZCBzdG9yYWdlIHR5cGU6ICR7dHlwZX1gKSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAoPGFueT4gZ2xvYmFsKS53ZWJraXRTdG9yYWdlSW5mby5yZXF1ZXN0UXVvdGEodHlwZSwgc2l6ZSwgc3VjY2VzcywgZXJyb3JDYWxsYmFjayk7XG4gIH1cbn1cblxuZnVuY3Rpb24gX3RvQXJyYXkobGlzdD86IGFueVtdKTogYW55W10ge1xuICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobGlzdCB8fCBbXSwgMCk7XG59XG5cbi8vIEEgbm90ZSBhYm91dCBnZXRGaWxlIGFuZCBnZXREaXJlY3Rvcnkgb3B0aW9uczpcbi8vIFRoZXNlIG1ldGhvZHMgYXJlIGNhbGxlZCBhdCBudW1lcm91cyBwbGFjZXMgaW4gdGhpcyBmaWxlLCBhbmQgYXJlIHBhc3NlZFxuLy8gc29tZSBjb21iaW5hdGlvbiBvZiB0aGVzZSB0d28gb3B0aW9uczpcbi8vICAgLSBjcmVhdGU6IElmIHRydWUsIHRoZSBlbnRyeSB3aWxsIGJlIGNyZWF0ZWQgaWYgaXQgZG9lc24ndCBleGlzdC5cbi8vICAgICAgICAgICAgIElmIGZhbHNlLCBhbiBlcnJvciB3aWxsIGJlIHRocm93biBpZiBpdCBkb2Vzbid0IGV4aXN0LlxuLy8gICAtIGV4Y2x1c2l2ZTogSWYgdHJ1ZSwgb25seSBjcmVhdGUgdGhlIGVudHJ5IGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdCxcbi8vICAgICAgICAgICAgICAgIGFuZCB0aHJvdyBhbiBlcnJvciBpZiBpdCBkb2VzLlxuXG5leHBvcnQgY2xhc3MgSFRNTDVGU0ZpbGUgZXh0ZW5kcyBwcmVsb2FkX2ZpbGUuUHJlbG9hZEZpbGU8SFRNTDVGUz4gaW1wbGVtZW50cyBmaWxlLkZpbGUge1xuICBjb25zdHJ1Y3RvcihfZnM6IEhUTUw1RlMsIF9wYXRoOiBzdHJpbmcsIF9mbGFnOiBGaWxlRmxhZywgX3N0YXQ6IFN0YXRzLCBjb250ZW50cz86IE5vZGVCdWZmZXIpIHtcbiAgICBzdXBlcihfZnMsIF9wYXRoLCBfZmxhZywgX3N0YXQsIGNvbnRlbnRzKTtcbiAgfVxuXG4gIHB1YmxpYyBzeW5jKGNiOiAoZT86IEFwaUVycm9yKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNEaXJ0eSgpKSB7XG4gICAgICAvLyBEb24ndCBjcmVhdGUgdGhlIGZpbGUgKGl0IHNob3VsZCBhbHJlYWR5IGhhdmUgYmVlbiBjcmVhdGVkIGJ5IGBvcGVuYClcbiAgICAgIHZhciBvcHRzID0ge1xuICAgICAgICBjcmVhdGU6IGZhbHNlXG4gICAgICB9O1xuICAgICAgdmFyIF9mcyA9IHRoaXMuX2ZzO1xuICAgICAgdmFyIHN1Y2Nlc3M6IEZpbGVFbnRyeUNhbGxiYWNrID0gKGVudHJ5KSA9PiB7XG4gICAgICAgIGVudHJ5LmNyZWF0ZVdyaXRlcigod3JpdGVyKSA9PiB7XG4gICAgICAgICAgdmFyIGJ1ZmZlciA9IHRoaXMuZ2V0QnVmZmVyKCk7XG4gICAgICAgICAgdmFyIGJsb2IgPSBuZXcgQmxvYihbYnVmZmVyMkFycmF5QnVmZmVyKGJ1ZmZlcildKTtcbiAgICAgICAgICB2YXIgbGVuZ3RoID0gYmxvYi5zaXplO1xuICAgICAgICAgIHdyaXRlci5vbndyaXRlZW5kID0gKCkgPT4ge1xuICAgICAgICAgICAgd3JpdGVyLm9ud3JpdGVlbmQgPSBudWxsO1xuICAgICAgICAgICAgd3JpdGVyLnRydW5jYXRlKGxlbmd0aCk7XG4gICAgICAgICAgICB0aGlzLnJlc2V0RGlydHkoKTtcbiAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICB3cml0ZXIub25lcnJvciA9IChlcnI6IERPTUVycm9yKSA9PiB7XG4gICAgICAgICAgICBjYihfZnMuY29udmVydChlcnIsIHRoaXMuZ2V0UGF0aCgpLCBmYWxzZSkpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgd3JpdGVyLndyaXRlKGJsb2IpO1xuICAgICAgICB9KTtcbiAgICAgIH07XG4gICAgICB2YXIgZXJyb3IgPSAoZXJyOiBET01FcnJvcikgPT4ge1xuICAgICAgICBjYihfZnMuY29udmVydChlcnIsIHRoaXMuZ2V0UGF0aCgpLCBmYWxzZSkpO1xuICAgICAgfTtcbiAgICAgIF9mcy5mcy5yb290LmdldEZpbGUodGhpcy5nZXRQYXRoKCksIG9wdHMsIHN1Y2Nlc3MsIGVycm9yKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2IoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xvc2UoY2I6IChlPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLnN5bmMoY2IpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEhUTUw1RlMgZXh0ZW5kcyBmaWxlX3N5c3RlbS5CYXNlRmlsZVN5c3RlbSBpbXBsZW1lbnRzIGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0ge1xuICBwcml2YXRlIHNpemU6IG51bWJlcjtcbiAgcHJpdmF0ZSB0eXBlOiBudW1iZXI7XG4gIC8vIEhUTUw1RmlsZSByZWFjaGVzIGludG8gSFRNTDVGUy4gOi9cbiAgcHVibGljIGZzOiBGaWxlU3lzdGVtO1xuICAvKipcbiAgICogQXJndW1lbnRzOlxuICAgKiAgIC0gdHlwZTogUEVSU0lTVEVOVCBvciBURU1QT1JBUllcbiAgICogICAtIHNpemU6IHN0b3JhZ2UgcXVvdGEgdG8gcmVxdWVzdCwgaW4gbWVnYWJ5dGVzLiBBbGxvY2F0ZWQgdmFsdWUgbWF5IGJlIGxlc3MuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihzaXplOiBudW1iZXIgPSA1LCB0eXBlOiBudW1iZXIgPSBnbG9iYWwuUEVSU0lTVEVOVCkge1xuICAgIHN1cGVyKCk7XG4gICAgLy8gQ29udmVydCBNQiB0byBieXRlcy5cbiAgICB0aGlzLnNpemUgPSAxMDI0ICogMTAyNCAqIHNpemU7XG4gICAgdGhpcy50eXBlID0gdHlwZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXROYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuICdIVE1MNSBGaWxlU3lzdGVtJztcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIF9nZXRGUyAhPSBudWxsO1xuICB9XG5cbiAgcHVibGljIGlzUmVhZE9ubHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzU3ltbGlua3MoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzUHJvcHMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIHRoZSBnaXZlbiBET01FcnJvciBpbnRvIGFuIGFwcHJvcHJpYXRlIEFwaUVycm9yLlxuICAgKiBGdWxsIGxpc3Qgb2YgdmFsdWVzIGhlcmU6XG4gICAqIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9ET01FcnJvclxuICAgKi9cbiAgcHVibGljIGNvbnZlcnQoZXJyOiBET01FcnJvciwgcDogc3RyaW5nLCBleHBlY3RlZERpcjogYm9vbGVhbik6IEFwaUVycm9yIHtcbiAgICBzd2l0Y2ggKGVyci5uYW1lKSB7XG4gICAgICAvKiBUaGUgdXNlciBhZ2VudCBmYWlsZWQgdG8gY3JlYXRlIGEgZmlsZSBvciBkaXJlY3RvcnkgZHVlIHRvIHRoZSBleGlzdGVuY2Ugb2YgYSBmaWxlIG9yXG4gICAgICAgICBkaXJlY3Rvcnkgd2l0aCB0aGUgc2FtZSBwYXRoLiAgKi9cbiAgICAgIGNhc2UgXCJQYXRoRXhpc3RzRXJyb3JcIjpcbiAgICAgICAgcmV0dXJuIEFwaUVycm9yLkVFWElTVChwKTtcbiAgICAgIC8qIFRoZSBvcGVyYXRpb24gZmFpbGVkIGJlY2F1c2UgaXQgd291bGQgY2F1c2UgdGhlIGFwcGxpY2F0aW9uIHRvIGV4Y2VlZCBpdHMgc3RvcmFnZSBxdW90YS4gICovXG4gICAgICBjYXNlICdRdW90YUV4Y2VlZGVkRXJyb3InOlxuICAgICAgICByZXR1cm4gQXBpRXJyb3IuRmlsZUVycm9yKEVycm9yQ29kZS5FTk9TUEMsIHApO1xuICAgICAgLyogIEEgcmVxdWlyZWQgZmlsZSBvciBkaXJlY3RvcnkgY291bGQgbm90IGJlIGZvdW5kIGF0IHRoZSB0aW1lIGFuIG9wZXJhdGlvbiB3YXMgcHJvY2Vzc2VkLiAgICovXG4gICAgICBjYXNlICdOb3RGb3VuZEVycm9yJzpcbiAgICAgICAgcmV0dXJuIEFwaUVycm9yLkVOT0VOVChwKTtcbiAgICAgIC8qIFRoaXMgaXMgYSBzZWN1cml0eSBlcnJvciBjb2RlIHRvIGJlIHVzZWQgaW4gc2l0dWF0aW9ucyBub3QgY292ZXJlZCBieSBhbnkgb3RoZXIgZXJyb3IgY29kZXMuXG4gICAgICAgICAtIEEgcmVxdWlyZWQgZmlsZSB3YXMgdW5zYWZlIGZvciBhY2Nlc3Mgd2l0aGluIGEgV2ViIGFwcGxpY2F0aW9uXG4gICAgICAgICAtIFRvbyBtYW55IGNhbGxzIGFyZSBiZWluZyBtYWRlIG9uIGZpbGVzeXN0ZW0gcmVzb3VyY2VzICovXG4gICAgICBjYXNlICdTZWN1cml0eUVycm9yJzpcbiAgICAgICAgcmV0dXJuIEFwaUVycm9yLkZpbGVFcnJvcihFcnJvckNvZGUuRUFDQ0VTLCBwKTtcbiAgICAgIC8qIFRoZSBtb2RpZmljYXRpb24gcmVxdWVzdGVkIHdhcyBpbGxlZ2FsLiBFeGFtcGxlcyBvZiBpbnZhbGlkIG1vZGlmaWNhdGlvbnMgaW5jbHVkZSBtb3ZpbmcgYVxuICAgICAgICAgZGlyZWN0b3J5IGludG8gaXRzIG93biBjaGlsZCwgbW92aW5nIGEgZmlsZSBpbnRvIGl0cyBwYXJlbnQgZGlyZWN0b3J5IHdpdGhvdXQgY2hhbmdpbmcgaXRzIG5hbWUsXG4gICAgICAgICBvciBjb3B5aW5nIGEgZGlyZWN0b3J5IHRvIGEgcGF0aCBvY2N1cGllZCBieSBhIGZpbGUuICAqL1xuICAgICAgY2FzZSAnSW52YWxpZE1vZGlmaWNhdGlvbkVycm9yJzpcbiAgICAgICAgcmV0dXJuIEFwaUVycm9yLkZpbGVFcnJvcihFcnJvckNvZGUuRVBFUk0sIHApO1xuICAgICAgLyogVGhlIHVzZXIgaGFzIGF0dGVtcHRlZCB0byBsb29rIHVwIGEgZmlsZSBvciBkaXJlY3RvcnksIGJ1dCB0aGUgRW50cnkgZm91bmQgaXMgb2YgdGhlIHdyb25nIHR5cGVcbiAgICAgICAgIFtlLmcuIGlzIGEgRGlyZWN0b3J5RW50cnkgd2hlbiB0aGUgdXNlciByZXF1ZXN0ZWQgYSBGaWxlRW50cnldLiAgKi9cbiAgICAgIGNhc2UgJ1R5cGVNaXNtYXRjaEVycm9yJzpcbiAgICAgICAgcmV0dXJuIEFwaUVycm9yLkZpbGVFcnJvcihleHBlY3RlZERpciA/IEVycm9yQ29kZS5FTk9URElSIDogRXJyb3JDb2RlLkVJU0RJUiwgcCk7XG4gICAgICAvKiBBIHBhdGggb3IgVVJMIHN1cHBsaWVkIHRvIHRoZSBBUEkgd2FzIG1hbGZvcm1lZC4gICovXG4gICAgICBjYXNlIFwiRW5jb2RpbmdFcnJvclwiOlxuICAgICAgLyogQW4gb3BlcmF0aW9uIGRlcGVuZGVkIG9uIHN0YXRlIGNhY2hlZCBpbiBhbiBpbnRlcmZhY2Ugb2JqZWN0LCBidXQgdGhhdCBzdGF0ZSB0aGF0IGhhcyBjaGFuZ2VkXG4gICAgICAgICBzaW5jZSBpdCB3YXMgcmVhZCBmcm9tIGRpc2suICAqL1xuICAgICAgY2FzZSBcIkludmFsaWRTdGF0ZUVycm9yXCI6XG4gICAgICAvKiBUaGUgdXNlciBhdHRlbXB0ZWQgdG8gd3JpdGUgdG8gYSBmaWxlIG9yIGRpcmVjdG9yeSB3aGljaCBjb3VsZCBub3QgYmUgbW9kaWZpZWQgZHVlIHRvIHRoZSBzdGF0ZVxuICAgICAgICAgb2YgdGhlIHVuZGVybHlpbmcgZmlsZXN5c3RlbS4gICovXG4gICAgICBjYXNlIFwiTm9Nb2RpZmljYXRpb25BbGxvd2VkRXJyb3JcIjpcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBBcGlFcnJvci5GaWxlRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgcCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE5vbnN0YW5kYXJkXG4gICAqIFJlcXVlc3RzIGEgc3RvcmFnZSBxdW90YSBmcm9tIHRoZSBicm93c2VyIHRvIGJhY2sgdGhpcyBGUy5cbiAgICovXG4gIHB1YmxpYyBhbGxvY2F0ZShjYjogKGU/OiBBcGlFcnJvcikgPT4gdm9pZCA9IGZ1bmN0aW9uKCl7fSk6IHZvaWQge1xuICAgIHZhciBzdWNjZXNzID0gKGZzOiBGaWxlU3lzdGVtKTogdm9pZCA9PiB7XG4gICAgICB0aGlzLmZzID0gZnM7XG4gICAgICBjYigpXG4gICAgfTtcbiAgICB2YXIgZXJyb3IgPSAoZXJyOiBET01FeGNlcHRpb24pOiB2b2lkID0+IHtcbiAgICAgIGNiKHRoaXMuY29udmVydChlcnIsIFwiL1wiLCB0cnVlKSk7XG4gICAgfTtcbiAgICBpZiAodGhpcy50eXBlID09PSBnbG9iYWwuUEVSU0lTVEVOVCkge1xuICAgICAgX3JlcXVlc3RRdW90YSh0aGlzLnR5cGUsIHRoaXMuc2l6ZSwgKGdyYW50ZWQ6IG51bWJlcikgPT4ge1xuICAgICAgICBfZ2V0RlModGhpcy50eXBlLCBncmFudGVkLCBzdWNjZXNzLCBlcnJvcik7XG4gICAgICB9LCBlcnJvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9nZXRGUyh0aGlzLnR5cGUsIHRoaXMuc2l6ZSwgc3VjY2VzcywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBOb25zdGFuZGFyZFxuICAgKiBEZWxldGVzIGV2ZXJ5dGhpbmcgaW4gdGhlIEZTLiBVc2VkIGZvciB0ZXN0aW5nLlxuICAgKiBLYXJtYSBjbGVhcnMgdGhlIHN0b3JhZ2UgYWZ0ZXIgeW91IHF1aXQgaXQgYnV0IG5vdCBiZXR3ZWVuIHJ1bnMgb2YgdGhlIHRlc3RcbiAgICogc3VpdGUsIGFuZCB0aGUgdGVzdHMgZXhwZWN0IGFuIGVtcHR5IEZTIGV2ZXJ5IHRpbWUuXG4gICAqL1xuICBwdWJsaWMgZW1wdHkobWFpbkNiOiAoZT86IEFwaUVycm9yKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgLy8gR2V0IGEgbGlzdCBvZiBhbGwgZW50cmllcyBpbiB0aGUgcm9vdCBkaXJlY3RvcnkgdG8gZGVsZXRlIHRoZW1cbiAgICB0aGlzLl9yZWFkZGlyKCcvJywgKGVycjogQXBpRXJyb3IsIGVudHJpZXM/OiBFbnRyeVtdKTogdm9pZCA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBlbXB0eSBGUycpO1xuICAgICAgICBtYWluQ2IoZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIENhbGxlZCB3aGVuIGV2ZXJ5IGVudHJ5IGhhcyBiZWVuIG9wZXJhdGVkIG9uXG4gICAgICAgIHZhciBmaW5pc2hlZCA9IChlcjogYW55KTogdm9pZCA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBlbXB0eSBGU1wiKTtcbiAgICAgICAgICAgIG1haW5DYihlcnIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtYWluQ2IoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8vIFJlbW92ZXMgZmlsZXMgYW5kIHJlY3Vyc2l2ZWx5IHJlbW92ZXMgZGlyZWN0b3JpZXNcbiAgICAgICAgdmFyIGRlbGV0ZUVudHJ5ID0gKGVudHJ5OiBFbnRyeSwgY2I6IChlPzogYW55KSA9PiB2b2lkKTogdm9pZCA9PiB7XG4gICAgICAgICAgdmFyIHN1Y2MgPSAoKSA9PiB7XG4gICAgICAgICAgICBjYigpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgdmFyIGVycm9yID0gKGVycjogRE9NRXhjZXB0aW9uKSA9PiB7XG4gICAgICAgICAgICBjYih0aGlzLmNvbnZlcnQoZXJyLCBlbnRyeS5mdWxsUGF0aCwgIWVudHJ5LmlzRGlyZWN0b3J5KSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBpZiAoaXNEaXJlY3RvcnlFbnRyeShlbnRyeSkpIHtcbiAgICAgICAgICAgIGVudHJ5LnJlbW92ZVJlY3Vyc2l2ZWx5KHN1Y2MsIGVycm9yKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZW50cnkucmVtb3ZlKHN1Y2MsIGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgZW50cmllcyBhbmQgcmVtb3ZlIHRoZW0sIHRoZW4gY2FsbCB0aGUgY2FsbGJhY2tcbiAgICAgICAgLy8gd2hlbiB0aGV5J3JlIGFsbCBmaW5pc2hlZC5cbiAgICAgICAgYXN5bmMuZWFjaChlbnRyaWVzLCBkZWxldGVFbnRyeSwgZmluaXNoZWQpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHJlbmFtZShvbGRQYXRoOiBzdHJpbmcsIG5ld1BhdGg6IHN0cmluZywgY2I6IChlPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB2YXIgc2VtYXBob3JlOiBudW1iZXIgPSAyLFxuICAgICAgc3VjY2Vzc0NvdW50OiBudW1iZXIgPSAwLFxuICAgICAgcm9vdDogRGlyZWN0b3J5RW50cnkgPSB0aGlzLmZzLnJvb3QsXG4gICAgICBjdXJyZW50UGF0aDogc3RyaW5nID0gb2xkUGF0aCxcbiAgICAgIGVycm9yID0gKGVycjogRE9NRXhjZXB0aW9uKTogdm9pZCA9PiB7XG4gICAgICAgIGlmICgtLXNlbWFwaG9yZSA8PSAwKSB7XG4gICAgICAgICAgICBjYih0aGlzLmNvbnZlcnQoZXJyLCBjdXJyZW50UGF0aCwgZmFsc2UpKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHN1Y2Nlc3MgPSAoZmlsZTogRW50cnkpOiB2b2lkID0+IHtcbiAgICAgICAgaWYgKCsrc3VjY2Vzc0NvdW50ID09PSAyKSB7XG4gICAgICAgICAgcmV0dXJuIGNiKG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBcIlNvbWV0aGluZyB3YXMgaWRlbnRpZmllZCBhcyBib3RoIGEgZmlsZSBhbmQgYSBkaXJlY3RvcnkuIFRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbi5cIikpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU1BFQ0lBTCBDQVNFOiBJZiBuZXdQYXRoID09PSBvbGRQYXRoLCBhbmQgdGhlIHBhdGggZXhpc3RzLCB0aGVuXG4gICAgICAgIC8vIHRoaXMgb3BlcmF0aW9uIHRyaXZpYWxseSBzdWNjZWVkcy5cbiAgICAgICAgaWYgKG9sZFBhdGggPT09IG5ld1BhdGgpIHtcbiAgICAgICAgICByZXR1cm4gY2IoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdldCB0aGUgbmV3IHBhcmVudCBkaXJlY3RvcnkuXG4gICAgICAgIGN1cnJlbnRQYXRoID0gcGF0aC5kaXJuYW1lKG5ld1BhdGgpO1xuICAgICAgICByb290LmdldERpcmVjdG9yeShjdXJyZW50UGF0aCwge30sIChwYXJlbnREaXI6IERpcmVjdG9yeUVudHJ5KTogdm9pZCA9PiB7XG4gICAgICAgICAgY3VycmVudFBhdGggPSBwYXRoLmJhc2VuYW1lKG5ld1BhdGgpO1xuICAgICAgICAgIGZpbGUubW92ZVRvKHBhcmVudERpciwgY3VycmVudFBhdGgsIChlbnRyeTogRW50cnkpOiB2b2lkID0+IHsgY2IoKTsgfSwgKGVycjogRE9NRXhjZXB0aW9uKTogdm9pZCA9PiB7XG4gICAgICAgICAgICAvLyBTUEVDSUFMIENBU0U6IElmIG9sZFBhdGggaXMgYSBkaXJlY3RvcnksIGFuZCBuZXdQYXRoIGlzIGFcbiAgICAgICAgICAgIC8vIGZpbGUsIHJlbmFtZSBzaG91bGQgZGVsZXRlIHRoZSBmaWxlIGFuZCBwZXJmb3JtIHRoZSBtb3ZlLlxuICAgICAgICAgICAgaWYgKGZpbGUuaXNEaXJlY3RvcnkpIHtcbiAgICAgICAgICAgICAgY3VycmVudFBhdGggPSBuZXdQYXRoO1xuICAgICAgICAgICAgICAvLyBVbmxpbmsgb25seSB3b3JrcyBvbiBmaWxlcy4gVHJ5IHRvIGRlbGV0ZSBuZXdQYXRoLlxuICAgICAgICAgICAgICB0aGlzLnVubGluayhuZXdQYXRoLCAoZT8pOiB2b2lkID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZSkge1xuICAgICAgICAgICAgICAgICAgLy8gbmV3UGF0aCBpcyBwcm9iYWJseSBhIGRpcmVjdG9yeS5cbiAgICAgICAgICAgICAgICAgIGVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIC8vIFJlY3VyLCBub3cgdGhhdCBuZXdQYXRoIGRvZXNuJ3QgZXhpc3QuXG4gICAgICAgICAgICAgICAgICB0aGlzLnJlbmFtZShvbGRQYXRoLCBuZXdQYXRoLCBjYik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGVycm9yKGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sIGVycm9yKTtcbiAgICAgIH07XG5cbiAgICAvLyBXZSBkb24ndCBrbm93IGlmIG9sZFBhdGggaXMgYSAqZmlsZSogb3IgYSAqZGlyZWN0b3J5KiwgYW5kIHRoZXJlJ3Mgbm9cbiAgICAvLyB3YXkgdG8gc3RhdCBpdGVtcy4gU28gbGF1bmNoIGJvdGggcmVxdWVzdHMsIHNlZSB3aGljaCBvbmUgc3VjY2VlZHMuXG4gICAgcm9vdC5nZXRGaWxlKG9sZFBhdGgsIHt9LCBzdWNjZXNzLCBlcnJvcik7XG4gICAgcm9vdC5nZXREaXJlY3Rvcnkob2xkUGF0aCwge30sIHN1Y2Nlc3MsIGVycm9yKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0KHBhdGg6IHN0cmluZywgaXNMc3RhdDogYm9vbGVhbiwgY2I6IChlcnI6IEFwaUVycm9yLCBzdGF0PzogU3RhdHMpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAvLyBUaHJvdyBhbiBlcnJvciBpZiB0aGUgZW50cnkgZG9lc24ndCBleGlzdCwgYmVjYXVzZSB0aGVuIHRoZXJlJ3Mgbm90aGluZ1xuICAgIC8vIHRvIHN0YXQuXG4gICAgdmFyIG9wdHMgPSB7XG4gICAgICBjcmVhdGU6IGZhbHNlXG4gICAgfTtcbiAgICAvLyBDYWxsZWQgd2hlbiB0aGUgcGF0aCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgbG9hZGVkIGFzIGEgZmlsZS5cbiAgICB2YXIgbG9hZEFzRmlsZSA9IChlbnRyeTogRmlsZUVudHJ5KTogdm9pZCA9PiB7XG4gICAgICB2YXIgZmlsZUZyb21FbnRyeSA9IChmaWxlOiBGaWxlKTogdm9pZCA9PiB7XG4gICAgICAgIHZhciBzdGF0ID0gbmV3IFN0YXRzKEZpbGVUeXBlLkZJTEUsIGZpbGUuc2l6ZSk7XG4gICAgICAgIGNiKG51bGwsIHN0YXQpO1xuICAgICAgfTtcbiAgICAgIGVudHJ5LmZpbGUoZmlsZUZyb21FbnRyeSwgZmFpbGVkVG9Mb2FkKTtcbiAgICB9O1xuICAgIC8vIENhbGxlZCB3aGVuIHRoZSBwYXRoIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBsb2FkZWQgYXMgYSBkaXJlY3RvcnkuXG4gICAgdmFyIGxvYWRBc0RpciA9IChkaXI6IERpcmVjdG9yeUVudHJ5KTogdm9pZCA9PiB7XG4gICAgICAvLyBEaXJlY3RvcnkgZW50cnkgc2l6ZSBjYW4ndCBiZSBkZXRlcm1pbmVkIGZyb20gdGhlIEhUTUw1IEZTIEFQSSwgYW5kIGlzXG4gICAgICAvLyBpbXBsZW1lbnRhdGlvbi1kZXBlbmRhbnQgYW55d2F5LCBzbyBhIGR1bW15IHZhbHVlIGlzIHVzZWQuXG4gICAgICB2YXIgc2l6ZSA9IDQwOTY7XG4gICAgICB2YXIgc3RhdCA9IG5ldyBTdGF0cyhGaWxlVHlwZS5ESVJFQ1RPUlksIHNpemUpO1xuICAgICAgY2IobnVsbCwgc3RhdCk7XG4gICAgfTtcbiAgICAvLyBDYWxsZWQgd2hlbiB0aGUgcGF0aCBjb3VsZG4ndCBiZSBvcGVuZWQgYXMgYSBkaXJlY3Rvcnkgb3IgYSBmaWxlLlxuICAgIHZhciBmYWlsZWRUb0xvYWQgPSAoZXJyOiBET01FeGNlcHRpb24pOiB2b2lkID0+IHtcbiAgICAgIGNiKHRoaXMuY29udmVydChlcnIsIHBhdGgsIGZhbHNlIC8qIFVua25vd24gLyBpcnJlbGV2YW50ICovKSk7XG4gICAgfTtcbiAgICAvLyBDYWxsZWQgd2hlbiB0aGUgcGF0aCBjb3VsZG4ndCBiZSBvcGVuZWQgYXMgYSBmaWxlLCBidXQgbWlnaHQgc3RpbGwgYmUgYVxuICAgIC8vIGRpcmVjdG9yeS5cbiAgICB2YXIgZmFpbGVkVG9Mb2FkQXNGaWxlID0gKCk6IHZvaWQgPT4ge1xuICAgICAgdGhpcy5mcy5yb290LmdldERpcmVjdG9yeShwYXRoLCBvcHRzLCBsb2FkQXNEaXIsIGZhaWxlZFRvTG9hZCk7XG4gICAgfTtcbiAgICAvLyBObyBtZXRob2QgY3VycmVudGx5IGV4aXN0cyB0byBkZXRlcm1pbmUgd2hldGhlciBhIHBhdGggcmVmZXJzIHRvIGFcbiAgICAvLyBkaXJlY3Rvcnkgb3IgYSBmaWxlLCBzbyB0aGlzIGltcGxlbWVudGF0aW9uIHRyaWVzIGJvdGggYW5kIHVzZXMgdGhlIGZpcnN0XG4gICAgLy8gb25lIHRoYXQgc3VjY2VlZHMuXG4gICAgdGhpcy5mcy5yb290LmdldEZpbGUocGF0aCwgb3B0cywgbG9hZEFzRmlsZSwgZmFpbGVkVG9Mb2FkQXNGaWxlKTtcbiAgfVxuXG4gIHB1YmxpYyBvcGVuKHA6IHN0cmluZywgZmxhZ3M6IEZpbGVGbGFnLCBtb2RlOiBudW1iZXIsIGNiOiAoZXJyOiBBcGlFcnJvciwgZmQ/OiBmaWxlLkZpbGUpID0+IGFueSk6IHZvaWQge1xuICAgIHZhciBlcnJvciA9IChlcnI6IERPTUVycm9yKTogdm9pZCA9PiB7XG4gICAgICBpZiAoZXJyLm5hbWUgPT09ICdJbnZhbGlkTW9kaWZpY2F0aW9uRXJyb3InICYmIGZsYWdzLmlzRXhjbHVzaXZlKCkpIHtcbiAgICAgICAgY2IoQXBpRXJyb3IuRUVYSVNUKHApKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNiKHRoaXMuY29udmVydChlcnIsIHAsIGZhbHNlKSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMuZnMucm9vdC5nZXRGaWxlKHAsIHtcbiAgICAgIGNyZWF0ZTogZmxhZ3MucGF0aE5vdEV4aXN0c0FjdGlvbigpID09PSBBY3Rpb25UeXBlLkNSRUFURV9GSUxFLFxuICAgICAgZXhjbHVzaXZlOiBmbGFncy5pc0V4Y2x1c2l2ZSgpXG4gICAgfSwgKGVudHJ5OiBGaWxlRW50cnkpOiB2b2lkID0+IHtcbiAgICAgIC8vIFRyeSB0byBmZXRjaCBjb3JyZXNwb25kaW5nIGZpbGUuXG4gICAgICBlbnRyeS5maWxlKChmaWxlOiBGaWxlKTogdm9pZCA9PiB7XG4gICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICByZWFkZXIub25sb2FkZW5kID0gKGV2ZW50OiBFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICAgIHZhciBiZnNfZmlsZSA9IHRoaXMuX21ha2VGaWxlKHAsIGZsYWdzLCBmaWxlLCA8QXJyYXlCdWZmZXI+IHJlYWRlci5yZXN1bHQpO1xuICAgICAgICAgIGNiKG51bGwsIGJmc19maWxlKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSAoZXY6IEV2ZW50KSA9PiB7XG4gICAgICAgICAgZXJyb3IocmVhZGVyLmVycm9yKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpO1xuICAgICAgfSwgZXJyb3IpO1xuICAgIH0sIGVycm9yKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgQnJvd3NlckZTIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHR5cGUgb2YgYSBEcm9wYm94LmpzIHN0YXQgb2JqZWN0XG4gICAqL1xuICBwcml2YXRlIF9zdGF0VHlwZShzdGF0OiBFbnRyeSk6IEZpbGVUeXBlIHtcbiAgICByZXR1cm4gc3RhdC5pc0ZpbGUgPyBGaWxlVHlwZS5GSUxFIDogRmlsZVR5cGUuRElSRUNUT1JZO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBCcm93c2VyRlMgb2JqZWN0IHJlcHJlc2VudGluZyBhIEZpbGUsIGNyZWF0ZWQgZnJvbSB0aGUgZGF0YVxuICAgKiByZXR1cm5lZCBieSBjYWxscyB0byB0aGUgRHJvcGJveCBBUEkuXG4gICAqL1xuICBwcml2YXRlIF9tYWtlRmlsZShwYXRoOiBzdHJpbmcsIGZsYWc6IEZpbGVGbGFnLCBzdGF0OiBGaWxlLCBkYXRhOiBBcnJheUJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcigwKSk6IEhUTUw1RlNGaWxlIHtcbiAgICB2YXIgc3RhdHMgPSBuZXcgU3RhdHMoRmlsZVR5cGUuRklMRSwgc3RhdC5zaXplKTtcbiAgICB2YXIgYnVmZmVyID0gYXJyYXlCdWZmZXIyQnVmZmVyKGRhdGEpO1xuICAgIHJldHVybiBuZXcgSFRNTDVGU0ZpbGUodGhpcywgcGF0aCwgZmxhZywgc3RhdHMsIGJ1ZmZlcik7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIGEgZmlsZSBvciBkaXJlY3RvcnkgZnJvbSB0aGUgZmlsZSBzeXN0ZW1cbiAgICogaXNGaWxlIHNob3VsZCByZWZsZWN0IHdoaWNoIGNhbGwgd2FzIG1hZGUgdG8gcmVtb3ZlIHRoZSBpdCAoYHVubGlua2Agb3JcbiAgICogYHJtZGlyYCkuIElmIHRoaXMgZG9lc24ndCBtYXRjaCB3aGF0J3MgYWN0dWFsbHkgYXQgYHBhdGhgLCBhbiBlcnJvciB3aWxsIGJlXG4gICAqIHJldHVybmVkXG4gICAqL1xuICBwcml2YXRlIF9yZW1vdmUocGF0aDogc3RyaW5nLCBjYjogKGU/OiBBcGlFcnJvcikgPT4gdm9pZCwgaXNGaWxlOiBib29sZWFuKTogdm9pZCB7XG4gICAgdmFyIHN1Y2Nlc3MgPSAoZW50cnk6IEVudHJ5KTogdm9pZCA9PiB7XG4gICAgICB2YXIgc3VjYyA9ICgpID0+IHtcbiAgICAgICAgY2IoKTtcbiAgICAgIH07XG4gICAgICB2YXIgZXJyID0gKGVycjogRE9NRXhjZXB0aW9uKSA9PiB7XG4gICAgICAgIGNiKHRoaXMuY29udmVydChlcnIsIHBhdGgsICFpc0ZpbGUpKTtcbiAgICAgIH07XG4gICAgICBlbnRyeS5yZW1vdmUoc3VjYywgZXJyKTtcbiAgICB9O1xuICAgIHZhciBlcnJvciA9IChlcnI6IERPTUV4Y2VwdGlvbik6IHZvaWQgPT4ge1xuICAgICAgY2IodGhpcy5jb252ZXJ0KGVyciwgcGF0aCwgIWlzRmlsZSkpO1xuICAgIH07XG4gICAgLy8gRGVsZXRpbmcgdGhlIGVudHJ5LCBzbyBkb24ndCBjcmVhdGUgaXRcbiAgICB2YXIgb3B0cyA9IHtcbiAgICAgIGNyZWF0ZTogZmFsc2VcbiAgICB9O1xuXG4gICAgaWYgKGlzRmlsZSkge1xuICAgICAgdGhpcy5mcy5yb290LmdldEZpbGUocGF0aCwgb3B0cywgc3VjY2VzcywgZXJyb3IpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZzLnJvb3QuZ2V0RGlyZWN0b3J5KHBhdGgsIG9wdHMsIHN1Y2Nlc3MsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdW5saW5rKHBhdGg6IHN0cmluZywgY2I6IChlPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLl9yZW1vdmUocGF0aCwgY2IsIHRydWUpO1xuICB9XG5cbiAgcHVibGljIHJtZGlyKHBhdGg6IHN0cmluZywgY2I6IChlPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLl9yZW1vdmUocGF0aCwgY2IsIGZhbHNlKTtcbiAgfVxuXG4gIHB1YmxpYyBta2RpcihwYXRoOiBzdHJpbmcsIG1vZGU6IG51bWJlciwgY2I6IChlPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAvLyBDcmVhdGUgdGhlIGRpcmVjdG9yeSwgYnV0IHRocm93IGFuIGVycm9yIGlmIGl0IGFscmVhZHkgZXhpc3RzLCBhcyBwZXJcbiAgICAvLyBta2RpcigxKVxuICAgIHZhciBvcHRzID0ge1xuICAgICAgY3JlYXRlOiB0cnVlLFxuICAgICAgZXhjbHVzaXZlOiB0cnVlXG4gICAgfTtcbiAgICB2YXIgc3VjY2VzcyA9IChkaXI6IERpcmVjdG9yeUVudHJ5KTogdm9pZCA9PiB7XG4gICAgICBjYigpO1xuICAgIH07XG4gICAgdmFyIGVycm9yID0gKGVycjogRE9NRXhjZXB0aW9uKTogdm9pZCA9PiB7XG4gICAgICBjYih0aGlzLmNvbnZlcnQoZXJyLCBwYXRoLCB0cnVlKSk7XG4gICAgfTtcbiAgICB0aGlzLmZzLnJvb3QuZ2V0RGlyZWN0b3J5KHBhdGgsIG9wdHMsIHN1Y2Nlc3MsIGVycm9yKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIGBGaWxlRW50cnlgcy4gVXNlZCBpbnRlcm5hbGx5IGJ5IGVtcHR5IGFuZCByZWFkZGlyLlxuICAgKi9cbiAgcHJpdmF0ZSBfcmVhZGRpcihwYXRoOiBzdHJpbmcsIGNiOiAoZTogQXBpRXJyb3IsIGVudHJpZXM/OiBFbnRyeVtdKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdmFyIGVycm9yID0gKGVycjogRE9NRXhjZXB0aW9uKTogdm9pZCA9PiB7XG4gICAgICBjYih0aGlzLmNvbnZlcnQoZXJyLCBwYXRoLCB0cnVlKSk7XG4gICAgfTtcbiAgICAvLyBHcmFiIHRoZSByZXF1ZXN0ZWQgZGlyZWN0b3J5LlxuICAgIHRoaXMuZnMucm9vdC5nZXREaXJlY3RvcnkocGF0aCwgeyBjcmVhdGU6IGZhbHNlIH0sIChkaXJFbnRyeTogRGlyZWN0b3J5RW50cnkpID0+IHtcbiAgICAgIHZhciByZWFkZXIgPSBkaXJFbnRyeS5jcmVhdGVSZWFkZXIoKTtcbiAgICAgIHZhciBlbnRyaWVzOiBFbnRyeVtdID0gW107XG5cbiAgICAgIC8vIENhbGwgdGhlIHJlYWRlci5yZWFkRW50cmllcygpIHVudGlsIG5vIG1vcmUgcmVzdWx0cyBhcmUgcmV0dXJuZWQuXG4gICAgICB2YXIgcmVhZEVudHJpZXMgPSAoKSA9PiB7XG4gICAgICAgIHJlYWRlci5yZWFkRW50cmllcygoKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGVudHJpZXMgPSBlbnRyaWVzLmNvbmNhdChfdG9BcnJheShyZXN1bHRzKSk7XG4gICAgICAgICAgICByZWFkRW50cmllcygpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYihudWxsLCBlbnRyaWVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLCBlcnJvcik7XG4gICAgICB9O1xuICAgICAgcmVhZEVudHJpZXMoKTtcbiAgICB9LCBlcnJvcik7XG4gIH1cblxuICAvKipcbiAgICogTWFwIF9yZWFkZGlyJ3MgbGlzdCBvZiBgRmlsZUVudHJ5YHMgdG8gdGhlaXIgbmFtZXMgYW5kIHJldHVybiB0aGF0LlxuICAgKi9cbiAgcHVibGljIHJlYWRkaXIocGF0aDogc3RyaW5nLCBjYjogKGVycjogQXBpRXJyb3IsIGZpbGVzPzogc3RyaW5nW10pID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLl9yZWFkZGlyKHBhdGgsIChlOiBBcGlFcnJvciwgZW50cmllcz86IEVudHJ5W10pOiB2b2lkID0+IHtcbiAgICAgIGlmIChlKSB7XG4gICAgICAgIHJldHVybiBjYihlKTtcbiAgICAgIH1cbiAgICAgIHZhciBydjogc3RyaW5nW10gPSBbXTtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZW50cmllcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBydi5wdXNoKGVudHJpZXNbaV0ubmFtZSk7XG4gICAgICB9XG4gICAgICBjYihudWxsLCBydik7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==