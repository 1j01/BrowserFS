var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var InMemory_1 = require('./InMemory');
var api_error_1 = require('../core/api_error');
var fs = require('../core/node_fs');
var util_1 = require('../core/util');
var MountableFileSystem = (function (_super) {
    __extends(MountableFileSystem, _super);
    function MountableFileSystem() {
        _super.call(this);
        this.mntMap = {};
        this.rootFs = new InMemory_1["default"]();
    }
    MountableFileSystem.prototype.mount = function (mountPoint, fs) {
        if (mountPoint[0] !== '/') {
            mountPoint = "/" + mountPoint;
        }
        if (this.mntMap[mountPoint]) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Mount point " + mountPoint + " is already taken.");
        }
        util_1.mkdirpSync(mountPoint, 0x1ff, this.rootFs);
        this.mntMap[mountPoint] = fs;
    };
    MountableFileSystem.prototype.umount = function (mountPoint) {
        if (!this.mntMap[mountPoint]) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Mount point " + mountPoint + " is already unmounted.");
        }
        delete this.mntMap[mountPoint];
        this.rootFs.rmdirSync(mountPoint);
    };
    MountableFileSystem.prototype._getFs = function (path) {
        for (var mountPoint in this.mntMap) {
            var fs = this.mntMap[mountPoint];
            if (path.indexOf(mountPoint) === 0) {
                path = path.substr(mountPoint.length > 1 ? mountPoint.length : 0);
                if (path === '') {
                    path = '/';
                }
                return { fs: fs, path: path };
            }
        }
        return { fs: this.rootFs, path: path };
    };
    MountableFileSystem.prototype.getName = function () {
        return 'MountableFileSystem';
    };
    MountableFileSystem.isAvailable = function () {
        return true;
    };
    MountableFileSystem.prototype.diskSpace = function (path, cb) {
        cb(0, 0);
    };
    MountableFileSystem.prototype.isReadOnly = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsLinks = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsProps = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsSynch = function () {
        return true;
    };
    MountableFileSystem.prototype.standardizeError = function (err, path, realPath) {
        var index;
        if (-1 !== (index = err.message.indexOf(path))) {
            err.message = err.message.substr(0, index) + realPath + err.message.substr(index + path.length);
        }
        err.path = realPath;
        return err;
    };
    MountableFileSystem.prototype.rename = function (oldPath, newPath, cb) {
        var fs1_rv = this._getFs(oldPath);
        var fs2_rv = this._getFs(newPath);
        if (fs1_rv.fs === fs2_rv.fs) {
            var _this = this;
            return fs1_rv.fs.rename(fs1_rv.path, fs2_rv.path, function (e) {
                if (e)
                    _this.standardizeError(_this.standardizeError(e, fs1_rv.path, oldPath), fs2_rv.path, newPath);
                cb(e);
            });
        }
        return fs.readFile(oldPath, function (err, data) {
            if (err) {
                return cb(err);
            }
            fs.writeFile(newPath, data, function (err) {
                if (err) {
                    return cb(err);
                }
                fs.unlink(oldPath, cb);
            });
        });
    };
    MountableFileSystem.prototype.renameSync = function (oldPath, newPath) {
        var fs1_rv = this._getFs(oldPath);
        var fs2_rv = this._getFs(newPath);
        if (fs1_rv.fs === fs2_rv.fs) {
            try {
                return fs1_rv.fs.renameSync(fs1_rv.path, fs2_rv.path);
            }
            catch (e) {
                this.standardizeError(this.standardizeError(e, fs1_rv.path, oldPath), fs2_rv.path, newPath);
                throw e;
            }
        }
        var data = fs.readFileSync(oldPath);
        fs.writeFileSync(newPath, data);
        return fs.unlinkSync(oldPath);
    };
    return MountableFileSystem;
})(file_system.BaseFileSystem);
exports.__esModule = true;
exports["default"] = MountableFileSystem;
function defineFcn(name, isSync, numArgs) {
    if (isSync) {
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i - 0] = arguments[_i];
            }
            var self = this;
            var path = args[0];
            var rv = self._getFs(path);
            args[0] = rv.path;
            try {
                return rv.fs[name].apply(rv.fs, args);
            }
            catch (e) {
                self.standardizeError(e, rv.path, path);
                throw e;
            }
        };
    }
    else {
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i - 0] = arguments[_i];
            }
            var self = this;
            var path = args[0];
            var rv = self._getFs(path);
            args[0] = rv.path;
            if (typeof args[args.length - 1] === 'function') {
                var cb = args[args.length - 1];
                args[args.length - 1] = function () {
                    var args = [];
                    for (var _i = 0; _i < arguments.length; _i++) {
                        args[_i - 0] = arguments[_i];
                    }
                    if (args.length > 0 && args[0] instanceof api_error_1.ApiError) {
                        self.standardizeError(args[0], rv.path, path);
                    }
                    cb.apply(null, args);
                };
            }
            return rv.fs[name].apply(rv.fs, args);
        };
    }
}
var fsCmdMap = [
    ['readdir', 'exists', 'unlink', 'rmdir', 'readlink'],
    ['stat', 'mkdir', 'realpath', 'truncate'],
    ['open', 'readFile', 'chmod', 'utimes'],
    ['chown'],
    ['writeFile', 'appendFile']];
for (var i = 0; i < fsCmdMap.length; i++) {
    var cmds = fsCmdMap[i];
    for (var j = 0; j < cmds.length; j++) {
        var fnName = cmds[j];
        MountableFileSystem.prototype[fnName] = defineFcn(fnName, false, i + 1);
        MountableFileSystem.prototype[fnName + 'Sync'] = defineFcn(fnName + 'Sync', true, i + 1);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW91bnRhYmxlRmlsZVN5c3RlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9iYWNrZW5kL01vdW50YWJsZUZpbGVTeXN0ZW0udHMiXSwibmFtZXMiOlsiTW91bnRhYmxlRmlsZVN5c3RlbSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uY29uc3RydWN0b3IiLCJNb3VudGFibGVGaWxlU3lzdGVtLm1vdW50IiwiTW91bnRhYmxlRmlsZVN5c3RlbS51bW91bnQiLCJNb3VudGFibGVGaWxlU3lzdGVtLl9nZXRGcyIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uZ2V0TmFtZSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uaXNBdmFpbGFibGUiLCJNb3VudGFibGVGaWxlU3lzdGVtLmRpc2tTcGFjZSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uaXNSZWFkT25seSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3VwcG9ydHNMaW5rcyIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3VwcG9ydHNQcm9wcyIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3VwcG9ydHNTeW5jaCIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3RhbmRhcmRpemVFcnJvciIsIk1vdW50YWJsZUZpbGVTeXN0ZW0ucmVuYW1lIiwiTW91bnRhYmxlRmlsZVN5c3RlbS5yZW5hbWVTeW5jIiwiZGVmaW5lRmNuIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLElBQU8sV0FBVyxXQUFXLHFCQUFxQixDQUFDLENBQUM7QUFDcEQseUJBQStCLFlBQVksQ0FBQyxDQUFBO0FBQzVDLDBCQUFrQyxtQkFBbUIsQ0FBQyxDQUFBO0FBQ3RELElBQU8sRUFBRSxXQUFXLGlCQUFpQixDQUFDLENBQUM7QUFFdkMscUJBQXlCLGNBQWMsQ0FBQyxDQUFBO0FBV3hDO0lBQWlEQSx1Q0FBMEJBO0lBR3pFQTtRQUNFQyxpQkFBT0EsQ0FBQ0E7UUFDUkEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFHakJBLElBQUlB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RSxPQUFPLEVBQUUsVUFBVSxDQUFDO0lBRXBELENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDO0lBRXpDLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDO0lBRXZDLENBQUMsT0FBTyxDQUFDO0lBRVQsQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQztBQUVoQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQ3pDLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2QixHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3JDLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNkLG1CQUFtQixDQUFDLFNBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekUsbUJBQW1CLENBQUMsU0FBVSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxHQUFHLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ25HLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZpbGVfc3lzdGVtID0gcmVxdWlyZSgnLi4vY29yZS9maWxlX3N5c3RlbScpO1xuaW1wb3J0IEluTWVtb3J5RmlsZVN5c3RlbSBmcm9tICcuL0luTWVtb3J5JztcbmltcG9ydCB7QXBpRXJyb3IsIEVycm9yQ29kZX0gZnJvbSAnLi4vY29yZS9hcGlfZXJyb3InO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnLi4vY29yZS9ub2RlX2ZzJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmltcG9ydCB7bWtkaXJwU3luY30gZnJvbSAnLi4vY29yZS91dGlsJztcblxuLyoqXG4gKiBUaGUgTW91bnRhYmxlRmlsZVN5c3RlbSBhbGxvd3MgeW91IHRvIG1vdW50IG11bHRpcGxlIGJhY2tlbmQgdHlwZXMgb3JcbiAqIG11bHRpcGxlIGluc3RhbnRpYXRpb25zIG9mIHRoZSBzYW1lIGJhY2tlbmQgaW50byBhIHNpbmdsZSBmaWxlIHN5c3RlbSB0cmVlLlxuICogVGhlIGZpbGUgc3lzdGVtcyBkbyBub3QgbmVlZCB0byBrbm93IGFib3V0IGVhY2ggb3RoZXI7IGFsbCBpbnRlcmFjdGlvbnMgYXJlXG4gKiBhdXRvbWF0aWNhbGx5IGZhY2lsaXRhdGVkIHRocm91Z2ggdGhpcyBpbnRlcmZhY2UuXG4gKlxuICogRm9yIGV4YW1wbGUsIGlmIGEgZmlsZSBzeXN0ZW0gaXMgbW91bnRlZCBhdCAvbW50L2JsYWgsIGFuZCBhIHJlcXVlc3QgY2FtZSBpblxuICogZm9yIC9tbnQvYmxhaC9mb28udHh0LCB0aGUgZmlsZSBzeXN0ZW0gd291bGQgc2VlIGEgcmVxdWVzdCBmb3IgL2Zvby50eHQuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vdW50YWJsZUZpbGVTeXN0ZW0gZXh0ZW5kcyBmaWxlX3N5c3RlbS5CYXNlRmlsZVN5c3RlbSBpbXBsZW1lbnRzIGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0ge1xuICBwcml2YXRlIG1udE1hcDoge1twYXRoOiBzdHJpbmddOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtfTtcbiAgcHJpdmF0ZSByb290RnM6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW07XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5tbnRNYXAgPSB7fTtcbiAgICAvLyBUaGUgSW5NZW1vcnkgZmlsZSBzeXN0ZW0gc2VydmVzIHB1cmVseSB0byBwcm92aWRlIGRpcmVjdG9yeSBsaXN0aW5ncyBmb3JcbiAgICAvLyBtb3VudGVkIGZpbGUgc3lzdGVtcy5cbiAgICB0aGlzLnJvb3RGcyA9IG5ldyBJbk1lbW9yeUZpbGVTeXN0ZW0oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNb3VudHMgdGhlIGZpbGUgc3lzdGVtIGF0IHRoZSBnaXZlbiBtb3VudCBwb2ludC5cbiAgICovXG4gIHB1YmxpYyBtb3VudChtb3VudFBvaW50OiBzdHJpbmcsIGZzOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtKTogdm9pZCB7XG4gICAgaWYgKG1vdW50UG9pbnRbMF0gIT09ICcvJykge1xuICAgICAgbW91bnRQb2ludCA9IGAvJHttb3VudFBvaW50fWA7XG4gICAgfVxuICAgIGlmICh0aGlzLm1udE1hcFttb3VudFBvaW50XSkge1xuICAgICAgdGhyb3cgbmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIFwiTW91bnQgcG9pbnQgXCIgKyBtb3VudFBvaW50ICsgXCIgaXMgYWxyZWFkeSB0YWtlbi5cIik7XG4gICAgfVxuICAgIG1rZGlycFN5bmMobW91bnRQb2ludCwgMHgxZmYsIHRoaXMucm9vdEZzKTtcbiAgICAvLyBAdG9kbyBFbnN1cmUgbmV3IG1vdW50IHBhdGggaXMgbm90IHN1YnN1bWVkIGJ5IGFjdGl2ZSBtb3VudCBwYXRocy5cbiAgICB0aGlzLm1udE1hcFttb3VudFBvaW50XSA9IGZzO1xuICB9XG5cbiAgcHVibGljIHVtb3VudChtb3VudFBvaW50OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMubW50TWFwW21vdW50UG9pbnRdKSB7XG4gICAgICB0aHJvdyBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgXCJNb3VudCBwb2ludCBcIiArIG1vdW50UG9pbnQgKyBcIiBpcyBhbHJlYWR5IHVubW91bnRlZC5cIik7XG4gICAgfVxuICAgIGRlbGV0ZSB0aGlzLm1udE1hcFttb3VudFBvaW50XTtcbiAgICB0aGlzLnJvb3RGcy5ybWRpclN5bmMobW91bnRQb2ludCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZmlsZSBzeXN0ZW0gdGhhdCB0aGUgcGF0aCBwb2ludHMgdG8uXG4gICAqL1xuICBwdWJsaWMgX2dldEZzKHBhdGg6IHN0cmluZyk6IHtmczogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbTsgcGF0aDogc3RyaW5nfSB7XG4gICAgZm9yICh2YXIgbW91bnRQb2ludCBpbiB0aGlzLm1udE1hcCkge1xuICAgICAgdmFyIGZzID0gdGhpcy5tbnRNYXBbbW91bnRQb2ludF07XG4gICAgICBpZiAocGF0aC5pbmRleE9mKG1vdW50UG9pbnQpID09PSAwKSB7XG4gICAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihtb3VudFBvaW50Lmxlbmd0aCA+IDEgPyBtb3VudFBvaW50Lmxlbmd0aCA6IDApO1xuICAgICAgICBpZiAocGF0aCA9PT0gJycpIHtcbiAgICAgICAgICBwYXRoID0gJy8nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7ZnM6IGZzLCBwYXRoOiBwYXRofTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gUXVlcnkgb3VyIHJvb3QgZmlsZSBzeXN0ZW0uXG4gICAgcmV0dXJuIHtmczogdGhpcy5yb290RnMsIHBhdGg6IHBhdGh9O1xuICB9XG5cbiAgLy8gR2xvYmFsIGluZm9ybWF0aW9uIG1ldGhvZHNcblxuICBwdWJsaWMgZ2V0TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiAnTW91bnRhYmxlRmlsZVN5c3RlbSc7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGlzQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGRpc2tTcGFjZShwYXRoOiBzdHJpbmcsIGNiOiAodG90YWw6IG51bWJlciwgZnJlZTogbnVtYmVyKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgY2IoMCwgMCk7XG4gIH1cblxuICBwdWJsaWMgaXNSZWFkT25seSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgc3VwcG9ydHNMaW5rcygpOiBib29sZWFuIHtcbiAgICAvLyBJJ20gbm90IHJlYWR5IGZvciBjcm9zcy1GUyBsaW5rcyB5ZXQuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzUHJvcHMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogRml4ZXMgdXAgZXJyb3IgbWVzc2FnZXMgc28gdGhleSBtZW50aW9uIHRoZSBtb3VudGVkIGZpbGUgbG9jYXRpb24gcmVsYXRpdmVcbiAgICogdG8gdGhlIE1GUyByb290LCBub3QgdG8gdGhlIHBhcnRpY3VsYXIgRlMncyByb290LlxuICAgKiBNdXRhdGVzIHRoZSBpbnB1dCBlcnJvciwgYW5kIHJldHVybnMgaXQuXG4gICAqL1xuICBwcml2YXRlIHN0YW5kYXJkaXplRXJyb3IoZXJyOiBBcGlFcnJvciwgcGF0aDogc3RyaW5nLCByZWFsUGF0aDogc3RyaW5nKTogQXBpRXJyb3Ige1xuICAgIHZhciBpbmRleDogbnVtYmVyO1xuICAgIGlmICgtMSAhPT0gKGluZGV4ID0gZXJyLm1lc3NhZ2UuaW5kZXhPZihwYXRoKSkpIHtcbiAgICAgIGVyci5tZXNzYWdlID0gZXJyLm1lc3NhZ2Uuc3Vic3RyKDAsIGluZGV4KSArIHJlYWxQYXRoICsgZXJyLm1lc3NhZ2Uuc3Vic3RyKGluZGV4ICsgcGF0aC5sZW5ndGgpO1xuICAgIH1cbiAgICBlcnIucGF0aCA9IHJlYWxQYXRoO1xuICAgIHJldHVybiBlcnI7XG4gIH1cblxuICAvLyBUaGUgZm9sbG93aW5nIG1ldGhvZHMgaW52b2x2ZSBtdWx0aXBsZSBmaWxlIHN5c3RlbXMsIGFuZCB0aHVzIGhhdmUgY3VzdG9tXG4gIC8vIGxvZ2ljLlxuICAvLyBOb3RlIHRoYXQgd2UgZ28gdGhyb3VnaCB0aGUgTm9kZSBBUEkgdG8gdXNlIGl0cyByb2J1c3QgZGVmYXVsdCBhcmd1bWVudFxuICAvLyBwcm9jZXNzaW5nLlxuXG4gIHB1YmxpYyByZW5hbWUob2xkUGF0aDogc3RyaW5nLCBuZXdQYXRoOiBzdHJpbmcsIGNiOiAoZT86IEFwaUVycm9yKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgLy8gU2NlbmFyaW8gMTogb2xkIGFuZCBuZXcgYXJlIG9uIHNhbWUgRlMuXG4gICAgdmFyIGZzMV9ydiA9IHRoaXMuX2dldEZzKG9sZFBhdGgpO1xuICAgIHZhciBmczJfcnYgPSB0aGlzLl9nZXRGcyhuZXdQYXRoKTtcbiAgICBpZiAoZnMxX3J2LmZzID09PSBmczJfcnYuZnMpIHtcbiAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICByZXR1cm4gZnMxX3J2LmZzLnJlbmFtZShmczFfcnYucGF0aCwgZnMyX3J2LnBhdGgsIGZ1bmN0aW9uKGU/OiBBcGlFcnJvcikge1xuICAgICAgICBpZiAoZSkgX3RoaXMuc3RhbmRhcmRpemVFcnJvcihfdGhpcy5zdGFuZGFyZGl6ZUVycm9yKGUsIGZzMV9ydi5wYXRoLCBvbGRQYXRoKSwgZnMyX3J2LnBhdGgsIG5ld1BhdGgpO1xuICAgICAgICBjYihlKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFNjZW5hcmlvIDI6IERpZmZlcmVudCBmaWxlIHN5c3RlbXMuXG4gICAgLy8gUmVhZCBvbGQgZmlsZSwgd3JpdGUgbmV3IGZpbGUsIGRlbGV0ZSBvbGQgZmlsZS5cbiAgICByZXR1cm4gZnMucmVhZEZpbGUob2xkUGF0aCwgZnVuY3Rpb24oZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgIH1cbiAgICAgIGZzLndyaXRlRmlsZShuZXdQYXRoLCBkYXRhLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgICB9XG4gICAgICAgIGZzLnVubGluayhvbGRQYXRoLCBjYik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyByZW5hbWVTeW5jKG9sZFBhdGg6IHN0cmluZywgbmV3UGF0aDogc3RyaW5nKTogdm9pZCB7XG4gICAgLy8gU2NlbmFyaW8gMTogb2xkIGFuZCBuZXcgYXJlIG9uIHNhbWUgRlMuXG4gICAgdmFyIGZzMV9ydiA9IHRoaXMuX2dldEZzKG9sZFBhdGgpO1xuICAgIHZhciBmczJfcnYgPSB0aGlzLl9nZXRGcyhuZXdQYXRoKTtcbiAgICBpZiAoZnMxX3J2LmZzID09PSBmczJfcnYuZnMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBmczFfcnYuZnMucmVuYW1lU3luYyhmczFfcnYucGF0aCwgZnMyX3J2LnBhdGgpO1xuICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgIHRoaXMuc3RhbmRhcmRpemVFcnJvcih0aGlzLnN0YW5kYXJkaXplRXJyb3IoZSwgZnMxX3J2LnBhdGgsIG9sZFBhdGgpLCBmczJfcnYucGF0aCwgbmV3UGF0aCk7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIFNjZW5hcmlvIDI6IERpZmZlcmVudCBmaWxlIHN5c3RlbXMuXG4gICAgdmFyIGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMob2xkUGF0aCk7XG4gICAgZnMud3JpdGVGaWxlU3luYyhuZXdQYXRoLCBkYXRhKTtcbiAgICByZXR1cm4gZnMudW5saW5rU3luYyhvbGRQYXRoKTtcbiAgfVxufVxuXG4vKipcbiAqIFRyaWNreTogRGVmaW5lIGFsbCBvZiB0aGUgZnVuY3Rpb25zIHRoYXQgbWVyZWx5IGZvcndhcmQgYXJndW1lbnRzIHRvIHRoZVxuICogcmVsZXZhbnQgZmlsZSBzeXN0ZW0sIG9yIHJldHVybi90aHJvdyBhbiBlcnJvci5cbiAqIFRha2UgYWR2YW50YWdlIG9mIHRoZSBmYWN0IHRoYXQgdGhlICpmaXJzdCogYXJndW1lbnQgaXMgYWx3YXlzIHRoZSBwYXRoLCBhbmRcbiAqIHRoZSAqbGFzdCogaXMgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBhc3luYykuXG4gKi9cbmZ1bmN0aW9uIGRlZmluZUZjbihuYW1lOiBzdHJpbmcsIGlzU3luYzogYm9vbGVhbiwgbnVtQXJnczogbnVtYmVyKTogKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnkge1xuICBpZiAoaXNTeW5jKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICBsZXQgc2VsZjogTW91bnRhYmxlRmlsZVN5c3RlbSA9IHRoaXM7XG4gICAgICB2YXIgcGF0aCA9IGFyZ3NbMF07XG4gICAgICB2YXIgcnYgPSBzZWxmLl9nZXRGcyhwYXRoKTtcbiAgICAgIGFyZ3NbMF0gPSBydi5wYXRoO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIHJ2LmZzW25hbWVdLmFwcGx5KHJ2LmZzLCBhcmdzKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgKDxhbnk+IHNlbGYpLnN0YW5kYXJkaXplRXJyb3IoZSwgcnYucGF0aCwgcGF0aCk7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcbiAgICAgIGxldCBzZWxmOiBNb3VudGFibGVGaWxlU3lzdGVtID0gdGhpcztcbiAgICAgIHZhciBwYXRoID0gYXJnc1swXTtcbiAgICAgIHZhciBydiA9IHNlbGYuX2dldEZzKHBhdGgpO1xuICAgICAgYXJnc1swXSA9IHJ2LnBhdGg7XG4gICAgICBpZiAodHlwZW9mIGFyZ3NbYXJncy5sZW5ndGgtMV0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdmFyIGNiID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdO1xuICAgICAgICBhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gPSBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA+IDAgJiYgYXJnc1swXSBpbnN0YW5jZW9mIEFwaUVycm9yKSB7XG4gICAgICAgICAgICAoPGFueT4gc2VsZikuc3RhbmRhcmRpemVFcnJvcihhcmdzWzBdLCBydi5wYXRoLCBwYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2IuYXBwbHkobnVsbCwgYXJncyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBydi5mc1tuYW1lXS5hcHBseShydi5mcywgYXJncyk7XG4gICAgfTtcbiAgfVxufVxuXG52YXIgZnNDbWRNYXAgPSBbXG4gICAvLyAxIGFyZyBmdW5jdGlvbnNcbiAgIFsncmVhZGRpcicsICdleGlzdHMnLCAndW5saW5rJywgJ3JtZGlyJywgJ3JlYWRsaW5rJ10sXG4gICAvLyAyIGFyZyBmdW5jdGlvbnNcbiAgIFsnc3RhdCcsICdta2RpcicsICdyZWFscGF0aCcsICd0cnVuY2F0ZSddLFxuICAgLy8gMyBhcmcgZnVuY3Rpb25zXG4gICBbJ29wZW4nLCAncmVhZEZpbGUnLCAnY2htb2QnLCAndXRpbWVzJ10sXG4gICAvLyA0IGFyZyBmdW5jdGlvbnNcbiAgIFsnY2hvd24nXSxcbiAgIC8vIDUgYXJnIGZ1bmN0aW9uc1xuICAgWyd3cml0ZUZpbGUnLCAnYXBwZW5kRmlsZSddXTtcblxuZm9yICh2YXIgaSA9IDA7IGkgPCBmc0NtZE1hcC5sZW5ndGg7IGkrKykge1xuICB2YXIgY21kcyA9IGZzQ21kTWFwW2ldO1xuICBmb3IgKHZhciBqID0gMDsgaiA8IGNtZHMubGVuZ3RoOyBqKyspIHtcbiAgICB2YXIgZm5OYW1lID0gY21kc1tqXTtcbiAgICAoPGFueT4gTW91bnRhYmxlRmlsZVN5c3RlbS5wcm90b3R5cGUpW2ZuTmFtZV0gPSBkZWZpbmVGY24oZm5OYW1lLCBmYWxzZSwgaSArIDEpO1xuICAgICg8YW55PiBNb3VudGFibGVGaWxlU3lzdGVtLnByb3RvdHlwZSlbZm5OYW1lICsgJ1N5bmMnXSA9IGRlZmluZUZjbihmbk5hbWUgKyAnU3luYycsIHRydWUsIGkgKyAxKTtcbiAgfVxufVxuIl19