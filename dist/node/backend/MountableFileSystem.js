var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var InMemory_1 = require('./InMemory');
var api_error_1 = require('../core/api_error');
var fs = require('../core/node_fs');
var path = require('path');
var util_1 = require('../core/util');
var MountableFileSystem = (function (_super) {
    __extends(MountableFileSystem, _super);
    function MountableFileSystem() {
        _super.call(this);
        this.mountList = [];
        this.mntMap = {};
        this.rootFs = new InMemory_1["default"]();
    }
    MountableFileSystem.prototype.mount = function (mountPoint, fs) {
        if (mountPoint[0] !== '/') {
            mountPoint = "/" + mountPoint;
        }
        mountPoint = path.resolve(mountPoint);
        if (this.mntMap[mountPoint]) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Mount point " + mountPoint + " is already taken.");
        }
        util_1.mkdirpSync(mountPoint, 0x1ff, this.rootFs);
        this.mntMap[mountPoint] = fs;
        this.mountList.push(mountPoint);
        this.mountList = this.mountList.sort(function (a, b) { return b.length - a.length; });
    };
    MountableFileSystem.prototype.umount = function (mountPoint) {
        if (mountPoint[0] !== '/') {
            mountPoint = "/" + mountPoint;
        }
        mountPoint = path.resolve(mountPoint);
        if (!this.mntMap[mountPoint]) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Mount point " + mountPoint + " is already unmounted.");
        }
        delete this.mntMap[mountPoint];
        this.mountList.splice(this.mountList.indexOf(mountPoint), 1);
        while (mountPoint !== '/') {
            if (this.rootFs.readdirSync(mountPoint).length === 0) {
                this.rootFs.rmdirSync(mountPoint);
                mountPoint = path.dirname(mountPoint);
            }
            else {
                break;
            }
        }
    };
    MountableFileSystem.prototype._getFs = function (path) {
        var mountList = this.mountList, len = mountList.length;
        for (var i_1 = 0; i_1 < len; i_1++) {
            var mountPoint = mountList[i_1];
            if (mountPoint.length <= path.length && path.indexOf(mountPoint) === 0) {
                path = path.substr(mountPoint.length > 1 ? mountPoint.length : 0);
                if (path === '') {
                    path = '/';
                }
                return { fs: this.mntMap[mountPoint], path: path };
            }
        }
        return { fs: this.rootFs, path: path };
    };
    MountableFileSystem.prototype.getName = function () {
        return 'MountableFileSystem';
    };
    MountableFileSystem.isAvailable = function () {
        return true;
    };
    MountableFileSystem.prototype.diskSpace = function (path, cb) {
        cb(0, 0);
    };
    MountableFileSystem.prototype.isReadOnly = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsLinks = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsProps = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsSynch = function () {
        return true;
    };
    MountableFileSystem.prototype.standardizeError = function (err, path, realPath) {
        var index;
        if (-1 !== (index = err.message.indexOf(path))) {
            err.message = err.message.substr(0, index) + realPath + err.message.substr(index + path.length);
            err.path = realPath;
        }
        return err;
    };
    MountableFileSystem.prototype.rename = function (oldPath, newPath, cb) {
        var fs1_rv = this._getFs(oldPath);
        var fs2_rv = this._getFs(newPath);
        if (fs1_rv.fs === fs2_rv.fs) {
            var _this = this;
            return fs1_rv.fs.rename(fs1_rv.path, fs2_rv.path, function (e) {
                if (e)
                    _this.standardizeError(_this.standardizeError(e, fs1_rv.path, oldPath), fs2_rv.path, newPath);
                cb(e);
            });
        }
        return fs.readFile(oldPath, function (err, data) {
            if (err) {
                return cb(err);
            }
            fs.writeFile(newPath, data, function (err) {
                if (err) {
                    return cb(err);
                }
                fs.unlink(oldPath, cb);
            });
        });
    };
    MountableFileSystem.prototype.renameSync = function (oldPath, newPath) {
        var fs1_rv = this._getFs(oldPath);
        var fs2_rv = this._getFs(newPath);
        if (fs1_rv.fs === fs2_rv.fs) {
            try {
                return fs1_rv.fs.renameSync(fs1_rv.path, fs2_rv.path);
            }
            catch (e) {
                this.standardizeError(this.standardizeError(e, fs1_rv.path, oldPath), fs2_rv.path, newPath);
                throw e;
            }
        }
        var data = fs.readFileSync(oldPath);
        fs.writeFileSync(newPath, data);
        return fs.unlinkSync(oldPath);
    };
    MountableFileSystem.prototype.readdirSync = function (p) {
        var fsInfo = this._getFs(p);
        var rv = null;
        if (fsInfo.fs !== this.rootFs) {
            try {
                rv = this.rootFs.readdirSync(p);
            }
            catch (e) {
            }
        }
        try {
            var rv2 = fsInfo.fs.readdirSync(fsInfo.path);
            if (rv === null) {
                return rv2;
            }
            else {
                return rv2.concat(rv.filter(function (val) { return rv2.indexOf(val) === -1; }));
            }
        }
        catch (e) {
            if (rv === null) {
                throw this.standardizeError(e, fsInfo.path, p);
            }
            else {
                return rv;
            }
        }
    };
    MountableFileSystem.prototype.readdir = function (p, cb) {
        var _this = this;
        var fsInfo = this._getFs(p);
        fsInfo.fs.readdir(fsInfo.path, function (err, files) {
            if (fsInfo.fs !== _this.rootFs) {
                try {
                    var rv = _this.rootFs.readdirSync(p);
                    if (files) {
                        files = files.concat(rv.filter(function (val) { return files.indexOf(val) === -1; }));
                    }
                    else {
                        files = rv;
                    }
                }
                catch (e) {
                    if (err) {
                        return cb(_this.standardizeError(err, fsInfo.path, p));
                    }
                }
            }
            else if (err) {
                return cb(_this.standardizeError(err, fsInfo.path, p));
            }
            cb(null, files);
        });
    };
    MountableFileSystem.prototype.rmdirSync = function (p) {
        var fsInfo = this._getFs(p);
        if (this._containsMountPt(p)) {
            throw api_error_1.ApiError.ENOTEMPTY(p);
        }
        else {
            try {
                fsInfo.fs.rmdirSync(fsInfo.path);
            }
            catch (e) {
                throw this.standardizeError(e, fsInfo.path, p);
            }
        }
    };
    MountableFileSystem.prototype._containsMountPt = function (p) {
        var mountPoints = this.mountList, len = mountPoints.length;
        for (var i_2 = 0; i_2 < len; i_2++) {
            var pt = mountPoints[i_2];
            if (pt.length >= p.length && pt.slice(0, p.length) === p) {
                return true;
            }
        }
        return false;
    };
    MountableFileSystem.prototype.rmdir = function (p, cb) {
        var _this = this;
        var fsInfo = this._getFs(p);
        if (this._containsMountPt(p)) {
            cb(api_error_1.ApiError.ENOTEMPTY(p));
        }
        else {
            fsInfo.fs.rmdir(fsInfo.path, function (err) {
                cb(err ? _this.standardizeError(err, fsInfo.path, p) : null);
            });
        }
    };
    return MountableFileSystem;
})(file_system.BaseFileSystem);
exports.__esModule = true;
exports["default"] = MountableFileSystem;
function defineFcn(name, isSync, numArgs) {
    if (isSync) {
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i - 0] = arguments[_i];
            }
            var self = this;
            var path = args[0];
            var rv = self._getFs(path);
            args[0] = rv.path;
            try {
                return rv.fs[name].apply(rv.fs, args);
            }
            catch (e) {
                self.standardizeError(e, rv.path, path);
                throw e;
            }
        };
    }
    else {
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i - 0] = arguments[_i];
            }
            var self = this;
            var path = args[0];
            var rv = self._getFs(path);
            args[0] = rv.path;
            if (typeof args[args.length - 1] === 'function') {
                var cb = args[args.length - 1];
                args[args.length - 1] = function () {
                    var args = [];
                    for (var _i = 0; _i < arguments.length; _i++) {
                        args[_i - 0] = arguments[_i];
                    }
                    if (args.length > 0 && args[0] instanceof api_error_1.ApiError) {
                        self.standardizeError(args[0], rv.path, path);
                    }
                    cb.apply(null, args);
                };
            }
            return rv.fs[name].apply(rv.fs, args);
        };
    }
}
var fsCmdMap = [
    ['exists', 'unlink', 'readlink'],
    ['stat', 'mkdir', 'realpath', 'truncate'],
    ['open', 'readFile', 'chmod', 'utimes'],
    ['chown'],
    ['writeFile', 'appendFile']];
for (var i = 0; i < fsCmdMap.length; i++) {
    var cmds = fsCmdMap[i];
    for (var j = 0; j < cmds.length; j++) {
        var fnName = cmds[j];
        MountableFileSystem.prototype[fnName] = defineFcn(fnName, false, i + 1);
        MountableFileSystem.prototype[fnName + 'Sync'] = defineFcn(fnName + 'Sync', true, i + 1);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW91bnRhYmxlRmlsZVN5c3RlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9iYWNrZW5kL01vdW50YWJsZUZpbGVTeXN0ZW0udHMiXSwibmFtZXMiOlsiTW91bnRhYmxlRmlsZVN5c3RlbSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uY29uc3RydWN0b3IiLCJNb3VudGFibGVGaWxlU3lzdGVtLm1vdW50IiwiTW91bnRhYmxlRmlsZVN5c3RlbS51bW91bnQiLCJNb3VudGFibGVGaWxlU3lzdGVtLl9nZXRGcyIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uZ2V0TmFtZSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uaXNBdmFpbGFibGUiLCJNb3VudGFibGVGaWxlU3lzdGVtLmRpc2tTcGFjZSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uaXNSZWFkT25seSIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3VwcG9ydHNMaW5rcyIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3VwcG9ydHNQcm9wcyIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3VwcG9ydHNTeW5jaCIsIk1vdW50YWJsZUZpbGVTeXN0ZW0uc3RhbmRhcmRpemVFcnJvciIsIk1vdW50YWJsZUZpbGVTeXN0ZW0ucmVuYW1lIiwiTW91bnRhYmxlRmlsZVN5c3RlbS5yZW5hbWVTeW5jIiwiTW91bnRhYmxlRmlsZVN5c3RlbS5yZWFkZGlyU3luYyIsIk1vdW50YWJsZUZpbGVTeXN0ZW0ucmVhZGRpciIsIk1vdW50YWJsZUZpbGVTeXN0ZW0ucm1kaXJTeW5jIiwiTW91bnRhYmxlRmlsZVN5c3RlbS5fY29udGFpbnNNb3VudFB0IiwiTW91bnRhYmxlRmlsZVN5c3RlbS5ybWRpciIsImRlZmluZUZjbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFPLFdBQVcsV0FBVyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ3BELHlCQUErQixZQUFZLENBQUMsQ0FBQTtBQUM1QywwQkFBa0MsbUJBQW1CLENBQUMsQ0FBQTtBQUN0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QUFDQSxNQUFNQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDckRBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO2dCQUNsQ0EsVUFBVUEsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7WUFDeENBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUNOQSxLQUFLQSxDQUFDQTtZQUNSQSxDQUFDQTtRQUNIQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUtNSCxvQ0FBTUEsR0FBYkEsVUFBY0EsSUFBWUE7UUFDeEJJLElBQUlBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLEVBQUVBLEdBQUdBLEdBQUdBLFNBQVNBLENBQUNBLE1BQU1BLENBQUNBO1FBQ3ZEQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxHQUFDQSxHQUFHQSxHQUFHQSxFQUFFQSxHQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUM3QkEsSUFBSUEsVUFBVUEsR0FBR0EsU0FBU0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFOUJBLEVBQUVBLENBQUNBLENBQUNBLFVBQVVBLENBQUNBLE1BQU1BLElBQUlBLElBQUlBLENBQUNBLE1BQU1BLElBQUlBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFVBQVVBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN2RUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsR0FBR0EsVUFBVUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2xFQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxLQUFLQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDaEJBLElBQUlBLEdBQUdBLEdBQUdBLENBQUNBO2dCQUNiQSxD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TyxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUM7SUFFekMsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUM7SUFFdkMsQ0FBQyxPQUFPLENBQUM7SUFFVCxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBRWhDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDekMsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDckMsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2QsbUJBQW1CLENBQUMsU0FBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN6RSxtQkFBbUIsQ0FBQyxTQUFVLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDbkcsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmlsZV9zeXN0ZW0gPSByZXF1aXJlKCcuLi9jb3JlL2ZpbGVfc3lzdGVtJyk7XG5pbXBvcnQgSW5NZW1vcnlGaWxlU3lzdGVtIGZyb20gJy4vSW5NZW1vcnknO1xuaW1wb3J0IHtBcGlFcnJvciwgRXJyb3JDb2RlfSBmcm9tICcuLi9jb3JlL2FwaV9lcnJvcic7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCcuLi9jb3JlL25vZGVfZnMnKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHtta2RpcnBTeW5jfSBmcm9tICcuLi9jb3JlL3V0aWwnO1xuXG4vKipcbiAqIFRoZSBNb3VudGFibGVGaWxlU3lzdGVtIGFsbG93cyB5b3UgdG8gbW91bnQgbXVsdGlwbGUgYmFja2VuZCB0eXBlcyBvclxuICogbXVsdGlwbGUgaW5zdGFudGlhdGlvbnMgb2YgdGhlIHNhbWUgYmFja2VuZCBpbnRvIGEgc2luZ2xlIGZpbGUgc3lzdGVtIHRyZWUuXG4gKiBUaGUgZmlsZSBzeXN0ZW1zIGRvIG5vdCBuZWVkIHRvIGtub3cgYWJvdXQgZWFjaCBvdGhlcjsgYWxsIGludGVyYWN0aW9ucyBhcmVcbiAqIGF1dG9tYXRpY2FsbHkgZmFjaWxpdGF0ZWQgdGhyb3VnaCB0aGlzIGludGVyZmFjZS5cbiAqXG4gKiBGb3IgZXhhbXBsZSwgaWYgYSBmaWxlIHN5c3RlbSBpcyBtb3VudGVkIGF0IC9tbnQvYmxhaCwgYW5kIGEgcmVxdWVzdCBjYW1lIGluXG4gKiBmb3IgL21udC9ibGFoL2Zvby50eHQsIHRoZSBmaWxlIHN5c3RlbSB3b3VsZCBzZWUgYSByZXF1ZXN0IGZvciAvZm9vLnR4dC5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTW91bnRhYmxlRmlsZVN5c3RlbSBleHRlbmRzIGZpbGVfc3lzdGVtLkJhc2VGaWxlU3lzdGVtIGltcGxlbWVudHMgZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbSB7XG4gIHByaXZhdGUgbW50TWFwOiB7W3BhdGg6IHN0cmluZ106IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW19O1xuICAvLyBDb250YWlucyB0aGUgbGlzdCBvZiBtb3VudCBwb2ludHMgaW4gbW50TWFwLCBzb3J0ZWQgYnkgc3RyaW5nIGxlbmd0aCBpbiBkZWNyZWFzaW5nIG9yZGVyLlxuICAvLyBFbnN1cmVzIHRoYXQgd2Ugc2NhbiB0aGUgbW9zdCBzcGVjaWZpYyBtb3VudCBwb2ludHMgZm9yIGEgbWF0Y2ggZmlyc3QsIHdoaWNoIGxldHMgdXNcbiAgLy8gbmVzdCBtb3VudCBwb2ludHMuXG4gIHByaXZhdGUgbW91bnRMaXN0OiBzdHJpbmdbXSA9IFtdO1xuICBwcml2YXRlIHJvb3RGczogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbTtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm1udE1hcCA9IHt9O1xuICAgIC8vIFRoZSBJbk1lbW9yeSBmaWxlIHN5c3RlbSBzZXJ2ZXMgcHVyZWx5IHRvIHByb3ZpZGUgZGlyZWN0b3J5IGxpc3RpbmdzIGZvclxuICAgIC8vIG1vdW50ZWQgZmlsZSBzeXN0ZW1zLlxuICAgIHRoaXMucm9vdEZzID0gbmV3IEluTWVtb3J5RmlsZVN5c3RlbSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIE1vdW50cyB0aGUgZmlsZSBzeXN0ZW0gYXQgdGhlIGdpdmVuIG1vdW50IHBvaW50LlxuICAgKi9cbiAgcHVibGljIG1vdW50KG1vdW50UG9pbnQ6IHN0cmluZywgZnM6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0pOiB2b2lkIHtcbiAgICBpZiAobW91bnRQb2ludFswXSAhPT0gJy8nKSB7XG4gICAgICBtb3VudFBvaW50ID0gYC8ke21vdW50UG9pbnR9YDtcbiAgICB9XG4gICAgbW91bnRQb2ludCA9IHBhdGgucmVzb2x2ZShtb3VudFBvaW50KTtcbiAgICBpZiAodGhpcy5tbnRNYXBbbW91bnRQb2ludF0pIHtcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBcIk1vdW50IHBvaW50IFwiICsgbW91bnRQb2ludCArIFwiIGlzIGFscmVhZHkgdGFrZW4uXCIpO1xuICAgIH1cbiAgICBta2RpcnBTeW5jKG1vdW50UG9pbnQsIDB4MWZmLCB0aGlzLnJvb3RGcyk7XG4gICAgdGhpcy5tbnRNYXBbbW91bnRQb2ludF0gPSBmcztcbiAgICB0aGlzLm1vdW50TGlzdC5wdXNoKG1vdW50UG9pbnQpO1xuICAgIHRoaXMubW91bnRMaXN0ID0gdGhpcy5tb3VudExpc3Quc29ydCgoYSwgYikgPT4gYi5sZW5ndGggLSBhLmxlbmd0aCk7XG4gIH1cblxuICBwdWJsaWMgdW1vdW50KG1vdW50UG9pbnQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChtb3VudFBvaW50WzBdICE9PSAnLycpIHtcbiAgICAgIG1vdW50UG9pbnQgPSBgLyR7bW91bnRQb2ludH1gO1xuICAgIH1cbiAgICBtb3VudFBvaW50ID0gcGF0aC5yZXNvbHZlKG1vdW50UG9pbnQpO1xuICAgIGlmICghdGhpcy5tbnRNYXBbbW91bnRQb2ludF0pIHtcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBcIk1vdW50IHBvaW50IFwiICsgbW91bnRQb2ludCArIFwiIGlzIGFscmVhZHkgdW5tb3VudGVkLlwiKTtcbiAgICB9XG4gICAgZGVsZXRlIHRoaXMubW50TWFwW21vdW50UG9pbnRdO1xuICAgIHRoaXMubW91bnRMaXN0LnNwbGljZSh0aGlzLm1vdW50TGlzdC5pbmRleE9mKG1vdW50UG9pbnQpLCAxKTtcblxuICAgIHdoaWxlIChtb3VudFBvaW50ICE9PSAnLycpIHtcbiAgICAgIGlmICh0aGlzLnJvb3RGcy5yZWFkZGlyU3luYyhtb3VudFBvaW50KS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhpcy5yb290RnMucm1kaXJTeW5jKG1vdW50UG9pbnQpO1xuICAgICAgICBtb3VudFBvaW50ID0gcGF0aC5kaXJuYW1lKG1vdW50UG9pbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGZpbGUgc3lzdGVtIHRoYXQgdGhlIHBhdGggcG9pbnRzIHRvLlxuICAgKi9cbiAgcHVibGljIF9nZXRGcyhwYXRoOiBzdHJpbmcpOiB7ZnM6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW07IHBhdGg6IHN0cmluZ30ge1xuICAgIGxldCBtb3VudExpc3QgPSB0aGlzLm1vdW50TGlzdCwgbGVuID0gbW91bnRMaXN0Lmxlbmd0aDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBsZXQgbW91bnRQb2ludCA9IG1vdW50TGlzdFtpXTtcbiAgICAgIC8vIFdlIGtub3cgcGF0aCBpcyBub3JtYWxpemVkLCBzbyBpdCBpcyBhIHN1YnN0cmluZyBvZiB0aGUgbW91bnQgcG9pbnQuXG4gICAgICBpZiAobW91bnRQb2ludC5sZW5ndGggPD0gcGF0aC5sZW5ndGggJiYgcGF0aC5pbmRleE9mKG1vdW50UG9pbnQpID09PSAwKSB7XG4gICAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihtb3VudFBvaW50Lmxlbmd0aCA+IDEgPyBtb3VudFBvaW50Lmxlbmd0aCA6IDApO1xuICAgICAgICBpZiAocGF0aCA9PT0gJycpIHtcbiAgICAgICAgICBwYXRoID0gJy8nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7ZnM6IHRoaXMubW50TWFwW21vdW50UG9pbnRdLCBwYXRoOiBwYXRofTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gUXVlcnkgb3VyIHJvb3QgZmlsZSBzeXN0ZW0uXG4gICAgcmV0dXJuIHtmczogdGhpcy5yb290RnMsIHBhdGg6IHBhdGh9O1xuICB9XG5cbiAgLy8gR2xvYmFsIGluZm9ybWF0aW9uIG1ldGhvZHNcblxuICBwdWJsaWMgZ2V0TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiAnTW91bnRhYmxlRmlsZVN5c3RlbSc7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGlzQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGRpc2tTcGFjZShwYXRoOiBzdHJpbmcsIGNiOiAodG90YWw6IG51bWJlciwgZnJlZTogbnVtYmVyKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgY2IoMCwgMCk7XG4gIH1cblxuICBwdWJsaWMgaXNSZWFkT25seSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgc3VwcG9ydHNMaW5rcygpOiBib29sZWFuIHtcbiAgICAvLyBJJ20gbm90IHJlYWR5IGZvciBjcm9zcy1GUyBsaW5rcyB5ZXQuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzUHJvcHMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogRml4ZXMgdXAgZXJyb3IgbWVzc2FnZXMgc28gdGhleSBtZW50aW9uIHRoZSBtb3VudGVkIGZpbGUgbG9jYXRpb24gcmVsYXRpdmVcbiAgICogdG8gdGhlIE1GUyByb290LCBub3QgdG8gdGhlIHBhcnRpY3VsYXIgRlMncyByb290LlxuICAgKiBNdXRhdGVzIHRoZSBpbnB1dCBlcnJvciwgYW5kIHJldHVybnMgaXQuXG4gICAqL1xuICBwcml2YXRlIHN0YW5kYXJkaXplRXJyb3IoZXJyOiBBcGlFcnJvciwgcGF0aDogc3RyaW5nLCByZWFsUGF0aDogc3RyaW5nKTogQXBpRXJyb3Ige1xuICAgIHZhciBpbmRleDogbnVtYmVyO1xuICAgIGlmICgtMSAhPT0gKGluZGV4ID0gZXJyLm1lc3NhZ2UuaW5kZXhPZihwYXRoKSkpIHtcbiAgICAgIGVyci5tZXNzYWdlID0gZXJyLm1lc3NhZ2Uuc3Vic3RyKDAsIGluZGV4KSArIHJlYWxQYXRoICsgZXJyLm1lc3NhZ2Uuc3Vic3RyKGluZGV4ICsgcGF0aC5sZW5ndGgpO1xuICAgICAgZXJyLnBhdGggPSByZWFsUGF0aDtcbiAgICB9XG4gICAgcmV0dXJuIGVycjtcbiAgfVxuXG4gIC8vIFRoZSBmb2xsb3dpbmcgbWV0aG9kcyBpbnZvbHZlIG11bHRpcGxlIGZpbGUgc3lzdGVtcywgYW5kIHRodXMgaGF2ZSBjdXN0b21cbiAgLy8gbG9naWMuXG4gIC8vIE5vdGUgdGhhdCB3ZSBnbyB0aHJvdWdoIHRoZSBOb2RlIEFQSSB0byB1c2UgaXRzIHJvYnVzdCBkZWZhdWx0IGFyZ3VtZW50XG4gIC8vIHByb2Nlc3NpbmcuXG5cbiAgcHVibGljIHJlbmFtZShvbGRQYXRoOiBzdHJpbmcsIG5ld1BhdGg6IHN0cmluZywgY2I6IChlPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAvLyBTY2VuYXJpbyAxOiBvbGQgYW5kIG5ldyBhcmUgb24gc2FtZSBGUy5cbiAgICB2YXIgZnMxX3J2ID0gdGhpcy5fZ2V0RnMob2xkUGF0aCk7XG4gICAgdmFyIGZzMl9ydiA9IHRoaXMuX2dldEZzKG5ld1BhdGgpO1xuICAgIGlmIChmczFfcnYuZnMgPT09IGZzMl9ydi5mcykge1xuICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgIHJldHVybiBmczFfcnYuZnMucmVuYW1lKGZzMV9ydi5wYXRoLCBmczJfcnYucGF0aCwgZnVuY3Rpb24oZT86IEFwaUVycm9yKSB7XG4gICAgICAgIGlmIChlKSBfdGhpcy5zdGFuZGFyZGl6ZUVycm9yKF90aGlzLnN0YW5kYXJkaXplRXJyb3IoZSwgZnMxX3J2LnBhdGgsIG9sZFBhdGgpLCBmczJfcnYucGF0aCwgbmV3UGF0aCk7XG4gICAgICAgIGNiKGUpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gU2NlbmFyaW8gMjogRGlmZmVyZW50IGZpbGUgc3lzdGVtcy5cbiAgICAvLyBSZWFkIG9sZCBmaWxlLCB3cml0ZSBuZXcgZmlsZSwgZGVsZXRlIG9sZCBmaWxlLlxuICAgIHJldHVybiBmcy5yZWFkRmlsZShvbGRQYXRoLCBmdW5jdGlvbihlcnI6IEFwaUVycm9yLCBkYXRhPzogYW55KSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgfVxuICAgICAgZnMud3JpdGVGaWxlKG5ld1BhdGgsIGRhdGEsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIGNiKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgZnMudW5saW5rKG9sZFBhdGgsIGNiKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHJlbmFtZVN5bmMob2xkUGF0aDogc3RyaW5nLCBuZXdQYXRoOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAvLyBTY2VuYXJpbyAxOiBvbGQgYW5kIG5ldyBhcmUgb24gc2FtZSBGUy5cbiAgICB2YXIgZnMxX3J2ID0gdGhpcy5fZ2V0RnMob2xkUGF0aCk7XG4gICAgdmFyIGZzMl9ydiA9IHRoaXMuX2dldEZzKG5ld1BhdGgpO1xuICAgIGlmIChmczFfcnYuZnMgPT09IGZzMl9ydi5mcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGZzMV9ydi5mcy5yZW5hbWVTeW5jKGZzMV9ydi5wYXRoLCBmczJfcnYucGF0aCk7XG4gICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgdGhpcy5zdGFuZGFyZGl6ZUVycm9yKHRoaXMuc3RhbmRhcmRpemVFcnJvcihlLCBmczFfcnYucGF0aCwgb2xkUGF0aCksIGZzMl9ydi5wYXRoLCBuZXdQYXRoKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gU2NlbmFyaW8gMjogRGlmZmVyZW50IGZpbGUgc3lzdGVtcy5cbiAgICB2YXIgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhvbGRQYXRoKTtcbiAgICBmcy53cml0ZUZpbGVTeW5jKG5ld1BhdGgsIGRhdGEpO1xuICAgIHJldHVybiBmcy51bmxpbmtTeW5jKG9sZFBhdGgpO1xuICB9XG5cbiAgcHVibGljIHJlYWRkaXJTeW5jKHA6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICBsZXQgZnNJbmZvID0gdGhpcy5fZ2V0RnMocCk7XG5cbiAgICAvLyBJZiBudWxsLCByb290ZnMgZGlkIG5vdCBoYXZlIHRoZSBkaXJlY3RvcnlcbiAgICAvLyAob3IgdGhlIHRhcmdldCBGUyBpcyB0aGUgcm9vdCBmcykuXG4gICAgbGV0IHJ2ID0gbnVsbDtcbiAgICAvLyBNb3VudCBwb2ludHMgYXJlIGFsbCBkZWZpbmVkIGluIHRoZSByb290IEZTLlxuICAgIC8vIEVuc3VyZSB0aGF0IHdlIGxpc3QgdGhvc2UsIHRvby5cbiAgICBpZiAoZnNJbmZvLmZzICE9PSB0aGlzLnJvb3RGcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcnYgPSB0aGlzLnJvb3RGcy5yZWFkZGlyU3luYyhwKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gSWdub3JlLlxuICAgICAgfVxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBsZXQgcnYyID0gZnNJbmZvLmZzLnJlYWRkaXJTeW5jKGZzSW5mby5wYXRoKTtcbiAgICAgIGlmIChydiA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gcnYyO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gRmlsdGVyIG91dCBkdXBsaWNhdGVzLlxuICAgICAgICByZXR1cm4gcnYyLmNvbmNhdChydi5maWx0ZXIoKHZhbCkgPT4gcnYyLmluZGV4T2YodmFsKSA9PT0gLTEpKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgIGlmIChydiA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyB0aGlzLnN0YW5kYXJkaXplRXJyb3IoZSwgZnNJbmZvLnBhdGgsIHApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVGhlIHJvb3QgRlMgaGFkIHNvbWV0aGluZy5cbiAgICAgICAgcmV0dXJuIHJ2O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZWFkZGlyKHA6IHN0cmluZywgY2I6IChlcnI6IE5vZGVKUy5FcnJub0V4Y2VwdGlvbiwgbGlzdGluZz86IHN0cmluZ1tdKSA9PiBhbnkpOiB2b2lkIHtcbiAgICBsZXQgZnNJbmZvID0gdGhpcy5fZ2V0RnMocCk7XG4gICAgZnNJbmZvLmZzLnJlYWRkaXIoZnNJbmZvLnBhdGgsIChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICBpZiAoZnNJbmZvLmZzICE9PSB0aGlzLnJvb3RGcykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGxldCBydiA9IHRoaXMucm9vdEZzLnJlYWRkaXJTeW5jKHApO1xuICAgICAgICAgIGlmIChmaWxlcykge1xuICAgICAgICAgICAgLy8gRmlsdGVyIG91dCBkdXBsaWNhdGVzLlxuICAgICAgICAgICAgZmlsZXMgPSBmaWxlcy5jb25jYXQocnYuZmlsdGVyKCh2YWwpID0+IGZpbGVzLmluZGV4T2YodmFsKSA9PT0gLTEpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZmlsZXMgPSBydjtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAvLyBSb290IEZTIGFuZCB0YXJnZXQgRlMgZGlkIG5vdCBoYXZlIGRpcmVjdG9yeS5cbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gY2IodGhpcy5zdGFuZGFyZGl6ZUVycm9yKGVyciwgZnNJbmZvLnBhdGgsIHApKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZXJyKSB7XG4gICAgICAgIC8vIFJvb3QgRlMgYW5kIHRhcmdldCBGUyBhcmUgdGhlIHNhbWUsIGFuZCBkaWQgbm90IGhhdmUgZGlyZWN0b3J5LlxuICAgICAgICByZXR1cm4gY2IodGhpcy5zdGFuZGFyZGl6ZUVycm9yKGVyciwgZnNJbmZvLnBhdGgsIHApKTtcbiAgICAgIH1cblxuICAgICAgY2IobnVsbCwgZmlsZXMpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHJtZGlyU3luYyhwOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBsZXQgZnNJbmZvID0gdGhpcy5fZ2V0RnMocCk7XG4gICAgaWYgKHRoaXMuX2NvbnRhaW5zTW91bnRQdChwKSkge1xuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVEVNUFRZKHApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cnkge1xuICAgICAgICBmc0luZm8uZnMucm1kaXJTeW5jKGZzSW5mby5wYXRoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgdGhpcy5zdGFuZGFyZGl6ZUVycm9yKGUsIGZzSW5mby5wYXRoLCBwKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBwYXRoIGNvbnRhaW5zIGEgbW91bnQgcG9pbnQuXG4gICAqL1xuICBwcml2YXRlIF9jb250YWluc01vdW50UHQocDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgbGV0IG1vdW50UG9pbnRzID0gdGhpcy5tb3VudExpc3QsIGxlbiA9IG1vdW50UG9pbnRzLmxlbmd0aDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBsZXQgcHQgPSBtb3VudFBvaW50c1tpXTtcbiAgICAgIGlmIChwdC5sZW5ndGggPj0gcC5sZW5ndGggJiYgcHQuc2xpY2UoMCwgcC5sZW5ndGgpID09PSBwKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgcm1kaXIocDogc3RyaW5nLCBjYjogKGVycj86IE5vZGVKUy5FcnJub0V4Y2VwdGlvbikgPT4gYW55KTogdm9pZCB7XG4gICAgbGV0IGZzSW5mbyA9IHRoaXMuX2dldEZzKHApO1xuICAgIGlmICh0aGlzLl9jb250YWluc01vdW50UHQocCkpIHtcbiAgICAgIGNiKEFwaUVycm9yLkVOT1RFTVBUWShwKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZzSW5mby5mcy5ybWRpcihmc0luZm8ucGF0aCwgKGVycj8pID0+IHtcbiAgICAgICAgY2IoZXJyID8gdGhpcy5zdGFuZGFyZGl6ZUVycm9yKGVyciwgZnNJbmZvLnBhdGgsIHApIDogbnVsbCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBUcmlja3k6IERlZmluZSBhbGwgb2YgdGhlIGZ1bmN0aW9ucyB0aGF0IG1lcmVseSBmb3J3YXJkIGFyZ3VtZW50cyB0byB0aGVcbiAqIHJlbGV2YW50IGZpbGUgc3lzdGVtLCBvciByZXR1cm4vdGhyb3cgYW4gZXJyb3IuXG4gKiBUYWtlIGFkdmFudGFnZSBvZiB0aGUgZmFjdCB0aGF0IHRoZSAqZmlyc3QqIGFyZ3VtZW50IGlzIGFsd2F5cyB0aGUgcGF0aCwgYW5kXG4gKiB0aGUgKmxhc3QqIGlzIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgYXN5bmMpLlxuICogQHRvZG8gQ2FuIHVzZSBudW1BcmdzIHRvIG1ha2UgcHJveHlpbmcgbW9yZSBlZmZpY2llbnQuXG4gKi9cbmZ1bmN0aW9uIGRlZmluZUZjbihuYW1lOiBzdHJpbmcsIGlzU3luYzogYm9vbGVhbiwgbnVtQXJnczogbnVtYmVyKTogKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnkge1xuICBpZiAoaXNTeW5jKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICBsZXQgc2VsZjogTW91bnRhYmxlRmlsZVN5c3RlbSA9IHRoaXM7XG4gICAgICB2YXIgcGF0aCA9IGFyZ3NbMF07XG4gICAgICB2YXIgcnYgPSBzZWxmLl9nZXRGcyhwYXRoKTtcbiAgICAgIGFyZ3NbMF0gPSBydi5wYXRoO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIHJ2LmZzW25hbWVdLmFwcGx5KHJ2LmZzLCBhcmdzKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgKDxhbnk+IHNlbGYpLnN0YW5kYXJkaXplRXJyb3IoZSwgcnYucGF0aCwgcGF0aCk7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcbiAgICAgIGxldCBzZWxmOiBNb3VudGFibGVGaWxlU3lzdGVtID0gdGhpcztcbiAgICAgIHZhciBwYXRoID0gYXJnc1swXTtcbiAgICAgIHZhciBydiA9IHNlbGYuX2dldEZzKHBhdGgpO1xuICAgICAgYXJnc1swXSA9IHJ2LnBhdGg7XG4gICAgICBpZiAodHlwZW9mIGFyZ3NbYXJncy5sZW5ndGgtMV0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdmFyIGNiID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdO1xuICAgICAgICBhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gPSBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA+IDAgJiYgYXJnc1swXSBpbnN0YW5jZW9mIEFwaUVycm9yKSB7XG4gICAgICAgICAgICAoPGFueT4gc2VsZikuc3RhbmRhcmRpemVFcnJvcihhcmdzWzBdLCBydi5wYXRoLCBwYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2IuYXBwbHkobnVsbCwgYXJncyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBydi5mc1tuYW1lXS5hcHBseShydi5mcywgYXJncyk7XG4gICAgfTtcbiAgfVxufVxuXG52YXIgZnNDbWRNYXAgPSBbXG4gICAvLyAxIGFyZyBmdW5jdGlvbnNcbiAgIFsnZXhpc3RzJywgJ3VubGluaycsICdyZWFkbGluayddLFxuICAgLy8gMiBhcmcgZnVuY3Rpb25zXG4gICBbJ3N0YXQnLCAnbWtkaXInLCAncmVhbHBhdGgnLCAndHJ1bmNhdGUnXSxcbiAgIC8vIDMgYXJnIGZ1bmN0aW9uc1xuICAgWydvcGVuJywgJ3JlYWRGaWxlJywgJ2NobW9kJywgJ3V0aW1lcyddLFxuICAgLy8gNCBhcmcgZnVuY3Rpb25zXG4gICBbJ2Nob3duJ10sXG4gICAvLyA1IGFyZyBmdW5jdGlvbnNcbiAgIFsnd3JpdGVGaWxlJywgJ2FwcGVuZEZpbGUnXV07XG5cbmZvciAodmFyIGkgPSAwOyBpIDwgZnNDbWRNYXAubGVuZ3RoOyBpKyspIHtcbiAgdmFyIGNtZHMgPSBmc0NtZE1hcFtpXTtcbiAgZm9yICh2YXIgaiA9IDA7IGogPCBjbWRzLmxlbmd0aDsgaisrKSB7XG4gICAgdmFyIGZuTmFtZSA9IGNtZHNbal07XG4gICAgKDxhbnk+IE1vdW50YWJsZUZpbGVTeXN0ZW0ucHJvdG90eXBlKVtmbk5hbWVdID0gZGVmaW5lRmNuKGZuTmFtZSwgZmFsc2UsIGkgKyAxKTtcbiAgICAoPGFueT4gTW91bnRhYmxlRmlsZVN5c3RlbS5wcm90b3R5cGUpW2ZuTmFtZSArICdTeW5jJ10gPSBkZWZpbmVGY24oZm5OYW1lICsgJ1N5bmMnLCB0cnVlLCBpICsgMSk7XG4gIH1cbn1cbiJdfQ==