var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var file_flag = require('../core/file_flag');
var preload_file = require('../generic/preload_file');
var MirrorFile = (function (_super) {
    __extends(MirrorFile, _super);
    function MirrorFile(fs, path, flag, stat, data) {
        _super.call(this, fs, path, flag, stat, data);
    }
    MirrorFile.prototype.syncSync = function () {
        if (this.isDirty()) {
            this._fs._syncSync(this);
            this.resetDirty();
        }
    };
    MirrorFile.prototype.closeSync = function () {
        this.syncSync();
    };
    return MirrorFile;
})(preload_file.PreloadFile);
var AsyncMirror = (function (_super) {
    __extends(AsyncMirror, _super);
    function AsyncMirror(sync, async) {
        _super.call(this);
        this._queue = [];
        this._queueRunning = false;
        this._isInitialized = false;
        this._sync = sync;
        this._async = async;
        if (!sync.supportsSynch()) {
            throw new Error("Expected synchronous storage.");
        }
        if (async.supportsSynch()) {
            throw new Error("Expected asynchronous storage.");
        }
    }
    AsyncMirror.prototype.getName = function () {
        return "AsyncMirror";
    };
    AsyncMirror.isAvailable = function () {
        return true;
    };
    AsyncMirror.prototype._syncSync = function (fd) {
        this._sync.writeFileSync(fd.getPath(), fd.getBuffer(), null, file_flag.FileFlag.getFileFlag('w'), fd.getStats().mode);
        this.enqueueOp({
            apiMethod: 'writeFile',
            arguments: [fd.getPath(), fd.getBuffer(), null, fd.getFlag(), fd.getStats().mode]
        });
    };
    AsyncMirror.prototype.initialize = function (finalCb) {
        var _this = this;
        if (!this._isInitialized) {
            var copyDirectory = function (p, mode, cb) {
                if (p !== '/') {
                    _this._sync.mkdirSync(p, mode);
                }
                _this._async.readdir(p, function (err, files) {
                    if (err) {
                        cb(err);
                    }
                    else {
                        var i = 0;
                        function copyNextFile(err) {
                            if (err) {
                                cb(err);
                            }
                            else if (i < files.length) {
                                copyItem(p + "/" + files[i], copyNextFile);
                                i++;
                            }
                            else {
                                cb();
                            }
                        }
                        copyNextFile();
                    }
                });
            }, copyFile = function (p, mode, cb) {
                _this._async.readFile(p, null, file_flag.FileFlag.getFileFlag('r'), function (err, data) {
                    if (err) {
                        cb(err);
                    }
                    else {
                        try {
                            _this._sync.writeFileSync(p, data, null, file_flag.FileFlag.getFileFlag('w'), mode);
                        }
                        catch (e) {
                            err = e;
                        }
                        finally {
                            cb(err);
                        }
                    }
                });
            }, copyItem = function (p, cb) {
                _this._async.stat(p, false, function (err, stats) {
                    if (err) {
                        cb(err);
                    }
                    else if (stats.isDirectory()) {
                        copyDirectory(p, stats.mode, cb);
                    }
                    else {
                        copyFile(p, stats.mode, cb);
                    }
                });
            };
            copyDirectory('/', 0, function (err) {
                if (err) {
                    finalCb(err);
                }
                else {
                    _this._isInitialized = true;
                    finalCb();
                }
            });
        }
        else {
            finalCb();
        }
    };
    AsyncMirror.prototype.isReadOnly = function () { return false; };
    AsyncMirror.prototype.supportsSynch = function () { return true; };
    AsyncMirror.prototype.supportsLinks = function () { return false; };
    AsyncMirror.prototype.supportsProps = function () { return this._sync.supportsProps() && this._async.supportsProps(); };
    AsyncMirror.prototype.enqueueOp = function (op) {
        var _this = this;
        this._queue.push(op);
        if (!this._queueRunning) {
            this._queueRunning = true;
            var doNextOp = function (err) {
                if (err) {
                    console.error("WARNING: File system has desynchronized. Received following error: " + err + "\n$");
                }
                if (_this._queue.length > 0) {
                    var op = _this._queue.shift(), args = op.arguments;
                    args.push(doNextOp);
                    _this._async[op.apiMethod].apply(_this._async, args);
                }
                else {
                    _this._queueRunning = false;
                }
            };
            doNextOp();
        }
    };
    AsyncMirror.prototype.renameSync = function (oldPath, newPath) {
        this._sync.renameSync(oldPath, newPath);
        this.enqueueOp({
            apiMethod: 'rename',
            arguments: [oldPath, newPath]
        });
    };
    AsyncMirror.prototype.statSync = function (p, isLstat) {
        return this._sync.statSync(p, isLstat);
    };
    AsyncMirror.prototype.openSync = function (p, flag, mode) {
        var fd = this._sync.openSync(p, flag, mode);
        fd.closeSync();
        return new MirrorFile(this, p, flag, this._sync.statSync(p, false), this._sync.readFileSync(p, null, file_flag.FileFlag.getFileFlag('r')));
    };
    AsyncMirror.prototype.unlinkSync = function (p) {
        this._sync.unlinkSync(p);
        this.enqueueOp({
            apiMethod: 'unlink',
            arguments: [p]
        });
    };
    AsyncMirror.prototype.rmdirSync = function (p) {
        this._sync.rmdirSync(p);
        this.enqueueOp({
            apiMethod: 'rmdir',
            arguments: [p]
        });
    };
    AsyncMirror.prototype.mkdirSync = function (p, mode) {
        this._sync.mkdirSync(p, mode);
        this.enqueueOp({
            apiMethod: 'mkdir',
            arguments: [p, mode]
        });
    };
    AsyncMirror.prototype.readdirSync = function (p) {
        return this._sync.readdirSync(p);
    };
    AsyncMirror.prototype.existsSync = function (p) {
        return this._sync.existsSync(p);
    };
    AsyncMirror.prototype.chmodSync = function (p, isLchmod, mode) {
        this._sync.chmodSync(p, isLchmod, mode);
        this.enqueueOp({
            apiMethod: 'chmod',
            arguments: [p, isLchmod, mode]
        });
    };
    AsyncMirror.prototype.chownSync = function (p, isLchown, uid, gid) {
        this._sync.chownSync(p, isLchown, uid, gid);
        this.enqueueOp({
            apiMethod: 'chown',
            arguments: [p, isLchown, uid, gid]
        });
    };
    AsyncMirror.prototype.utimesSync = function (p, atime, mtime) {
        this._sync.utimesSync(p, atime, mtime);
        this.enqueueOp({
            apiMethod: 'utimes',
            arguments: [p, atime, mtime]
        });
    };
    return AsyncMirror;
})(file_system.SynchronousFileSystem);
exports.__esModule = true;
exports["default"] = AsyncMirror;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXN5bmNNaXJyb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFja2VuZC9Bc3luY01pcnJvci50cyJdLCJuYW1lcyI6WyJNaXJyb3JGaWxlIiwiTWlycm9yRmlsZS5jb25zdHJ1Y3RvciIsIk1pcnJvckZpbGUuc3luY1N5bmMiLCJNaXJyb3JGaWxlLmNsb3NlU3luYyIsIkFzeW5jTWlycm9yIiwiQXN5bmNNaXJyb3IuY29uc3RydWN0b3IiLCJBc3luY01pcnJvci5nZXROYW1lIiwiQXN5bmNNaXJyb3IuaXNBdmFpbGFibGUiLCJBc3luY01pcnJvci5fc3luY1N5bmMiLCJBc3luY01pcnJvci5pbml0aWFsaXplIiwiQXN5bmNNaXJyb3IuaW5pdGlhbGl6ZS5jb3B5TmV4dEZpbGUiLCJBc3luY01pcnJvci5pc1JlYWRPbmx5IiwiQXN5bmNNaXJyb3Iuc3VwcG9ydHNTeW5jaCIsIkFzeW5jTWlycm9yLnN1cHBvcnRzTGlua3MiLCJBc3luY01pcnJvci5zdXBwb3J0c1Byb3BzIiwiQXN5bmNNaXJyb3IuZW5xdWV1ZU9wIiwiQXN5bmNNaXJyb3IucmVuYW1lU3luYyIsIkFzeW5jTWlycm9yLnN0YXRTeW5jIiwiQXN5bmNNaXJyb3Iub3BlblN5bmMiLCJBc3luY01pcnJvci51bmxpbmtTeW5jIiwiQXN5bmNNaXJyb3Iucm1kaXJTeW5jIiwiQXN5bmNNaXJyb3IubWtkaXJTeW5jIiwiQXN5bmNNaXJyb3IucmVhZGRpclN5bmMiLCJBc3luY01pcnJvci5leGlzdHNTeW5jIiwiQXN5bmNNaXJyb3IuY2htb2RTeW5jIiwiQXN5bmNNaXJyb3IuY2hvd25TeW5jIiwiQXN5bmNNaXJyb3IudXRpbWVzU3luYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFPLFdBQVcsV0FBVyxxQkFBcUIsQ0FBQyxDQUFDO0FBRXBELElBQU8sU0FBUyxXQUFXLG1CQUFtQixDQUFDLENBQUM7QUFHaEQsSUFBTyxZQUFZLFdBQVcseUJBQXlCLENBQUMsQ0FB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S0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsS0FBS0EsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDdkNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBO1lBQ2JBLFNBQVNBLEVBQUVBLFFBQVFBO1lBQ25CQSxTQUFTQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxDQUFDQTtTQUM3QkEsQ0FBQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFDSHRCLGtCQUFDQTtBQUFEQSxDQUFDQSxBQWhNRCxFQUF5QyxXQUFXLENBQUMscUJBQXFCLEVBZ016RTtBQWhNRDtnQ0FnTUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmaWxlX3N5c3RlbSA9IHJlcXVpcmUoJy4uL2NvcmUvZmlsZV9zeXN0ZW0nKTtcbmltcG9ydCB7QXBpRXJyb3IsIEVycm9yQ29kZX0gZnJvbSAnLi4vY29yZS9hcGlfZXJyb3InO1xuaW1wb3J0IGZpbGVfZmxhZyA9IHJlcXVpcmUoJy4uL2NvcmUvZmlsZV9mbGFnJyk7XG5pbXBvcnQgZmlsZSA9IHJlcXVpcmUoJy4uL2NvcmUvZmlsZScpO1xuaW1wb3J0IFN0YXRzIGZyb20gJy4uL2NvcmUvbm9kZV9mc19zdGF0cyc7XG5pbXBvcnQgcHJlbG9hZF9maWxlID0gcmVxdWlyZSgnLi4vZ2VuZXJpYy9wcmVsb2FkX2ZpbGUnKTtcblxuaW50ZXJmYWNlIElBc3luY09wZXJhdGlvbiB7XG5cdGFwaU1ldGhvZDogc3RyaW5nO1xuXHRhcmd1bWVudHM6IGFueVtdO1xufVxuXG4vKipcbiAqIFdlIGRlZmluZSBvdXIgb3duIGZpbGUgdG8gaW50ZXJwb3NlIG9uIHN5bmNTeW5jKCkgZm9yIG1pcnJvcmluZyBwdXJwb3Nlcy5cbiAqL1xuY2xhc3MgTWlycm9yRmlsZSBleHRlbmRzIHByZWxvYWRfZmlsZS5QcmVsb2FkRmlsZTxBc3luY01pcnJvcj4gaW1wbGVtZW50cyBmaWxlLkZpbGUge1xuICBjb25zdHJ1Y3RvcihmczogQXN5bmNNaXJyb3IsIHBhdGg6IHN0cmluZywgZmxhZzogZmlsZV9mbGFnLkZpbGVGbGFnLCBzdGF0OiBTdGF0cywgZGF0YTogQnVmZmVyKSB7XG4gICAgc3VwZXIoZnMsIHBhdGgsIGZsYWcsIHN0YXQsIGRhdGEpO1xuICB9XG5cbiAgcHVibGljIHN5bmNTeW5jKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmlzRGlydHkoKSkge1xuICAgICAgdGhpcy5fZnMuX3N5bmNTeW5jKHRoaXMpO1xuICAgICAgdGhpcy5yZXNldERpcnR5KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNsb3NlU3luYygpOiB2b2lkIHtcbiAgICB0aGlzLnN5bmNTeW5jKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBBc3luY01pcnJvckZTIG1pcnJvcnMgYSBzeW5jaHJvbm91cyBmaWxlc3lzdGVtIGludG8gYW4gYXN5bmNocm9ub3VzIGZpbGVzeXN0ZW1cbiAqIGJ5OlxuICogKiBQZXJmb3JtaW5nIG9wZXJhdGlvbnMgb3ZlciB0aGUgaW4tbWVtb3J5IGNvcHksIHdoaWxlIGFzeW5jaHJvbm91c2x5IHBpcGVsaW5pbmcgdGhlbVxuICogICB0byB0aGUgYmFja2luZyBzdG9yZS5cbiAqICogRHVyaW5nIGFwcGxpY2F0aW9uIGxvYWRpbmcsIHRoZSBjb250ZW50cyBvZiB0aGUgYXN5bmMgZmlsZSBzeXN0ZW0gY2FuIGJlIHJlbG9hZGVkIGludG9cbiAqICAgdGhlIHN5bmNocm9ub3VzIHN0b3JlLCBpZiBkZXNpcmVkLlxuICogVGhlIHR3byBzdG9yZXMgd2lsbCBiZSBrZXB0IGluIHN5bmMuIFRoZSBtb3N0IGNvbW1vbiB1c2UtY2FzZSBpcyB0byBwYWlyIGEgc3luY2hyb25vdXNcbiAqIGluLW1lbW9yeSBmaWxlc3lzdGVtIHdpdGggYW4gYXN5bmNocm9ub3VzIGJhY2tpbmcgc3RvcmUuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFzeW5jTWlycm9yIGV4dGVuZHMgZmlsZV9zeXN0ZW0uU3luY2hyb25vdXNGaWxlU3lzdGVtIGltcGxlbWVudHMgZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbSB7XG4gIC8qKlxuICAgKiBRdWV1ZSBvZiBwZW5kaW5nIGFzeW5jaHJvbm91cyBvcGVyYXRpb25zLlxuICAgKi9cbiAgcHJpdmF0ZSBfcXVldWU6IElBc3luY09wZXJhdGlvbltdID0gW107XG4gIHByaXZhdGUgX3F1ZXVlUnVubmluZzogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIF9zeW5jOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtO1xuICBwcml2YXRlIF9hc3luYzogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbTtcbiAgcHJpdmF0ZSBfaXNJbml0aWFsaXplZDogYm9vbGVhbiA9IGZhbHNlO1xuICBjb25zdHJ1Y3RvcihzeW5jOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtLCBhc3luYzogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc3luYyA9IHN5bmM7XG4gICAgdGhpcy5fYXN5bmMgPSBhc3luYztcbiAgICBpZiAoIXN5bmMuc3VwcG9ydHNTeW5jaCgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFeHBlY3RlZCBzeW5jaHJvbm91cyBzdG9yYWdlLlwiKTtcbiAgICB9XG4gICAgaWYgKGFzeW5jLnN1cHBvcnRzU3luY2goKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXhwZWN0ZWQgYXN5bmNocm9ub3VzIHN0b3JhZ2UuXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXROYW1lKCk6IHN0cmluZyB7XG5cdCBcdHJldHVybiBcIkFzeW5jTWlycm9yXCI7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGlzQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIF9zeW5jU3luYyhmZDogcHJlbG9hZF9maWxlLlByZWxvYWRGaWxlPGFueT4pIHtcbiAgICB0aGlzLl9zeW5jLndyaXRlRmlsZVN5bmMoZmQuZ2V0UGF0aCgpLCBmZC5nZXRCdWZmZXIoKSwgbnVsbCwgZmlsZV9mbGFnLkZpbGVGbGFnLmdldEZpbGVGbGFnKCd3JyksIGZkLmdldFN0YXRzKCkubW9kZSk7XG4gICAgdGhpcy5lbnF1ZXVlT3Aoe1xuICAgICAgYXBpTWV0aG9kOiAnd3JpdGVGaWxlJyxcbiAgICAgIGFyZ3VtZW50czogW2ZkLmdldFBhdGgoKSwgZmQuZ2V0QnVmZmVyKCksIG51bGwsIGZkLmdldEZsYWcoKSwgZmQuZ2V0U3RhdHMoKS5tb2RlXVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGxlZCBvbmNlIHRvIGxvYWQgdXAgZmlsZXMgZnJvbSBhc3luYyBzdG9yYWdlIGludG8gc3luYyBzdG9yYWdlLlxuICAgKi9cbiAgcHVibGljIGluaXRpYWxpemUoZmluYWxDYjogKGVycj86IEFwaUVycm9yKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLl9pc0luaXRpYWxpemVkKSB7XG4gICAgICB2YXIgY29weURpcmVjdG9yeSA9IChwOiBzdHJpbmcsIG1vZGU6IG51bWJlciwgY2I6IChlcnI/OiBBcGlFcnJvcikgPT4gdm9pZCkgPT4ge1xuICAgICAgICBpZiAocCAhPT0gJy8nKSB7XG4gICAgICAgICAgdGhpcy5fc3luYy5ta2RpclN5bmMocCwgbW9kZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYXN5bmMucmVhZGRpcihwLCAoZXJyLCBmaWxlcykgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGNiKGVycik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBpID0gMDtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGNvcHlOZXh0RmlsZShlcnI/OiBBcGlFcnJvcikge1xuICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY2IoZXJyKTtcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpIDwgZmlsZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29weUl0ZW0oYCR7cH0vJHtmaWxlc1tpXX1gLCBjb3B5TmV4dEZpbGUpO1xuICAgICAgICAgICAgICAgIGkrKztcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjYigpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb3B5TmV4dEZpbGUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSwgY29weUZpbGUgPSAocDogc3RyaW5nLCBtb2RlOiBudW1iZXIsIGNiOiAoZXJyPzogQXBpRXJyb3IpID0+IHZvaWQpID0+IHtcbiAgICAgICAgdGhpcy5fYXN5bmMucmVhZEZpbGUocCwgbnVsbCwgZmlsZV9mbGFnLkZpbGVGbGFnLmdldEZpbGVGbGFnKCdyJyksIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjYihlcnIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICB0aGlzLl9zeW5jLndyaXRlRmlsZVN5bmMocCwgZGF0YSwgbnVsbCwgZmlsZV9mbGFnLkZpbGVGbGFnLmdldEZpbGVGbGFnKCd3JyksIG1vZGUpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICBlcnIgPSBlO1xuICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgY2IoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSwgY29weUl0ZW0gPSAocDogc3RyaW5nLCBjYjogKGVycj86IEFwaUVycm9yKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgIHRoaXMuX2FzeW5jLnN0YXQocCwgZmFsc2UsIChlcnIsIHN0YXRzKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY2IoZXJyKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGNvcHlEaXJlY3RvcnkocCwgc3RhdHMubW9kZSwgY2IpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb3B5RmlsZShwLCBzdGF0cy5tb2RlLCBjYik7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH07XG4gICAgICBjb3B5RGlyZWN0b3J5KCcvJywgMCwgKGVycj86IEFwaUVycm9yKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBmaW5hbENiKGVycik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5faXNJbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgICAgZmluYWxDYigpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmluYWxDYigpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpc1JlYWRPbmx5KCk6IGJvb2xlYW4geyByZXR1cm4gZmFsc2U7IH1cbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7IHJldHVybiB0cnVlOyB9XG4gIHB1YmxpYyBzdXBwb3J0c0xpbmtzKCk6IGJvb2xlYW4geyByZXR1cm4gZmFsc2U7IH1cbiAgcHVibGljIHN1cHBvcnRzUHJvcHMoKTogYm9vbGVhbiB7IHJldHVybiB0aGlzLl9zeW5jLnN1cHBvcnRzUHJvcHMoKSAmJiB0aGlzLl9hc3luYy5zdXBwb3J0c1Byb3BzKCk7IH1cblxuICBwcml2YXRlIGVucXVldWVPcChvcDogSUFzeW5jT3BlcmF0aW9uKSB7XG4gICAgdGhpcy5fcXVldWUucHVzaChvcCk7XG4gICAgaWYgKCF0aGlzLl9xdWV1ZVJ1bm5pbmcpIHtcbiAgICAgIHRoaXMuX3F1ZXVlUnVubmluZyA9IHRydWU7XG4gICAgICB2YXIgZG9OZXh0T3AgPSAoZXJyPzogQXBpRXJyb3IpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFdBUk5JTkc6IEZpbGUgc3lzdGVtIGhhcyBkZXN5bmNocm9uaXplZC4gUmVjZWl2ZWQgZm9sbG93aW5nIGVycm9yOiAke2Vycn1cXG4kYCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX3F1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB2YXIgb3AgPSB0aGlzLl9xdWV1ZS5zaGlmdCgpLFxuICAgICAgICAgICAgYXJncyA9IG9wLmFyZ3VtZW50cztcbiAgICAgICAgICBhcmdzLnB1c2goZG9OZXh0T3ApO1xuICAgICAgICAgICg8RnVuY3Rpb24+ICg8YW55PiB0aGlzLl9hc3luYylbb3AuYXBpTWV0aG9kXSkuYXBwbHkodGhpcy5fYXN5bmMsIGFyZ3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX3F1ZXVlUnVubmluZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgZG9OZXh0T3AoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVuYW1lU3luYyhvbGRQYXRoOiBzdHJpbmcsIG5ld1BhdGg6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuX3N5bmMucmVuYW1lU3luYyhvbGRQYXRoLCBuZXdQYXRoKTtcbiAgICB0aGlzLmVucXVldWVPcCh7XG4gICAgICBhcGlNZXRob2Q6ICdyZW5hbWUnLFxuICAgICAgYXJndW1lbnRzOiBbb2xkUGF0aCwgbmV3UGF0aF1cbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgc3RhdFN5bmMocDogc3RyaW5nLCBpc0xzdGF0OiBib29sZWFuKTogU3RhdHMge1xuICAgIHJldHVybiB0aGlzLl9zeW5jLnN0YXRTeW5jKHAsIGlzTHN0YXQpO1xuICB9XG4gIHB1YmxpYyBvcGVuU3luYyhwOiBzdHJpbmcsIGZsYWc6IGZpbGVfZmxhZy5GaWxlRmxhZywgbW9kZTogbnVtYmVyKTogZmlsZS5GaWxlIHtcbiAgICAvLyBTYW5pdHkgY2hlY2s6IElzIHRoaXMgb3Blbi9jbG9zZSBwZXJtaXR0ZWQ/XG4gICAgdmFyIGZkID0gdGhpcy5fc3luYy5vcGVuU3luYyhwLCBmbGFnLCBtb2RlKTtcbiAgICBmZC5jbG9zZVN5bmMoKTtcbiAgICByZXR1cm4gbmV3IE1pcnJvckZpbGUodGhpcywgcCwgZmxhZywgdGhpcy5fc3luYy5zdGF0U3luYyhwLCBmYWxzZSksIHRoaXMuX3N5bmMucmVhZEZpbGVTeW5jKHAsIG51bGwsIGZpbGVfZmxhZy5GaWxlRmxhZy5nZXRGaWxlRmxhZygncicpKSk7XG4gIH1cbiAgcHVibGljIHVubGlua1N5bmMocDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5fc3luYy51bmxpbmtTeW5jKHApO1xuICAgIHRoaXMuZW5xdWV1ZU9wKHtcbiAgICAgIGFwaU1ldGhvZDogJ3VubGluaycsXG4gICAgICBhcmd1bWVudHM6IFtwXVxuICAgIH0pO1xuICB9XG4gIHB1YmxpYyBybWRpclN5bmMocDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5fc3luYy5ybWRpclN5bmMocCk7XG4gICAgdGhpcy5lbnF1ZXVlT3Aoe1xuICAgICAgYXBpTWV0aG9kOiAncm1kaXInLFxuICAgICAgYXJndW1lbnRzOiBbcF1cbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgbWtkaXJTeW5jKHA6IHN0cmluZywgbW9kZTogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5fc3luYy5ta2RpclN5bmMocCwgbW9kZSk7XG4gICAgdGhpcy5lbnF1ZXVlT3Aoe1xuICAgICAgYXBpTWV0aG9kOiAnbWtkaXInLFxuICAgICAgYXJndW1lbnRzOiBbcCwgbW9kZV1cbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgcmVhZGRpclN5bmMocDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLl9zeW5jLnJlYWRkaXJTeW5jKHApO1xuICB9XG4gIHB1YmxpYyBleGlzdHNTeW5jKHA6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9zeW5jLmV4aXN0c1N5bmMocCk7XG4gIH1cbiAgcHVibGljIGNobW9kU3luYyhwOiBzdHJpbmcsIGlzTGNobW9kOiBib29sZWFuLCBtb2RlOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9zeW5jLmNobW9kU3luYyhwLCBpc0xjaG1vZCwgbW9kZSk7XG4gICAgdGhpcy5lbnF1ZXVlT3Aoe1xuICAgICAgYXBpTWV0aG9kOiAnY2htb2QnLFxuICAgICAgYXJndW1lbnRzOiBbcCwgaXNMY2htb2QsIG1vZGVdXG4gICAgfSk7XG4gIH1cbiAgcHVibGljIGNob3duU3luYyhwOiBzdHJpbmcsIGlzTGNob3duOiBib29sZWFuLCB1aWQ6IG51bWJlciwgZ2lkOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9zeW5jLmNob3duU3luYyhwLCBpc0xjaG93biwgdWlkLCBnaWQpO1xuICAgIHRoaXMuZW5xdWV1ZU9wKHtcbiAgICAgIGFwaU1ldGhvZDogJ2Nob3duJyxcbiAgICAgIGFyZ3VtZW50czogW3AsIGlzTGNob3duLCB1aWQsIGdpZF1cbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgdXRpbWVzU3luYyhwOiBzdHJpbmcsIGF0aW1lOiBEYXRlLCBtdGltZTogRGF0ZSk6IHZvaWQge1xuICAgIHRoaXMuX3N5bmMudXRpbWVzU3luYyhwLCBhdGltZSwgbXRpbWUpO1xuICAgIHRoaXMuZW5xdWV1ZU9wKHtcbiAgICAgIGFwaU1ldGhvZDogJ3V0aW1lcycsXG4gICAgICBhcmd1bWVudHM6IFtwLCBhdGltZSwgbXRpbWVdXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==