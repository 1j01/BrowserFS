var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var file_flag = require('../core/file_flag');
var preload_file = require('../generic/preload_file');
var MirrorFile = (function (_super) {
    __extends(MirrorFile, _super);
    function MirrorFile(fs, path, flag, stat, data) {
        _super.call(this, fs, path, flag, stat, data);
    }
    MirrorFile.prototype.syncSync = function () {
        if (this.isDirty()) {
            this._fs._syncSync(this);
            this.resetDirty();
        }
    };
    MirrorFile.prototype.closeSync = function () {
        this.syncSync();
    };
    return MirrorFile;
})(preload_file.PreloadFile);
var AsyncMirror = (function (_super) {
    __extends(AsyncMirror, _super);
    function AsyncMirror(sync, async) {
        _super.call(this);
        this._queue = [];
        this._queueRunning = false;
        this._isInitialized = false;
        this._sync = sync;
        this._async = async;
        if (!sync.supportsSynch()) {
            throw new Error("Expected synchronous storage.");
        }
        if (async.supportsSynch()) {
            throw new Error("Expected asynchronous storage.");
        }
    }
    AsyncMirror.prototype.getName = function () {
        return "AsyncMirror";
    };
    AsyncMirror.isAvailable = function () {
        return true;
    };
    AsyncMirror.prototype._syncSync = function (fd) {
        this._sync.writeFileSync(fd.getPath(), fd.getBuffer(), null, file_flag.FileFlag.getFileFlag('w'), fd.getStats().mode);
        this.enqueueOp({
            apiMethod: 'writeFile',
            arguments: [fd.getPath(), fd.getBuffer(), null, fd.getFlag(), fd.getStats().mode]
        });
    };
    AsyncMirror.prototype.initialize = function (finalCb) {
        var _this = this;
        if (!this._isInitialized) {
            var copyDirectory = function (p, mode, cb) {
                if (p !== '/') {
                    _this._sync.mkdirSync(p, mode);
                }
                _this._async.readdir(p, function (err, files) {
                    if (err) {
                        cb(err);
                    }
                    else {
                        var i = 0;
                        function copyNextFile(err) {
                            if (err) {
                                cb(err);
                            }
                            else if (i < files.length) {
                                copyItem(p + "/" + files[i], copyNextFile);
                                i++;
                            }
                            else {
                                cb();
                            }
                        }
                        copyNextFile();
                    }
                });
            }, copyFile = function (p, mode, cb) {
                _this._async.readFile(p, null, file_flag.FileFlag.getFileFlag('r'), function (err, data) {
                    if (err) {
                        cb(err);
                    }
                    else {
                        try {
                            _this._sync.writeFileSync(p, data, null, file_flag.FileFlag.getFileFlag('w'), mode);
                        }
                        catch (e) {
                            err = e;
                        }
                        finally {
                            cb(err);
                        }
                    }
                });
            }, copyItem = function (p, cb) {
                _this._async.stat(p, false, function (err, stats) {
                    if (err) {
                        cb(err);
                    }
                    else if (stats.isDirectory()) {
                        copyDirectory(p, stats.mode, cb);
                    }
                    else {
                        copyFile(p, stats.mode, cb);
                    }
                });
            };
            copyDirectory('/', 0, function (err) {
                if (err) {
                    finalCb(err);
                }
                else {
                    _this._isInitialized = true;
                    finalCb();
                }
            });
        }
        else {
            finalCb();
        }
    };
    AsyncMirror.prototype.isReadOnly = function () { return false; };
    AsyncMirror.prototype.supportsSynch = function () { return true; };
    AsyncMirror.prototype.supportsLinks = function () { return false; };
    AsyncMirror.prototype.supportsProps = function () { return this._sync.supportsProps() && this._async.supportsProps(); };
    AsyncMirror.prototype.enqueueOp = function (op) {
        var _this = this;
        this._queue.push(op);
        if (!this._queueRunning) {
            this._queueRunning = true;
            var doNextOp = function (err) {
                if (err) {
                    console.error("WARNING: File system has desynchronized. Received following error: " + err + "\n$");
                }
                if (_this._queue.length > 0) {
                    var op = _this._queue.shift(), args = op.arguments;
                    args.push(doNextOp);
                    _this._async[op.apiMethod].apply(_this._async, args);
                }
                else {
                    _this._queueRunning = false;
                }
            };
            doNextOp();
        }
    };
    AsyncMirror.prototype.renameSync = function (oldPath, newPath) {
        this._sync.renameSync(oldPath, newPath);
        this.enqueueOp({
            apiMethod: 'rename',
            arguments: [oldPath, newPath]
        });
    };
    AsyncMirror.prototype.statSync = function (p, isLstat) {
        return this._sync.statSync(p, isLstat);
    };
    AsyncMirror.prototype.openSync = function (p, flag, mode) {
        var fd = this._sync.openSync(p, flag, mode);
        fd.closeSync();
        return new MirrorFile(this, p, flag, this._sync.statSync(p, false), this._sync.readFileSync(p, null, file_flag.FileFlag.getFileFlag('r')));
    };
    AsyncMirror.prototype.unlinkSync = function (p) {
        this._sync.unlinkSync(p);
        this.enqueueOp({
            apiMethod: 'unlink',
            arguments: [p]
        });
    };
    AsyncMirror.prototype.rmdirSync = function (p) {
        this._sync.rmdirSync(p);
        this.enqueueOp({
            apiMethod: 'rmdir',
            arguments: [p]
        });
    };
    AsyncMirror.prototype.mkdirSync = function (p, mode) {
        this._sync.mkdirSync(p, mode);
        this.enqueueOp({
            apiMethod: 'mkdir',
            arguments: [p, mode]
        });
    };
    AsyncMirror.prototype.readdirSync = function (p) {
        return this._sync.readdirSync(p);
    };
    AsyncMirror.prototype.existsSync = function (p) {
        return this._sync.existsSync(p);
    };
    AsyncMirror.prototype.chmodSync = function (p, isLchmod, mode) {
        this._sync.chmodSync(p, isLchmod, mode);
        this.enqueueOp({
            apiMethod: 'chmod',
            arguments: [p, isLchmod, mode]
        });
    };
    AsyncMirror.prototype.chownSync = function (p, isLchown, uid, gid) {
        this._sync.chownSync(p, isLchown, uid, gid);
        this.enqueueOp({
            apiMethod: 'chown',
            arguments: [p, isLchown, uid, gid]
        });
    };
    AsyncMirror.prototype.utimesSync = function (p, atime, mtime) {
        this._sync.utimesSync(p, atime, mtime);
        this.enqueueOp({
            apiMethod: 'utimes',
            arguments: [p, atime, mtime]
        });
    };
    return AsyncMirror;
})(file_system.SynchronousFileSystem);
exports.__esModule = true;
exports["default"] = AsyncMirror;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXN5bmNNaXJyb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFja2VuZC9Bc3luY01pcnJvci50cyJdLCJuYW1lcyI6WyJNaXJyb3JGaWxlIiwiTWlycm9yRmlsZS5jb25zdHJ1Y3RvciIsIk1pcnJvckZpbGUuc3luY1N5bmMiLCJNaXJyb3JGaWxlLmNsb3NlU3luYyIsIkFzeW5jTWlycm9yIiwiQXN5bmNNaXJyb3IuY29uc3RydWN0b3IiLCJBc3luY01pcnJvci5nZXROYW1lIiwiQXN5bmNNaXJyb3IuaXNBdmFpbGFibGUiLCJBc3luY01pcnJvci5fc3luY1N5bmMiLCJBc3luY01pcnJvci5pbml0aWFsaXplIiwiQXN5bmNNaXJyb3IuaW5pdGlhbGl6ZS5jb3B5TmV4dEZpbGUiLCJBc3luY01pcnJvci5pc1JlYWRPbmx5IiwiQXN5bmNNaXJyb3Iuc3VwcG9ydHNTeW5jaCIsIkFzeW5jTWlycm9yLnN1cHBvcnRzTGlua3MiLCJBc3luY01pcnJvci5zdXBwb3J0c1Byb3BzIiwiQXN5bmNNaXJyb3IuZW5xdWV1ZU9wIiwiQXN5bmNNaXJyb3IucmVuYW1lU3luYyIsIkFzeW5jTWlycm9yLnN0YXRTeW5jIiwiQXN5bmNNaXJyb3Iub3BlblN5bmMiLCJBc3luY01pcnJvci51bmxpbmtTeW5jIiwiQXN5bmNNaXJyb3Iucm1kaXJTeW5jIiwiQXN5bmNNaXJyb3IubWtkaXJTeW5jIiwiQXN5bmNNaXJyb3IucmVhZGRpclN5bmMiLCJBc3luY01pcnJvci5leGlzdHNTeW5jIiwiQXN5bmNNaXJyb3IuY2htb2RTeW5jIiwiQXN5bmNNaXJyb3IuY2hvd25TeW5jIiwiQXN5bmNNaXJyb3IudXRpbWVzU3luYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFPLFdBQVcsV0FBVyxxQkFBcUIsQ0FBQyxDQUFDO0FBRXBELElBQU8sU0FBUyxXQUFXLG1CQUFtQixDQUFDLENBQUM7QUFHaEQsSUFBTyxZQUFZLFdBQVcseUJBQXlCLENBQUMsQ0FB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QUtBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLEVBQUVBLEtBQUtBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBQ3ZDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQTtZQUNiQSxTQUFTQSxFQUFFQSxRQUFRQTtZQUNuQkEsU0FBU0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsS0FBS0EsRUFBRUEsS0FBS0EsQ0FBQ0E7U0FDN0JBLENBQUNBLENBQUNBO0lBQ0xBLENBQUNBO0lBQ0h0QixrQkFBQ0E7QUFBREEsQ0FBQ0EsQUFoTUQsRUFBeUMsV0FBVyxDQUFDLHFCQUFxQixFQWdNekU7QUFoTUQ7Z0NBZ01DLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmlsZV9zeXN0ZW0gPSByZXF1aXJlKCcuLi9jb3JlL2ZpbGVfc3lzdGVtJyk7XG5pbXBvcnQge0FwaUVycm9yLCBFcnJvckNvZGV9IGZyb20gJy4uL2NvcmUvYXBpX2Vycm9yJztcbmltcG9ydCBmaWxlX2ZsYWcgPSByZXF1aXJlKCcuLi9jb3JlL2ZpbGVfZmxhZycpO1xuaW1wb3J0IGZpbGUgPSByZXF1aXJlKCcuLi9jb3JlL2ZpbGUnKTtcbmltcG9ydCBub2RlX2ZzX3N0YXRzID0gcmVxdWlyZSgnLi4vY29yZS9ub2RlX2ZzX3N0YXRzJyk7XG5pbXBvcnQgcHJlbG9hZF9maWxlID0gcmVxdWlyZSgnLi4vZ2VuZXJpYy9wcmVsb2FkX2ZpbGUnKTtcblxuaW50ZXJmYWNlIElBc3luY09wZXJhdGlvbiB7XG5cdGFwaU1ldGhvZDogc3RyaW5nO1xuXHRhcmd1bWVudHM6IGFueVtdO1xufVxuXG4vKipcbiAqIFdlIGRlZmluZSBvdXIgb3duIGZpbGUgdG8gaW50ZXJwb3NlIG9uIHN5bmNTeW5jKCkgZm9yIG1pcnJvcmluZyBwdXJwb3Nlcy5cbiAqL1xuY2xhc3MgTWlycm9yRmlsZSBleHRlbmRzIHByZWxvYWRfZmlsZS5QcmVsb2FkRmlsZTxBc3luY01pcnJvcj4gaW1wbGVtZW50cyBmaWxlLkZpbGUge1xuICBjb25zdHJ1Y3RvcihmczogQXN5bmNNaXJyb3IsIHBhdGg6IHN0cmluZywgZmxhZzogZmlsZV9mbGFnLkZpbGVGbGFnLCBzdGF0OiBub2RlX2ZzX3N0YXRzLlN0YXRzLCBkYXRhOiBCdWZmZXIpIHtcbiAgICBzdXBlcihmcywgcGF0aCwgZmxhZywgc3RhdCwgZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgc3luY1N5bmMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNEaXJ0eSgpKSB7XG4gICAgICB0aGlzLl9mcy5fc3luY1N5bmModGhpcyk7XG4gICAgICB0aGlzLnJlc2V0RGlydHkoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xvc2VTeW5jKCk6IHZvaWQge1xuICAgIHRoaXMuc3luY1N5bmMoKTtcbiAgfVxufVxuXG4vKipcbiAqIEFzeW5jTWlycm9yRlMgbWlycm9ycyBhIHN5bmNocm9ub3VzIGZpbGVzeXN0ZW0gaW50byBhbiBhc3luY2hyb25vdXMgZmlsZXN5c3RlbVxuICogYnk6XG4gKiAqIFBlcmZvcm1pbmcgb3BlcmF0aW9ucyBvdmVyIHRoZSBpbi1tZW1vcnkgY29weSwgd2hpbGUgYXN5bmNocm9ub3VzbHkgcGlwZWxpbmluZyB0aGVtXG4gKiAgIHRvIHRoZSBiYWNraW5nIHN0b3JlLlxuICogKiBEdXJpbmcgYXBwbGljYXRpb24gbG9hZGluZywgdGhlIGNvbnRlbnRzIG9mIHRoZSBhc3luYyBmaWxlIHN5c3RlbSBjYW4gYmUgcmVsb2FkZWQgaW50b1xuICogICB0aGUgc3luY2hyb25vdXMgc3RvcmUsIGlmIGRlc2lyZWQuXG4gKiBUaGUgdHdvIHN0b3JlcyB3aWxsIGJlIGtlcHQgaW4gc3luYy4gVGhlIG1vc3QgY29tbW9uIHVzZS1jYXNlIGlzIHRvIHBhaXIgYSBzeW5jaHJvbm91c1xuICogaW4tbWVtb3J5IGZpbGVzeXN0ZW0gd2l0aCBhbiBhc3luY2hyb25vdXMgYmFja2luZyBzdG9yZS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXN5bmNNaXJyb3IgZXh0ZW5kcyBmaWxlX3N5c3RlbS5TeW5jaHJvbm91c0ZpbGVTeXN0ZW0gaW1wbGVtZW50cyBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtIHtcbiAgLyoqXG4gICAqIFF1ZXVlIG9mIHBlbmRpbmcgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMuXG4gICAqL1xuICBwcml2YXRlIF9xdWV1ZTogSUFzeW5jT3BlcmF0aW9uW10gPSBbXTtcbiAgcHJpdmF0ZSBfcXVldWVSdW5uaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgX3N5bmM6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW07XG4gIHByaXZhdGUgX2FzeW5jOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtO1xuICBwcml2YXRlIF9pc0luaXRpYWxpemVkOiBib29sZWFuID0gZmFsc2U7XG4gIGNvbnN0cnVjdG9yKHN5bmM6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0sIGFzeW5jOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zeW5jID0gc3luYztcbiAgICB0aGlzLl9hc3luYyA9IGFzeW5jO1xuICAgIGlmICghc3luYy5zdXBwb3J0c1N5bmNoKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkV4cGVjdGVkIHN5bmNocm9ub3VzIHN0b3JhZ2UuXCIpO1xuICAgIH1cbiAgICBpZiAoYXN5bmMuc3VwcG9ydHNTeW5jaCgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFeHBlY3RlZCBhc3luY2hyb25vdXMgc3RvcmFnZS5cIik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldE5hbWUoKTogc3RyaW5nIHtcblx0IFx0cmV0dXJuIFwiQXN5bmNNaXJyb3JcIjtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgX3N5bmNTeW5jKGZkOiBwcmVsb2FkX2ZpbGUuUHJlbG9hZEZpbGU8YW55Pikge1xuICAgIHRoaXMuX3N5bmMud3JpdGVGaWxlU3luYyhmZC5nZXRQYXRoKCksIGZkLmdldEJ1ZmZlcigpLCBudWxsLCBmaWxlX2ZsYWcuRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3cnKSwgZmQuZ2V0U3RhdHMoKS5tb2RlKTtcbiAgICB0aGlzLmVucXVldWVPcCh7XG4gICAgICBhcGlNZXRob2Q6ICd3cml0ZUZpbGUnLFxuICAgICAgYXJndW1lbnRzOiBbZmQuZ2V0UGF0aCgpLCBmZC5nZXRCdWZmZXIoKSwgbnVsbCwgZmQuZ2V0RmxhZygpLCBmZC5nZXRTdGF0cygpLm1vZGVdXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsbGVkIG9uY2UgdG8gbG9hZCB1cCBmaWxlcyBmcm9tIGFzeW5jIHN0b3JhZ2UgaW50byBzeW5jIHN0b3JhZ2UuXG4gICAqL1xuICBwdWJsaWMgaW5pdGlhbGl6ZShmaW5hbENiOiAoZXJyPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuX2lzSW5pdGlhbGl6ZWQpIHtcbiAgICAgIHZhciBjb3B5RGlyZWN0b3J5ID0gKHA6IHN0cmluZywgbW9kZTogbnVtYmVyLCBjYjogKGVycj86IEFwaUVycm9yKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgIGlmIChwICE9PSAnLycpIHtcbiAgICAgICAgICB0aGlzLl9zeW5jLm1rZGlyU3luYyhwLCBtb2RlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9hc3luYy5yZWFkZGlyKHAsIChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY2IoZXJyKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGkgPSAwO1xuICAgICAgICAgICAgZnVuY3Rpb24gY29weU5leHRGaWxlKGVycj86IEFwaUVycm9yKSB7XG4gICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjYihlcnIpO1xuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPCBmaWxlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBjb3B5SXRlbShgJHtwfS8ke2ZpbGVzW2ldfWAsIGNvcHlOZXh0RmlsZSk7XG4gICAgICAgICAgICAgICAgaSsrO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvcHlOZXh0RmlsZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9LCBjb3B5RmlsZSA9IChwOiBzdHJpbmcsIG1vZGU6IG51bWJlciwgY2I6IChlcnI/OiBBcGlFcnJvcikgPT4gdm9pZCkgPT4ge1xuICAgICAgICB0aGlzLl9hc3luYy5yZWFkRmlsZShwLCBudWxsLCBmaWxlX2ZsYWcuRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3InKSwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGNiKGVycik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIHRoaXMuX3N5bmMud3JpdGVGaWxlU3luYyhwLCBkYXRhLCBudWxsLCBmaWxlX2ZsYWcuRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3cnKSwgbW9kZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIGVyciA9IGU7XG4gICAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgICBjYihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9LCBjb3B5SXRlbSA9IChwOiBzdHJpbmcsIGNiOiAoZXJyPzogQXBpRXJyb3IpID0+IHZvaWQpID0+IHtcbiAgICAgICAgdGhpcy5fYXN5bmMuc3RhdChwLCBmYWxzZSwgKGVyciwgc3RhdHMpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjYihlcnIpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgY29weURpcmVjdG9yeShwLCBzdGF0cy5tb2RlLCBjYik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvcHlGaWxlKHAsIHN0YXRzLm1vZGUsIGNiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIGNvcHlEaXJlY3RvcnkoJy8nLCAwLCAoZXJyPzogQXBpRXJyb3IpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGZpbmFsQ2IoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICBmaW5hbENiKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBmaW5hbENiKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGlzUmVhZE9ubHkoKTogYm9vbGVhbiB7IHJldHVybiBmYWxzZTsgfVxuICBwdWJsaWMgc3VwcG9ydHNTeW5jaCgpOiBib29sZWFuIHsgcmV0dXJuIHRydWU7IH1cbiAgcHVibGljIHN1cHBvcnRzTGlua3MoKTogYm9vbGVhbiB7IHJldHVybiBmYWxzZTsgfVxuICBwdWJsaWMgc3VwcG9ydHNQcm9wcygpOiBib29sZWFuIHsgcmV0dXJuIHRoaXMuX3N5bmMuc3VwcG9ydHNQcm9wcygpICYmIHRoaXMuX2FzeW5jLnN1cHBvcnRzUHJvcHMoKTsgfVxuXG4gIHByaXZhdGUgZW5xdWV1ZU9wKG9wOiBJQXN5bmNPcGVyYXRpb24pIHtcbiAgICB0aGlzLl9xdWV1ZS5wdXNoKG9wKTtcbiAgICBpZiAoIXRoaXMuX3F1ZXVlUnVubmluZykge1xuICAgICAgdGhpcy5fcXVldWVSdW5uaW5nID0gdHJ1ZTtcbiAgICAgIHZhciBkb05leHRPcCA9IChlcnI/OiBBcGlFcnJvcikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgV0FSTklORzogRmlsZSBzeXN0ZW0gaGFzIGRlc3luY2hyb25pemVkLiBSZWNlaXZlZCBmb2xsb3dpbmcgZXJyb3I6ICR7ZXJyfVxcbiRgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5fcXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHZhciBvcCA9IHRoaXMuX3F1ZXVlLnNoaWZ0KCksXG4gICAgICAgICAgICBhcmdzID0gb3AuYXJndW1lbnRzO1xuICAgICAgICAgIGFyZ3MucHVzaChkb05leHRPcCk7XG4gICAgICAgICAgKDxGdW5jdGlvbj4gKDxhbnk+IHRoaXMuX2FzeW5jKVtvcC5hcGlNZXRob2RdKS5hcHBseSh0aGlzLl9hc3luYywgYXJncyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fcXVldWVSdW5uaW5nID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBkb05leHRPcCgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZW5hbWVTeW5jKG9sZFBhdGg6IHN0cmluZywgbmV3UGF0aDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5fc3luYy5yZW5hbWVTeW5jKG9sZFBhdGgsIG5ld1BhdGgpO1xuICAgIHRoaXMuZW5xdWV1ZU9wKHtcbiAgICAgIGFwaU1ldGhvZDogJ3JlbmFtZScsXG4gICAgICBhcmd1bWVudHM6IFtvbGRQYXRoLCBuZXdQYXRoXVxuICAgIH0pO1xuICB9XG4gIHB1YmxpYyBzdGF0U3luYyhwOiBzdHJpbmcsIGlzTHN0YXQ6IGJvb2xlYW4pOiBub2RlX2ZzX3N0YXRzLlN0YXRzIHtcbiAgICByZXR1cm4gdGhpcy5fc3luYy5zdGF0U3luYyhwLCBpc0xzdGF0KTtcbiAgfVxuICBwdWJsaWMgb3BlblN5bmMocDogc3RyaW5nLCBmbGFnOiBmaWxlX2ZsYWcuRmlsZUZsYWcsIG1vZGU6IG51bWJlcik6IGZpbGUuRmlsZSB7XG4gICAgLy8gU2FuaXR5IGNoZWNrOiBJcyB0aGlzIG9wZW4vY2xvc2UgcGVybWl0dGVkP1xuICAgIHZhciBmZCA9IHRoaXMuX3N5bmMub3BlblN5bmMocCwgZmxhZywgbW9kZSk7XG4gICAgZmQuY2xvc2VTeW5jKCk7XG4gICAgcmV0dXJuIG5ldyBNaXJyb3JGaWxlKHRoaXMsIHAsIGZsYWcsIHRoaXMuX3N5bmMuc3RhdFN5bmMocCwgZmFsc2UpLCB0aGlzLl9zeW5jLnJlYWRGaWxlU3luYyhwLCBudWxsLCBmaWxlX2ZsYWcuRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3InKSkpO1xuICB9XG4gIHB1YmxpYyB1bmxpbmtTeW5jKHA6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuX3N5bmMudW5saW5rU3luYyhwKTtcbiAgICB0aGlzLmVucXVldWVPcCh7XG4gICAgICBhcGlNZXRob2Q6ICd1bmxpbmsnLFxuICAgICAgYXJndW1lbnRzOiBbcF1cbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgcm1kaXJTeW5jKHA6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuX3N5bmMucm1kaXJTeW5jKHApO1xuICAgIHRoaXMuZW5xdWV1ZU9wKHtcbiAgICAgIGFwaU1ldGhvZDogJ3JtZGlyJyxcbiAgICAgIGFyZ3VtZW50czogW3BdXG4gICAgfSk7XG4gIH1cbiAgcHVibGljIG1rZGlyU3luYyhwOiBzdHJpbmcsIG1vZGU6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuX3N5bmMubWtkaXJTeW5jKHAsIG1vZGUpO1xuICAgIHRoaXMuZW5xdWV1ZU9wKHtcbiAgICAgIGFwaU1ldGhvZDogJ21rZGlyJyxcbiAgICAgIGFyZ3VtZW50czogW3AsIG1vZGVdXG4gICAgfSk7XG4gIH1cbiAgcHVibGljIHJlYWRkaXJTeW5jKHA6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdGhpcy5fc3luYy5yZWFkZGlyU3luYyhwKTtcbiAgfVxuICBwdWJsaWMgZXhpc3RzU3luYyhwOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fc3luYy5leGlzdHNTeW5jKHApO1xuICB9XG4gIHB1YmxpYyBjaG1vZFN5bmMocDogc3RyaW5nLCBpc0xjaG1vZDogYm9vbGVhbiwgbW9kZTogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5fc3luYy5jaG1vZFN5bmMocCwgaXNMY2htb2QsIG1vZGUpO1xuICAgIHRoaXMuZW5xdWV1ZU9wKHtcbiAgICAgIGFwaU1ldGhvZDogJ2NobW9kJyxcbiAgICAgIGFyZ3VtZW50czogW3AsIGlzTGNobW9kLCBtb2RlXVxuICAgIH0pO1xuICB9XG4gIHB1YmxpYyBjaG93blN5bmMocDogc3RyaW5nLCBpc0xjaG93bjogYm9vbGVhbiwgdWlkOiBudW1iZXIsIGdpZDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5fc3luYy5jaG93blN5bmMocCwgaXNMY2hvd24sIHVpZCwgZ2lkKTtcbiAgICB0aGlzLmVucXVldWVPcCh7XG4gICAgICBhcGlNZXRob2Q6ICdjaG93bicsXG4gICAgICBhcmd1bWVudHM6IFtwLCBpc0xjaG93biwgdWlkLCBnaWRdXG4gICAgfSk7XG4gIH1cbiAgcHVibGljIHV0aW1lc1N5bmMocDogc3RyaW5nLCBhdGltZTogRGF0ZSwgbXRpbWU6IERhdGUpOiB2b2lkIHtcbiAgICB0aGlzLl9zeW5jLnV0aW1lc1N5bmMocCwgYXRpbWUsIG10aW1lKTtcbiAgICB0aGlzLmVucXVldWVPcCh7XG4gICAgICBhcGlNZXRob2Q6ICd1dGltZXMnLFxuICAgICAgYXJndW1lbnRzOiBbcCwgYXRpbWUsIG10aW1lXVxuICAgIH0pO1xuICB9XG59XG4iXX0=