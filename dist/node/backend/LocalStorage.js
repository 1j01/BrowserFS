var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var kvfs = require('../generic/key_value_filesystem');
var api_error_1 = require('../core/api_error');
var global = require('../core/global');
var supportsBinaryString = false, binaryEncoding;
try {
    global.localStorage.setItem("__test__", String.fromCharCode(0xD800));
    supportsBinaryString = global.localStorage.getItem("__test__") === String.fromCharCode(0xD800);
}
catch (e) {
    supportsBinaryString = false;
}
binaryEncoding = supportsBinaryString ? 'binary_string' : 'binary_string_ie';
var LocalStorageStore = (function () {
    function LocalStorageStore() {
    }
    LocalStorageStore.prototype.name = function () {
        return 'LocalStorage';
    };
    LocalStorageStore.prototype.clear = function () {
        global.localStorage.clear();
    };
    LocalStorageStore.prototype.beginTransaction = function (type) {
        return new kvfs.SimpleSyncRWTransaction(this);
    };
    LocalStorageStore.prototype.get = function (key) {
        try {
            var data = global.localStorage.getItem(key);
            if (data !== null) {
                return new Buffer(data, binaryEncoding);
            }
        }
        catch (e) {
        }
        return undefined;
    };
    LocalStorageStore.prototype.put = function (key, data, overwrite) {
        try {
            if (!overwrite && global.localStorage.getItem(key) !== null) {
                return false;
            }
            global.localStorage.setItem(key, data.toString(binaryEncoding));
            return true;
        }
        catch (e) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.ENOSPC, "LocalStorage is full.");
        }
    };
    LocalStorageStore.prototype.del = function (key) {
        try {
            global.localStorage.removeItem(key);
        }
        catch (e) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EIO, "Unable to delete key " + key + ": " + e);
        }
    };
    return LocalStorageStore;
})();
exports.LocalStorageStore = LocalStorageStore;
var LocalStorageFileSystem = (function (_super) {
    __extends(LocalStorageFileSystem, _super);
    function LocalStorageFileSystem() {
        _super.call(this, { store: new LocalStorageStore() });
    }
    LocalStorageFileSystem.isAvailable = function () {
        return typeof global.localStorage !== 'undefined';
    };
    return LocalStorageFileSystem;
})(kvfs.SyncKeyValueFileSystem);
exports.__esModule = true;
exports["default"] = LocalStorageFileSystem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9jYWxTdG9yYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2JhY2tlbmQvTG9jYWxTdG9yYWdlLnRzIl0sIm5hbWVzIjpbIkxvY2FsU3RvcmFnZVN0b3JlIiwiTG9jYWxTdG9yYWdlU3RvcmUuY29uc3RydWN0b3IiLCJMb2NhbFN0b3JhZ2VTdG9yZS5uYW1lIiwiTG9jYWxTdG9yYWdlU3RvcmUuY2xlYXIiLCJMb2NhbFN0b3JhZ2VTdG9yZS5iZWdpblRyYW5zYWN0aW9uIiwiTG9jYWxTdG9yYWdlU3RvcmUuZ2V0IiwiTG9jYWxTdG9yYWdlU3RvcmUucHV0IiwiTG9jYWxTdG9yYWdlU3RvcmUuZGVsIiwiTG9jYWxTdG9yYWdlRmlsZVN5c3RlbSIsIkxvY2FsU3RvcmFnZUZpbGVTeXN0ZW0uY29uc3RydWN0b3IiLCJMb2NhbFN0b3JhZ2VGaWxlU3lzdGVtLmlzQXZhaWxhYmxlIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLElBQU8sSUFBSSxXQUFXLGlDQUFpQyxDQUFDLENBQUM7QUFDekQsMEJBQWtDLG1CQUFtQixDQUFDLENBQUE7QUFDdEQsSUFBTyxNQUFNLFdBQVcsZ0JBQWdCLENBQUMsQ0FBQztBQUsxQyxJQUFJLG9CQUFvQixHQUFZLEtBQUssRUFDdkMsY0FBc0IsQ0FBQztBQUN6QixJQUFJLENBQUM7SUFDSCxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLG9CQUFvQixHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDakcsQ0FBRTtBQUFBLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFWCxvQkFBb0IsR0FBRyxLQUFLLENBQUM7QUFDL0IsQ0FBQztBQUNELGNBQWMsR0FBRyxvQkFB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Q0FBQ0E7SUFDSEYsNkJBQUNBO0FBQURBLENBQUNBLEFBTEQsRUFBb0QsSUFBSSxDQUFDLHNCQUFzQixFQUs5RTtBQUxEOzJDQUtDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQga3ZmcyA9IHJlcXVpcmUoJy4uL2dlbmVyaWMva2V5X3ZhbHVlX2ZpbGVzeXN0ZW0nKTtcbmltcG9ydCB7QXBpRXJyb3IsIEVycm9yQ29kZX0gZnJvbSAnLi4vY29yZS9hcGlfZXJyb3InO1xuaW1wb3J0IGdsb2JhbCA9IHJlcXVpcmUoJy4uL2NvcmUvZ2xvYmFsJyk7XG5cbi8vIFNvbWUgdmVyc2lvbnMgb2YgRkYgYW5kIGFsbCB2ZXJzaW9ucyBvZiBJRSBkbyBub3Qgc3VwcG9ydCB0aGUgZnVsbCByYW5nZSBvZlxuLy8gMTYtYml0IG51bWJlcnMgZW5jb2RlZCBhcyBjaGFyYWN0ZXJzLCBhcyB0aGV5IGVuZm9yY2UgVVRGLTE2IHJlc3RyaWN0aW9ucy5cbi8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTExNzA3MTYvYXJlLXRoZXJlLWFueS1jaGFyYWN0ZXJzLXRoYXQtYXJlLW5vdC1hbGxvd2VkLWluLWxvY2Fsc3RvcmFnZS8xMTE3MzY3MyMxMTE3MzY3M1xudmFyIHN1cHBvcnRzQmluYXJ5U3RyaW5nOiBib29sZWFuID0gZmFsc2UsXG4gIGJpbmFyeUVuY29kaW5nOiBzdHJpbmc7XG50cnkge1xuICBnbG9iYWwubG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJfX3Rlc3RfX1wiLCBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4RDgwMCkpO1xuICBzdXBwb3J0c0JpbmFyeVN0cmluZyA9IGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShcIl9fdGVzdF9fXCIpID09PSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4RDgwMCk7XG59IGNhdGNoIChlKSB7XG4gIC8vIElFIHRocm93cyBhbiBleGNlcHRpb24uXG4gIHN1cHBvcnRzQmluYXJ5U3RyaW5nID0gZmFsc2U7XG59XG5iaW5hcnlFbmNvZGluZyA9IHN1cHBvcnRzQmluYXJ5U3RyaW5nID8gJ2JpbmFyeV9zdHJpbmcnIDogJ2JpbmFyeV9zdHJpbmdfaWUnO1xuXG5cbi8qKlxuICogQSBzeW5jaHJvbm91cyBrZXktdmFsdWUgc3RvcmUgYmFja2VkIGJ5IGxvY2FsU3RvcmFnZS5cbiAqL1xuZXhwb3J0IGNsYXNzIExvY2FsU3RvcmFnZVN0b3JlIGltcGxlbWVudHMga3Zmcy5TeW5jS2V5VmFsdWVTdG9yZSwga3Zmcy5TaW1wbGVTeW5jU3RvcmUge1xuICBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gIHB1YmxpYyBuYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuICdMb2NhbFN0b3JhZ2UnO1xuICB9XG5cbiAgcHVibGljIGNsZWFyKCk6IHZvaWQge1xuICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UuY2xlYXIoKTtcbiAgfVxuXG4gIHB1YmxpYyBiZWdpblRyYW5zYWN0aW9uKHR5cGU6IHN0cmluZyk6IGt2ZnMuU3luY0tleVZhbHVlUldUcmFuc2FjdGlvbiB7XG4gICAgLy8gTm8gbmVlZCB0byBkaWZmZXJlbnRpYXRlLlxuICAgIHJldHVybiBuZXcga3Zmcy5TaW1wbGVTeW5jUldUcmFuc2FjdGlvbih0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQoa2V5OiBzdHJpbmcpOiBOb2RlQnVmZmVyIHtcbiAgICB0cnkge1xuICAgICAgdmFyIGRhdGEgPSBnbG9iYWwubG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTtcbiAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiBuZXcgQnVmZmVyKGRhdGEsIGJpbmFyeUVuY29kaW5nKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG5cbiAgICB9XG4gICAgLy8gS2V5IGRvZXNuJ3QgZXhpc3QsIG9yIGEgZmFpbHVyZSBvY2N1cnJlZC5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIHB1dChrZXk6IHN0cmluZywgZGF0YTogTm9kZUJ1ZmZlciwgb3ZlcndyaXRlOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghb3ZlcndyaXRlICYmIGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpICE9PSBudWxsKSB7XG4gICAgICAgIC8vIERvbid0IHdhbnQgdG8gb3ZlcndyaXRlIHRoZSBrZXkhXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIGRhdGEudG9TdHJpbmcoYmluYXJ5RW5jb2RpbmcpKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRU5PU1BDLCBcIkxvY2FsU3RvcmFnZSBpcyBmdWxsLlwiKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGVsKGtleTogc3RyaW5nKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlPLCBcIlVuYWJsZSB0byBkZWxldGUga2V5IFwiICsga2V5ICsgXCI6IFwiICsgZSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQSBzeW5jaHJvbm91cyBmaWxlIHN5c3RlbSBiYWNrZWQgYnkgbG9jYWxTdG9yYWdlLiBDb25uZWN0cyBvdXJcbiAqIExvY2FsU3RvcmFnZVN0b3JlIHRvIG91ciBTeW5jS2V5VmFsdWVGaWxlU3lzdGVtLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMb2NhbFN0b3JhZ2VGaWxlU3lzdGVtIGV4dGVuZHMga3Zmcy5TeW5jS2V5VmFsdWVGaWxlU3lzdGVtIHtcbiAgY29uc3RydWN0b3IoKSB7IHN1cGVyKHsgc3RvcmU6IG5ldyBMb2NhbFN0b3JhZ2VTdG9yZSgpIH0pOyB9XG4gIHB1YmxpYyBzdGF0aWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiBnbG9iYWwubG9jYWxTdG9yYWdlICE9PSAndW5kZWZpbmVkJztcbiAgfVxufVxuIl19