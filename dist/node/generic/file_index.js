var node_fs_stats_1 = require('../core/node_fs_stats');
var path = require('path');
var FileIndex = (function () {
    function FileIndex() {
        this._index = {};
        this.addPath('/', new DirInode());
    }
    FileIndex.prototype._split_path = function (p) {
        var dirpath = path.dirname(p);
        var itemname = p.substr(dirpath.length + (dirpath === "/" ? 0 : 1));
        return [dirpath, itemname];
    };
    FileIndex.prototype.fileIterator = function (cb) {
        for (var path in this._index) {
            var dir = this._index[path];
            var files = dir.getListing();
            for (var i = 0; i < files.length; i++) {
                var item = dir.getItem(files[i]);
                if (isFileInode(item)) {
                    cb(item.getData());
                }
            }
        }
    };
    FileIndex.prototype.addPath = function (path, inode) {
        if (inode == null) {
            throw new Error('Inode must be specified');
        }
        if (path[0] !== '/') {
            throw new Error('Path must be absolute, got: ' + path);
        }
        if (this._index.hasOwnProperty(path)) {
            return this._index[path] === inode;
        }
        var splitPath = this._split_path(path);
        var dirpath = splitPath[0];
        var itemname = splitPath[1];
        var parent = this._index[dirpath];
        if (parent === undefined && path !== '/') {
            parent = new DirInode();
            if (!this.addPath(dirpath, parent)) {
                return false;
            }
        }
        if (path !== '/') {
            if (!parent.addItem(itemname, inode)) {
                return false;
            }
        }
        if (isDirInode(inode)) {
            this._index[path] = inode;
        }
        return true;
    };
    FileIndex.prototype.removePath = function (path) {
        var splitPath = this._split_path(path);
        var dirpath = splitPath[0];
        var itemname = splitPath[1];
        var parent = this._index[dirpath];
        if (parent === undefined) {
            return null;
        }
        var inode = parent.remItem(itemname);
        if (inode === null) {
            return null;
        }
        if (isDirInode(inode)) {
            var children = inode.getListing();
            for (var i = 0; i < children.length; i++) {
                this.removePath(path + '/' + children[i]);
            }
            if (path !== '/') {
                delete this._index[path];
            }
        }
        return inode;
    };
    FileIndex.prototype.ls = function (path) {
        var item = this._index[path];
        if (item === undefined) {
            return null;
        }
        return item.getListing();
    };
    FileIndex.prototype.getInode = function (path) {
        var splitPath = this._split_path(path);
        var dirpath = splitPath[0];
        var itemname = splitPath[1];
        var parent = this._index[dirpath];
        if (parent === undefined) {
            return null;
        }
        if (dirpath === path) {
            return parent;
        }
        return parent.getItem(itemname);
    };
    FileIndex.fromListing = function (listing) {
        var idx = new FileIndex();
        var rootInode = new DirInode();
        idx._index['/'] = rootInode;
        var queue = [['', listing, rootInode]];
        while (queue.length > 0) {
            var inode;
            var next = queue.pop();
            var pwd = next[0];
            var tree = next[1];
            var parent = next[2];
            for (var node in tree) {
                var children = tree[node];
                var name = "" + pwd + "/" + node;
                if (children != null) {
                    idx._index[name] = inode = new DirInode();
                    queue.push([name, children, inode]);
                }
                else {
                    inode = new FileInode(new node_fs_stats_1.default(node_fs_stats_1.FileType.FILE, -1, 0x16D));
                }
                if (parent != null) {
                    parent._ls[node] = inode;
                }
            }
        }
        return idx;
    };
    return FileIndex;
})();
exports.FileIndex = FileIndex;
var FileInode = (function () {
    function FileInode(data) {
        this.data = data;
    }
    FileInode.prototype.isFile = function () { return true; };
    FileInode.prototype.isDir = function () { return false; };
    FileInode.prototype.getData = function () { return this.data; };
    FileInode.prototype.setData = function (data) { this.data = data; };
    return FileInode;
})();
exports.FileInode = FileInode;
var DirInode = (function () {
    function DirInode(data) {
        if (data === void 0) { data = null; }
        this.data = data;
        this._ls = {};
    }
    DirInode.prototype.isFile = function () {
        return false;
    };
    DirInode.prototype.isDir = function () {
        return true;
    };
    DirInode.prototype.getData = function () { return this.data; };
    DirInode.prototype.getStats = function () {
        return new node_fs_stats_1.default(node_fs_stats_1.FileType.DIRECTORY, 4096, 0x16D);
    };
    DirInode.prototype.getListing = function () {
        return Object.keys(this._ls);
    };
    DirInode.prototype.getItem = function (p) {
        var _ref;
        return (_ref = this._ls[p]) != null ? _ref : null;
    };
    DirInode.prototype.addItem = function (p, inode) {
        if (p in this._ls) {
            return false;
        }
        this._ls[p] = inode;
        return true;
    };
    DirInode.prototype.remItem = function (p) {
        var item = this._ls[p];
        if (item === undefined) {
            return null;
        }
        delete this._ls[p];
        return item;
    };
    return DirInode;
})();
exports.DirInode = DirInode;
function isFileInode(inode) {
    return inode && inode.isFile();
}
exports.isFileInode = isFileInode;
function isDirInode(inode) {
    return inode && inode.isDir();
}
exports.isDirInode = isDirInode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZV9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9nZW5lcmljL2ZpbGVfaW5kZXgudHMiXSwibmFtZXMiOlsiRmlsZUluZGV4IiwiRmlsZUluZGV4LmNvbnN0cnVjdG9yIiwiRmlsZUluZGV4Ll9zcGxpdF9wYXRoIiwiRmlsZUluZGV4LmZpbGVJdGVyYXRvciIsIkZpbGVJbmRleC5hZGRQYXRoIiwiRmlsZUluZGV4LnJlbW92ZVBhdGgiLCJGaWxlSW5kZXgubHMiLCJGaWxlSW5kZXguZ2V0SW5vZGUiLCJGaWxlSW5kZXguZnJvbUxpc3RpbmciLCJGaWxlSW5vZGUiLCJGaWxlSW5vZGUuY29uc3RydWN0b3IiLCJGaWxlSW5vZGUuaXNGaWxlIiwiRmlsZUlub2RlLmlzRGlyIiwiRmlsZUlub2RlLmdldERhdGEiLCJGaWxlSW5vZGUuc2V0RGF0YSIsIkRpcklub2RlIiwiRGlySW5vZGUuY29uc3RydWN0b3IiLCJEaXJJbm9kZS5pc0ZpbGUiLCJEaXJJbm9kZS5pc0RpciIsIkRpcklub2RlLmdldERhdGEiLCJEaXJJbm9kZS5nZXRTdGF0cyIsIkRpcklub2RlLmdldExpc3RpbmciLCJEaXJJbm9kZS5nZXRJdGVtIiwiRGlySW5vZGUuYWRkSXRlbSIsIkRpcklub2RlLnJlbUl0ZW0iLCJpc0ZpbGVJbm9kZSIsImlzRGlySW5vZGUiXSwibWFwcGluZ3MiOiJBQUFBLDhCQUF5Qyx1QkFBdUIsQ0FBQyxDQUFBO0FBQ2pFLElBQU8sSUFBSSxXQUFXLE1BQU0sQ0FBQyxDQUFDO0FBUzlCO0lBT0VBO1FBR0VDLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLEVBQUVBLENBQUNBO1FBRWpCQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxFQUFFQSxJQUFJQSxRQUFRQSxFQUFFQSxDQUFDQSxDQUFDQTtJQUNwQ0EsQ0FBQ0E7SUFLT0QsK0JBQVdBLEdBQW5CQSxVQUFvQkEsQ0FBU0E7UUFDM0JFLElBQUlBLE9BQU9BLEdBQUdB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Q0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7UUFDckNBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLEtBQUtBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ25CQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUNkQSxDQUFDQTtRQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxVQUFVQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN0QkEsSUFBSUEsUUFBUUEsR0FBR0EsS0FBS0EsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0E7WUFDbENBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLFFBQVFBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO2dCQUN6Q0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsR0FBR0EsR0FBR0EsR0FBR0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDNUNBLENBQUNBO1lBR0RBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLEtBQUtBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO2dCQUNqQkEsT0FBT0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLENBQUNBO1FBQ0hBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2ZBLENBQUNBO0lBT01MLHNCQUFFQSxHQUFUQSxVQUFVQSxJQUFZQTtRQUNwQk0sSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDN0JBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLEtBQUtBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUNkQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQTtJQUMzQkEsQ0FBQ0E7SUFRTU4sNEJBQVFBLEdBQWZBLFVBQWdCQSxJQUFZQTtRQUMxQk8sSUFBSUEsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDdkNBLElBQUlBLE9BQU9BLEdBQUdBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQzNCQSxJQUFJQSxRQUFRQSxHQUFHQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUU1QkEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7UUFDbENBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLEtBQUtBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3pCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUNkQSxDQUFDQTtRQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxLQUFLQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNyQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFDaEJBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO0lBQ2xDQSxDQUFDQTtJQU9hUCxxQkFBV0EsR0FBekJBLFVBQTZCQSxPQUFPQTtRQUNsQ1EsSUFBSUEsR0FBR0EsR0FBR0EsSUFBSUEsU0FBU0EsRUFBS0EsQ0FBQ0E7UUFFN0JBLElBQUlBLFNBQVNBLEdBQUdBLElBQUlBLFFBQVFBLEVBQUtBLENBQUNBO1FBQ2xDQSxHQUFHQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxTQUFTQSxDQUFDQTtRQUM1QkEsSUFBSUEsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsRUFBRUEsT0FBT0EsRUFBRUEsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDdkNBLE9BQU9BLEtBQUtBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBO1lBQ3hCQSxJQUFJQSxLQUFLQSxDQUFDQTtZQUNWQSxJQUFJQSxJQUFJQSxHQUFHQSxLQUFLQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUN2QkEsSUFBSUEsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbEJBLElBQUlBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ25CQSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNyQkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3RCQSxJQUFJQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDMUJBLElBQUlBLElBQUlBLEdBQUdBLEVBQUVBLEdBQUdBLEdBQUdBLEdBQUdBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBO2dCQUNqQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3JCQSxHQUFHQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxLQUFLQSxHQUFHQSxJQUFJQSxRQUFRQSxFQUFLQSxDQUFDQTtvQkFDN0NBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLElBQUlBLEVBQUVBLFFBQVFBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO2dCQUN0Q0EsQ0FBQ0E7Z0JBQUNBLElBQUlBLENBQUNBLENBQUNBO29CQUVOQSxLQUFLQSxHQUFHQSxJQUFJQSxTQUFTQSxDQUFRQSxJQUFJQSx1QkFBS0EsQ0FBQ0Esd0JBQVFBLENBQUNBLElBQUlBLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO2dCQUNwRUEsQ0FBQ0E7Z0JBQ0RBLEVBQUVBLENBQUNBLENB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U0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdkJBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ2RBLENBQUNBO1FBQ0RBLE9BQU9BLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQ25CQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtJQUNkQSxDQUFDQTtJQUNIVCxlQUFDQTtBQUFEQSxDQUFDQSxBQXJFRCxJQXFFQztBQXJFWSxnQkFBUSxXQXFFcEIsQ0FBQTtBQUVELHFCQUErQixLQUFZO0lBQ3pDVSxNQUFNQSxDQUFDQSxLQUFLQSxJQUFJQSxLQUFLQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtBQUNqQ0EsQ0FBQ0E7QUFGZSxtQkFBVyxjQUUxQixDQUFBO0FBRUQsb0JBQThCLEtBQVk7SUFDeENDLE1BQU1BLENBQUNBLEtBQUtBLElBQUlBLEtBQUtBLENBQUNBLEtBQUtBLEVBQUVBLENBQUNBO0FBQ2hDQSxDQUFDQTtBQUZlLGtCQUFVLGFBRXpCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2RlZmF1bHQgYXMgU3RhdHMsIEZpbGVUeXBlfSBmcm9tICcuLi9jb3JlL25vZGVfZnNfc3RhdHMnO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbi8qKlxuICogQSBzaW1wbGUgY2xhc3MgZm9yIHN0b3JpbmcgYSBmaWxlc3lzdGVtIGluZGV4LiBBc3N1bWVzIHRoYXQgYWxsIHBhdGhzIHBhc3NlZFxuICogdG8gaXQgYXJlICphYnNvbHV0ZSogcGF0aHMuXG4gKlxuICogQ2FuIGJlIHVzZWQgYXMgYSBwYXJ0aWFsIG9yIGEgZnVsbCBpbmRleCwgYWx0aG91Z2ggY2FyZSBtdXN0IGJlIHRha2VuIGlmIHVzZWRcbiAqIGZvciB0aGUgZm9ybWVyIHB1cnBvc2UsIGVzcGVjaWFsbHkgd2hlbiBkaXJlY3RvcmllcyBhcmUgY29uY2VybmVkLlxuICovXG5leHBvcnQgY2xhc3MgRmlsZUluZGV4PFQ+IHtcbiAgLy8gTWFwcyBkaXJlY3RvcnkgcGF0aHMgdG8gZGlyZWN0b3J5IGlub2Rlcywgd2hpY2ggY29udGFpbiBmaWxlcy5cbiAgcHJpdmF0ZSBfaW5kZXg6IHtbcGF0aDogc3RyaW5nXTogRGlySW5vZGU8VD59XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgYSBuZXcgRmlsZUluZGV4LlxuICAgKi9cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgLy8gX2luZGV4IGlzIGEgc2luZ2xlLWxldmVsIGtleSx2YWx1ZSBzdG9yZSB0aGF0IG1hcHMgKmRpcmVjdG9yeSogcGF0aHMgdG9cbiAgICAvLyBEaXJJbm9kZXMuIEZpbGUgaW5mb3JtYXRpb24gaXMgb25seSBjb250YWluZWQgaW4gRGlySW5vZGVzIHRoZW1zZWx2ZXMuXG4gICAgdGhpcy5faW5kZXggPSB7fTtcbiAgICAvLyBDcmVhdGUgdGhlIHJvb3QgZGlyZWN0b3J5LlxuICAgIHRoaXMuYWRkUGF0aCgnLycsIG5ldyBEaXJJbm9kZSgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTcGxpdCBpbnRvIGEgKGRpcmVjdG9yeSBwYXRoLCBpdGVtIG5hbWUpIHBhaXJcbiAgICovXG4gIHByaXZhdGUgX3NwbGl0X3BhdGgocDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIHZhciBkaXJwYXRoID0gcGF0aC5kaXJuYW1lKHApO1xuICAgIHZhciBpdGVtbmFtZSA9IHAuc3Vic3RyKGRpcnBhdGgubGVuZ3RoICsgKGRpcnBhdGggPT09IFwiL1wiID8gMCA6IDEpKTtcbiAgICByZXR1cm4gW2RpcnBhdGgsIGl0ZW1uYW1lXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW5zIHRoZSBnaXZlbiBmdW5jdGlvbiBvdmVyIGFsbCBmaWxlcyBpbiB0aGUgaW5kZXguXG4gICAqL1xuICBwdWJsaWMgZmlsZUl0ZXJhdG9yPFQ+KGNiOiAoZmlsZTogVCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIGZvciAodmFyIHBhdGggaW4gdGhpcy5faW5kZXgpIHtcbiAgICAgIHZhciBkaXIgPSB0aGlzLl9pbmRleFtwYXRoXTtcbiAgICAgIHZhciBmaWxlcyA9IGRpci5nZXRMaXN0aW5nKCk7XG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZhciBpdGVtID0gZGlyLmdldEl0ZW0oZmlsZXNbaV0pO1xuICAgICAgICBpZiAoaXNGaWxlSW5vZGU8VD4oaXRlbSkpIHtcbiAgICAgICAgICBjYihpdGVtLmdldERhdGEoKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWRkcyB0aGUgZ2l2ZW4gYWJzb2x1dGUgcGF0aCB0byB0aGUgaW5kZXggaWYgaXQgaXMgbm90IGFscmVhZHkgaW4gdGhlIGluZGV4LlxuICAgKiBDcmVhdGVzIGFueSBuZWVkZWQgcGFyZW50IGRpcmVjdG9yaWVzLlxuICAgKiBAcGFyYW0gW1N0cmluZ10gcGF0aCBUaGUgcGF0aCB0byBhZGQgdG8gdGhlIGluZGV4LlxuICAgKiBAcGFyYW0gW0Jyb3dzZXJGUy5GaWxlSW5vZGUgfCBCcm93c2VyRlMuRGlySW5vZGVdIGlub2RlIFRoZSBpbm9kZSBmb3IgdGhlXG4gICAqICAgcGF0aCB0byBhZGQuXG4gICAqIEByZXR1cm4gW0Jvb2xlYW5dICdUcnVlJyBpZiBpdCB3YXMgYWRkZWQgb3IgYWxyZWFkeSBleGlzdHMsICdmYWxzZScgaWYgdGhlcmVcbiAgICogICB3YXMgYW4gaXNzdWUgYWRkaW5nIGl0IChlLmcuIGl0ZW0gaW4gcGF0aCBpcyBhIGZpbGUsIGl0ZW0gZXhpc3RzIGJ1dCBpc1xuICAgKiAgIGRpZmZlcmVudCkuXG4gICAqIEB0b2RvIElmIGFkZGluZyBmYWlscyBhbmQgaW1wbGljaXRseSBjcmVhdGVzIGRpcmVjdG9yaWVzLCB3ZSBkbyBub3QgY2xlYW4gdXBcbiAgICogICB0aGUgbmV3IGVtcHR5IGRpcmVjdG9yaWVzLlxuICAgKi9cbiAgcHVibGljIGFkZFBhdGgocGF0aDogc3RyaW5nLCBpbm9kZTogSW5vZGUpOiBib29sZWFuIHtcbiAgICBpZiAoaW5vZGUgPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbm9kZSBtdXN0IGJlIHNwZWNpZmllZCcpO1xuICAgIH1cbiAgICBpZiAocGF0aFswXSAhPT0gJy8nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BhdGggbXVzdCBiZSBhYnNvbHV0ZSwgZ290OiAnICsgcGF0aCk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgaXQgYWxyZWFkeSBleGlzdHMuXG4gICAgaWYgKHRoaXMuX2luZGV4Lmhhc093blByb3BlcnR5KHBhdGgpKSB7XG4gICAgICByZXR1cm4gdGhpcy5faW5kZXhbcGF0aF0gPT09IGlub2RlO1xuICAgIH1cblxuICAgIHZhciBzcGxpdFBhdGggPSB0aGlzLl9zcGxpdF9wYXRoKHBhdGgpO1xuICAgIHZhciBkaXJwYXRoID0gc3BsaXRQYXRoWzBdO1xuICAgIHZhciBpdGVtbmFtZSA9IHNwbGl0UGF0aFsxXTtcbiAgICAvLyBUcnkgdG8gYWRkIHRvIGl0cyBwYXJlbnQgZGlyZWN0b3J5IGZpcnN0LlxuICAgIHZhciBwYXJlbnQgPSB0aGlzLl9pbmRleFtkaXJwYXRoXTtcbiAgICBpZiAocGFyZW50ID09PSB1bmRlZmluZWQgJiYgcGF0aCAhPT0gJy8nKSB7XG4gICAgICAvLyBDcmVhdGUgcGFyZW50LlxuICAgICAgcGFyZW50ID0gbmV3IERpcklub2RlPFQ+KCk7XG4gICAgICBpZiAoIXRoaXMuYWRkUGF0aChkaXJwYXRoLCBwYXJlbnQpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gQWRkIG15c2VsZiB0byBteSBwYXJlbnQuXG4gICAgaWYgKHBhdGggIT09ICcvJykge1xuICAgICAgaWYgKCFwYXJlbnQuYWRkSXRlbShpdGVtbmFtZSwgaW5vZGUpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gSWYgSSdtIGEgZGlyZWN0b3J5LCBhZGQgbXlzZWxmIHRvIHRoZSBpbmRleC5cbiAgICBpZiAoaXNEaXJJbm9kZTxUPihpbm9kZSkpIHtcbiAgICAgIHRoaXMuX2luZGV4W3BhdGhdID0gaW5vZGU7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgdGhlIGdpdmVuIHBhdGguIENhbiBiZSBhIGZpbGUgb3IgYSBkaXJlY3RvcnkuXG4gICAqIEByZXR1cm4gW0Jyb3dzZXJGUy5GaWxlSW5vZGUgfCBCcm93c2VyRlMuRGlySW5vZGUgfCBudWxsXSBUaGUgcmVtb3ZlZCBpdGVtLFxuICAgKiAgIG9yIG51bGwgaWYgaXQgZGlkIG5vdCBleGlzdC5cbiAgICovXG4gIHB1YmxpYyByZW1vdmVQYXRoKHBhdGg6IHN0cmluZyk6IElub2RlIHtcbiAgICB2YXIgc3BsaXRQYXRoID0gdGhpcy5fc3BsaXRfcGF0aChwYXRoKTtcbiAgICB2YXIgZGlycGF0aCA9IHNwbGl0UGF0aFswXTtcbiAgICB2YXIgaXRlbW5hbWUgPSBzcGxpdFBhdGhbMV07XG5cbiAgICAvLyBUcnkgdG8gcmVtb3ZlIGl0IGZyb20gaXRzIHBhcmVudCBkaXJlY3RvcnkgZmlyc3QuXG4gICAgdmFyIHBhcmVudCA9IHRoaXMuX2luZGV4W2RpcnBhdGhdO1xuICAgIGlmIChwYXJlbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIC8vIFJlbW92ZSBteXNlbGYgZnJvbSBteSBwYXJlbnQuXG4gICAgdmFyIGlub2RlID0gcGFyZW50LnJlbUl0ZW0oaXRlbW5hbWUpO1xuICAgIGlmIChpbm9kZSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIC8vIElmIEknbSBhIGRpcmVjdG9yeSwgcmVtb3ZlIG15c2VsZiBmcm9tIHRoZSBpbmRleCwgYW5kIHJlbW92ZSBteSBjaGlsZHJlbi5cbiAgICBpZiAoaXNEaXJJbm9kZShpbm9kZSkpIHtcbiAgICAgIHZhciBjaGlsZHJlbiA9IGlub2RlLmdldExpc3RpbmcoKTtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5yZW1vdmVQYXRoKHBhdGggKyAnLycgKyBjaGlsZHJlbltpXSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlbW92ZSB0aGUgZGlyZWN0b3J5IGZyb20gdGhlIGluZGV4LCB1bmxlc3MgaXQncyB0aGUgcm9vdC5cbiAgICAgIGlmIChwYXRoICE9PSAnLycpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuX2luZGV4W3BhdGhdO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaW5vZGU7XG4gIH1cblxuICAvKipcbiAgICogUmV0cmlldmVzIHRoZSBkaXJlY3RvcnkgbGlzdGluZyBvZiB0aGUgZ2l2ZW4gcGF0aC5cbiAgICogQHJldHVybiBbU3RyaW5nW11dIEFuIGFycmF5IG9mIGZpbGVzIGluIHRoZSBnaXZlbiBwYXRoLCBvciAnbnVsbCcgaWYgaXQgZG9lc1xuICAgKiAgIG5vdCBleGlzdC5cbiAgICovXG4gIHB1YmxpYyBscyhwYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgdmFyIGl0ZW0gPSB0aGlzLl9pbmRleFtwYXRoXTtcbiAgICBpZiAoaXRlbSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGl0ZW0uZ2V0TGlzdGluZygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGlub2RlIG9mIHRoZSBnaXZlbiBpdGVtLlxuICAgKiBAcGFyYW0gW1N0cmluZ10gcGF0aFxuICAgKiBAcmV0dXJuIFtCcm93c2VyRlMuRmlsZUlub2RlIHwgQnJvd3NlckZTLkRpcklub2RlIHwgbnVsbF0gUmV0dXJucyBudWxsIGlmXG4gICAqICAgdGhlIGl0ZW0gZG9lcyBub3QgZXhpc3QuXG4gICAqL1xuICBwdWJsaWMgZ2V0SW5vZGUocGF0aDogc3RyaW5nKTogSW5vZGUge1xuICAgIHZhciBzcGxpdFBhdGggPSB0aGlzLl9zcGxpdF9wYXRoKHBhdGgpO1xuICAgIHZhciBkaXJwYXRoID0gc3BsaXRQYXRoWzBdO1xuICAgIHZhciBpdGVtbmFtZSA9IHNwbGl0UGF0aFsxXTtcbiAgICAvLyBSZXRyaWV2ZSBmcm9tIGl0cyBwYXJlbnQgZGlyZWN0b3J5LlxuICAgIHZhciBwYXJlbnQgPSB0aGlzLl9pbmRleFtkaXJwYXRoXTtcbiAgICBpZiAocGFyZW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICAvLyBSb290IGNhc2VcbiAgICBpZiAoZGlycGF0aCA9PT0gcGF0aCkge1xuICAgICAgcmV0dXJuIHBhcmVudDtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmVudC5nZXRJdGVtKGl0ZW1uYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGF0aWMgbWV0aG9kIGZvciBjb25zdHJ1Y3RpbmcgaW5kaWNlcyBmcm9tIGEgSlNPTiBsaXN0aW5nLlxuICAgKiBAcGFyYW0gW09iamVjdF0gbGlzdGluZyBEaXJlY3RvcnkgbGlzdGluZyBnZW5lcmF0ZWQgYnkgdG9vbHMvWEhSSW5kZXhlci5jb2ZmZWVcbiAgICogQHJldHVybiBbQnJvd3NlckZTLkZpbGVJbmRleF0gQSBuZXcgRmlsZUluZGV4IG9iamVjdC5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZnJvbUxpc3Rpbmc8VD4obGlzdGluZyk6IEZpbGVJbmRleDxUPiB7XG4gICAgdmFyIGlkeCA9IG5ldyBGaWxlSW5kZXg8VD4oKTtcbiAgICAvLyBBZGQgYSByb290IERpck5vZGUuXG4gICAgdmFyIHJvb3RJbm9kZSA9IG5ldyBEaXJJbm9kZTxUPigpO1xuICAgIGlkeC5faW5kZXhbJy8nXSA9IHJvb3RJbm9kZTtcbiAgICB2YXIgcXVldWUgPSBbWycnLCBsaXN0aW5nLCByb290SW5vZGVdXTtcbiAgICB3aGlsZSAocXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgdmFyIGlub2RlO1xuICAgICAgdmFyIG5leHQgPSBxdWV1ZS5wb3AoKTtcbiAgICAgIHZhciBwd2QgPSBuZXh0WzBdO1xuICAgICAgdmFyIHRyZWUgPSBuZXh0WzFdO1xuICAgICAgdmFyIHBhcmVudCA9IG5leHRbMl07XG4gICAgICBmb3IgKHZhciBub2RlIGluIHRyZWUpIHtcbiAgICAgICAgdmFyIGNoaWxkcmVuID0gdHJlZVtub2RlXTtcbiAgICAgICAgdmFyIG5hbWUgPSBcIlwiICsgcHdkICsgXCIvXCIgKyBub2RlO1xuICAgICAgICBpZiAoY2hpbGRyZW4gIT0gbnVsbCkge1xuICAgICAgICAgIGlkeC5faW5kZXhbbmFtZV0gPSBpbm9kZSA9IG5ldyBEaXJJbm9kZTxUPigpO1xuICAgICAgICAgIHF1ZXVlLnB1c2goW25hbWUsIGNoaWxkcmVuLCBpbm9kZV0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIFRoaXMgaW5vZGUgZG9lc24ndCBoYXZlIGNvcnJlY3Qgc2l6ZSBpbmZvcm1hdGlvbiwgbm90ZWQgd2l0aCAtMS5cbiAgICAgICAgICBpbm9kZSA9IG5ldyBGaWxlSW5vZGU8U3RhdHM+KG5ldyBTdGF0cyhGaWxlVHlwZS5GSUxFLCAtMSwgMHgxNkQpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocGFyZW50ICE9IG51bGwpIHtcbiAgICAgICAgICBwYXJlbnQuX2xzW25vZGVdID0gaW5vZGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGlkeDtcbiAgfVxufVxuXG4vKipcbiAqIEdlbmVyaWMgaW50ZXJmYWNlIGZvciBmaWxlL2RpcmVjdG9yeSBpbm9kZXMuXG4gKiBOb3RlIHRoYXQgU3RhdHMgb2JqZWN0cyBhcmUgd2hhdCB3ZSB1c2UgZm9yIGZpbGUgaW5vZGVzLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElub2RlIHtcbiAgLy8gSXMgdGhpcyBhbiBpbm9kZSBmb3IgYSBmaWxlP1xuICBpc0ZpbGUoKTogYm9vbGVhbjtcbiAgLy8gSXMgdGhpcyBhbiBpbm9kZSBmb3IgYSBkaXJlY3Rvcnk/XG4gIGlzRGlyKCk6IGJvb2xlYW47XG59XG5cbi8qKlxuICogSW5vZGUgZm9yIGEgZmlsZS4gU3RvcmVzIGFuIGFyYml0cmFyeSAoZmlsZXN5c3RlbS1zcGVjaWZpYykgZGF0YSBwYXlsb2FkLlxuICovXG5leHBvcnQgY2xhc3MgRmlsZUlub2RlPFQ+IGltcGxlbWVudHMgSW5vZGUge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGE6IFQpIHsgfVxuICBwdWJsaWMgaXNGaWxlKCk6IGJvb2xlYW4geyByZXR1cm4gdHJ1ZTsgfVxuICBwdWJsaWMgaXNEaXIoKTogYm9vbGVhbiB7IHJldHVybiBmYWxzZTsgfVxuICBwdWJsaWMgZ2V0RGF0YSgpOiBUIHsgcmV0dXJuIHRoaXMuZGF0YTsgfVxuICBwdWJsaWMgc2V0RGF0YShkYXRhOiBUKTogdm9pZCB7IHRoaXMuZGF0YSA9IGRhdGE7IH1cbn1cblxuLyoqXG4gKiBJbm9kZSBmb3IgYSBkaXJlY3RvcnkuIEN1cnJlbnRseSBvbmx5IGNvbnRhaW5zIHRoZSBkaXJlY3RvcnkgbGlzdGluZy5cbiAqL1xuZXhwb3J0IGNsYXNzIERpcklub2RlPFQ+IGltcGxlbWVudHMgSW5vZGUge1xuICBwcml2YXRlIF9sczoge1twYXRoOiBzdHJpbmddOiBJbm9kZX0gPSB7fTtcbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgYW4gaW5vZGUgZm9yIGEgZGlyZWN0b3J5LlxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRhOiBUID0gbnVsbCkge31cbiAgcHVibGljIGlzRmlsZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgcHVibGljIGlzRGlyKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHB1YmxpYyBnZXREYXRhKCk6IFQgeyByZXR1cm4gdGhpcy5kYXRhOyB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBhIFN0YXRzIG9iamVjdCBmb3IgdGhpcyBpbm9kZS5cbiAgICogQHRvZG8gU2hvdWxkIHByb2JhYmx5IHJlbW92ZSB0aGlzIGF0IHNvbWUgcG9pbnQuIFRoaXMgaXNuJ3QgdGhlXG4gICAqICAgICAgIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBGaWxlSW5kZXguXG4gICAqIEByZXR1cm4gW0Jyb3dzZXJGUy5ub2RlLmZzLlN0YXRzXVxuICAgKi9cbiAgcHVibGljIGdldFN0YXRzKCk6IFN0YXRzIHtcbiAgICByZXR1cm4gbmV3IFN0YXRzKEZpbGVUeXBlLkRJUkVDVE9SWSwgNDA5NiwgMHgxNkQpO1xuICB9XG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBkaXJlY3RvcnkgbGlzdGluZyBmb3IgdGhpcyBkaXJlY3RvcnkuIFBhdGhzIGluIHRoZSBkaXJlY3RvcnkgYXJlXG4gICAqIHJlbGF0aXZlIHRvIHRoZSBkaXJlY3RvcnkncyBwYXRoLlxuICAgKiBAcmV0dXJuIFtTdHJpbmdbXV0gVGhlIGRpcmVjdG9yeSBsaXN0aW5nIGZvciB0aGlzIGRpcmVjdG9yeS5cbiAgICovXG4gIHB1YmxpYyBnZXRMaXN0aW5nKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fbHMpO1xuICB9XG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBpbm9kZSBmb3IgdGhlIGluZGljYXRlZCBpdGVtLCBvciBudWxsIGlmIGl0IGRvZXMgbm90IGV4aXN0LlxuICAgKiBAcGFyYW0gW1N0cmluZ10gcCBOYW1lIG9mIGl0ZW0gaW4gdGhpcyBkaXJlY3RvcnkuXG4gICAqIEByZXR1cm4gW0Jyb3dzZXJGUy5GaWxlSW5vZGUgfCBCcm93c2VyRlMuRGlySW5vZGUgfCBudWxsXVxuICAgKi9cbiAgcHVibGljIGdldEl0ZW0ocDogc3RyaW5nKTogSW5vZGUge1xuICAgIHZhciBfcmVmO1xuICAgIHJldHVybiAoX3JlZiA9IHRoaXMuX2xzW3BdKSAhPSBudWxsID8gX3JlZiA6IG51bGw7XG4gIH1cbiAgLyoqXG4gICAqIEFkZCB0aGUgZ2l2ZW4gaXRlbSB0byB0aGUgZGlyZWN0b3J5IGxpc3RpbmcuIE5vdGUgdGhhdCB0aGUgZ2l2ZW4gaW5vZGUgaXNcbiAgICogbm90IGNvcGllZCwgYW5kIHdpbGwgYmUgbXV0YXRlZCBieSB0aGUgRGlySW5vZGUgaWYgaXQgaXMgYSBEaXJJbm9kZS5cbiAgICogQHBhcmFtIFtTdHJpbmddIHAgSXRlbSBuYW1lIHRvIGFkZCB0byB0aGUgZGlyZWN0b3J5IGxpc3RpbmcuXG4gICAqIEBwYXJhbSBbQnJvd3NlckZTLkZpbGVJbm9kZSB8IEJyb3dzZXJGUy5EaXJJbm9kZV0gaW5vZGUgVGhlIGlub2RlIGZvciB0aGVcbiAgICogICBpdGVtIHRvIGFkZCB0byB0aGUgZGlyZWN0b3J5IGlub2RlLlxuICAgKiBAcmV0dXJuIFtCb29sZWFuXSBUcnVlIGlmIGl0IHdhcyBhZGRlZCwgZmFsc2UgaWYgaXQgYWxyZWFkeSBleGlzdGVkLlxuICAgKi9cbiAgcHVibGljIGFkZEl0ZW0ocDogc3RyaW5nLCBpbm9kZTogSW5vZGUpOiBib29sZWFuIHtcbiAgICBpZiAocCBpbiB0aGlzLl9scykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLl9sc1twXSA9IGlub2RlO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIC8qKlxuICAgKiBSZW1vdmVzIHRoZSBnaXZlbiBpdGVtIGZyb20gdGhlIGRpcmVjdG9yeSBsaXN0aW5nLlxuICAgKiBAcGFyYW0gW1N0cmluZ10gcCBOYW1lIG9mIGl0ZW0gdG8gcmVtb3ZlIGZyb20gdGhlIGRpcmVjdG9yeSBsaXN0aW5nLlxuICAgKiBAcmV0dXJuIFtCcm93c2VyRlMuRmlsZUlub2RlIHwgQnJvd3NlckZTLkRpcklub2RlIHwgbnVsbF0gUmV0dXJucyB0aGUgaXRlbVxuICAgKiAgIHJlbW92ZWQsIG9yIG51bGwgaWYgdGhlIGl0ZW0gZGlkIG5vdCBleGlzdC5cbiAgICovXG4gIHB1YmxpYyByZW1JdGVtKHA6IHN0cmluZyk6IElub2RlIHtcbiAgICB2YXIgaXRlbSA9IHRoaXMuX2xzW3BdO1xuICAgIGlmIChpdGVtID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBkZWxldGUgdGhpcy5fbHNbcF07XG4gICAgcmV0dXJuIGl0ZW07XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmlsZUlub2RlPFQ+KGlub2RlOiBJbm9kZSk6IGlub2RlIGlzIEZpbGVJbm9kZTxUPiB7XG4gIHJldHVybiBpbm9kZSAmJiBpbm9kZS5pc0ZpbGUoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRGlySW5vZGU8VD4oaW5vZGU6IElub2RlKTogaW5vZGUgaXMgRGlySW5vZGU8VD4ge1xuICByZXR1cm4gaW5vZGUgJiYgaW5vZGUuaXNEaXIoKTtcbn1cbiJdfQ==